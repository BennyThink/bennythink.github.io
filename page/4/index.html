<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>土豆不好吃</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="土豆不好吃">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="土豆不好吃">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Benny小土豆">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="土豆不好吃" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">土豆不好吃</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-yyets-hack/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/12/yyets-hack/index/" class="article-date">
  <time class="dt-published" datetime="2023-03-12T00:00:00.000Z" itemprop="datePublished">2023-03-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/website/">website</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/03/12/yyets-hack/index/">这是人人影视分享站被黑的最惨的一次</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近这段时间，我的<a target="_blank" rel="noopener" href="https://yyets.dmesg.app/home">人人影视分享站</a>不怎么太平，不是被恶意爬虫就是被CC攻击。不知道是遭遇了竞争对手还是怎么的。</p>
<p>3月7日中午，收到cloudflare邮件说服务器无法连接</p>
<p><img src="/images/2023031204182854.png" alt="图形用户界面, 文本, 应用程序, 电子邮件 描述已自动生成"></p>
<p>SSH看一下日志，果然，有很多莫名其妙的搜索，</p>
<p><img src="/images/2023031204182942.jpeg" alt="背景图案 描述已自动生成"></p>
<p>这些请求主要有如下特点：</p>
<p>40秒内200多个请求，分布在60个不同的IP地址上，还全都是中国民用家宽的IP。</p>
<ol>
<li>使用中国各个地区、各个运营商的民用家宽IP，比如上图40秒内200多请求，分布在60个不同的IP地址上</li>
<li>同一个IP的UA还会变，一会是Chrome一会是Firefox，这看起来很不正常</li>
<li>即使到了下半夜也还在大量请求，正常人都是要睡觉的</li>
<li>搜索内容大致为某些综艺的名字+集数或演员名字，没有referer，正常搜索浏览器是一定会带referer的，因此应该是机器人直接发出的请求</li>
<li>他直接请求的！要是跑的selenium我也就认啦，就当给我点广告了</li>
</ol>
<p>我尝试了如下解决方案：</p>
<ol>
<li>根据IP去cloudflare上拉黑，结果发现IP太多，根本拉不过来</li>
<li>用Cloudflare的 rate limit去限制请求频率，结果因为他们IP实在是太多了，全都分散开了，没用</li>
<li>开cloudflare的DDoS 防护规则也没用，因为IP太多了，在cf 看来基本就是正常请求，至少免费版来看是这样的</li>
</ol>
<p>发现以上办法似乎都没有什么用，于是开了三秒墙，所有用户在打开网站的时候都会有浏览器检查，大概这样</p>
<p><img src="/images/2023031204183031.png" alt="文本 描述已自动生成"></p>
<p>机器人自然无法完成JS challenge，于是这一波下来稳了。</p>
<p>我的<a target="_blank" rel="noopener" href="https://yyets.dmesg.app/database"><strong>数据库是公开的</strong></a>，这么爬很不地道，动了这么多IP也一定没少破费。何必呢？我也不是什么竞争对手，我只不过是开了一个很普通的个人站，全靠网友贡献。挺累的。</p>
<hr>
<p>几天之后星期五，我发现网站竟然又挂了！开着三秒墙也能被打挂？看了一眼日志……</p>
<p><img src="/images/2023031204183524.png" alt="电脑屏幕的照片 中度可信度描述已自动生成"></p>
<p>Vultr的美国机，竟然用这种随机无意义的字符串来搜索，竟然还绕过了三秒墙，也绕过了rate limit。🤣于是MongoDB炸了，nginx也基本要炸了。</p>
<p>去cloudflare上添加了黑名单，并没有效果。哦豁？难道是cloudflare又bug了……想了一下，不对，是我的源站IP被找到了，怪不得三秒墙和rate limit都没效果😓</p>
<p>这种情况下只能去机器上添加防火墙，或者机器的供应商那里添加安全组之类的了。不幸的事情来了：</p>
<ol>
<li>没有安全组可用</li>
<li>我的nginx是docker启动的，这也就意味着一般的在<a target="_blank" rel="noopener" href="https://dmesg.app/ufw-vs-docker.html">INPUT链拉黑IP的办法不管用</a></li>
<li>在尝试调解docker和nginx的过程中，一不小心写错了iptables规则。出门没带钥匙嘛。</li>
<li>我不知道SSH的密码是什么，应该是16位的hex，去grub改init然后修改密码很麻烦毕竟是VNC</li>
</ol>
<p><img src="/images/2023031204184330.png" alt="卡通人物 中度可信度描述已自动生成"></p>
<p>不幸之外还有一些好消息：</p>
<ol>
<li>我没有持久化iptables规则，意味着只要去控制面板重启一下，我刚刚写错的规则就会消失了！</li>
<li>我可以换IP，至少能够暂时化解这种情况</li>
</ol>
<hr>
<p>于是问题就这么解决了。这是我做这个小破站被黑的最惨的一次。在这次经历中，我学习到了如下经验教训：</p>
<ol>
<li>爬虫死全家，尤其是45.32.227.75 😄</li>
<li><a target="_blank" rel="noopener" href="https://twitter.com/baobao1270/status/1634619642630246401?s=20">docker会破坏基于iptables为后端的防火墙</a>。Docker跑的应用，如果绑定了端口，那么会给iptables打洞，意味着常规堵INPUT链的办法不管用，要PRE ROUTTING、改DOCKER-USER或者<a target="_blank" rel="noopener" href="https://dmesg.app/ufw-vs-docker.html">让docker和ufw一起工作</a>，巨麻烦，心智负担非常大。</li>
<li>网站躲在cloudflare后也可能被抓到源站IP，比如说censys，全网扫IP+443然后找证书，或者IP+80比对特征</li>
<li>应该拒绝全部非cloudflare IP对80和443的请求，甚至直接通过argo tunnel之类的来解决，连nginx都用不上</li>
<li>保护好自己的IP，毕竟只要IP被抓到了，14亿中国人一人一个ping你也受不了🇨🇳</li>
<li>在MongoDB中使用正则模糊查询，如&#x2F;.*keyword.*&#x2F;是非常慢的，全文检索的话，我记得是Atlas专有，而且一旦涉及到CJK，也有可能完犊子</li>
<li>容器如果一直不停地yyetsbot_web_1 exited with code 137，记得检查下是不是有什么<a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks/status/1634342211319128064?s=20">奇奇怪怪的保活监测脚本</a></li>
<li>配置路由表、iptables规则时务必小心，务必给自己留后门。我之前留的后门是只能通过console登录的root权限用户，密码不是很复杂，通过VNC之类的东西输入还是可以的</li>
<li>MongoDB的aggregation很强大，可以做到跨集合查询，自定义查询字段名称等等</li>
<li>遇到问题不要慌，记得先撸猫再解决问题</li>
</ol>
<p><img src="/images/2023031204184447.jpeg" alt="猫躺在沙发上 描述已自动生成"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/12/yyets-hack/index/" data-id="clhp7rtnw00bys2qr57r91p67" data-title="这是人人影视分享站被黑的最惨的一次" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-container-smtp/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/02/07/container-smtp/index/" class="article-date">
  <time class="dt-published" datetime="2023-02-07T00:00:00.000Z" itemprop="datePublished">2023-02-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/02/07/container-smtp/index/">为什么我的容器连不上riseup的邮件服务器了？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>几天前，我开放了<a target="_blank" rel="noopener" href="https://yyets.dmesg.app/home">人人影视下载站</a>的用户注册功能，并且新用户在注册后需要验证邮箱才能发表评论。开放注册可能会提高用户的活跃度，但是又总有用户发一些不合适的东西，因此有必要提高一点注册门槛。</p>
<p>后端的接口大概在半年前就写好了，我最近才学了一点点 React做好了邮件验证的功能。</p>
<h2 id="如何用发邮件"><a href="#如何用发邮件" class="headerlink" title="如何用发邮件"></a>如何用发邮件</h2><p>我用的是riseup来发，基本如下几步：</p>
<ol>
<li>去域名注册商那边添加一个email forward，因为后需要验证</li>
<li>去riseup添加一个alias</li>
<li>去DNS那边添加一个SPF 记录<code>v=spf1 include:riseup.net +all</code>，如果同时还想用email forward，那就添加 include就好了，比如说我的是这样的<code>v=spf1 include:_spf.mx.cloudflare.net include:riseup.net +all</code></li>
<li>用SMTP协议，可以先用mailhog做测试，确定没问题来之后切到riseup，代码大概这样</li>
</ol>
<p>import smtplib<br>from email.header import Header<br>from email.mime.text import MIMEText<br>from email.utils import formataddr, parseaddr</p>
<p>def _format_addr(s):<br>    name, addr &#x3D; parseaddr(s)<br>    return formataddr((Header(name, ‘utf-8’).encode(), addr))</p>
<p>def send_mail(to: str, subject: str, body: str):<br>    user &#x3D; “username”<br>    password &#x3D; “password”<br>    host &#x3D; “mail.riseup.net”<br>    port &#x3D; 465<br>    from_addr &#x3D; “<a href="mailto:&#121;&#121;&#x65;&#116;&#115;&#x40;&#100;&#x6d;&#x65;&#x73;&#103;&#x2e;&#x61;&#112;&#112;">&#121;&#121;&#x65;&#116;&#115;&#x40;&#100;&#x6d;&#x65;&#x73;&#103;&#x2e;&#x61;&#112;&#112;</a>“</p>
<pre><code>msg = MIMEText(body, &#39;html&#39;, &#39;utf-8&#39;)
msg\[&#39;From&#39;\] = \_format\_addr(&#39;YYeTs &lt;%s&gt;&#39; % from\_addr)
msg\[&#39;To&#39;\] = \_format\_addr(to)
msg\[&#39;Subject&#39;\] = Header(subject, &#39;utf-8&#39;).encode()

if port == &quot;1025&quot;:
    server = smtplib.SMTP(host, int(port))
else:

    server = smtplib.SMTP\_SSL(host, int(port))
server.login(user, password)
server.sendmail(from\_addr, \[to\], msg.as\_string())
server.quit()
</code></pre>
<p>if __name__ &#x3D;&#x3D; ‘__main__‘:<br>    send_mail(“<a href="mailto:&#98;&#x65;&#110;&#110;&#121;&#x2e;&#116;&#104;&#105;&#110;&#x6b;&#x40;&#x67;&#109;&#97;&#x69;&#x6c;&#x2e;&#99;&#111;&#x6d;">&#98;&#x65;&#110;&#110;&#121;&#x2e;&#116;&#104;&#105;&#110;&#x6b;&#x40;&#x67;&#109;&#97;&#x69;&#x6c;&#x2e;&#99;&#111;&#x6d;</a>“, “test subject”, “test body”)</p>
<p>收到的邮件也比较理想，一般来说不会进spam</p>
<p><img src="/images/2023020703173685.png" alt="图形用户界面, 文本, 应用程序 描述已自动生成"></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>前几天做测试的时候一切顺利，上线的时候本来以为没什么大问题，结果今天却收到了一个用户的反馈，说收不到邮件，试了各种邮箱，检查了垃圾箱，也没有收到。</p>
<h2 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h2><p>加了几条log之后发现在容器中 smtplib.SMTP_SSL 会直接卡住，如果按ctrl + c会收到这样的报错</p>
<p>Traceback(most recent call last):<br>  File “”, line 1, in<br>  File “&#x2F;YYeTsBot&#x2F;yyetsweb&#x2F;utils.py”, line 51, in send_mail<br>    server &#x3D; smtplib.SMTP_SSL(host, int(port))<br>  File “&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.10&#x2F;smtplib.py”, line 1050, in __init__<br>    SMTP.__init__(self, host, port, local_hostname, timeout,<br>  File “&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.10&#x2F;smtplib.py”, line 255, in __init__<br>    (code, msg)&#x3D;self.connect(host, port)<br>  File “&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.10&#x2F;smtplib.py”, line 341, in connect<br>    self.sock&#x3D;self._get_socket(host, port, self.timeout)<br>  File “&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.10&#x2F;smtplib.py”, line 1057, in _get_socket<br>    new_socket&#x3D;self.context.wrap_socket(new_socket,<br>  File “&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.10&#x2F;ssl.py”, line 513, in wrap_socket<br>    return self.sslsocket_class._create(<br>  File “&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.10&#x2F;ssl.py”, line 1071, in _create<br>    self.do_handshake()<br>  File “&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.10&#x2F;ssl.py”, line 1342, in do_handshake<br>    self._sslobj.do_handshake()<br>ssl.SSLZeroReturnError: TLS&#x2F;SSL connection has been closed(EOF)(_ssl.c: 997)</p>
<p>奇怪哦，那就排除法做几个测试，首先在容器内nc一下看看</p>
<p>&#x2F; # nc -v mail.riseup.net 465<br>mail.riseup.net (198.252.153.21:465) open</p>
<p>通的耶！那容器内连试试？</p>
<p>[root:~]# docker run –rm -it python:alpine sh<br>&#x2F; # python<br>Python 3.11.1 (main, Feb 4 2023, 01:59:37) [GCC 12.2.1 20220924] on linux<br>Type “help”, “copyright”, “credits” or “license” for more information.</p>
<blockquote>
<blockquote>
<blockquote>
<p>import smtplib<br>smtplib.SMTP_SSL(“mail.riseup.net”,465)</p>
</blockquote>
</blockquote>
</blockquote>
<p>果不其然，卡住了。去宿主机试试看呢？</p>
<p>[root:~]# python<br>Python 3.8.10 (default, Nov 14 2022, 12:59:47)<br>[GCC 9.4.0] on linux<br>Type “help”, “copyright”, “credits” or “license” for more information.</p>
<blockquote>
<blockquote>
<blockquote>
<p>import smtplib<br>smtplib.SMTP_SSL(“mail.riseup.net”,465)<br>&lt;smtplib.SMTP_SSL object at 0xffffa1148610&gt;</p>
</blockquote>
</blockquote>
</blockquote>
<p>没问题哎。看着上面有TLS&#x2F;SSL connection has been closed(EOF)，难道是OpenSSL的问题，试试 <code>python</code>而不是<code>python:alpine</code> 呢？</p>
<p>也不行。</p>
<p>是因为arm64有bug吗？但是我的电脑没问题啊🤔找了一台x86_64的试了一下也没问题。</p>
<p>这么排除下来，问题就是容器的网络了。默认来说docker的默认网络上bridge模式。Bridge是通过iptables去做转发的，之前在<a target="_blank" rel="noopener" href="https://dmesg.app/ufw-vs-docker.html">《我的ufw怎么又不好用了？使用docker时如何拒绝非cloudflare访问》</a>中提到过。</p>
<p>切换到host模式试试看？</p>
<p>[root:~]# docker run –rm –network host -it python:alpine sh<br>&#x2F; # python<br>Python 3.11.1 (main, Feb 4 2023, 01:59:37) [GCC 12.2.1 20220924] on linux<br>Type “help”, “copyright”, “credits” or “license” for more information.</p>
<blockquote>
<blockquote>
<blockquote>
<p>import smtplib<br>smtplib.SMTP_SSL(“mail.riseup.net”,465)<br>&lt;smtplib.SMTP_SSL object at 0xffff96122ed0&gt;</p>
</blockquote>
</blockquote>
</blockquote>
<p>果然，那为什么bridge模式不行host就可以呢？</p>
<p>看了一眼iptables，突然看到这么一条</p>
<p>Chain PREROUTING (policy ACCEPT)<br>target prot opt source destination</p>
<p>REDIRECT tcp – anywhere anywhere tcp dpts:telnet:finger redir ports 16698<br>REDIRECT tcp – anywhere anywhere tcp dpts:81:442 redir ports 16698<br>REDIRECT tcp – anywhere anywhere tcp dpts:snpp:1000 redir ports 16698<br>DOCKER all – anywhere anywhere ADDRTYPE match dst-type LOCAL</p>
<p>这不是之前为了方便梯子使用，把23-1000中除了80和443的端口都给转发到本地的16698了吗？😓</p>
<p>删掉这条规则就好了。</p>
<h2 id="其他的发邮件的办法"><a href="#其他的发邮件的办法" class="headerlink" title="其他的发邮件的办法"></a>其他的发邮件的办法</h2><p>比如说自建，mailgun，sendgrid之类的，我个人觉得sendgrid比较不错，免费用户每天可以发100封。另外一个mailersend一个月可以发12000。同样都可以用SMTP协议手搓邮件。</p>
<h2 id="人人影视分享站运行状况分享"><a href="#人人影视分享站运行状况分享" class="headerlink" title="人人影视分享站运行状况分享"></a>人人影视分享站运行状况分享</h2><p>人人影视分享站大概2021年2月初开始上线，6月的时候在 <a target="_blank" rel="noopener" href="https://github.com/wyx1818">zuiyu</a>的帮助下用React重做了前端，已经跑了整整两年啦。</p>
<h3 id="两年里的收获"><a href="#两年里的收获" class="headerlink" title="两年里的收获"></a>两年里的收获</h3><ul>
<li>总计21000条评论，有很多热心网友都会把新出的剧集网盘分享贴到评论区，非常优秀！</li>
<li>37000个用户😂虽然可能大部分用户都不活跃</li>
<li>每日大概有几千个访问</li>
<li><a target="_blank" rel="noopener" href="https://github.com/tgbot-collection/YYeTsBot">YYeTsBot项目</a>收获了12.4K的star和1.7k的fork，写在简历上很有趣😂</li>
<li><a target="_blank" rel="noopener" href="https://github.com/tgbot-collection/YYeTsFE">前端YYeTsFE</a> 收获了182个star和49个fork</li>
<li><a target="_blank" rel="noopener" href="https://afdian.net/a/BennyThink">爱发电</a>得到了一些热心网友的帮助，足够域名和服务器的费用了，也不枉费我N多个小时的努力</li>
<li>加了Adsense，如果可以的话希望各位能关掉广告屏蔽器。<strong>以后我的猫猫们就是广大网友们养的了！</strong></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2023/02/2023020703250152.jpg"><img src="/images/2023020703250152.jpg" alt="猫"></a></p>
<h3 id="未来一段时间想要做的事情"><a href="#未来一段时间想要做的事情" class="headerlink" title="未来一段时间想要做的事情"></a>未来一段时间想要做的事情</h3><ul>
<li>把网站继续开下去，尽量活下去</li>
<li>优化前端，提升易用性</li>
<li>提升访问量，这很刑！</li>
<li>希望能找到人和我一起维护，这样你也是某个10K+ star的项目都维护者了 🤩，要不我这开源有什么意思嘛</li>
</ul>
<p> </p>
<p>欢迎给个star或者点个广告～</p>
<p><a target="_blank" rel="noopener" href="https://yyets.dmesg.app/">https://yyets.dmesg.app/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/tgbot-collection/YYeTsBot">https://github.com/tgbot-collection/YYeTsBot</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/02/07/container-smtp/index/" data-id="clhp7rtfp001ys2qr1go0h41t" data-title="为什么我的容器连不上riseup的邮件服务器了？" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-stripe-telegram/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/07/stripe-telegram/index/" class="article-date">
  <time class="dt-published" datetime="2023-01-07T00:00:00.000Z" itemprop="datePublished">2023-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/07/stripe-telegram/index/">初探Stripe与Telegram Bot Payments API</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>4个月了，朕又出现了！刁民没能害得了武功高强的朕</p>
<p>Stripe是一个用于全球收钱的在线服务，支持很多种货币，哪怕你人在美国，收人民币也行，Stripe会自动帮你转成账户对应的货币。Stripe支持的支付方式包括银行卡，Apple Pay，Google Pay甚至是国内非常流行的支付宝和微信。</p>
<p>当你有了Stripe账户之后，无代码的情况下可以弄一个收款链接或者二维码，用户通过他们的本地支付方式就可以给你塞钱了。比如说下图这里，用户就可以用支付宝来给我打钱。</p>
<p><img src="/images/2023010721475179.png" alt="手机屏幕截图 描述已自动生成"></p>
<h2 id="集成Stripe"><a href="#集成Stripe" class="headerlink" title="集成Stripe"></a>集成Stripe</h2><p>无代码的方式显然是不够的。很多情况下我们出售服务，或者说是软件授权，都需要自动化进行的。此时我们就可以利用Stripe的API了。想要利用这个API，主要就是两步：</p>
<ol>
<li>创建<code>PaymentIntent</code>，主要就是定义了支持什么支付方式，想要收多少钱，想要什么币种</li>
<li>用户付款之后处理回调，比如说给用户发KEY啦之类的</li>
</ol>
<p>我们以做一个用户任意捐款的页面为例（当然这个可以用Stripe的无代码，只是以此来作为例子），页面大概是这样子的</p>
<p><img src="/images/2023010721475495.png" alt="图示, 文本 描述已自动生成"></p>
<h3 id="创建PaymentIntent"><a href="#创建PaymentIntent" class="headerlink" title="创建PaymentIntent"></a>创建PaymentIntent</h3><p>很丑有没有。用户输入一个金额，提交表单之后，后端需要请求创建Payment Indent，大概是这样的：</p>
<p> </p>
<p>import stripe</p>
<p>stripe.api_key &#x3D;xxx</p>
<p>@app.route(‘&#x2F;checkout’, methods&#x3D;[‘POST’])<br>def checkout():<br>    method &#x3D; request.form[‘method’]<br>    # unit is 分<br>    amount &#x3D; int(float(request.form[‘amount’]) * 100)<br>    # create payment intent<br>    logging.info(“method: %s, amount: %s”, method, amount)<br>    intent &#x3D; stripe.PaymentIntent.create(payment_method_types&#x3D;[method], amount&#x3D;amount, currency&#x3D;”cny”)<br>    secret &#x3D; intent.client_secret<br>    return render_template(‘checkout.html’, pk&#x3D;pk, secret&#x3D;secret, method&#x3D;method)</p>
<p>有几点需要注意的：</p>
<ol>
<li>method是付款方式，具体会受到国家地区和货币的限制</li>
<li>amount是收多少钱，也就是用户在输入框里输入的，需要注意是会变成最小货币单位。对于人民币来说，最小的货币单位是分，也就是说收人民币12.34元，这个amount应该是1234；对于日元这种最小单位就是元的货币（[零位十进制货币](<a target="_blank" rel="noopener" href="https://stripe.com/docs/currencies">https://stripe.com/docs/currencies</a>“ \l “zero-decimal)），收500日元那么就写500即可。</li>
<li>pk是Stripe的API的public key，其实是可以公开的。写在前端的代码里是没问题的</li>
<li>client_secret 对于每一个付款请求都是唯一的</li>
</ol>
<h3 id="发起请求"><a href="#发起请求" class="headerlink" title="发起请求"></a>发起请求</h3><p>前端可以这么写，很简单，总之就是要让用户进入付款页面</p>
<p>const stripe &#x3D; Stripe(pk);<br>error &#x3D; stripe.confirmAlipayPayment(clientSecret, {<br>    &#x2F;&#x2F; Return URL where the customer should be redirected after the authorization<br>    return_url: `${window.location.origin}&#x2F;callback`,<br>});</p>
<p>测试模式下，用户会进入这样的页面</p>
<p><img src="/images/2023010721475750.png" alt="图形用户界面, 应用程序 描述已自动生成"></p>
<p>真实模式下是这样的</p>
<p><img src="/images/2023010721475979.png" alt="图形用户界面, 应用程序 描述已自动生成"></p>
<h3 id="处理回调"><a href="#处理回调" class="headerlink" title="处理回调"></a>处理回调</h3><p>用户付款，成功或者失败之后，会返回return url，我们通过URL就可以知道付款是否成功，当然通过API或者webhook也是可以的。</p>
<p><img src="/images/2023010721480049.png" alt="表格 描述已自动生成"></p>
<p>此时在Stripe的网页上就应该可以看到付款成功了</p>
<p><img src="/images/2023010721480110.png" alt="图形用户界面, 文本, 应用程序, 电子邮件 描述已自动生成"></p>
<p>基本上简单来说就是这样的😂微信也差不多，只不过微信模式下<code>stripe.js</code> 会直接嵌入一个微信的二维码，然后需要用webhook或者API去验证用户是否已经付款，不能依赖callback url啦。完整代码可以看最后gist</p>
<h3 id="Stripe-费率"><a href="#Stripe-费率" class="headerlink" title="Stripe 费率"></a>Stripe 费率</h3><p>在上面的那个Stripe的页面，能发现Stripe抽了不少钱，具体费率每个国家、每种支付方式都不一样。比如如果是加拿大，用支付宝支付，那么费率是2.9% + C$0.30，如果需要货币转换，有些国家也还要收钱的。具体信息可以看这里 <a target="_blank" rel="noopener" href="https://stripe.com/zh-cn-ca/pricing/local-payment-methods">https://stripe.com/zh-cn-ca/pricing/local-payment-methods</a>，把ca（加拿大）替换成你的国家代码就有啦。</p>
<h2 id="Telegram-Bot-Payment"><a href="#Telegram-Bot-Payment" class="headerlink" title="Telegram Bot Payment"></a>Telegram Bot Payment</h2><p>Telegram很早之前也给bot提供了骗钱的功能，支持的收款服务商包括Stripe之类的。想要用Payment API，先要去和Bot Father申请，选择 Bot Settings-Payments，然后选择对应的付款提供商，比如Stripe，之后会被重定向到对应的bot，然后选择测试还是生产模式，做一下oauth就可以拿到一个token了</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2023/01/2023010721561074.jpeg"><img src="/images/2023010721561074.jpeg"></a></p>
<p>测试付款的时候可以用stripe的测试模式，有很多卡号可以模拟各种情况，成功失败都有，比如4242 4242 4242 4242就是可以用的测试卡，完整列表[可以看这里](<a target="_blank" rel="noopener" href="https://stripe.com/docs/testing">https://stripe.com/docs/testing</a>“ \l “cards)。</p>
<p>一些Bot API wrapper，比如pytelegrambotapi已经有了很<a target="_blank" rel="noopener" href="https://github.com/eternnoir/pyTelegramBotAPI/blob/master/examples/payments_example.py">简单易懂的例子</a>。这里我用的pyrogram（1.x）来做例子说明怎么生成、验证付款。</p>
<h2 id="生成invoice"><a href="#生成invoice" class="headerlink" title="生成invoice"></a>生成invoice</h2><p>需要使用<code>raw_types</code></p>
<p>from pyrogram.raw import types as raw_types<br>raw_types.invoice.Invoice(currency&#x3D;”USD”, prices&#x3D;[raw_types.LabeledPrice(label&#x3D;”price”, amount&#x3D;amount)])</p>
<p>其中prices接受的参数是一个list，意味着这里可以有多项，比如说商品价格，税费，折扣，等等。amount同样遵循上面的最小货币单位原则，要收11.3美元，那么就要写1130</p>
<p>这里Invoice支持很多额外参数，比如<code>email_requested</code>，<code>name_requested</code>，<code>suggested_tip_amounts</code>等等，自行发挥吧</p>
<h2 id="生成InputMediaInvoice"><a href="#生成InputMediaInvoice" class="headerlink" title="生成InputMediaInvoice"></a>生成InputMediaInvoice</h2><p>raw_types.input_media_invoice.InputMediaInvoice(<br>    invoice&#x3D;(<br>        raw_types.invoice.Invoice(currency&#x3D;”USD”, prices&#x3D;[raw_types.LabeledPrice(label&#x3D;”price”, amount&#x3D;amount)])),<br>    title&#x3D;title,<br>    description&#x3D;description,<br>    provider&#x3D;PROVIDER_TOKEN,<br>    provider_data&#x3D;raw_types.DataJSON(data&#x3D;”{}”),<br>    payload&#x3D;payload,<br>)</p>
<ul>
<li><code>PROVIDER_TOKEN</code>是在Bot Father中申请的那个token，不是bot token。</li>
<li><code>provider_data</code> 是收款商需要要求的信息，比如<a target="_blank" rel="noopener" href="https://stripe.com/docs/india-accept-international-payments">印度Stripe强制要求姓名地址</a>，那么就应该写在这里，否则Stripe会拒付。我这边没有要求，所以直接空json字符串就好</li>
<li>Payload是我们自定义的信息，内部使用，比如用于区分是什么的付款</li>
</ul>
<p>如果要inline模式，那么就要用<code>InputBotInlineMessageMediaInvoice</code></p>
<h2 id="选择Forwarding-Behavior"><a href="#选择Forwarding-Behavior" class="headerlink" title="选择Forwarding Behavior"></a>选择Forwarding Behavior</h2><p>当invoice被转发了之后，我们可以选择有什么样的行为，一种是会可以继续付款，另外一种是通过deep linking跳转到机器人。由<code>InputMediaInvoice</code>的参数<code>start_param</code>控制的。直接忽略这个参数，意味着转发的消息也可以付款，并且付款后按钮不会变成receipt</p>
<p><img src="/images/2023010721480686.png" alt="图形用户界面, 文本, 应用程序, 聊天或短信 描述已自动生成"></p>
<h2 id="发送invoice"><a href="#发送invoice" class="headerlink" title="发送invoice"></a>发送invoice</h2><p>用<code>SendMedia</code>就可以了</p>
<p>peer &#x3D; raw_types.InputPeerUser(user_id&#x3D;chat_id, access_hash&#x3D;0)</p>
<p>app.send(<br>    functions.messages.SendMedia(<br>        peer&#x3D;peer,<br>        media&#x3D;inputinvoice,<br>        random_id&#x3D;app.rnd_id(),<br>        message&#x3D;”pay for it!”,<br>    )<br>)</p>
<h2 id="Pre-Checkout"><a href="#Pre-Checkout" class="headerlink" title="Pre-Checkout"></a>Pre-Checkout</h2><p>用户在付款之后，Telegram这边会给bot发一个<code>pre_checkout_query</code>的更新，要求bot做一个precheckout的检查，比如说检查是否还有货啦这种。Bot需要在10秒之内用<code>answerPreCheckoutQuery</code>应答，否则就会出错。</p>
<p>Pyrogram这边我没找到合适的事件监听，可能是版本太老了，所以只能这样了：</p>
<p>@app.on_raw_update()<br>def raw_update(client: “Client”, update, users, chats):<br>    if update.QUALNAME &#x3D;&#x3D; ‘types.UpdateBotPrecheckoutQuery’:<br>        client.send(<br>            functions.messages.SetBotPrecheckoutResults(<br>            query_id&#x3D;update.query_id,<br>            success&#x3D;True<br>            )<br>        )</p>
<ul>
<li>success表示pre checkout状态，如果是false，需要提供一个error</li>
</ul>
<h2 id="checkout"><a href="#checkout" class="headerlink" title="checkout"></a>checkout</h2><p>Bot确认之后，Telegram就会请求Stripe完成付款请求。之后telegram会发一个<code>successful_payment</code>的service message，bot看到之后确认就可以了。</p>
<p>我们可以通过raw update的 <code>types.MessageActionPaymentSentMe</code> 来确认</p>
<p>打开你的Stripe，切换到测试模式，可以看到已经有“进账”啦，甚至还可以提现到银行卡😂</p>
<p><img src="/images/2023010721480796.png" alt="图形用户界面, 文本, 应用程序 描述已自动生成"></p>
<h2 id="值得思考的问题"><a href="#值得思考的问题" class="headerlink" title="值得思考的问题"></a>值得思考的问题</h2><p>既然Stripe能支持支付宝微信付款，并且可以提现到银行卡，那么相比较银行汇款，哪个更划算呢？</p>
<p>已知条件如下：</p>
<ol>
<li>招商银行通信费150元&#x2F;笔，手续费为汇款金额的0.1%，最低100最高1000，不考虑境外银行的收费</li>
<li>Stripe手续费 2.9%，无提现、货币转换费</li>
<li>均不考虑不同平台银行的汇率差异</li>
</ol>
<h2 id="欢迎大家给我打钱！"><a href="#欢迎大家给我打钱！" class="headerlink" title="欢迎大家给我打钱！"></a>欢迎大家给我打钱！</h2><p><a target="_blank" rel="noopener" href="https://dmesg.app/donate">参考这里</a>或者直接Stripe吧！</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2023/01/2023010623451377.png"><img src="/images/2023010623451377-250x300.png"></a></p>
<p> </p>
<p> </p>
<p> </p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://core.telegram.org/bots/payments#step-by-step-process">https://core.telegram.org/bots/payments#step-by-step-process</a></p>
<p><a target="_blank" rel="noopener" href="https://stripe.com/docs/payments/alipay/accept-a-payment?locale=zh-CN">https://stripe.com/docs/payments/alipay/accept-a-payment?locale=zh-CN</a></p>
<p><a target="_blank" rel="noopener" href="https://stripe.com/docs/payments/wechat-pay/accept-a-payment">https://stripe.com/docs/payments/wechat-pay/accept-a-payment</a></p>
<p><a target="_blank" rel="noopener" href="https://stripe.com/zh-cn-ca/pricing/local-payment-methods">https://stripe.com/zh-cn-ca/pricing/local-payment-methods</a></p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/BennyThink/d3a0de89d21ccb955636e0ffba0f9ea1">https://gist.github.com/BennyThink/d3a0de89d21ccb955636e0ffba0f9ea1</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/01/07/stripe-telegram/index/" data-id="clhp7rtke0096s2qrgma31es9" data-title="初探Stripe与Telegram Bot Payments API" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-wg0000/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/20/wg0000/index/" class="article-date">
  <time class="dt-published" datetime="2022-09-20T00:00:00.000Z" itemprop="datePublished">2022-09-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/what/">what</a>►<a class="article-category-link" href="/categories/what/gfw/">gfw</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/20/wg0000/index/">为什么我的WireGuard 配置 AllowedIPs=0.0.0.0/0 之后客户端断网了？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>一直以来我都是使用WireGuard组建<a target="_blank" rel="noopener" href="https://nova.moe/deploy-wireguard-on-ubuntu-bionic/">安全大内网的</a>，几乎没有拿它来当作代理工具使用。</p>
<p>今天突然要测试一下腾讯云的IP，那还不简单嘛，直接 <code>AllowedIPs=0.0.0.0/0</code>，让所有流量都走WG就好了！只是简单的测一下，并不想搭个shadowsocks或者OpenVPN什么的。（小心被警告写保证书哦）</p>
<p>结果我一波配置完，却断网了</p>
<p><img src="/images/2022092019575915.png"></p>
<p>以为是DNS的问题，配置上 DNS&#x3D;223.5.5.5，还断网，当然peer的IP能ping通，路由器还能通。</p>
<p>思考了很多可能的因素，包括腾讯云的网络是fullcone NAT，macOS的Darwin内核，本地的IPv6网络，腾讯云的wg配置。尝试了换vultr做peer，开一个新的虚拟机，换手机，换surfshark的配置文件</p>
<p><code>net.ipv4.ip_forward</code> 和<code>net.ipv4.conf.all.proxy_arp</code> 也都开了，peer也没有防火墙……</p>
<p>最后发现是因为没有添加iptables规则</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2022/09/2022092020071682.jpeg"><img src="/images/2022092020071682.jpeg"></a></p>
<p>在腾讯云配置文件中添加两行规则</p>
<p>PostUp &#x3D; iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ens5 -j MASQUERADE;<br>PostDown &#x3D; iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ens5 -j MASQUERADE;</p>
<p>如果还要支持IPv6的话</p>
<p>PostUp &#x3D; iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ens5 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o en s -j MASQUERADE</p>
<p>PostDown &#x3D; iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ens5 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o ens5 -j MASQUERADE</p>
<p>重新载入一下配置文件就好了。macOS和iOS这边的Interface再加上一个DNS配置就好了</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><h3 id="腾讯云"><a href="#腾讯云" class="headerlink" title="腾讯云"></a>腾讯云</h3><p>[Interface]<br>Address &#x3D; 192.168.2.1&#x2F;24<br>SaveConfig &#x3D; false<br>ListenPort &#x3D; 443<br>PrivateKey &#x3D; </p>
<p>PostUp &#x3D; iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ens5 -j MASQUERADE;<br>PostDown &#x3D; iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ens5 -j MASQUERADE;</p>
<p>[Peer]<br>PublicKey &#x3D;<br>AllowedIPs &#x3D; 192.168.2.64&#x2F;32</p>
<h3 id="Peer"><a href="#Peer" class="headerlink" title="Peer"></a>Peer</h3><p>[Interface]<br>PrivateKey &#x3D;<br>Address &#x3D; 192.168.2.64&#x2F;32<br>DNS &#x3D; 223.5.5.5</p>
<p>[Peer]<br>PublicKey &#x3D; 4<br>AllowedIPs &#x3D; 0.0.0.0&#x2F;0, ::&#x2F;0<br>Endpoint &#x3D; xxxxxx.xxx:443<br>PersistentKeepalive &#x3D; 30</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://y2k38.github.io/posts/how-to-setup-wireguard-vpn-server/">https://y2k38.github.io/posts/how-to-setup-wireguard-vpn-server/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/09/20/wg0000/index/" data-id="clhp7rtn600b3s2qr592ndvny" data-title="为什么我的WireGuard 配置 AllowedIPs=0.0.0.0/0 之后客户端断网了？" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-linux-lipo/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/13/linux-lipo/index/" class="article-date">
  <time class="dt-published" datetime="2022-09-13T00:00:00.000Z" itemprop="datePublished">2022-09-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/13/linux-lipo/index/">在Linux下使用lipo创建 universal macOS binary</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>macOS的应用程序可以同时包含多种架构，最常见的是包含arm64和amd64这两种。操作系统会自动选择执行最合适的架构，避免使用rosetta 2.</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2022/09/2022091220433923.png"><img src="/images/2022091220433923.png"></a></p>
<h2 id="创建universal-binary"><a href="#创建universal-binary" class="headerlink" title="创建universal binary"></a>创建universal binary</h2><p>在macOS中，自带一个工具 <code>lipo</code>，可以用来合并、提取、显示这种universal binary的信息。</p>
<p>比如我想创建一个universal binary，可以这样做</p>
<p># lipo -create -output universal amd64 arm64</p>
<h1 id="file-universal"><a href="#file-universal" class="headerlink" title="file universal"></a>file universal</h1><p>universal: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64Mach-O 64-bit executable x86_64] [arm64]<br>universal (for architecture x86_64): Mach-O 64-bit executable x86_64<br>universal (for architecture arm64): Mach-O 64-bit executable arm64</p>
<p>可以把某个架构的binary提取出来，<code>-extract</code></p>
<p># lipo -extract x86_64 -output amd universal</p>
<h1 id="file-amd"><a href="#file-amd" class="headerlink" title="file amd"></a>file amd</h1><p>amd: Mach-O universal binary with 1 architecture: [x86_64:Mach-O 64-bit executable x86_64Mach-O 64-bit executable x86_64]<br>amd (for architecture x86_64): Mach-O 64-bit executable x86_64</p>
<p>也可以用来显示binary的一些信息</p>
<p>&gt; $ lipo -detailed_info universal<br>Fat header in: universal<br>fat_magic 0xcafebabe<br>nfat_arch 2<br>architecture x86_64<br>    cputype CPU_TYPE_X86_64<br>    cpusubtype CPU_SUBTYPE_X86_64_ALL<br>    capabilities 0x0<br>    offset 4096<br>    size 1181264<br>    align 2^12 (4096)<br>architecture arm64<br>    cputype CPU_TYPE_ARM64<br>    cpusubtype CPU_SUBTYPE_ARM64_ALL<br>    capabilities 0x0<br>    offset 1196032<br>    size 1190706<br>    align 2^14 (16384)</p>
<h2 id="Linux下创建universal-binary替代品"><a href="#Linux下创建universal-binary替代品" class="headerlink" title="Linux下创建universal binary替代品"></a>Linux下创建universal binary替代品</h2><p>可惜Linux上竟然没有对应的lipo。对于那些用Go写的应用程序，天生就支持交叉编译，那为了在release发布一个universal binary，还得自己合并，或者GitHub Actions跑一个macOS？也不是不行，就是太麻烦啦！</p>
<p>但是不怕，universal binary的技术细节是公开的，并且Apple开源了lipo对应的代码，可以看<a target="_blank" rel="noopener" href="https://github.com/apple-oss-distributions/cctools">cctools</a>. 非常幸运的是还有一个人给port到了Linux，<a target="_blank" rel="noopener" href="https://github.com/tpoechtrager/cctools-port">https://github.com/tpoechtrager/cctools-port</a></p>
<p>那么为了在Linux下创建这样的universal binary，要么就去读技术细节，参考官方的C语言实践，自己用其他语言写一个；要么就直接用现成的cctools-port，编译一个lipo，直接用即可。</p>
<h2 id="Linux-lipo"><a href="#Linux-lipo" class="headerlink" title="Linux-lipo"></a>Linux-lipo</h2><p>我比较菜，大概读不懂那些难度很高的文档，还得看十六进制，因此我选择直接用官方的代码。</p>
<p>于是我就做了一个docker image，只要传递过来参数，就可以创建universal binary</p>
<p>比如我写了这样的简单的Go代码，打印出运行时的架构</p>
<p>package main</p>
<p>import “runtime”</p>
<p>func main() {<br>    &#x2F;&#x2F; print architecture info<br>    println(“Architecture:”, runtime.GOARCH)<br>}</p>
<p>然后编译两个不同架构的binary</p>
<p>GOOS&#x3D;darwin GOARCH&#x3D;amd64 go build -o amd64 .<br>GOOS&#x3D;darwin GOARCH&#x3D;arm64 go build -o arm64 .</p>
<blockquote>
<p>$ file amd64 arm64<br>amd64: Mach-O 64-bit executable x86_64<br>arm64: Mach-O 64-bit executable arm64</p>
</blockquote>
<p>然后就可以这样创建出来universal binary</p>
<p>docker run –rm -v $(pwd):&#x2F;app&#x2F; bennythink&#x2F;lipo-linux -create -output universal amd64 arm64</p>
<p>或者extract啊什么的都行的。只要你想，甚至可以把这个docker image里的lipo提取出来用，问题不大。</p>
<p> </p>
<h2 id="也许可以……"><a href="#也许可以……" class="headerlink" title="也许可以……"></a>也许可以……</h2><p>如果你的Mac的存储空间严重不足，也许可以考虑把那些fat binary给瘦身一下。毕竟两个架构，体积翻倍。framework之类的也可以瘦身，就看能不能找到。比如说word的话……可以考虑瘦身一下这个文件，80M变40M🤣</p>
<p>Microsoft Word.app&#x2F;Contents&#x2F;MacOS&#x2F;Microsoft Word</p>
<p>效果还是有的，70%左右吧😂 <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2022/09/2022091623192693.png"><img src="/images/2022091623192693.png"></a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>A deep dive on macOS universal binaries</p>
<p><a target="_blank" rel="noopener" href="https://www.jviotti.com/2021/07/23/a-deep-dive-on-macos-universal-binaries.html">https://www.jviotti.com/2021/07/23/a-deep-dive-on-macos-universal-binaries.html</a></p>
<p>Building a Universal macOS Binary</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/apple-silicon/building-a-universal-macos-binary">https://developer.apple.com/documentation/apple-silicon/building-a-universal-macos-binary</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/09/13/linux-lipo/index/" data-id="clhp7rthe004os2qra61g0589" data-title="在Linux下使用lipo创建 universal macOS binary" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-m1-aom/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/26/m1-aom/index/" class="article-date">
  <time class="dt-published" datetime="2022-08-26T00:00:00.000Z" itemprop="datePublished">2022-08-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/08/26/m1-aom/index/">在M1 Mac下开发WebP Server Go</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近换了M1的Mac，成为了ARM芯片的受害者。在尝试用Go运行WebP Server Go的时候出错了</p>
<p><img src="/images/2022082608305257.jpeg" alt="图形用户界面, 文本, 应用程序 描述已自动生成"></p>
<p>看起来是没有安装aom，但是<code>brew install</code>了一下还是有的啊。另一边的Intel Mac就没这个问题。</p>
<p>╰─$ ls &#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;include&#x2F;aom<br>aom.h aom_external_partition.h aomcx.h<br>aom_codec.h aom_frame_buffer.h aomdx.h<br>aom_decoder.h aom_image.h<br>aom_encoder.h aom_integer.h</p>
<p>头文件明明是有的！</p>
<p>想了一下， 原因可能是因为M1的homebrew会把相关的依赖安装到 <code>/opt/homebrew</code>下，而不像Intel的版本会丢在<code>/usr/local/</code>下，而<code>/usr/local/</code>大概率是gcc默认的搜索路径。所以gcc compiler找不到对应的头文件了。</p>
<p>创建了一个简单的<code>test.c</code> 验证一下</p>
<p>#include<br>#include<br>#include &lt;aom&#x2F;aom_encoder.h&gt;<br>int main() {<br>   &#x2F;&#x2F; printf() displays the string inside quotation<br>   printf(“Hello, World!”);<br>   return 0;<br>}</p>
<p>╰─$ gcc test.c test.c:3:10: fatal error: ‘aom&#x2F;aom_encoder.h’ file not found #include &lt;aom&#x2F;aom_encoder.h&gt; ^~~~~~~~~~~~~~~~~~~ 1 error generated.</p>
<p>果真如此，那么就export一下CFLAGS吧</p>
<p>╰─$ export CFLAGS&#x3D;I&#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;include&#x2F; 1 ↵<br>╭─benny@MBP ~&#x2F;Downloads<br>╰─$ gcc test.c<br>test.c:3:10: fatal error: ‘aom&#x2F;aom_encoder.h’ file not found<br>#include &lt;aom&#x2F;aom_encoder.h&gt;<br>^~~~~~~~~~~~~~~~~~~<br>1 error generated.</p>
<p>依旧报错。为什么CFLAGS不生效呢？</p>
<p>试试把aom符号连接到 <code>/usr/local/include</code>？ 这个目录应该是默认搜索的。</p>
<p>❯ ln -s &#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;include&#x2F;aom &#x2F;usr&#x2F;local&#x2F;include<br>~&#x2F;Downloads<br>❯ gcc test.c</p>
<p>没有报错，证明我的推断是正确的。</p>
<p>突然想到，macOS的这个gcc，其实是clang啊，那么是不是和正常的gcc用的环境变量不同？搜了一下还真是，clang应该用<code>CPATH</code>，<code>C_INCLUDE_PATH</code> 和<code>CPLUS_PATH</code>之类的，具体可以参考这里 <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/CommandGuide/clang.html">https://clang.llvm.org/docs/CommandGuide/clang.html</a></p>
<p>把符号连接删掉，再试试看！</p>
<p>└&gt; gcc test.c<br>test.c:3:10: fatal error: ‘aom&#x2F;aom_encoder.h’ file not found<br>#include &lt;aom&#x2F;aom_encoder.h&gt;<br>^~~~~~~~~~~~~~~~~~~<br>1 error generated.<br>┌[kiwish-4.2]-(<del>&#x2F;Downloads)-<br>└&gt; export CPATH&#x3D;&#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;include&#x2F;<br>┌[kiwish-4.2]-(</del>&#x2F;Downloads)-<br>└&gt; gcc test.c</p>
<p>果真如此！于是Goland加一个环境变量，再次编译</p>
<p>&#x2F;opt&#x2F;homebrew&#x2F;Cellar&#x2F;go&#x2F;1.19&#x2F;libexec&#x2F;pkg&#x2F;tool&#x2F;darwin_arm64&#x2F;link: running clang failed: exit status 1<br>ld: library not found for -laom<br>clang: error: linker command failed with exit code 1 (use -v to see invocation)</p>
<p>看起来是LDFLAGS的问题，猜测clang还是用的奇奇怪怪的环境变量。先link一下看看</p>
<p>ln -s &#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;lib&#x2F;* &#x2F;usr&#x2F;local&#x2F;lib&#x2F;</p>
<p>再运行，果真好了。那么如何用环境变量解决问题呢？我不太喜欢在系统目录里link来link去的。</p>
<p>搜了一圈，正确的环境变量的名字叫<code>LIBRARY_PATH</code></p>
<p>LIBRARY_PATH&#x3D;&#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;lib&#x2F;</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Clang真坑</p>
<p>设置两个环境变量就好了</p>
<p>CPATH&#x3D;&#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;include&#x2F;;LIBRARY_PATH&#x3D;&#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;lib&#x2F;</p>
<p><img src="/images/2022082608305373.png" alt="文本 中度可信度描述已自动生成"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/26/m1-aom/index/" data-id="clhp7rthi004ss2qr85fk9fvn" data-title="在M1 Mac下开发WebP Server Go" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-go-selenium/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/23/go-selenium/index/" class="article-date">
  <time class="dt-published" datetime="2022-07-23T00:00:00.000Z" itemprop="datePublished">2022-07-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/23/go-selenium/index/">Go 使用selenium截图</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今天想给<a target="_blank" rel="noopener" href="https://t.me/wayback_machine_bot">wayback machine bot</a>增加一个截图的功能，难度不大，用selenium打开浏览器，截图，再发给用户就可以了。</p>
<p>网上随便就可以找到教程，比如说这样</p>
<p>package main</p>
<p>import (<br>    “fmt”<br>    log “github.com&#x2F;sirupsen&#x2F;logrus”<br>    “github.com&#x2F;tebeka&#x2F;selenium”<br>    “io&#x2F;ioutil”<br>)</p>
<p>const (<br>    chromeDriverPath &#x3D; “&#x2F;usr&#x2F;local&#x2F;bin&#x2F;chromedriver”<br>    port &#x3D; 9515<br>)</p>
<p>func main() {<br>    var opts []selenium.ServiceOption<br>    selenium.SetDebug(false)<br>    service, err :&#x3D; selenium.NewChromeDriverService(chromeDriverPath, port, opts…)<br>    if err !&#x3D; nil {<br>        panic(err) &#x2F;&#x2F; panic is used only as an example and is not otherwise recommended.<br>    }<br>    defer service.Stop()</p>
<pre><code>caps := selenium.Capabilities&#123;&quot;browserName&quot;: &quot;chrome&quot;&#125;
wd, err := selenium.NewRemote(caps, fmt.Sprintf(&quot;http://localhost:%d/wd/hub&quot;, port))
if err != nil &#123;
    panic(err)
&#125;

defer wd.Quit()
if err := wd.Get(&quot;https://github.com/tgbot-collection/archiver&quot;); err != nil &#123;
    panic(err)
&#125;

screenshot, err := wd.Screenshot()
if err != nil &#123;
    log.Errorln(err)

&#125;
ioutil.WriteFile(&quot;screenshot.png&quot;, screenshot, 0644)
</code></pre>
<p>}</p>
<p><img src="/images/2022072320584942.png"></p>
<p>但是问题来了，这里的截屏只有当前窗口，怎么把整个页面都截屏了呢？</p>
<h2 id="整页截屏"><a href="#整页截屏" class="headerlink" title="整页截屏"></a>整页截屏</h2><p>方法还是有的，一个简单的办法就是获取到网页的宽高，然后把浏览器的窗口设置成这么大，然后再截图就好了！需要注意的是只有headless模式可以任意设置窗口大小，否则最大高度不能超过你的显示器分辨率</p>
<p>设置headless只需要加个参数就好了，如下</p>
<p>caps :&#x3D; selenium.Capabilities{“browserName”: “chrome”}<br>    chromeCaps :&#x3D; chrome.Capabilities{<br>        Path: “”,<br>        Args: []string{<br>            “–headless”,<br>        },<br>    }<br>    caps.AddChrome(chromeCaps)<br>    wd, err :&#x3D; selenium.NewRemote(caps, fmt.Sprintf(“<a href="http://localhost:%d/wd/hub">http://localhost:%d/wd/hub</a>“, port))</p>
<p>获取网课宽高很容易，偷懒的话只要获取网页的高就可以了，宽我们可以固定成固定的像素，比如1920.</p>
<p>在chrome的控制台里，输入这么一串神秘代码可获得网页的高</p>
<p>document.body.parentNode.scrollHeight</p>
<p>在selenium中使用<code>ExecuteScript</code>就可以执行JavaScript代码，需要注意返回值是interface，所以要类型断言成float，然后再转成int</p>
<p>height, _ :&#x3D; wd.ExecuteScript(“return document.body.parentNode.scrollHeight”, nil)<br>var realHeight &#x3D; int(height.(float64))</p>
<p>然后我们需要设置窗口大小</p>
<p>wd.ResizeWindow(“”, 1920, realHeight)</p>
<p>运行一下看看，果然正确且完美</p>
<h2 id="在服务器中运行"><a href="#在服务器中运行" class="headerlink" title="在服务器中运行"></a>在服务器中运行</h2><p>必然这个东西是要在某台服务器中跑起来的，也没什么不同的，下载自己的webdriver，安装浏览器，照样headless启动就好了。应该不会遇到大问题</p>
<h2 id="在容器中运行"><a href="#在容器中运行" class="headerlink" title="在容器中运行"></a>在容器中运行</h2><p>理论上来说，在容器中运行和在某个Linux发行版运行是没什么太大差别的。无非就是找到对应的webdriver。比如我经常用的alpine恰巧提供了chrome和chrome-webdriver，并且有amd64和arm64(aarch64)的预编译包</p>
<p>直接运行 <code>apk add chromium-chromedriver</code> 浏览器和webdriver会一起安装好</p>
<p>要注意一件事情，如果你是root用户运行的，那么要加上<code>--no-sandbox</code> 参数</p>
<p>一运行却发现结果不如人意，总是写入0大小的文件，或者报错</p>
<p><img src="/images/2022072320585057.png"></p>
<p>强行加一行sleep，会有比较大的概率会避免这个问题，但是这不是个办法嘛。</p>
<p>if err :&#x3D; wd.Get(“<a target="_blank" rel="noopener" href="https://www.baidu.com/">https://www.baidu.com</a>“); err !&#x3D; nil {<br>    panic(err)<br>}<br>time.Sleep(10 * time.Second)</p>
<p>后来搜了一下，是Chrome和 container的兼容性问题，Chrome需要比较大的<code>/dev/shm</code>，然而容器中的<code>/dev/shm</code>往往都比较小，对于Chrome这种内大户来说不太行。</p>
<p><img src="/images/2022072320585144.png"></p>
<p>解决方法要么就增大容器里的<code>/dev/shm</code>，可以通过run时额外参数<code>--shm-size=256m</code></p>
<p><img src="/images/2022072320585236.png"></p>
<p>也可以直接把宿主机的共享进去</p>
<p>docker run –rm -v &#x2F;dev&#x2F;shm:&#x2F;dev&#x2F;shm -it alpine sh</p>
<p>也可以禁用Chrome的shm功能，加一个参数</p>
<p>“–disable-dev-shm-usage”,</p>
<p>还有一种办法，换Firefox也许也有救。</p>
<h2 id="中文乱码"><a href="#中文乱码" class="headerlink" title="中文乱码"></a>中文乱码</h2><p>alpine里没带中文字体，所以中文会乱码。可以用alpine自带的一个，这样安装就好，也可以自己偷字体，然后放到<code>/usr/share/fonts/</code> 就好了</p>
<p>apk add wqy-zenhei –update-cache –repository <a target="_blank" rel="noopener" href="https://nl.alpinelinux.org/alpine/edge/testing">https://nl.alpinelinux.org/alpine/edge/testing</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/53970825/10264400">https://stackoverflow.com/a/53970825/10264400</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/tgbot-collection/archiver/blob/master/screenshot.go">https://github.com/tgbot-collection/archiver/blob/master/screenshot.go</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/23/go-selenium/index/" data-id="clhp7rtge0038s2qr3i7g30pn" data-title="Go 使用selenium截图" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-change-git-user/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/13/change-git-user/index/" class="article-date">
  <time class="dt-published" datetime="2022-06-13T00:00:00.000Z" itemprop="datePublished">2022-06-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/what/">what</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/13/change-git-user/index/">如何更改git commit user？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>乔治·奥威尔有言</p>
<blockquote>
<p>历史不是一面镜子，而是黑板上的记号，可以随时擦去，随时填补。更为可怕的是，一旦涂改了，你找不到证据去证明这是篡改历史的行为。</p>
</blockquote>
<p>Git会追踪每一次commit的历史记录，如果之前不小心配置错了用户名，那么有办法改掉吗？</p>
<p>当然了办法是有的，改掉commit username和email是很容易的，不就是这么几行嘛？</p>
<p>git rebase -i f25f719f7c2333d310696c3ed41e5a90ed078e55</p>
<p>弹出的交互式窗口，把要改的commit从<code>pick</code>改成<code>edit</code></p>
<p><img src="/images/2022061322415582.png"></p>
<p>然后不停地</p>
<p>git commit –amend –author&#x3D;”Cool <a href="mailto:&#x63;&#111;&#x6f;&#108;&#x40;&#103;&#x6d;&#x61;&#x69;&#x6c;&#46;&#99;&#x6f;&#x6d;">&#x63;&#111;&#x6f;&#108;&#x40;&#103;&#x6d;&#x61;&#x69;&#x6c;&#46;&#99;&#x6f;&#x6d;</a>“ –no-edit &amp;&amp; git rebase –continue</p>
<p>就可以了</p>
<p><img src="/images/2022061322415653.png"></p>
<p>事实果真如此吗？<code>git push -fv</code>试试看？</p>
<p><img src="/images/2022061322415838.png"> <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2022/06/2022061322453057.jpg"><img src="/images/2022061322453057.jpg"></a></p>
<hr>
<p>妈勒个巴子，时间不对啊，明明是Feb的怎么就变成了现在的时间了。这不就露馅了吗！</p>
<p>千辛万苦找到一个名字叫<a target="_blank" rel="noopener" href="https://github.com/newren/git-filter-repo">git-filter-repo</a>的东西，试了一下是可以的。</p>
<p>先安装，比如说 <code>apt install git-filter-repo</code></p>
<p>然后创建一个<code>mailmap</code>文件，格式如下</p>
<p>New <a href="mailto:&#x6e;&#101;&#x77;&#64;&#x67;&#109;&#x61;&#105;&#108;&#46;&#x63;&#111;&#x6d;">&#x6e;&#101;&#x77;&#64;&#x67;&#109;&#x61;&#105;&#108;&#46;&#x63;&#111;&#x6d;</a> BennyThink <a href="mailto:&#x62;&#x65;&#110;&#110;&#121;&#46;&#116;&#104;&#x69;&#110;&#107;&#x40;&#103;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#x6f;&#x6d;">&#x62;&#x65;&#110;&#110;&#121;&#46;&#116;&#104;&#x69;&#110;&#107;&#x40;&#103;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#x6f;&#x6d;</a></p>
<p>如有需要可以写多行</p>
<p>然后</p>
<p>git filter-repo –mailmap &#x2F;etc&#x2F;mailmap</p>
<p>然后再push，如果遇到缺失remote的问题，重新添加一下</p>
<p>git remote add origin <a target="_blank" rel="noopener" href="https://github.com/tgbot-collection/history">https://github.com/tgbot-collection/history</a><br>git push –set-upstream origin master -fv</p>
<p>优秀吧！全变成对应的名字和邮箱了，并且commit的时间也没有改变。<code>git log</code>和GitHub是一致的。</p>
<p><img src="/images/2022061322420811.png"></p>
<p>如果想要只改几个commit的邮箱，那怎么办呢？</p>
<p>比如说只想改前两个</p>
<p>git filter-repo –refs master~2..master –mailmap &#x2F;etc&#x2F;mailmap</p>
<p><img src="/images/2022061322420927.png"></p>
<p>如果想改某个中间的一些commit的邮箱为某个人、并且还不改变GitHub上显示的时间呢？甚至不敢确定这种是否可行😂</p>
<p>emmm这个我还不太知道，其实不太知道refs是什么意思，尝试了很久也不行</p>
<p>看到git-filter-repo里写着</p>
<p>git filter-repo … –refs C..H<br>git filter-repo … –refs C..H ^D<br>git filter-repo … –refs D..H ^C</p>
<p>H应该指的是HEAD？</p>
<p>总之，暂时够用了😂</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/13/change-git-user/index/" data-id="clhp7rtek000qs2qrhtvr4bqs" data-title="如何更改git commit user？" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-rssbot-down-again/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/27/rssbot-down-again/index/" class="article-date">
  <time class="dt-published" datetime="2022-05-27T00:00:00.000Z" itemprop="datePublished">2022-05-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/what/">what</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/27/rssbot-down-again/index/">为什么我的rssbot又不好用了？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今晚想在rssbot上订阅一个博客，发现发了消息竟然没反应。心想可能是容器挂了，上去重启一下。</p>
<p><img src="/images/2022052721363834.jpeg"></p>
<p>竟然还没好，而且发现logs里有这么怪的一行</p>
<blockquote>
<p><strong>error:</strong> <strong>Error</strong>(“expected `,` or `}`“, line: 2, column: 2388),</p>
</blockquote>
<p>这啥？</p>
<p><code>rssbot.json</code> 坏了？用<code>json.load</code> 试了一下没问题</p>
<p>程序有问题？触发了一个GitHub actions，从release里下载了binary，也没问题</p>
<p>Rust的json解析有问题？弄了一个空的json文件，也还是同样报错。</p>
<p>网络问题？明明是直接在梯子上运行的。</p>
<p>容器问题？直接跑在alpine的容器里，host OS上，也不行</p>
<p><img src="/images/2022052721363814.jpeg" alt="挠头表情包_抖音熊猫挠头表情包套图下载_游戏吧"></p>
<p>Bot的token失效了？revoke重新生成一个，还不行。</p>
<p>换个其他bot的token，竟然可以了。</p>
<p><img src="/images/2022052721363947.png"></p>
<p>难道是我的rssbot 被Durov扬了？拿起来 bot HTTP api试试看</p>
<p>import telebot<br>from telebot import apihelper<br>import logging</p>
<p>logging.basicConfig(level&#x3D;logging.INFO)<br>apihelper.proxy &#x3D; {‘https’: ‘socks5h:&#x2F;&#x2F;127.0.0.1:1080’}<br>TOKEN &#x3D; “548k4qc”<br>bot &#x3D; telebot.TeleBot(TOKEN)<br>print(bot.get_me())</p>
<p>活着呢啊……</p>
<p>那是不是incoming message被扬了？</p>
<p>@bot.message_handler(commands&#x3D;[‘start’, ‘help’])<br>def send_welcome(message):<br>    bot.reply_to(message, “Howdy, how are you doing?”)</p>
<p>if __name__ &#x3D;&#x3D; ‘__main__‘:<br>    bot.polling()</p>
<p><img src="/images/2022052721364143.png"></p>
<p>也好用啊……</p>
<p>那再跑一次？竟然好了……</p>
<h2 id="推测原因"><a href="#推测原因" class="headerlink" title="推测原因"></a>推测原因</h2><p>不知道为什么莫名其妙的就好了，前前后后花了一个多小时的时间。</p>
<p>推测是，由于这个程序写的有些bug，导致没能处理用户发送的消息，然后telegram Bot API会缓存一定数量的消息，当用户开始polling时会发送updates。但是由于有bug，导致bot无法处理updates，所以所有后续的updates都被block住了。</p>
<p>当我用Python版本开始polling时，updates就被处理完成了，导致rssbot出bug的那个update也被消耗掉了。</p>
<p>🤦‍♂️算了我要切换到inoreader了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/27/rssbot-down-again/index/" data-id="clhp7rtip007vs2qr3d2lef60" data-title="为什么我的rssbot又不好用了？" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-who-view-micam/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/30/who-view-micam/index/" class="article-date">
  <time class="dt-published" datetime="2022-04-30T00:00:00.000Z" itemprop="datePublished">2022-04-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/what/">what</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/30/who-view-micam/index/">谁看了我的米家摄像头？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>一年前，由于一个有些可笑的原因（别问我为什么，真的），我买了个米家的摄像头，然后分享给了某个人。那个时候我在想，有没有办法随时知道谁看了监控呢？管他是某个人还是其他什么奇奇怪怪的人。</p>
<p>米家本身并不提供这种功能，也不像其他品牌一样在摄像头被查看的时候会有一个特殊的指示灯显示。</p>
<p>既然如此，那作为一名有灵性的工程师，一定能找到办法的！</p>
<p>简单的说，自然就要从网络上下手啦！毕竟这个东西是需要通过网络传输数据的，在其他人查看的时候一定会大量的传输数据，并且根据常识推断，极有可能是UDP，并且有可能通过UDP打洞的方式直接看到查看者的IP地址。</p>
<p>话不多说，说干就干，老子干网络这么多年，还不是 permit any any 通了就走！</p>
<h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><p>既然要抓包，那自然也就在路由器上动手脚最好了。此时需要一个刷了padavan、OpenWRT、Merlin之类第三方固件的路由器，然后准备好tcpdump</p>
<p>tcpdump可以使用opkg之类的命令安装，如果你的CPU恰巧是arm的，可以<a target="_blank" rel="noopener" href="https://fw.koolcenter.com/binary/tcpdump/">用这个</a>静态编译的。</p>
<p>假设摄像头的IP是192.168.7.149，然后路由器的网桥是br-lan（有些可能是br0）</p>
<p>tcpdump -i br-lan udp and host 192.168.7.149</p>
<p>此时打开手机，最好用流量来测试IP，查看摄像头，大概率会看到类似如下日志：</p>
<p><img src="/images/2022043021474977.png"></p>
<p>如果没有的话，去掉UDP试试看。再没有就看看接口和IP对不对，有些情况下抓对应的wlan01可能更好。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>此时右侧的那个疯狂刷屏39.xxxx就是我的手机数据流量的出口IP，中国移动的某个IP。有些时候会看到一些金山云的IP，可以直接忽略。</p>
<p>那么接下来问题来了</p>
<ol>
<li>只有刷屏的IP才算是可能的查看记录，有什么办法揪出来吗？</li>
<li>咱也不能时时刻刻盯着tcpdump的输出啊！</li>
</ol>
<h2 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h2><p>只有刷屏的IP才可能是查看记录，那么如何分析统计这个“刷屏频率”？最好的办法就是令牌桶算法啦！</p>
<p>所谓令牌桶，就是设计一个桶，某个组件持续地往里面丢令牌（token），然后每个请求进来的时候去这里拿令牌，拿到了就执行，拿不到就只能等着了。</p>
<p>令牌桶通常用于限流，我们的这个恰巧是“反着来的限流”，反正只要撞了rate limit就是我们要的数据。</p>
<p>记得先写正则表达式过滤一下。</p>
<p>为了方便在路由器上运行，这事必然是要用Go来写的，毕竟交叉编译嘛</p>
<p>package main</p>
<p>import (<br>    log “github.com&#x2F;sirupsen&#x2F;logrus”<br>    “golang.org&#x2F;x&#x2F;time&#x2F;rate”<br>)</p>
<p>const (<br>    bucketSize &#x3D; 70<br>    bucketRate &#x3D; 35<br>)</p>
<p>var limiter &#x3D; rate.NewLimiter(bucketRate, bucketSize)</p>
<p>func main() {</p>
<pre><code>if limiter.Allow() &#123;
    log.Infoln(&quot;Using token...&quot;)
&#125; else &#123;
    log.Warnln(&quot;Potential view, sending alert now...&quot;)
&#125;
</code></pre>
<p>}</p>
<p>很简单，定义了一个桶，大小是70，每秒钟产生35个令牌，说人话：每秒钟抓到35个包，刚好可以抵消令牌桶消耗；每秒抓到40个包，大概8秒会报警。至于这个35和70是怎么设计的嘛，是我从实践与经验中发现这个值最稳妥、最不容易误报。</p>
<h2 id="消息通知"><a href="#消息通知" class="headerlink" title="消息通知"></a>消息通知</h2><p>消息通知就很简单了，当 <code>limiter.Allow()</code> 不满足时，直接telegram bot就行了，这样最方便。</p>
<p>代码太过简单，就不说了</p>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>真挺准的！俗话说知己知彼，百战不殆反正我是认输了，权限也已经撤销了。因为我发现我就是“充话费送的”。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2022/04/2022043021541218.jpeg"><img src="/images/2022043021541218.jpeg"></a></p>
<p>也真的挺不好意思的我这玩意藏着掖着，快一年了才放出来……</p>
<p><img src="/images/2022043021481460.png"></p>
<h2 id="参考代码"><a href="#参考代码" class="headerlink" title="参考代码"></a>参考代码</h2><p><a target="_blank" rel="noopener" href="https://gist.github.com/BennyThink/c78cefa446fc492209710796ee342dec">https://gist.github.com/BennyThink/c78cefa446fc492209710796ee342dec</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/04/30/who-view-micam/index/" data-id="clhp7rtn600b5s2qr13ef50zq" data-title="谁看了我的米家摄像头？" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/azure/">azure</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/azure/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/china/">china</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/china/justsay/">justsay</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloudflare/">cloudflare</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/">it</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/it/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/">justsay</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/website/">website</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/program/">program</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/program/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/security/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/share/">share</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/website/">website</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/website/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/what/">what</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/what/gfw/">gfw</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">March 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">December 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/03/16/py-azure-oai-proxy/index/">使用50行Python代码实现一个Azure OpenAI Proxy</a>
          </li>
        
          <li>
            <a href="/2024/12/12/candlestick-llm/index/">使用Python 通过K线计算技术指标，并用 LLM 预测趋势</a>
          </li>
        
          <li>
            <a href="/2024/11/03/warp-http-proxy/index/">把 Cloudflare WARP 转换为 http 代理</a>
          </li>
        
          <li>
            <a href="/2024/10/12/aca-php/index/">用 Azure Container Apps 运行PHP网站</a>
          </li>
        
          <li>
            <a href="/2024/10/06/aca-vm-scale/index/">Azure Container Apps 连接到虚拟机并配置CPU自动缩放</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 Benny小土豆<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>