<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>一次找不到错误的巨坑的http header的url编码的Python 3迁移问题 | 土豆不好吃</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="起源近期，我把一个Python 2 的项目迁移到了Python 3，今早在进行最后一次测试时，发现下载的一个按钮是失效的。当时立刻就想，完蛋了，难道是遇到了跨平台的问题？那就糟糕了啊，跨平台问题都不太好处理的。 试了下原来的Python 2版本的还正常，那么就是这次迁移有点小问题了。  确定复现经过一系列绝望的瞎猫碰死耗子的尝试，发现了当要下载的文件是第三个，就会触发这个错误，抛的异常如下： [E">
<meta property="og:type" content="article">
<meta property="og:title" content="一次找不到错误的巨坑的http header的url编码的Python 3迁移问题">
<meta property="og:url" content="http://example.com/2018/04/17/python2-3-port/index/index.html">
<meta property="og:site_name" content="土豆不好吃">
<meta property="og:description" content="起源近期，我把一个Python 2 的项目迁移到了Python 3，今早在进行最后一次测试时，发现下载的一个按钮是失效的。当时立刻就想，完蛋了，难道是遇到了跨平台的问题？那就糟糕了啊，跨平台问题都不太好处理的。 试了下原来的Python 2版本的还正常，那么就是这次迁移有点小问题了。  确定复现经过一系列绝望的瞎猫碰死耗子的尝试，发现了当要下载的文件是第三个，就会触发这个错误，抛的异常如下： [E">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/201804170754535.png">
<meta property="og:image" content="http://example.com/images/201804170754546.png">
<meta property="og:image" content="http://example.com/images/2018041707545544.png">
<meta property="og:image" content="http://example.com/images/2018041707545536.png">
<meta property="og:image" content="http://example.com/images/2018041707545689.png">
<meta property="og:image" content="http://example.com/images/2018041707545712.png">
<meta property="og:image" content="http://example.com/images/2018041707545743.png">
<meta property="og:image" content="http://example.com/images/201804170754585.png">
<meta property="og:image" content="http://example.com/images/2018041707545941.png">
<meta property="og:image" content="http://example.com/images/2018041803535426.png">
<meta property="og:image" content="http://example.com/images/2018041803535177.png">
<meta property="og:image" content="http://example.com/images/2018041803535360.png">
<meta property="article:published_time" content="2018-04-17T00:00:00.000Z">
<meta property="article:modified_time" content="2023-05-15T18:16:49.945Z">
<meta property="article:author" content="Benny小土豆">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/201804170754535.png">
  
    <link rel="alternate" href="/atom.xml" title="土豆不好吃" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">土豆不好吃</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-python2-3-port/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/04/17/python2-3-port/index/" class="article-date">
  <time class="dt-published" datetime="2018-04-17T00:00:00.000Z" itemprop="datePublished">2018-04-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      一次找不到错误的巨坑的http header的url编码的Python 3迁移问题
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="起源"><a href="#起源" class="headerlink" title="起源"></a>起源</h2><p>近期，我把一个Python 2 的项目迁移到了Python 3，今早在进行最后一次测试时，发现下载的一个按钮是失效的。当时立刻就想，完蛋了，难道是遇到了跨平台的问题？那就糟糕了啊，跨平台问题都不太好处理的。</p>
<p>试了下原来的Python 2版本的还正常，那么就是这次迁移有点小问题了。</p>
<p><img src="/images/201804170754535.png"></p>
<h2 id="确定复现"><a href="#确定复现" class="headerlink" title="确定复现"></a>确定复现</h2><p>经过一系列绝望的瞎猫碰死耗子的尝试，发现了当要下载的文件是第三个，就会触发这个错误，抛的异常如下：</p>
<p>[E 180417 11:03:48 web:1590] Uncaught exception GET &#x2F;apps&#x2F;scenario_change&#x2F;page&#x2F;download?_id&#x3D;5aab8287e138235c1c9fa9ea&amp;type&#x3D;task (127.0.0.1)<br>    HTTPServerRequest(protocol&#x3D;’http’, host&#x3D;’127.0.0.1:9118’, method&#x3D;’GET’, uri&#x3D;’&#x2F;apps&#x2F;scenario_change&#x2F;page&#x2F;download?_id&#x3D;5aab8287e138235c1c9fa9ea&amp;type&#x3D;task’, version&#x3D;’HTTP&#x2F;1.1’, remote_ip&#x3D;’127.0.0.1’, headers&#x3D;{‘Host’: ‘127.0.0.1:9118’, ‘Connection’: ‘keep-alive’, ‘Upgrade-Insecure-Requests’: ‘1’, ‘User-Agent’: ‘Mozilla&#x2F;5.0 (Macintosh; U; Intel Mac OS X 10.11; rv:54.0) Gecko&#x2F;20100101 Firefox&#x2F;54.0’, ‘Accept’: ‘text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8’, ‘Dnt’: ‘1’, ‘Referer’: ‘<a target="_blank" rel="noopener" href="http://127.0.0.1:9118/apps/scenario/_change/task/_management.html">http://127.0.0.1:9118/apps/scenario\_change/task\_management.html</a>‘, ‘Accept-Encoding’: ‘gzip, deflate, br’, ‘Accept-Language’: ‘zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7’})<br>    Traceback (most recent call last):<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 1513, in _execute<br>        self.finish()<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 991, in finish<br>        self.flush(include_footers&#x3D;True)<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 947, in flush<br>        start_line, self._headers, chunk, callback&#x3D;callback)<br>      File “C:\Python36\lib\site-packages\tornado\http1connection.py”, line 381, in write_headers<br>        lines.extend(l.encode(‘latin1’) for l in header_lines)<br>      File “C:\Python36\lib\site-packages\tornado\http1connection.py”, line 381, in<br>        lines.extend(l.encode(‘latin1’) for l in header_lines)<br>    UnicodeEncodeError: ‘latin-1’ codec can’t encode characters in position 45-46: ordinal not in range(256)<br>[E 180417 11:03:48 web:1015] Cannot send error response after headers written<br>[E 180417 11:03:48 web:1025] Failed to flush partial response<br>    Traceback (most recent call last):<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 1513, in _execute<br>        self.finish()<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 991, in finish<br>        self.flush(include_footers&#x3D;True)<br>      File “C:\Python36\lib\site-packages\tornado\web.py”, line 947, in flush<br>        start_line, self._headers, chunk, callback&#x3D;callback)<br>      File “C:\Python36\lib\site-packages\tornado\http1connection.py”, line 381, in write_headers<br>        lines.extend(l.encode(‘latin1’) for l in header_lines)<br>      File “C:\Python36\lib\site-packages\tornado\http1connection.py”, line 381, in<br>        lines.extend(l.encode(‘latin1’) for l in header_lines)<br>    UnicodeEncodeError: ‘latin-1’ codec can’t encode characters in position 45-46: ordinal not in range(256)</p>
<pre><code>During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File &quot;C:\\Python36\\lib\\site-packages\\tornado\\web.py&quot;, line 1022, in send\_error
    self.finish()
  File &quot;C:\\Python36\\lib\\site-packages\\tornado\\web.py&quot;, line 992, in finish
    self.request.finish()
  File &quot;C:\\Python36\\lib\\site-packages\\tornado\\httputil.py&quot;, line 419, in finish
    self.connection.finish()
  File &quot;C:\\Python36\\lib\\site-packages\\tornado\\http1connection.py&quot;, line 448, in finish
    self.\_expected\_content\_remaining)
tornado.httputil.HTTPOutputError: Tried to write 8015 bytes less than Content-Length
</code></pre>
<h2 id="追踪异常1：白高兴"><a href="#追踪异常1：白高兴" class="headerlink" title="追踪异常1：白高兴"></a>追踪异常1：白高兴</h2><p>按照常理讲，咱代码出了异常，咱就定位到报错的最后一行（most recent call last嘛，最后一次调用），看下异常是什么知道个大概，然后跳过去，该回溯的回溯，管它是高级的打断点开debug还是低级的一顿print的，确定问题根源然后修改。</p>
<p>看一眼这个异常，<strong>Tried to write 8015 bytes less than Content-Length</strong>，看样子好像是指定了一个Content-Length但是实际上发送的文件却比这个短8015字节。莫非是迁移到3的过程中对Unicode与bytes应用了错误的<code>len()</code>导致抛异常？</p>
<p>那简单了，看一眼是不是设错了headers就好了啊，Edit - Find - Find in path，限定文件类型为py，开搜！</p>
<p><img src="/images/201804170754546.png"></p>
<p>啥？逗我呢？没有？ [v_tips] 小提示：为啥第一想法要怀疑Content-Length的长度设置错了呢？</p>
<p>很简单啦，Python 2对Unicode的实现emmm这么说吧，在Python 2里，<code>&#39;hello&#39;</code>是二进制（字节流 bytes），<code>u&#39;hello&#39;</code>才是Unicode；但是在3里呢，<code>&#39;hello&#39;</code>是Unicode，<code>b&#39;hello&#39;</code>才是二进制。唉，谁叫Python 问世（第一版发布于1991.02）的时候Unicode标准（1991.10）还没出来呢。</p>
<p>以防你们不晓得这么个大坑，看下图：</p>
<p><img src="/images/2018041707545544.png"></p>
<p>以后在有人跟你说一个汉字是两个字节，你就拿这个图怼死他：不说编码就说一个汉字是几个字节就是耍流氓，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">说了编码那也是耍流氓</a>。[&#x2F;v_tips]</p>
<h2 id="追踪异常2：找到根源"><a href="#追踪异常2：找到根源" class="headerlink" title="追踪异常2：找到根源"></a>追踪异常2：找到根源</h2><p>有点扫兴，竟然没有Content-Length，那是因为啥呢？那就继续看着报错回溯呗。扫了一眼，啥，<strong>都是tornado的错</strong>，<strong>不是我的错</strong>？难道我要怀疑编译器解释器和久负盛名的tornado……？ [v_blue] 扩展阅读：</p>
<p>《<a target="_blank" rel="noopener" href="https://v2mm.tech/topic/830/%E5%A4%A7%E5%AE%B6%E6%9C%89%E4%BB%80%E4%B9%88%E5%86%99%E4%BB%A3%E7%A0%81%E5%86%99%E5%88%B0%E6%80%80%E7%96%91%E4%BA%BA%E7%94%9F-%E6%80%80%E7%96%91%E7%BC%96%E8%AF%91%E5%99%A8%E8%A7%A3%E9%87%8A%E5%99%A8%E7%9A%84%E7%BB%8F%E5%8E%86%E5%90%97">大家有什么写代码写到怀疑人生、怀疑编译器解释器的经历吗</a>》</p>
<p>cookies的时间戳，C语言标准for循环<code>for(int i=0;i++;i&lt;10)</code>，mian，ture，全角符号，以及<code>&lt;link href</code>……[&#x2F;v_blue]</p>
<p>又仔细看了一眼，发现这么一段话：<strong>During handling of the above exception, another exception occurred</strong>:</p>
<p>处理上面这个异常的时候，又来了个这么异常。</p>
<p>啊原来我刚刚看的是后来的异常啊，那我得看第一个异常的尾巴：</p>
<p><strong>UnicodeEncodeError: ‘latin-1’ codec can’t encode characters in position 45-46: ordinal not in range(256)</strong></p>
<p>多少年了，无数的Python程序员都曾经被UnicodeEncodeError与UnicodeDecodeError坑的说不出话来。</p>
<p>可是依旧没有我的代码啊。</p>
<p>终于，通过搜索.txt（下载的文件的扩展名）我成功找到了这一行：</p>
<p>file_name &#x3D; response[‘data’][0][‘task_name’] + ‘.txt’</p>
<p>看来是这句话负责生成文件名的，找到这句的函数定义，继续找调用者，叮咚！</p>
<p>一看函数名叫download，看样子下图这里就是该排错的地方</p>
<p><img src="/images/2018041707545536.png"></p>
<h2 id="解决异常1：瞎比划"><a href="#解决异常1：瞎比划" class="headerlink" title="解决异常1：瞎比划"></a>解决异常1：瞎比划</h2><h3 id="加个Content-Length"><a href="#加个Content-Length" class="headerlink" title="加个Content-Length"></a>加个Content-Length</h3><p>大致看了眼，好像没啥问题。要不在这里加上个Content-Length试试？</p>
<p>self.set_header(“Content-Length”, len(file_content.encode(‘utf-8’)))</p>
<p><img src="/images/2018041707545689.png"></p>
<p>我的基础还是很牢固的，没算错，一点问题都没有，肯定没错啊。但是<strong>Tried to write 8015 bytes less than Content-Length</strong>这个异常还是抛了。</p>
<h3 id="数据类型错了"><a href="#数据类型错了" class="headerlink" title="数据类型错了"></a>数据类型错了</h3><p>也许是数据类型错了？说不定<code>file_name</code>, <code>file_content</code>需要字节流而不是字符串呢？这好像有点接近Unicode错误了。简单的<code>encode(&#39;utf-8&#39;)</code>一下，当然还是继续错啦。</p>
<h3 id="也许是因为header的事情"><a href="#也许是因为header的事情" class="headerlink" title="也许是因为header的事情"></a>也许是因为header的事情</h3><p>那就把header都注释了看看。于是在浏览器里打开了文件……</p>
<p><img src="/images/2018041707545712.png"></p>
<p>那我只留Content-Type</p>
<p><img src="/images/2018041707545743.png"></p>
<p>噗(&#x2F;≧▽≦)&#x2F;我的文件名呢，内容是正确的。</p>
<p>啊，原来是靠的Content-Disposition这个响应头来强制浏览器下载文件，指定文件名什么的啊……</p>
<h2 id="解决异常2：确定问题"><a href="#解决异常2：确定问题" class="headerlink" title="解决异常2：确定问题"></a>解决异常2：确定问题</h2><p>终于，我确定了出错的代码在这一行</p>
<p>self.set_header(“Content-Disposition”, “attachment; filename&#x3D;%s” % file_name)</p>
<p>看样子是文件名。那就把filename替换成硬编码的<code>test.txt</code>，正常下载；再换成<code>tes啊t.txt</code>，一模一样的报错。</p>
<p>于是我果断的搜索了Content-Disposition encoding以及Content-Disposition 编码，看到<a target="_blank" rel="noopener" href="https://blog.robotshell.org/2012/deal-with-http-header-encoding-for-file-download/">这么一篇说得还挺有道理的文章</a>：</p>
<p>Content-Disposition: attachment;filename&#x3D;”$encoded_fname”;<br>filename*&#x3D;utf-8’’$encoded_fname</p>
<p>当然了我没看到下面那句话（<strong>读书要读全啊</strong>），直接套上了</p>
<p>self.set_header(“Content-Disposition”, “attachment; filename*&#x3D;utf-8’’%s” % file_name)</p>
<p>当然继续报错啦。还是<code>file_name</code>数据类型不对？encode成UTF-8？差点用上decode（字符串怎么可能再decode嘛？必然要报错的）</p>
<p><img src="/images/201804170754585.png"></p>
<p>噗，这倒真是<code>tes的t.txt</code>这个字符串的UTF-8编码。</p>
<p>这就纠结了，难道我要把文件名搞成什么ASCII的？比如干脆是几个真伪随机数吧？</p>
<h2 id="解决异常3：解决"><a href="#解决异常3：解决" class="headerlink" title="解决异常3：解决"></a>解决异常3：解决</h2><p>然后又找到了这么一篇<a target="_blank" rel="noopener" href="http://lgbolgger.iteye.com/blog/2108396">例子丰富的文章</a>，看到一半突然想起了，既然要给任意文字编码成ASCII字符集内的，那就用base64啊，但是浏览器又不懂base64没办法给还原回来啊……</p>
<p>唉？？不是有个东西叫URL编码吗？迅速翻了翻例子丰富的文章，还真提了一句……</p>
<p>from urllib.parse import quote<br>self.set_header(“Content-Disposition”, “attachment; filename&#x3D;%s” % quote(‘tes的t.txt’))</p>
<p><img src="/images/2018041707545941.png"></p>
<p>我爱emoji，emoji也爱我。???典型的傲娇受。</p>
<p>??? ??? ??? ??? ??? ??? ???</p>
<p>其实<a target="_blank" rel="noopener" href="https://blog.robotshell.org/2012/deal-with-http-header-encoding-for-file-download/">第一篇文章</a>提了一句的：其中， <code>$encoded_fname</code>指的是将 UTF-8 编码的原始文件名按照 RFC 3986 进行百分号编码（percent encoding）后得到的。</p>
<p>百分号编码就是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E7%99%BE%E5%88%86%E5%8F%B7%E7%BC%96%E7%A0%81">URL编码</a>啦……</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个小问题其实隐藏的还是很深的，而且奇特的是在Python 2没有问题但是到了3就冒出来了。</p>
<p>光看报错基本上没什么线索，只能靠对业务的熟悉摸索找到对应的代码，仔细排查最终确定导致出错的代码……然后解决之。</p>
<p>就我这水平啊，还是别怀疑编译器解释器，也别怀疑久负盛名的库了，绝对是我错了。</p>
<blockquote>
<p>You tell me I’m wrong, then you’d better prove you’re right. ——M.J.</p>
</blockquote>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>经过一小段时间的阅读源代码，在tornado源代码中发现了问题的根源。跟着我的节奏走！先看下抓包的结果吧：</p>
<p>Python 2未编码 <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2018/04/2018041803535426.png"><img src="/images/2018041803535426.png"></a></p>
<p>Python 2 URL编码 <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2018/04/2018041803535177.png"><img src="/images/2018041803535177.png"></a></p>
<p>Python 3 URL编码 <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2018/04/2018041803535360.png"><img src="/images/2018041803535360.png"></a></p>
<p>我们知道问题是由set_header引起的，所以看一下set_header的源代码：</p>
<p>def set_header(self, name, value):<br>        # type: (str, _HeaderTypes) -&gt; None<br>        “””Sets the given response header name and value.</p>
<pre><code>    If a datetime is given, we automatically format it according to the
    HTTP specification. If the value is not a string, we convert it to
    a string. All header values are then encoded as UTF-8.
    &quot;&quot;&quot;
    self.\_headers\[name\] = self.\_convert\_header\_value(value)
</code></pre>
<p>非常清楚的看到调用了一个<code>_convert_header_value()</code>，继续追溯</p>
<pre><code>def \_convert\_header\_value(self, value):
    # type: (\_HeaderTypes) -&gt; str

    # Convert the input value to a str. This type check is a bit
    # subtle: The bytes case only executes on python 3, and the
    # unicode case only executes on python 2, because the other
    # cases are covered by the first match for str.
    if isinstance(value, str):
        retval = value
    elif isinstance(value, bytes):  # py3
        # Non-ascii characters in headers are not well supported,
        # but if you pass bytes, use latin1 so they pass through as-is.
        retval = value.decode(&#39;latin1&#39;)
    elif isinstance(value, unicode\_type):  # py2
        # TODO: This is inconsistent with the use of latin1 above,
        # but it&#39;s been that way for a long time. Should it change?
        retval = escape.utf8(value)
    elif isinstance(value, numbers.Integral):
        # return immediately since we know the converted value will be safe
        return str(value)
    elif isinstance(value, datetime.datetime):
        return httputil.format\_timestamp(value)
    else:
        raise TypeError(&quot;Unsupported header value %r&quot; % value)
    # If \\n is allowed into the header, it is possible to inject
    # additional headers or split the request.
    if RequestHandler.\_INVALID\_HEADER\_CHAR\_RE.search(retval):
        raise ValueError(&quot;Unsafe header value %r&quot;, retval)
    return retval
</code></pre>
<p>这段代码有点冗长，但实际上只做了一件事情，将传递过来的value转换为字符串，更进一步，在Python 2中，如果传过来的是<code>&#39;hello&#39;</code>，那么直接返回；如果类型是<code>u&#39;hello&#39;</code>, 那么<code>escape.utf8(value)</code>。在Python 3中如果是<code>&#39;hello&#39;</code>那么直接返回，如果是<code>&#39;hello你&#39;.encode(&#39;utf-8&#39;)</code>，那么用latin1解码。</p>
<p>最终这段代码会保证返回的类型是对应Python 2&#x2F;3的str类型。</p>
<p>但其实这段代码并没有什么错，不过确实写的有点难懂。 之后继续追溯到<code>write_headers()</code>，在http1connection.py的第380行左右：</p>
<p>if PY3:<br>            lines.extend(l.encode(‘latin1’) for l in header_lines)<br>        else:<br>            lines.extend(header_lines)</p>
<p>其中header_lines是一个生成器对象，包含了所有的headers，其类型为str（对应2&#x2F;3的类型） 那么错误就显然易见了，在Python 3中对<code>&#39;hello&#39;.encode(&#39;latin1&#39;)</code>是没有任何问题的，但是<code>&#39;hello和&#39;.encode(&#39;latin1&#39;)</code>肯定会报UnicodeEncodeError啊，这也印证了我最开始发现的编码错误。</p>
<p>但是在Python 2，直接就走了下面extend进去了，自然也没问题了。 但是如果我们调用set_header时传递的参数是<code>&#39;hell你&#39;.encode(&#39;utf-8&#39;)</code>，那么在<code>_convert_header_value</code>中会被用latin1解码，在这里又使用latin1编码，又回到了utf-8编码之后的形态，所以自然会出现对应文件名的UTF-8编码，也印证了上面下载出来的乱码文件。</p>
<p>所以，如果要修复这个问题，要么我们保证只传递过来ASCII的文件名（进行URL编码），这样用latin1编码就不会错了。要么直接把这俩latin1改成utf-8。</p>
<p>不过根据<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7230#section-3.2.4">RFC7230 section 3.2.4</a>:</p>
<blockquote>
<p>Historically, HTTP has allowed field content with text in the ISO-8859-1 charset [ISO-8859-1], supporting other charsets only through use of [RFC2047] encoding. In practice, most HTTP header field values use only a subset of the US-ASCII charset [USASCII]. Newly defined header fields SHOULD limit their field values to US-ASCII octets. A recipient SHOULD treat other octets in field content (obs-text) as opaque data.</p>
</blockquote>
<p>这么做其实是有悖标准的，但是Python 2的版本直接不管不顾发出去了啊，实际上Python 2版本的应该拒绝这种headers的。我也很纠结，我也觉得没办法啊。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/04/17/python2-3-port/index/" data-id="clhp7rtie0073s2qrhi226brl" data-title="一次找不到错误的巨坑的http header的url编码的Python 3迁移问题" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/04/22/hopeless-future/index/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          看不到希望的未来
        
      </div>
    </a>
  
  
    <a href="/2018/04/13/python-longpoll-db/index/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Python长期连接数据库的最不佳实践：Lost connection to MySQL server during query</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/azure/">azure</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/azure/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/china/">china</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/china/justsay/">justsay</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloudflare/">cloudflare</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/">it</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/it/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/">justsay</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/website/">website</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/program/">program</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/program/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/security/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/share/">share</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/website/">website</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/website/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/what/">what</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/what/gfw/">gfw</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">March 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">December 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/03/16/py-azure-oai-proxy/index/">使用50行Python代码实现一个Azure OpenAI Proxy</a>
          </li>
        
          <li>
            <a href="/2024/12/12/candlestick-llm/index/">使用Python 通过K线计算技术指标，并用 LLM 预测趋势</a>
          </li>
        
          <li>
            <a href="/2024/11/03/warp-http-proxy/index/">把 Cloudflare WARP 转换为 http 代理</a>
          </li>
        
          <li>
            <a href="/2024/10/12/aca-php/index/">用 Azure Container Apps 运行PHP网站</a>
          </li>
        
          <li>
            <a href="/2024/10/06/aca-vm-scale/index/">Azure Container Apps 连接到虚拟机并配置CPU自动缩放</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 Benny小土豆<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>