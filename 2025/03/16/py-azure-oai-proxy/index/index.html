<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>ä½¿ç”¨50è¡ŒPythonä»£ç å®ç°ä¸€ä¸ªAzure OpenAI Proxy | åœŸè±†ä¸å¥½åƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="[v_error]ä¸è¦ä½¿ç”¨ blacksheepï¼Œå¦åˆ™ä½ çš„äººç”Ÿä¼šå˜å¾—ä¸å¹¸[&#x2F;v_error] Azure OpenAIå’ŒOpenAIæä¾›çš„æœåŠ¡åŸºæœ¬ä¸€è‡´çš„ï¼Œé™¤äº†äº†Azure æ›´æ–°ä¼šæ…¢ä¸€ç‚¹ä¹‹å¤–ï¼Œæœ€å¤§çš„åŒºåˆ«æ˜¯è¯·æ±‚è·¯å¾„ä¸åŒã€‚ å¯¹äºAzureè€Œè¨€ï¼Œéœ€è¦å»Azure AI Foundry é‡Œåˆ›å»ºéƒ¨ç½²  éƒ¨ç½²åç§°å°±æ˜¯è¯·æ±‚æ—¶çš„URLå‚æ•°çš„ä¸€éƒ¨åˆ†ï¼Œä¸¾ä¾‹å¦‚ä¸‹ https:&#x2F;&#x2F;xxx.openai.azure">
<meta property="og:type" content="article">
<meta property="og:title" content="ä½¿ç”¨50è¡ŒPythonä»£ç å®ç°ä¸€ä¸ªAzure OpenAI Proxy">
<meta property="og:url" content="http://example.com/2025/03/16/py-azure-oai-proxy/index/index.html">
<meta property="og:site_name" content="åœŸè±†ä¸å¥½åƒ">
<meta property="og:description" content="[v_error]ä¸è¦ä½¿ç”¨ blacksheepï¼Œå¦åˆ™ä½ çš„äººç”Ÿä¼šå˜å¾—ä¸å¹¸[&#x2F;v_error] Azure OpenAIå’ŒOpenAIæä¾›çš„æœåŠ¡åŸºæœ¬ä¸€è‡´çš„ï¼Œé™¤äº†äº†Azure æ›´æ–°ä¼šæ…¢ä¸€ç‚¹ä¹‹å¤–ï¼Œæœ€å¤§çš„åŒºåˆ«æ˜¯è¯·æ±‚è·¯å¾„ä¸åŒã€‚ å¯¹äºAzureè€Œè¨€ï¼Œéœ€è¦å»Azure AI Foundry é‡Œåˆ›å»ºéƒ¨ç½²  éƒ¨ç½²åç§°å°±æ˜¯è¯·æ±‚æ—¶çš„URLå‚æ•°çš„ä¸€éƒ¨åˆ†ï¼Œä¸¾ä¾‹å¦‚ä¸‹ https:&#x2F;&#x2F;xxx.openai.azure">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/202503161933463.png">
<meta property="og:image" content="http://example.com/images/2025031619334840.png">
<meta property="og:image" content="http://example.com/images/2025031619334875.png">
<meta property="og:image" content="http://example.com/images/2025031619334993.png">
<meta property="og:image" content="http://example.com/images/202503161933491.png">
<meta property="og:image" content="http://example.com/images/2025031619335077.png">
<meta property="article:published_time" content="2025-03-16T00:00:00.000Z">
<meta property="article:modified_time" content="2025-03-16T22:37:10.251Z">
<meta property="article:author" content="Bennyå°åœŸè±†">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/202503161933463.png">
  
    <link rel="alternate" href="/atom.xml" title="åœŸè±†ä¸å¥½åƒ" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">åœŸè±†ä¸å¥½åƒ</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-py-azure-oai-proxy/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/16/py-azure-oai-proxy/index/" class="article-date">
  <time class="dt-published" datetime="2025-03-16T00:00:00.000Z" itemprop="datePublished">2025-03-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/azure/">azure</a>â–º<a class="article-category-link" href="/categories/azure/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      ä½¿ç”¨50è¡ŒPythonä»£ç å®ç°ä¸€ä¸ªAzure OpenAI Proxy
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[v_error]ä¸è¦ä½¿ç”¨ blacksheepï¼Œå¦åˆ™ä½ çš„äººç”Ÿä¼šå˜å¾—ä¸å¹¸[&#x2F;v_error]</p>
<p>Azure OpenAIå’ŒOpenAIæä¾›çš„æœåŠ¡åŸºæœ¬ä¸€è‡´çš„ï¼Œé™¤äº†äº†Azure æ›´æ–°ä¼šæ…¢ä¸€ç‚¹ä¹‹å¤–ï¼Œæœ€å¤§çš„åŒºåˆ«æ˜¯è¯·æ±‚è·¯å¾„ä¸åŒã€‚</p>
<p>å¯¹äºAzureè€Œè¨€ï¼Œéœ€è¦å»Azure AI Foundry é‡Œåˆ›å»ºéƒ¨ç½²</p>
<p><img src="/images/202503161933463.png" alt="å›¾å½¢ç”¨æˆ·ç•Œé¢, åº”ç”¨ç¨‹åº, Teams AI ç”Ÿæˆçš„å†…å®¹å¯èƒ½ä¸æ­£ç¡®ã€‚"></p>
<p>éƒ¨ç½²åç§°å°±æ˜¯è¯·æ±‚æ—¶çš„URLå‚æ•°çš„ä¸€éƒ¨åˆ†ï¼Œä¸¾ä¾‹å¦‚ä¸‹</p>
<p><a target="_blank" rel="noopener" href="https://xxx.openai.azure.com/openai/deployments/%7Byour/_deployment/_name%7D/chat/completions?api-version=2024-12-01-preview">https://xxx.openai.azure.com/openai/deployments/{your\_deployment\_name}/chat/completions?api-version=2024-12-01-preview</a></p>
<p><code>api-version</code> éœ€è¦æ ¹æ®ä¸ªäººæƒ…å†µé€‰æ‹©ï¼Œæ–°ç‰ˆæœ¬çš„åŒ…å«æ›´å¤šçš„åŠŸèƒ½ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜å°±ç®€å•äº†ï¼Œå¦‚æœè¦åšä»£ç†è½¬å‘ï¼Œéœ€è¦åšçš„äº‹æƒ…å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ¨¡å‹åç§°ï¼ˆå¦‚gpt-4-miniï¼‰å’Œéƒ¨ç½²åç§°çš„æ˜ å°„è¡¨ï¼Œå†™ä¸€ä¸ªç®€å•çš„ç¨‹åºè¯»å–bodyï¼Œç„¶ååŠ¨æ€æ‹¼æ¥ä¸ºæ­£ç¡®çš„URLï¼Œç„¶åè¯·æ±‚è¿”å›å³å¯ã€‚</p>
<p>å¦‚æœä½ ä¼šå†™luaï¼Œé‚£ä¹ˆç›´æ¥æ­é…ä¸‹openrestyå°±å¯ä»¥äº†ã€‚ç„¶è€Œâ€¦â€¦</p>
<h2 id="é€‰æ‹©Webæ¡†æ¶"><a href="#é€‰æ‹©Webæ¡†æ¶" class="headerlink" title="é€‰æ‹©Webæ¡†æ¶"></a>é€‰æ‹©Webæ¡†æ¶</h2><p>ä¸ºäº†å›¾ç®€å•ï¼Œè¯­è¨€å°±é€‰Pythonå§ã€‚åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://klen.github.io/py-frameworks-bench/">Python Web frameworkçš„æ€§èƒ½å¯¹æ¯”å›¾</a>ï¼Œè¿˜æœ‰ä¸€ä¸ª[æ¯”è¾ƒæ–°çš„å¯¹æ¯”å›¾](<a target="_blank" rel="noopener" href="https://www.techempower.com/benchmarks/">https://www.techempower.com/benchmarks/</a>â€œ \l â€œhw&#x3D;ph&amp;test&#x3D;composite&amp;section&#x3D;data-r23&amp;l&#x3D;zijzen-cn3)</p>
<p><img src="/images/2025031619334840.png" alt="å›¾ç‰‡åŒ…å« å›¾æ ‡ AI ç”Ÿæˆçš„å†…å®¹å¯èƒ½ä¸æ­£ç¡®ã€‚"></p>
<p>[v_blue]å¯æƒœtornadoå·²ç»å»‰é¢‡è€çŸ£äº†ï¼Œåœ¨æ²¡æœ‰asyncioçš„é‚£ä¸ªæ—¶ä»£ï¼Œtornadoæ˜¯ç‹è€…ğŸ¥²[&#x2F;v_blue]</p>
<p>ä¿¡æˆ‘çš„ï¼Œä¸è¦é€‰æ‹©blacksheepï¼ˆåé¢ä¼šè®²ï¼‰ã€‚è¿™æ¬¡æˆ‘ä»¬å°±é€‰æ‹©ç¬¬äºŒåçš„sanicï¼Œæ–‡æ¡£å¾ˆå¥½ï¼Œè¯­æ³•å¾ˆåƒflaskï¼ŒåŸç”Ÿæ”¯æŒasyncioï¼Œæ˜Ÿæ ‡ä¹Ÿå¾ˆå¤š</p>
<h2 id="éæµå®ç°"><a href="#éæµå®ç°" class="headerlink" title="éæµå®ç°"></a>éæµå®ç°</h2><p>éæµå¼å“åº”ç›´æ¥ç”¨httpxå‘è¯·æ±‚ï¼Œç„¶åè¿”å›å°±è¡Œäº†ï¼Œéå¸¸ç®€å•ï¼Œè®°å¾—è·Ÿç€æŠŠçŠ¶æ€ç ä¹Ÿè®¾ç½®äº†</p>
<p>ä»£ç å¦‚ä¸‹ï¼Œéå¸¸ç®€å•ï¼Œåº”è¯¥ä¸ç”¨è§£é‡Šå°±èƒ½çœ‹æ‡‚</p>
<p>import os</p>
<p>import httpx<br>from sanic import Sanic<br>from sanic import json as json_response<br>from sanic.request import Request</p>
<p>client &#x3D; httpx.AsyncClient(<br>    http2&#x3D;True,<br>    timeout&#x3D;httpx.Timeout(<br>        connect&#x3D;15.0,<br>        read&#x3D;300.0,<br>        write&#x3D;300.0,<br>        pool&#x3D;10.0,<br>    ),<br>)</p>
<p>app &#x3D; Sanic(__name__)</p>
<p>url &#x3D; os.getenv(â€œURLâ€)<br>api_key &#x3D; os.getenv(â€œAPI_KEYâ€)</p>
<p>@app.route(â€œ&#x2F;v1&#x2F;chat&#x2F;completionsâ€, methods&#x3D;[â€œPOSTâ€])<br>async def chat_completions(request: Request):<br>    body &#x3D; request.json<br>    if body.get(â€œstreamâ€):<br>        pass<br>    else:<br>        return await non_stream(body)</p>
<p>async def non_stream(body):<br>    response &#x3D; await client.post(url, json&#x3D;body, headers&#x3D;{â€œapi-keyâ€: api_key})<br>    return json_response(response.json(), status&#x3D;response.status_code)</p>
<p>if __name__ &#x3D;&#x3D; â€œ__main__â€œ:<br>    app.run(host&#x3D;â€127.0.0.1â€, port&#x3D;8000, debug&#x3D;True, dev&#x3D;True, auto_reload&#x3D;True)</p>
<h2 id="æµå¼å®ç°"><a href="#æµå¼å®ç°" class="headerlink" title="æµå¼å®ç°"></a>æµå¼å®ç°</h2><p>Sanicçš„æµå¼ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ httpxçš„<code>stream</code>å°±å¯ä»¥ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¯·æ±‚å‚æ•°é”™è¯¯ï¼Œé‚£ä¹ˆAzureä¼šç»™è¿”å›400ç±»é”™è¯¯ï¼Œæ­¤æ—¶ä¸èƒ½è¿”å›SSEï¼Œè€Œä¸”æ™®é€šçš„jsonã€‚è¿™é‡Œå¯ä»¥é€šè¿‡<code>response.aread()</code> æ¥è¯»å–å“åº”ä½“ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ä»£ç å¤§æ¦‚é•¿è¿™æ ·</p>
<p>async with client.stream(â€œPOSTâ€, url, json&#x3D;body, headers&#x3D;{â€œapi-keyâ€: api_key}) as response:<br>    if response.status_code !&#x3D; 200:<br>        error &#x3D; await response.aread()<br>        # ç”±äº aread() ç›´æ¥è¿”å›äº†bytesï¼Œæ‰€ä»¥å°±ç”¨rawæ–¹æ³•è¿”å›ï¼Œè®¾ç½®content-typeä¸ºapplication jsonï¼Œæ²¡å¿…è¦åœ¨ååºåˆ—åŒ–ä¸€æ¬¡ç”¨jsonè¿”å›<br>        return raw(error, content_type&#x3D;â€application&#x2F;jsonâ€, status&#x3D;response.status_code)</p>
<p>å¦‚æœè¯·æ±‚æ­£å¸¸å¼€å§‹è¿”å›ï¼Œé‚£ä¹ˆå°±å…ˆè®¾ç½®è®¾ç½®<code>content-type</code></p>
<p>server &#x3D; await request.respond(content_type&#x3D;â€text&#x2F;event-streamâ€)</p>
<p>ç„¶åå»è¿­ä»£</p>
<p>async for chunk in response.aiter_text():<br>    await server.send(chunk)</p>
<p><img src="/images/2025031619334875.png" alt="å›¾å½¢ç”¨æˆ·ç•Œé¢, æ–‡æœ¬, åº”ç”¨ç¨‹åº, ç”µå­é‚®ä»¶ AI ç”Ÿæˆçš„å†…å®¹å¯èƒ½ä¸æ­£ç¡®ã€‚"></p>
<p>æ­å–œä½ ï¼Œç”¨50è¡Œä»£ç å®ç°äº†ä»£ç†æœåŠ¡ï¼è‡³äº text-embedding è¿™ç§æ ¹æœ¬ä¸æ”¯æŒæµå¼çš„æ¨¡å‹ï¼Œç”šè‡³å¯ä»¥å†™ä¸€ä¸ªé€šç”¨çš„å‡½æ•°ï¼Œåæ­£å°±æ˜¯åŸæ ·å‘é€ã€åŸæ ·è¿”å›</p>
<h2 id="è¿›ä¸€æ­¥â€¦â€¦"><a href="#è¿›ä¸€æ­¥â€¦â€¦" class="headerlink" title="è¿›ä¸€æ­¥â€¦â€¦"></a>è¿›ä¸€æ­¥â€¦â€¦</h2><p>å½“ç„¶ï¼Œ ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›ä¸€æ­¥æ‰©å±•ã€‚æ¯”å¦‚è¯´â€¦â€¦</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªyamlé…ç½®æ–‡ä»¶ï¼Œé…ç½®Azure OpenAIåŒºåŸŸ</li>
<li>é…ç½®å¥½deploymentå’ŒOpenAI modelåå­—çš„æ˜ å°„è¡¨</li>
<li>åŠ ä¸Šæƒé‡</li>
<li>æ ¹æ®ä¸€å®šçš„ç®—æ³•ï¼Œå¦‚è½®è¯¢ï¼ŒåŠ æƒè½®è¯¢ï¼Œæœ€å°‘ä½¿ç”¨ç­‰é€‰æ‹©æœ€ä½³åŒºåŸŸ</li>
<li>è¿‡æ»¤å“åº”å†…å®¹ä¸­çš„å­—æ®µï¼ˆæ¯”å¦‚<code>content_filter_results</code> ä¹‹ç±»çš„ï¼‰</li>
<li>å†…å®¹å®¡æŸ¥</li>
</ul>
<p>ç”¨Pythonæ“ä½œjsonå¯æ¯”ç”¨Goæ–¹ä¾¿å¤šäº†ï¼ä¸ç”¨ä¸¤çœ¼ä¸€å‘é»‘çš„å†™typeçœŸçš„æ˜¯å¤ªå¹¸ç¦äº†ï¼</p>
<p>å…·ä½“æ“ä½œç©ºé—´ï¼Œé‚£ç•™ç»™è‡ªå·±æƒ³è±¡å•¦ï¼</p>
<h2 id="ä¸ºä»€ä¹ˆä¸è¦ä½¿ç”¨-blacksheep"><a href="#ä¸ºä»€ä¹ˆä¸è¦ä½¿ç”¨-blacksheep" class="headerlink" title="ä¸ºä»€ä¹ˆä¸è¦ä½¿ç”¨ blacksheep"></a>ä¸ºä»€ä¹ˆä¸è¦ä½¿ç”¨ blacksheep</h2><p>æœ€å¼€å§‹æˆ‘é€‰æ‹©äº†blacksheepï¼Œå› ä¸ºè¿™ä¸ªæœ€å¿«å˜›ï¼Œæ–‡æ¡£çœ‹èµ·æ¥ä¹Ÿä¸é”™ã€‚</p>
<p>åæ¥å‘ç°è¸©äº†å¾ˆå¤šå‘ï¼Œç›´æ¥æ•´ä¸ªä¸€å¤©æ—¶é—´æ²¡äº†ğŸ« â€¦â€¦</p>
<h3 id="SSEçš„åºåˆ—åŒ–"><a href="#SSEçš„åºåˆ—åŒ–" class="headerlink" title="SSEçš„åºåˆ—åŒ–"></a>SSEçš„åºåˆ—åŒ–</h3><p>Blacksheepç”¨SSEæ˜¯è¿™æ ·å­æ»´ï¼š</p>
<p>import asyncio<br>from collections.abc import AsyncIterable</p>
<p>from blacksheep import Application, get<br>from blacksheep.server.sse import ServerSentEvent, ServerSentEventsResponse</p>
<p>app &#x3D; Application()</p>
<h1 id="An-AsyncGenerator-yielding-ServerSentEventâ€¦"><a href="#An-AsyncGenerator-yielding-ServerSentEventâ€¦" class="headerlink" title="An AsyncGenerator yielding ServerSentEventâ€¦"></a>An AsyncGenerator yielding ServerSentEventâ€¦</h1><p>async def events_provider() -&gt; AsyncIterable[ServerSentEvent]:<br>    for i in range(3):<br>        yield ServerSentEvent({â€œmessageâ€: fâ€Hello World {i}â€})<br>        await asyncio.sleep(1)</p>
<h1 id="A-request-handler-returning-a-streaming-response-bound-to-the-generatorâ€¦"><a href="#A-request-handler-returning-a-streaming-response-bound-to-the-generatorâ€¦" class="headerlink" title="A request handler returning a streaming response bound to the generatorâ€¦"></a>A request handler returning a streaming response bound to the generatorâ€¦</h1><p>@get(â€œ&#x2F;eventsâ€)<br>def events_handler():<br>    return ServerSentEventsResponse(events_provider)</p>
<p><code>ServerSentEvent</code> ä¼šè‡ªåŠ¨jsonåºåˆ—åŒ–ä½ çš„ä¼ å…¥çš„å‚æ•°ï¼Œæ­£å¸¸OpenAIæœ€åä¸€ä¸ªå“åº”æ˜¯<code>[DONE]</code></p>
<p><img src="/images/2025031619334993.png" alt="å›¾å½¢ç”¨æˆ·ç•Œé¢, åº”ç”¨ç¨‹åº AI ç”Ÿæˆçš„å†…å®¹å¯èƒ½ä¸æ­£ç¡®ã€‚"></p>
<p>ç„¶è€Œç”¨å®ƒä½ å‘ç°â€¦â€¦ä½ æ°¸è¿œæ— æ³•æ­£ç¡®è¿”å› <code>[DONE]</code>ï¼Œæ¯”å¦‚</p>
<p>yield ServerSentEvent(â€œ[DONE]â€œ)<br>yield ServerSentEvent([â€œDONEâ€])</p>
<p>ä½ ä¼šå‘ç°è¿™å¼•å·æ˜¯æ€ä¹ˆå›äº‹ğŸ¤¡</p>
<p><img src="/images/202503161933491.png" alt="å›¾å½¢ç”¨æˆ·ç•Œé¢, æ–‡æœ¬, åº”ç”¨ç¨‹åº, ç”µå­é‚®ä»¶ AI ç”Ÿæˆçš„å†…å®¹å¯èƒ½ä¸æ­£ç¡®ã€‚"></p>
<p>è§£å†³æ–¹æ¡ˆæ˜¯<a target="_blank" rel="noopener" href="https://github.com/Neoteroi/BlackSheep/issues/484">è‡ªå®šä¹‰ä»–çš„json dumps</a>ï¼Œç¡¬ç¼–ç ä¸€ä¸‹ï¼Œå¦‚æœæ˜¯<code>[DONE]</code>çš„æ—¶å€™ç›´æ¥è¿”å›</p>
<p>from blacksheep.settings.json import default_json_dumps, json_settings</p>
<p>def custom_dumps(value):<br>    if value &#x3D;&#x3D; â€œ[DONE]â€œ:<br>        return value<br>    else:<br>        return default_json_dumps(value)</p>
<p>json_settings.use(dumps&#x3D;custom_dumps)</p>
<h3 id="å¼‚æ­¥ç”Ÿæˆå™¨é”æ­»"><a href="#å¼‚æ­¥ç”Ÿæˆå™¨é”æ­»" class="headerlink" title="å¼‚æ­¥ç”Ÿæˆå™¨é”æ­»"></a>å¼‚æ­¥ç”Ÿæˆå™¨é”æ­»</h3><p>Blacksheepæ˜¯ä½¿ç”¨çš„å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œçœ‹<code>yield</code>å’Œ<code>async</code>å°±çŸ¥é“ã€‚ä½†æ˜¯åœ¨æµå¼è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœazureè¿”å›äº†é”™è¯¯jsonï¼Œæˆ‘ä»¬ä¹Ÿè¦è¿”å›é”™è¯¯jsonç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸æ˜¯è¿”å›SSEã€‚</p>
<p>ç„¶è€Œâ€¦â€¦ä¸€æ—¦ä½ ç”¨äº†yield+asyncï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°äº†ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>return</code>ç»“æŸç”Ÿæˆå™¨ï¼Œä½†æ˜¯å´ä¸èƒ½ä½¿ç”¨ <code>return 123</code>è¿™æ ·çš„è¡¨è¾¾å¼ã€‚</p>
<p>æ‰€ä»¥è¯•å›¾åœ¨ <code>as response</code>ååˆ¤æ–­çŠ¶æ€ç ï¼Œç„¶åè¯•å›¾è¿”å›ä¸€ä¸ªjsonçš„æ“ä½œï¼Œæ¯”å¦‚</p>
<p>return json({â€œmessageâ€: â€œHello, World!â€})</p>
<p>éƒ½æ˜¯ä¸è¡Œæ»´ï¼</p>
<p><img src="/images/2025031619335077.png" alt="å›¾å½¢ç”¨æˆ·ç•Œé¢, æ–‡æœ¬ AI ç”Ÿæˆçš„å†…å®¹å¯èƒ½ä¸æ­£ç¡®ã€‚"></p>
<h3 id="SSEé”æ­»"><a href="#SSEé”æ­»" class="headerlink" title="SSEé”æ­»"></a>SSEé”æ­»</h3><p>å®é™…ä¸Šï¼Œå½“ä½ è·¯ç”±ä¸­è°ƒç”¨<code>return ServerSentEventsResponse(events_provider)</code>åï¼Œæ•´ä¸ªè¯·æ±‚åªå¯èƒ½ä»¥SSEçš„æ ¼å¼è¿”å›äº†ğŸ« </p>
<p>èªæ˜çš„ä½ å¯èƒ½ä¼šæƒ³ç€æ—¢ç„¶ä¸èƒ½<code>return</code>ï¼Œé‚£æˆ‘<code>yield</code>ä¸€ä¸‹</p>
<p>if response.status_code !&#x3D; HTTPStatus.OK:<br>    content &#x3D; await response.aread()<br>    yield content<br>    return</p>
<p>IDEæ²¡æŠ¥é”™ï¼Œä½†æ˜¯è¿è¡Œæ—¶â€¦â€¦</p>
<p>TypeError: Argument â€˜eventâ€™ has incorrect type (expected blacksheep.contents.ServerSentEvent, got bytes)</p>
<p>åˆ«æƒ³ç€æ”¹type annotationäº†ï¼Œä¸ç®¡ç”¨çš„ğŸ¤£</p>
<h3 id="æå‡-httpx-Client-ä¹Ÿæ²¡ç”¨"><a href="#æå‡-httpx-Client-ä¹Ÿæ²¡ç”¨" class="headerlink" title="æå‡ httpx.Client ä¹Ÿæ²¡ç”¨"></a>æå‡ httpx.Client ä¹Ÿæ²¡ç”¨</h3><p>æˆ‘ä¹Ÿæƒ³åˆ°äº†è¿™ä¸ªåŠæ³•ï¼Œå…ˆåœ¨è·¯ç”±åè°ƒç”¨ <code>client.stream()</code> ç„¶åçœ‹status codeæ˜¯ä¸æ˜¯200ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆèµ° <code>return ServerSentEventsResponse</code> å¦åˆ™å°±æ˜¯ return json</p>
<p>æ­å–œä½ ï¼å‘ç°äº†æ–°çš„å‘ï¼ä½ ä¼šå‘ç°â€¦â€¦</p>
<p>raise StreamClosed() httpx.StreamClosed: Attempted to read or stream content, but the stream has been closed.</p>
<p>é‚£å°è¯•æ‰‹åŠ¨è¿›å…¥ï¼Œä¸ç”¨<code>async with</code>äº†</p>
<p>stream_ctx &#x3D; client.stream(   )<br>stream_response &#x3D; await stream_ctx.__aenter__()<br>â€¦.<br>return ServerSentEventsResponse(partial(stream_provider, stream_ctx, stream_response))</p>
<p>å¾ˆå¥½</p>
<p>line 155, in stream_provider<br>async for c in stream_response.aiter_text():<br>httpx.ReadTimeout</p>
<p>é‚£å°±é—­åŒ…ï¼Œç”¨å‰æœçš„å‰‘æŒ‡æŒ¥ä»Šæœçš„å…µï¼è¿™æ ·çš„è¯ï¼Œå…¶å®ä¸Šé¢é”™è¯¯å·®ä¸å¤šğŸ˜‚</p>
<h3 id="å”¯ä¸€å¯èƒ½çš„è§£å†³æ–¹æ¡ˆâ€¦â€¦"><a href="#å”¯ä¸€å¯èƒ½çš„è§£å†³æ–¹æ¡ˆâ€¦â€¦" class="headerlink" title="å”¯ä¸€å¯èƒ½çš„è§£å†³æ–¹æ¡ˆâ€¦â€¦"></a>å”¯ä¸€å¯èƒ½çš„è§£å†³æ–¹æ¡ˆâ€¦â€¦</h3><p>ç»™Azureè¿”å›çš„<code>chunks</code>éƒ½ç¼“å­˜èµ·æ¥ï¼Œç­‰éƒ½è¿”å›å®Œäº†ï¼ŒæŠŠå…¨éƒ¨<code>chunks</code>äº¤<code>stream_provider</code>ï¼Œæµå¼ç›´æ¥å˜éæµğŸ‘çœŸæœ‰ä½ çš„</p>
<p>æŠ›å‡ºä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸çš„åŠæ³•ä¹Ÿè®¸ç®¡ç”¨ï¼Œä½†æ˜¯æˆ‘ä¸€ç›´æ²¡æ¥ä½â€¦â€¦</p>
<p>æ‰€ä»¥ï¼Œä¸è¦ä½¿ç”¨ blacksheepï¼Œå¦åˆ™ä½ çš„äººç”Ÿä¼šå˜å¾—ä¸å¹¸</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>å®Œæ•´ä»£ç å¯è§ <a target="_blank" rel="noopener" href="https://gist.github.com/BennyThink/94ac6e088feb1cec829cf7c280c56783">https://gist.github.com/BennyThink/94ac6e088feb1cec829cf7c280c56783</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/16/py-azure-oai-proxy/index/" data-id="cm8c7uxyn00003zjf7syn157r" data-title="ä½¿ç”¨50è¡ŒPythonä»£ç å®ç°ä¸€ä¸ªAzure OpenAI Proxy" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2024/12/12/candlestick-llm/index/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ä½¿ç”¨Python é€šè¿‡Kçº¿è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼Œå¹¶ç”¨ LLM é¢„æµ‹è¶‹åŠ¿</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/azure/">azure</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/azure/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/china/">china</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/china/justsay/">justsay</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloudflare/">cloudflare</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/">it</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/it/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/">justsay</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/website/">website</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/program/">program</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/program/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/security/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/share/">share</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/website/">website</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/website/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/what/">what</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/what/gfw/">gfw</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">March 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">December 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/03/16/py-azure-oai-proxy/index/">ä½¿ç”¨50è¡ŒPythonä»£ç å®ç°ä¸€ä¸ªAzure OpenAI Proxy</a>
          </li>
        
          <li>
            <a href="/2024/12/12/candlestick-llm/index/">ä½¿ç”¨Python é€šè¿‡Kçº¿è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼Œå¹¶ç”¨ LLM é¢„æµ‹è¶‹åŠ¿</a>
          </li>
        
          <li>
            <a href="/2024/11/03/warp-http-proxy/index/">æŠŠ Cloudflare WARP è½¬æ¢ä¸º http ä»£ç†</a>
          </li>
        
          <li>
            <a href="/2024/10/12/aca-php/index/">ç”¨ Azure Container Apps è¿è¡ŒPHPç½‘ç«™</a>
          </li>
        
          <li>
            <a href="/2024/10/06/aca-vm-scale/index/">Azure Container Apps è¿æ¥åˆ°è™šæ‹Ÿæœºå¹¶é…ç½®CPUè‡ªåŠ¨ç¼©æ”¾</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 Bennyå°åœŸè±†<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>